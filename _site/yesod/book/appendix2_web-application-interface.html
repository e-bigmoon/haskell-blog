<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">

  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
  <!-- MUST in hex format, may the same as header-color. This color is for android chrome browser. -->
  <meta name="theme-color" content="#5c6bc0">

  <!-- Metadata. -->
  <meta name="keywords" content="haskell,blog,bigmoon" />
  <title>Web Application Interface</title>
  <meta name="description" content="BIG MOON">
  <link rel="canonical" href="../../yesod/book/appendix2_web-application-interface.html">
  <link rel="alternate" type="application/atom+xml" title="Web Application Interface" href="../../feed.xml" />
  <link rel="shortcut icon" href="../../images/favicon.ico" />
  <meta name="google-site-verification" content="X2YNboLvzw3_bclXLMvohyJDqj68D06_hPDMukRbgTs" />

  <!-- Stylesheets. -->
  <link rel="stylesheet" href="../../lib/materialize/css/materialize.min.css" />
  <link rel="stylesheet" href="../../css/main.css" />
  <link media="all" rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/3.3.92/css/materialdesignicons.min.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="../../lib/material-scrolltop/material-scrolltop.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/agate.min.css" />
  

  <!-- OGP -->
  <meta property="og:title" content="Web Application Interface" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="/yesod/book/appendix2_web-application-interface.html" />
  <!-- <meta property="og:image" content=" サムネイル画像の URL" /> -->
  <meta property="og:site_name" content="Web Application Interface" />
  <meta property="og:description" content="BIG MOON" />

  <meta name="twitter:card" content="summary" />
  <!-- <meta name="twitter:site" content="@[ Twitter ID]" /> -->
  <!-- <meta name="twitter:player" content="@[ Twitter ID]" /> -->

  <noscript>
  <div class="notice-warning noscript">You don't have javascript enabled. Good luck! :(</div>
</noscript>

<!--[if IE]>
  <div class="notice-warning">Oh, you are using Internet Explorer! Good luck... :(</div>
<![endif]-->

</head>


  <body>
    <header class="site-header">
      <nav class="nav-extended indigo lighten-1">
        <div class="nav-wrapper">
  <a href="../../"><span class="site-title">BIGMOON Haskeller's BLOG</span></a>
  <a href="#" data-activates="mobile-navbar" class="button-collapse">
    <i class="mdi mdi-menu white-text"></i>
  </a>

  <ul id="nav-mobile" class="right hide-on-med-and-down">
    <li>
      <a href="../../" class="white-text">
        <i class="mdi mdi-home left indigo-text text-lighten-3"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="white-text">
        <i class="mdi mdi-account-circle left indigo-text text-lighten-3"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../books/" class="white-text">
        <i class="mdi mdi-book-open left indigo-text text-lighten-3"></i>
        Books
      </a>
    </li>
    <li>
      <a href="../../stack/" class="white-text">
        <i class="mdi mdi-wrench left indigo-text text-lighten-3"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/" class="white-text">
        <i class="mdi mdi-comment-question-outline left indigo-text text-lighten-3"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="white-text">
        <i class="mdi mdi-package-variant left indigo-text text-lighten-3"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="white-text">
        <i class="mdi mdi-earth left indigo-text text-lighten-3"></i>
        Yesod
      </a>
    </li>
    <li>
      <a href="../../feed.xml" class="white-text">
        <i class="mdi mdi-rss left indigo-text text-lighten-3"></i>
        Feed
      </a>
    </li>
  </ul>

  <ul class="side-nav" id="mobile-navbar">
    <li>
      <a href="../../" class="waves-effect waves-teal black-text">
        <i class="mdi mdi-home left green-text"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="navbar-text-colour-mobile">
        <i class="mdi mdi-account-circle left blue-text"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../books/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-book-open left blue-text"></i>
        Books
      </a>
    </li>
    <li>
      <a href="../../stack/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-wrench left blue-text"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-comment-question-outline left blue-text"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-package-variant left blue-text"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-earth left blue-text"></i>
        Yesod
      </a>
    </li>
  </ul>
</div>

      </nav>
    </header>

    <div class="site-container" id="tab-main">
      <div class="wrapper">
        <div class="post-ribbon"></div>

<div class="container page-container">
  <div class="post-page card-panel z-depth-2">
    <div class="post-section">
      <div class="post-heading">
        <div style="float: right;">
          
          <span>記事公開日: 2021/02/22</span><br>
          
          
        </div>
        <h1 class="post-title">Web Application Interface</h1>
      </div>

      <article class="page-content">
        <div class="yesod-book-notice">
<p>この章ではWAI version 3.0を扱うが, これは前のバージョンと多数の変更点がある.</p>
</div>
<p>これはほとんど全てのウェブ開発に使われる言語が対処してきた問題である: ウェブサーバとアプリケーション間におけるローレベルのインターフェース. 初期における解決策としては立派で枯れたCommon Gateway Interface(CGI)であり, 言語によらないインターフェースを提供しており, 標準入力, 標準出力と環境変数のみを用いている.</p>
<p>Perlが事実上のウェブプログラミング言語になりつつあった頃に遡ると, CGIの主な短所は明確になった: プロセスが各リクエスト毎に新たに開始される必要があった. インタープリタ型言語やデータベースコネクションを要するアプリケーションを扱う際, このオーバーヘッドは耐え難いものであった. FastCGI(後のSCGI)はCGIの後継者として登場したが, 多くのプログラミング界の大部分は間違った方向に進んでいるように見えた.</p>
<p>各言語はサーバと相互作用するための独自の基準を作り始めた. mod_perl. mod_python. mod_php. mod_ruby. 同じ言語内において, 複数のインターフェースが生じた. ある場合には, インターフェースの上にインターフェースがあった. そしてこれら全てはかなり重複した作業を要した: FastCGIと機能するように設計されたPythonアプリケーションはmod_pythonでは機能しなかった; mod_pythonはあるウェブサーバのためだけに存在した; そしてこれらのプログラミング言語固有のサーバ拡張が, 各プログラミング毎に書かれる必要があった.</p>
<p>Haskellには独自の歴史がある. 元々cgiパッケージがあり, モナドインターフェースを提供していた. そしてfastcgiパッケージは同じインターフェースを与えた. 一方, Haskellウェブ開発の大部分はスタンドアロンサーバに焦点を当てた. 問題としては, 各サーバが独自のインターフェースを有したことであり, 特定のバックエンドを標的にする必要があったことを意味する. これは, GZIPエンコーディング, 開発サーバ, テストフレームワークのような共通の機能を共有することが不可能であることを意味する.</p>
<p>WAIはこれを解決しようとし, ウェブサーバとアプリケーション間における効率的で包括的なインターフェースを提供した. インターフェースをサポートする全てのハンドラが, あらゆるWAIアプリケーションにサーブでき, またそのインターフェースを用いるあらゆるアプリケーションが全てのハンドラで実行可能である.</p>
<p>これを書いている時には, Warp, FastCGI, そして開発サーバのように様々なバックエンドがある. wai-handler-webkitのようにデスクトップアプリケーションを作るためのより秘伝のバックエンドも存在する. wai-extraはGZIP, JSON-P, そしてvirtual hostingのような多くの共通のミドルウェアコンポーネントを提供する. wai-testによってユニットテストを書くのが容易になり, wai-handler-develによりコンパイルするために止める心配をせずにアプリケーションを開発することが可能になる. YesodはScottyやMFlowのような他のHaskellウェブフレームワークと同様, WAIをターゲットにする. それはHoogleを含む, フレームワークを完全にスキップするアプリケーションによっても用いられている.</p>
<div class="yesod-book-notice">
<p>Yesodはdevel serverに対し別のアプローチを取り, それはyesod develとして知られている. wai-handler-develとの相違としてはyesod develは実際にコードを毎回コンパイルし, cabalファイルのあらゆる設定を遵守することである. これは一般的なYesod開発において推奨される方法である.</p>
</div>
<h2 id="インターフェース">インターフェース</h2>
<p>インターフェース自身は非常に率直である: アプリケーションはリクエストを取り, レスポンスを返す. レスポンスはHTTPステータス, ヘッダのリストとリクエストボディである. リクエストは様々な情報を含む: リクエストされたパス, クエリストリング, リクエストボディ, HTTPバージョンなどである.</p>
<p>リソースマネジメントを例外安全な方法で扱うために, 継続渡しスタイルを用いてレスポンスを返す. <code>bracket</code>関数の仕様と同様である. これによりアプリケーションの定義は次のようなる.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Application</span> <span class="ot">=</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Request</span> <span class="ot">-&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Response</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">ResponseReceived</span>) <span class="ot">-&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">IO</span> <span class="dt">ResponseReceived</span></span></code></pre></div>
<p>最初の引数は<code>Request</code>であり, これはあまり驚くべきことではない. 2つ目は継続, あるいは<code>Response</code>でなされるべきことである. 一般的にこれはだだクライアントに送っているだけである. 特別な<code>ResponseReceived</code>型を用いてアプリケーションが実際に継続を呼び出したかを確認できる.</p>
<p>これは少し奇妙に見えるが, 使い方は非常に単純であり, それを以下に示す.</p>
<h2 id="response-body">Response Body</h2>
<p>Haskellはlazy bytestringとして知られるデータ型を持つ. 遅延性を利用することでメモリを浪費せずに大きな値を作ることができる. 遅延I/Oを用いることで, ファイルコンテンツ全体を表すが, 小さなメモリ領域しか占領しない. 理論的に, lazy bytestringはレスポンスボディのために必要な唯一の表現である.</p>
<p>実践的には, lazy bytestringは“純粋”な値を生成するのには有用で, ファイルを読むのに必要な遅延I/Oはプログラムに対し, ある非決定性を導入する. 1秒で数千のファイルを扱うために, 制限となるのはメモリではなく, ファイルハンドルである. 遅延I/Oを用いることでファイルハンドルはすぐには開放されず, リソース浪費になる. これに対処するために, WAIは独自のストリーミングデータインターフェースを与える.</p>
<p>このストリーミングインターフェースの中心は<code>Builder</code>である. <code>Builder</code>はバッファを<code>data</code>のバイトで満たすアクションを表現する. これは単純に<code>ByteString</code>を受け渡すよりも効率的である. なぜならば, データの複数コピーを避けられるためである. 多くの場合, アプリケーションは単一の<code>Builder</code>値を与える必要がある. そしてその単純な場合, <code>ResponseBuilder</code>コンストラクタがある.</p>
<p>しかし, <code>Application</code>がクライアントへのデータを生成するIOアクションを交互に挟む必要のある場合がある. その場合, <code>ResponseStream</code>を用いる. <code>ResponseStream</code>では, 関数を与える. この関数は2つのアクションを取る: “より多くのデータを生成する”アクションと, “バッファをフラッシュする”アクションである. これによりデータを生成し, IOアクションを行い, フラッシュすることを必要な回数だけ行い, 交互に挟む操作も必要なだけ持たせることができる.</p>
<p>1つさらに最適化することができる: 多くのオペレーティングシステムはsendfileシステムコールがあり, これはファイルを直接ソケットに送り, より一般的なI/Oシステムコールに特有のメモリコピーを多く迂回する. この場合, <code>ResponseFile</code>を用いる.</p>
<p>最後に, HTTPモードから完全に抜け出す必要のある場合がある. 2つの例として, WebSocketsでは半二重通信HTTP接続を完全な二重通信接続にアップグレードする必要がある. HTTPSプロキシでは, プロキシサーバが接続を確立し, ダムデータを運送する媒体になる必要がある. これらの場合, <code>ResponseRaw</code>コンストラクタを用いる. 必ずしも全てのWAIハンドラが実際に<code>ResponseRaw</code>をサポートをしている訳ではないことに注意せよ, しかし, 最も一般的に用いられているWarpハンドラはこれをサポートする.</p>
<h2 id="request-body">Request Body</h2>
<p>レスポンスボディと同様に, 理論的にはlazy ByteStringをリクエストボディに用いるが, 実践的には遅延I/Oは避けたい. 代わりに, リクエストボディはIO ByteStringにより表現される(ここでのByteStringはstrict ByteStringである). これはリクエストボディ全体でなく, データの次のチャンクを返すことに注意せよ. 一度リクエストボディ全体を消費したら, このアクションに対する次の呼び出しは空ByteStringを返す.</p>
<p>次のことに注意せよ. レスポンスボディと異なり, リクエスト側で<code>Builder</code>を用いる必要がない. なぜならば, 目的としては単に読むだけだからである.</p>
<p>理論的にはリクエストボディはどんな型のデータも含むことができるが, 最も一般的なのはURLエンコードされたデータとmultipart formデータである. wai-extraパッケージはこれらをメモリ上効率的な方法でパースする組み込みのサポートを含む.</p>
<h2 id="hello-world">Hello World</h2>
<p>WAIの単純さを示すために, hello worldの例を見てみよう. OverloadedString言語拡張を用いて, 明示的に文字列をbytestringにパックしなければならないのを避ける.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Network.Wai</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Network.HTTP.Types</span> (status200)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Network.Wai.Handler.Warp</span> (run)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>application _ respond <span class="ot">=</span> respond <span class="op">$</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  responseLBS status200 [(<span class="st">&quot;Content-Type&quot;</span>, <span class="st">&quot;text/plain&quot;</span>)] <span class="st">&quot;Hello World&quot;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> run <span class="dv">3000</span> application</span></code></pre></div>
<p>2行目から4行目ではインポートを行っている. Warpはwarpパッケージにより与えられ, 主要なWAIバックエンドである. WAIはまた, http-typesパッケージのトップにあり, 多くのデータ型と<code>status 200</code>を含む便利な値を含む.</p>
<p>最初にアプリケーションを定義する. 特定のリクエストパラメータには関心がないため, 関数の最初の引数は無視する. これは, リクエスト値を含む. 2つ目の引数は“レスポンスを送る”関数であり, すぐに使うことになる. 送信するレスポンス値はlazy ByteString(よって respondLBS)で作られ, ステータスコード200(“OK”), text/plainコンテンツタイプ, そして“Hello World”を含むボディを持つ. 非常に単純である.</p>
<h2 id="resource-allocation">Resource allocation</h2>
<p>これをもう少し面白いものにして, レスポンスに対しリソースを割り当ててみよう. <code>MVar</code>を<code>main</code>関数に作りリクエスト数を追跡し, その<code>MVar</code>を各レスポンスを送る際に所持する.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Blaze.ByteString.Builder</span>           (fromByteString)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Blaze.ByteString.Builder.Char.Utf8</span> (fromShow)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Control.Concurrent.MVar</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Monoid</span>                        ((&lt;&gt;))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.HTTP.Types</span>                 (status200)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai.Handler.Warp</span>           (run)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>application countRef _ respond <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    modifyMVar countRef <span class="op">$</span> \count <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> count' <span class="ot">=</span> count <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>            msg <span class="ot">=</span> fromByteString <span class="st">&quot;You are visitor number: &quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>                  fromShow count'</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        responseReceived <span class="ot">&lt;-</span> respond <span class="op">$</span> responseBuilder</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>            status200</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>            [(<span class="st">&quot;Content-Type&quot;</span>, <span class="st">&quot;text/plain&quot;</span>)]</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>            msg</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span> (count', responseReceived)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    visitorCount <span class="ot">&lt;-</span> newMVar <span class="dv">0</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    run <span class="dv">3000</span> <span class="op">$</span> application visitorCount</span></code></pre></div>
<p>これはWAIの継続渡しインターフェースが活躍する場である. 標準<code>modyfyMVar</code>関数を用いて<code>MVar</code>ロックを取得し, レスポンスを送る. どのようにresponseReceivedを挿入したかについて注意せよ, 実際にはその値は何にも使われていないが. これは単に, 実際にレスポンスを送ったことを明示しただけである.</p>
<p>またどのように<code>Builder</code>を利用し<code>msg</code>値を構築するかについて注意せよ. 2つのByteStringを直接連結する代わりに, モノイドとして2つの異なる<code>Builder</code>値を連結する. これの利点は, 最初に一時的な<code>ByteString</code>バッファにコピーされ, 後に最終的なバッファにコピーされる代わりに, 結果が直接最終的な出力バッファにコピーされることである.</p>
<h2 id="streaming-response">Streaming Response</h2>
<p>ストリーミングインターフェースを同様に試してみよう.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Blaze.ByteString.Builder</span> (fromByteString)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Control.Concurrent</span>       (threadDelay)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.HTTP.Types</span>       (status200)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai.Handler.Warp</span> (run)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>application _ respond <span class="ot">=</span> respond <span class="op">$</span> responseStream status200 [(<span class="st">&quot;Content-Type&quot;</span>, <span class="st">&quot;text/plain&quot;</span>)]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">$</span> \send flush <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        send <span class="op">$</span> fromByteString <span class="st">&quot;Starting the response...\n&quot;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        flush</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        threadDelay <span class="dv">1000000</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        send <span class="op">$</span> fromByteString <span class="st">&quot;All done!\n&quot;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> run <span class="dv">3000</span> application</span></code></pre></div>
<p><code>responseStream</code>を用い, 3番目の引数は“ビルダを送信する”, そして“バッファをフラッシュする”関数である. クライアントがすぐにデータを見れるようにするために, 最初のデータチャンクの後にどのようにデータをフラッシュするかについて注意せよ. しかし, レスポンスの最後にフラッシュする必要はない. WAIはハンドラが自動的にストリームの最後でフラッシュすることを要求する.</p>
<h2 id="middleware">Middleware</h2>
<p>アプリケーションをコードの変更なしに複数のバックエンドで実行することを可能にすることの他に, WAIには他の利点がある: ミドルウェア. ミドルウェアは本質的にはアプリケーショントランスフォーマであり, あるアプリケーションを取り, 他のを返す.</p>
<p>ミドルウェアのコンポーネントは多くのサービスを提供するために使われる: URLの整理, 認証, キャッシュ, JSON-Pリクエスト. しかしおそらくもっとも有益で直感的なミドルウェアはgzip圧縮である. ミドルウェアは非常に単純に機能する: リクエストヘッダをパースし, クライアントが圧縮をサポートするか決定し, もしそうならばレスポンスボディを圧縮し, 適切なレスポンスヘッダを付け加える.</p>
<p>ミドルウェアの素晴らしい点は, 目障りでないことである. どのようにgzipをhello worldアプリケーションに適応するかを見てみよう.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Network.Wai</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Network.Wai.Handler.Warp</span> (run)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Network.Wai.Middleware.Gzip</span> (gzip, def)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Network.HTTP.Types</span> (status200)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>application _ respond <span class="ot">=</span> respond <span class="op">$</span> responseLBS status200 [(<span class="st">&quot;Content-Type&quot;</span>, <span class="st">&quot;text/plain&quot;</span>)]</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;Hello World&quot;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> run <span class="dv">3000</span> <span class="op">$</span> gzip def application</span></code></pre></div>
<p>インポート行を付け加え, 実際にミドルウェアへのアクセスを可能にし, 単純にgzipをアプリケーションに適応する. 複数のミドルウェアをつなぎ合わせることも可能である: <code>gzip False $ jsonp $ othermiddleware $ myapplication</code>のような行は完全に適切である. ひとつ警告がある: ミドルウェアが適応される順序は重要である. 例えば, jsonpは非圧縮データ上で機能する必要がある. よってもしそれをgzipの後に適応したら, 困難に陥ることになる.</p>
      </article>

      <div class="pager">
      
      
      </div>

      <div class="row">
        <div class="col s6 offset-s6" style="position: relative; height: 100px;">
          <div class="fixed-action-btn horizontal" style="position: absolute; display: inline-block; right: 24px;">
  <a class="btn-floating btn-large red">
    <i class="large material-icons">share</i>
  </a>
  <ul>
    <li>
      <a class="btn-floating waves-effect waves-light blue tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Twitter" href="https://twitter.com/intent/tweet?text=Web Application Interface&url=https://haskell.e-bigmoon.com/yesod/book/appendix2_web-application-interface.html"><i class="mdi mdi-twitter white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light indigo tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Facebook" href="https://facebook.com/sharer.php?u=https://haskell.e-bigmoon.com/yesod/book/appendix2_web-application-interface.html"><i class="mdi mdi-facebook white-text"></i></a>
    </li>
  </ul>
</div>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
    </div>

    <footer class="page-footer indigo lighten-1">
  <div class="footer-copyright">
    <div class="container">
      © 2017-2020 BIGMOON&nbsp;
      Site proudly generated by <a class="red-text text-accent-1" href="http://jaspervdj.be/hakyll">Hakyll</a>,&nbsp;
      original Jekyll theme by <a class="red-text text-accent-1" href="https://github.com/mumuxme/materialize-jekyll">mumuxme</a>.
    </div>
  </div>
</footer>


    <!-- scrolltop button -->
    <button class="material-scrolltop waves-effect waves-light hide-on-small-only" type="button">
      <i class="mdi mdi-arrow-up-bold small white-text"></i>
    </button>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-19322672-9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-19322672-9');
    </script>

    <!-- jquery -->
    <script type="text/javascript" src="../../lib/jquery-min.js"></script>
    <!-- materialize -->
    <script src="../../lib/materialize/js/materialize.min.js"></script>
    <!-- <\!-- Material ScrollTop plugin -\-> -->
    <script src="../../lib/material-scrolltop/material-scrolltop.js"></script>
    <!-- main -->
    <script src="../../js/init.js"></script>
    <script src="../../js/main.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/haskell.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/yaml.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/shell.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/bash.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>

</html>
