<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">

  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
  <!-- MUST in hex format, may the same as header-color. This color is for android chrome browser. -->
  <meta name="theme-color" content="#5c6bc0">

  <!-- Metadata. -->
  <meta name="keywords" content="haskell,blog,bigmoon" />
  <title>ch14-Authentification-and-Authorization</title>
  <meta name="description" content="BIG MOON">
  <link rel="canonical" href="../../yesod/book/ch14-Authentification-and-Authorization.html">
  <link rel="alternate" type="application/atom+xml" title="ch14-Authentification-and-Authorization" href="../../feed.xml" />
  <link rel="shortcut icon" href="../../images/favicon.ico" />
  <meta name="google-site-verification" content="X2YNboLvzw3_bclXLMvohyJDqj68D06_hPDMukRbgTs" />

  <!-- Stylesheets. -->
  <link rel="stylesheet" href="../../lib/materialize/css/materialize.min.css" />
  <link rel="stylesheet" href="../../css/main.css" />
  <link media="all" rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/3.3.92/css/materialdesignicons.min.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="../../lib/material-scrolltop/material-scrolltop.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" />

  <!-- OGP -->
  <meta property="og:title" content="ch14-Authentification-and-Authorization" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="/yesod/book/ch14-Authentification-and-Authorization.html" />
  <!-- <meta property="og:image" content=" サムネイル画像の URL" /> -->
  <meta property="og:site_name" content="ch14-Authentification-and-Authorization" />
  <meta property="og:description" content="BIG MOON" />

  <meta name="twitter:card" content="summary" />
  <!-- <meta name="twitter:site" content="@[ Twitter ID]" /> -->
  <!-- <meta name="twitter:player" content="@[ Twitter ID]" /> -->

  <noscript>
  <div class="notice-warning noscript">You don't have javascript enabled. Good luck! :(</div>
</noscript>

<!--[if IE]>
  <div class="notice-warning">Oh, you are using Internet Explorer! Good luck... :(</div>
<![endif]-->

</head>


  <body>
    <header class="site-header">
      <nav class="nav-extended indigo lighten-1">
        <div class="nav-wrapper">
  <a href="../../"><span class="site-title">BIGMOON Haskeller's BLOG</span></a>
  <a href="#" data-activates="mobile-navbar" class="button-collapse">
    <i class="mdi mdi-menu white-text"></i>
  </a>

  <ul id="nav-mobile" class="right hide-on-med-and-down">
    <li>
      <a href="../../" class="white-text">
        <i class="mdi mdi-home left indigo-text text-lighten-3"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="white-text">
        <i class="mdi mdi-account-circle left indigo-text text-lighten-3"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../stack/" class="white-text">
        <i class="mdi mdi-wrench left indigo-text text-lighten-3"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/index.html" class="white-text">
        <i class="mdi mdi-comment-question-outline left indigo-text text-lighten-3"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="white-text">
        <i class="mdi mdi-package-variant left indigo-text text-lighten-3"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="white-text">
        <i class="mdi mdi-earth left indigo-text text-lighten-3"></i>
        Yesod
      </a>
    </li>
    <li>
      <a href="../../contact.html" class="white-text">
        <i class="mdi mdi-lead-pencil left indigo-text text-lighten-3"></i>
        Contact
      </a>
    </li>
    <li>
      <a href="../../feed.xml" class="white-text">
        <i class="mdi mdi-rss left indigo-text text-lighten-3"></i>
        Feed
      </a>
    </li>
  </ul>

  <ul class="side-nav" id="mobile-navbar">
    <li>
      <a href="../../" class="waves-effect waves-teal black-text">
        <i class="mdi mdi-home left green-text"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="navbar-text-colour-mobile">
        <i class="mdi mdi-account-circle left blue-text"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../stack/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-wrench left blue-text"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-comment-question-outline left blue-text"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-package-variant left blue-text"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-earth left blue-text"></i>
        Yesod
      </a>
    </li>
    <li>
      <a href="../../contact.html" class="navbar-text-colour-mobile">
        <i class="mdi mdi-lead-pencil left blue-text"></i>
        Contact
      </a>
    </li>
  </ul>
</div>

      </nav>
    </header>

    <div class="site-container" id="tab-main">
      <div class="wrapper">
        <div class="post-ribbon"></div>

<div class="container page-container">
  <div class="post-page card-panel z-depth-2">
    <div class="post-section">
      <div class="post-heading">
        <h1 class="post-title">ch14-Authentification-and-Authorization</h1>
        
      </div>

      <article class="page-content">
        <h1 id="認証と認可">認証と認可</h1>
<p>認証と認可は2つの非常に関連した, しかし異なる概念である. 前者はユーザを特定することに関与し, 後者はユーザに許可されたことを決定する. 残念なことに, 両方の用語はしばしば“auth”と省略されるため, その概念はしばしば融合されてしまう.</p>
<p>YesodはOpenID, BrowserIDやOAUTHのような多くの第3者認証システムに対し, 組込式のサポートを提供している. これらは, アプリケーションがユーザのクレデンシャルの妥当性を確認するための外部システムを信頼するシステムである. さらに, より一般的に用いられるusername/passwordやemail/passwordシステムに対するサポートもある. 最初の方法はユーザ(新しいパスワードを覚えずに済む)と実装者(セキュリティ構造全体を扱う必要がなくなる)にとっての簡便性を保証する. 一方, 後ろの方法はより開発者に制御されている.</p>
<p>認可側では, RESTと型安全URLを利用し, シンプルで宣言的なシステムを作る. さらに, すべての認可コードはHaskellで書かれているため, 言語を完全に柔軟かつ自由に使うことができる.</p>
<p>この章では, Yesodにおいてどのように“auth”解決策を構成するかについて示し, 異なる認証システム選択におけるトレードオフについて論ずる.</p>
<h1 id="概略">概略</h1>
<p>yesod-authパッケージはいくつもの異なる認証プラグインのための, 統一的インターフェースを与える. これらのバックエンドに対し, 唯一の実際に必要なものはユーザをある一意的な文字列で特定することである. 例えばOpenIDにおいては, それはOpenID値アドレスに相当する. BrowserIDでは, emailアドレスに相当する. HashDB(ハッシュ化されたパスワードのデータベースを用いる)においては, ユーザ名に相当する.</p>
<p>各認証プラグインは, ログインのための独自システムを与える. そして, それは外部サイトでトークンを渡したり, , email/password形式で渡したりする. ログインが成功すると, プラグインはユーザのセッションに値を設定し, 彼/彼女の<code>AuthId</code>を指定する. この<code>AuthID</code>はたいていは, ユーザを追跡するために用いられるテーブルからのPersistent IDである.</p>
<p>ユーザの<code>AuthID</code>を問い合わせするための関数はいくつか存在し, 最も一般的なものは, <code>maybeAuthID</code> , <code>requireAuthID</code>, <code>maybeAuth</code>そして, <code>requireAuth</code>である. “require”の方は, ユーザがログインしていなければログインページにリダイレクトし, 2つめの関数のセット(<code>Id</code>で終わっていない関数)は, テーブルIDとエンティティ値の両方を与える.</p>
<p><code>AuthID</code>の全てのストレージは, セッションの頂点に構築されているため, そこにおける全てのルールが適用される. 特に, データは暗号化され, HMAC化したクライアントクッキーに保存され, ある設定可能な時間の間, 使用されなければ, 自動的にタイムアウトする. さらに, セッションにはサーバサイドの要素が存在しないため, ログアウトによりセッションクッキーからデータが削除される;もし, ユーザが古いクッキー値を用いていれば, セッションはまだ有効である.</p>
<div class="yesod-book-notice">
もし望むのなら, デフォルトのクライアントサイドセッションをサーバサイドセッションに置き換え, 強制ログアウト機能を与えることができる. また, もしセッションを中間者(MITM)攻撃からセッションを保護したいのなら, サイトをSSL上で作動させ, セッションの章で紹介した<code>sslOnlySessions</code>や<code>sslOnlyMiddleware</code>を用い, セッションを堅牢にすべきである.
<div>

<p>裏面, 認可は<code>Yesod</code>型クラスにおけるいくつかの関数により処理される. 各リクエストに対し, これらのメソッドは, アクセスが許可されているか, 拒否されているか, あるいは, もしユーザが認可される必要があるかどうかについてを決定するために実行される. デフォルトでは, これらのメソッドは, どのリクエストも許可している. 代わりに, 認可をよりアドホックな方法で実装し, <code>requireAuth</code>にようなものを各ハンドラに追加したりできる. しかし, これは宣言的認証システムの利点を損ねることになる.</p>
<h2 id="私を認証しなさい">私を認証しなさい</h2>
<p>認証の例に取り組んでみよう. Google oAuth認証が機能するためには, 次のステップに従う必要がある:</p>
<ol type="1">
<li><p><a href="https://developers.google.com/identity/protocols/OAuth2">Google Developers Help</a>で, どのようにして, Googleとアプリケーションに分かるクライアントIDやクライアント秘密情報のようなOAuth 2.0クレデンシャルを得るかについて, 読みなさい.</p></li>
<li><p><code>Authorized redirect URIs</code>を<code>http://localhost:3000/auth/page/googleemail2/complete</code>に設定しなさい.</p></li>
<li><p><code>Google+ API</code>と<code>Contacts API</code>を有効にしなさい.</p></li>
<li><p><code>clientId</code>と<code>secretID</code>を得たら, 下のコードで交換してみなさい.</p></li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="ot">{-# LANGUAGE MultiParamTypeClasses #-}</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="ot">{-# LANGUAGE OverloadedStrings     #-}</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="ot">{-# LANGUAGE QuasiQuotes           #-}</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="ot">{-# LANGUAGE TemplateHaskell       #-}</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="ot">{-# LANGUAGE TypeFamilies          #-}</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="kw">import</span>           <span class="dt">Data.Default</span>                (def)</a>
<a class="sourceLine" id="cb1-7" title="7"><span class="kw">import</span>           <span class="dt">Data.Text</span>                   (<span class="dt">Text</span>)</a>
<a class="sourceLine" id="cb1-8" title="8"><span class="kw">import</span>           <span class="dt">Network.HTTP.Client.Conduit</span> (<span class="dt">Manager</span>, newManager)</a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw">import</span>           <span class="dt">Yesod</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="kw">import</span>           <span class="dt">Yesod.Auth</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="kw">import</span>           <span class="dt">Yesod.Auth.BrowserId</span></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="kw">import</span>           <span class="dt">Yesod.Auth.GoogleEmail2</span></a>
<a class="sourceLine" id="cb1-13" title="13"></a>
<a class="sourceLine" id="cb1-14" title="14"></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="co">-- Replace with Google client ID.</span></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="ot">clientId ::</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb1-17" title="17">clientId <span class="fu">=</span> <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb1-18" title="18"></a>
<a class="sourceLine" id="cb1-19" title="19"><span class="co">-- Replace with Google secret ID.</span></a>
<a class="sourceLine" id="cb1-20" title="20"><span class="ot">clientSecret ::</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb1-21" title="21">clientSecret <span class="fu">=</span> <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb1-22" title="22"></a>
<a class="sourceLine" id="cb1-23" title="23"><span class="kw">data</span> <span class="dt">App</span> <span class="fu">=</span> <span class="dt">App</span></a>
<a class="sourceLine" id="cb1-24" title="24">    {<span class="ot"> httpManager ::</span> <span class="dt">Manager</span></a>
<a class="sourceLine" id="cb1-25" title="25">    }</a>
<a class="sourceLine" id="cb1-26" title="26"></a>
<a class="sourceLine" id="cb1-27" title="27">mkYesod <span class="st">&quot;App&quot;</span> [parseRoutes|</a>
<a class="sourceLine" id="cb1-28" title="28">/ HomeR GET</a>
<a class="sourceLine" id="cb1-29" title="29">/auth AuthR Auth getAuth</a>
<a class="sourceLine" id="cb1-30" title="30">|]</a>
<a class="sourceLine" id="cb1-31" title="31"></a>
<a class="sourceLine" id="cb1-32" title="32"><span class="kw">instance</span> <span class="dt">Yesod</span> <span class="dt">App</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-33" title="33">    <span class="co">-- Note: In order to log in with BrowserID, you must correctly</span></a>
<a class="sourceLine" id="cb1-34" title="34">    <span class="co">-- set your hostname here.</span></a>
<a class="sourceLine" id="cb1-35" title="35">    approot <span class="fu">=</span> <span class="dt">ApprootStatic</span> <span class="st">&quot;http://localhost:3000&quot;</span></a>
<a class="sourceLine" id="cb1-36" title="36"></a>
<a class="sourceLine" id="cb1-37" title="37"><span class="kw">instance</span> <span class="dt">YesodAuth</span> <span class="dt">App</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-38" title="38">    <span class="kw">type</span> <span class="dt">AuthId</span> <span class="dt">App</span> <span class="fu">=</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb1-39" title="39">    getAuthId <span class="fu">=</span> <span class="fu">return</span> <span class="fu">.</span> <span class="dt">Just</span> <span class="fu">.</span> credsIdent</a>
<a class="sourceLine" id="cb1-40" title="40"></a>
<a class="sourceLine" id="cb1-41" title="41">    loginDest _ <span class="fu">=</span> <span class="dt">HomeR</span></a>
<a class="sourceLine" id="cb1-42" title="42">    logoutDest _ <span class="fu">=</span> <span class="dt">HomeR</span></a>
<a class="sourceLine" id="cb1-43" title="43"></a>
<a class="sourceLine" id="cb1-44" title="44">    authPlugins _ <span class="fu">=</span></a>
<a class="sourceLine" id="cb1-45" title="45">        [ authBrowserId def</a>
<a class="sourceLine" id="cb1-46" title="46">        , authGoogleEmail clientId clientSecret</a>
<a class="sourceLine" id="cb1-47" title="47">        ]</a>
<a class="sourceLine" id="cb1-48" title="48"></a>
<a class="sourceLine" id="cb1-49" title="49">    <span class="co">-- The default maybeAuthId assumes a Persistent database. We're going for a</span></a>
<a class="sourceLine" id="cb1-50" title="50">    <span class="co">-- simpler AuthId, so we'll just do a direct lookup in the session.</span></a>
<a class="sourceLine" id="cb1-51" title="51">    maybeAuthId <span class="fu">=</span> lookupSession <span class="st">&quot;_ID&quot;</span></a>
<a class="sourceLine" id="cb1-52" title="52"></a>
<a class="sourceLine" id="cb1-53" title="53"><span class="kw">instance</span> <span class="dt">RenderMessage</span> <span class="dt">App</span> <span class="dt">FormMessage</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-54" title="54">    renderMessage _ _ <span class="fu">=</span> defaultFormMessage</a>
<a class="sourceLine" id="cb1-55" title="55"></a>
<a class="sourceLine" id="cb1-56" title="56"><span class="ot">getHomeR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></a>
<a class="sourceLine" id="cb1-57" title="57">getHomeR <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-58" title="58">    maid <span class="ot">&lt;-</span> maybeAuthId</a>
<a class="sourceLine" id="cb1-59" title="59">    defaultLayout</a>
<a class="sourceLine" id="cb1-60" title="60">        [whamlet|</a>
<a class="sourceLine" id="cb1-61" title="61">            <span class="kw">&lt;p&gt;</span>Your current auth ID: <span class="kw">#{</span><span class="fu">show</span> maid<span class="kw">}</span></a>
<a class="sourceLine" id="cb1-62" title="62">            <span class="kw">$maybe</span> _ <span class="ot">&lt;-</span> maid</a>
<a class="sourceLine" id="cb1-63" title="63">                <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb1-64" title="64">                    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">AuthR</span> <span class="dt">LogoutR</span><span class="kw">}&gt;</span>Logout</a>
<a class="sourceLine" id="cb1-65" title="65">            <span class="kw">$nothing</span></a>
<a class="sourceLine" id="cb1-66" title="66">                <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb1-67" title="67">                    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">AuthR</span> <span class="dt">LoginR</span><span class="kw">}&gt;</span>Go to the login page</a>
<a class="sourceLine" id="cb1-68" title="68">        |]</a>
<a class="sourceLine" id="cb1-69" title="69"></a>
<a class="sourceLine" id="cb1-70" title="70"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb1-71" title="71">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-72" title="72">    man <span class="ot">&lt;-</span> newManager</a>
<a class="sourceLine" id="cb1-73" title="73">    warp <span class="dv">3000</span> <span class="fu">$</span> <span class="dt">App</span> man</a></code></pre></div>
<p>ルートの宣言から始める. まず, 標準的な<code>HomeR</code>ルートを宣言し, 認証サブサイトを設定する. サブサイトは, 4つのパラメータが必要であることを思い出しなさい: サブサイトへのパス, ルート名, サブサイト名, そして, サブサイト値を得るための関数. コードに換言すれば, 次のようになる.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="fu">/</span>auth <span class="dt">AuthR</span> <span class="dt">Auth</span> getAuth</a></code></pre></div>
<p><code>getAuth :: MyAuthSite → Auth</code>を持つ必要がある. 自身でその関数を書いてはいないが, yesod-authが自動的に与えてくれる. 他のサブサイト(static fileのような)では, サブサイト値における構築設定をする必要があり, それゆえget関数を明記する必要がある. authサブサイトでは, これらの設定は別の型クラスである<code>YesodAuth</code>で明記する.</p>
<div class="yesod-book-notice">
なぜサブサイト値を使わないのか? authサブサイトに対して与えたい設定はいくつもあるが, レコード型からそのようにすることは不便であろう. また, <code>AuthID</code>関連型を持ちたいため, 型クラスがより自然である. そして, なぜ全てのサブサイトで型クラスを用いないのか? それは次の短所より来る: その場合, 各サイトにつき単一のインスタンスのみしか持てず, 異なるstaticファイルを異なるルートから得ることができなくなる. また, サブサイト値はアプリケーション初期化時にデータをロードする際に, よりうまく機能する.
<div>

<p>すると, この<code>YesodAuth</code>インスタンスでは実際に何が起こっているのか? そこには, 6つの必要な宣言が存在する:</p>
<ul>
<li><p><code>AuthId</code>は関連型である. これは, ユーザがログインしているか(<code>maybeAuthId</code>または, <code>requireAuthId</code>を通して)尋ねる際<code>yesod-auth</code>が与えてくれる値である. 今回の場合, 単純に<code>text</code>を用い, すぐに分かるように, 生識別子-今回はemailアドレス, を保存している.</p></li>
<li><p><code>getAuthId</code>は実際の<code>AuthId</code>を<code>Creds</code>(credentials)型から取得する. この型は, 3つの情報を持っている: 使用されている認証バックエンド(今回の場合, ブラウザid, または, googleemial), 実際の識別子, そして, 任意の追加情報についての関連するリスト. 各バックエンドは, 異なる追加情報を与える; 詳細については文書を参照しなさい.</p></li>
<li><p><code>loginDest</code>は, 成功したログイン後リダイレクトするルートを与える.</p></li>
<li><p>同様に, <code>logoutDest</code>は, ログアウト後リダイレクトするルートを与える.</p></li>
<li><p><code>authPlugins</code>は使用する個々の認証バックエンドリストである. 今回の例では, BrowserIDを用いており, MozillaのBrowserIDシステムと, Google oAuthによってログインし, Googleアカウントを用いてユーザを認証する. BrowserIDバックエンドのちょっとした利点は次のようになる:</p>
<ul>
<li><p>セットアップクレデンシャルが必要となるFacebookやOAuthとは対照的に, セットアップが不要である.</p></li>
<li><p>識別子としてemailアドレスを用い, それはURLを用いるOpenIDとは対照的に, 人々にとって快適である.</p></li>
</ul></li>
<li><p><code>authHttpManager</code>はfoundationデータ型から, HTTP通信マネージャを取得する. これによりHTTP通信(言い換えれば, 大部分の第3者ログインシステム)を用いる認証バックエンドが通信を共有し, TCP接続をリクエスト毎に再開始するコストを避けることができる.</p></li>
</ul>
<p>これら5つのメソッドに加え, ログインページがどのように見えるか, のような認証システムの別の側面を制御するのを可能にする, 他のメソッドが存在する. 詳細については, <a href="https://www.stackage.org/package/yesod-auth">API文書</a>を参照しなさい.</p>
<p>今回の<code>HomeR</code>ハンドラでは, ユーザがログインしているかそうでないかにより, ログイン, ログアウトページへの簡単なリンクがある. どのようにしてこれらのサブサイトリンクを作ったかについて, 注意しなさい: まず, サブサイトのルート名(<code>AuthR</code>)を与え, サブサイト内のルートを与えた(<code>LoginR</code>と<code>LogoutR</code>).</p>
<p>下の写真は, ログインプロセスがユーザ視点からどのよに見えるかを示している.</p>
<h3 id="最初にロードされるページ">最初にロードされるページ</h3>
<figure>
<img src="https://www.yesodweb.com/book/image/initial-screen" alt="Initial page load" /><figcaption>Initial page load</figcaption>
</figure>
<h3 id="ブラウザidログイン画面">ブラウザIDログイン画面</h3>
<figure>
<img src="https://www.yesodweb.com/book/image/login-with-browserid" alt="BrowserID login screen" /><figcaption>BrowserID login screen</figcaption>
</figure>
<h3 id="ログインした後のホームページ">ログインした後のホームページ</h3>
<figure>
<img src="https://www.yesodweb.com/book/image/after-login" alt="Homepage after logging in" /><figcaption>Homepage after logging in</figcaption>
</figure>
<h2 id="email">Email</h2>
<p>多くの使用例において, 第3者によるemailの認証で十分である. 時々, ユーザがサイト上でパスワードを作れるようにしたいと思うだろう. scaffoldedサイトは以下の理由で, この設定を含まない:</p>
<ul>
<li><p>安全にパスワードを受理するためには, SSL上で実行する必要がある. 多くのユーザはSSL上でサイトを実行していない.</p></li>
<li><p>emailバックエンドは適切にパスワードにソルトとハッシュ行うが, 欠陥のあるデータベースは依然として問題がある. また, Yesodユーザが安全なデプロイメントプラクティスに則っていることを想定していないのである.</p></li>
<li><p>emailを送るためのワークシステムが必要である. 最近, 多くのウェブサーバはメールサーバによって用いられているような, あらゆるスパム防御処置を行う準備ができていないのである.</p></li>
</ul>
<div class="yesod-book-notice">
下の例では, システム組込のsendmailコマンドを用いる. もし自分のemailサーバを用いる面倒さを避けたいならば, Amazon SESを用いることができる. <a href="https://www.stackage.org/package/mime-mail-ses">mime-mail-ses</a>と呼ばれるパッケージが存在し, それは下のemailを送るコードで用いられているように, ちょっとした代わりの方法を与える. これはたいてい私が推奨する方法であり, FP Haskell CenterやHaskellers.comのような私の大部分のサイトでも用いられている.
<div>

<p>しかし, これらの要望を叶え, 独自のサイトに特化したパスワードログインを持ちたいと想定した時, Yesodは組込のバックエンドを提供する. それは, データベースにパスワードを安全に保管する必要があり, 多くの異なるemailをユーザに送信する必要があるため(アカウントの検証や, パスワード修復など), 設定にかなり多くのコードを要する.</p>
<p>email認証を与えるサイトを作り, パスワードをPersistent SQLiteデータベースに保存してみよう.</p>
<div class="yesod-book-notice">
emailサーバを持っていなくても, デバック目的のために, リンクがコンソールに表示される.
<div>


<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1"><span class="ot">{-# LANGUAGE DeriveDataTypeable         #-}</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="ot">{-# LANGUAGE FlexibleContexts           #-}</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="ot">{-# LANGUAGE GADTs                      #-}</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="ot">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="ot">{-# LANGUAGE MultiParamTypeClasses      #-}</span></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="ot">{-# LANGUAGE OverloadedStrings          #-}</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="ot">{-# LANGUAGE QuasiQuotes                #-}</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="ot">{-# LANGUAGE TemplateHaskell            #-}</span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="ot">{-# LANGUAGE TypeFamilies               #-}</span></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="kw">import</span>           <span class="dt">Control.Monad</span>            (join)</a>
<a class="sourceLine" id="cb3-11" title="11"><span class="kw">import</span>           <span class="dt">Control.Monad.Logger</span> (runNoLoggingT)</a>
<a class="sourceLine" id="cb3-12" title="12"><span class="kw">import</span>           <span class="dt">Data.Maybe</span>               (isJust)</a>
<a class="sourceLine" id="cb3-13" title="13"><span class="kw">import</span>           <span class="dt">Data.Text</span>                (<span class="dt">Text</span>, unpack)</a>
<a class="sourceLine" id="cb3-14" title="14"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text.Lazy.Encoding</span></a>
<a class="sourceLine" id="cb3-15" title="15"><span class="kw">import</span>           <span class="dt">Data.Typeable</span>            (<span class="dt">Typeable</span>)</a>
<a class="sourceLine" id="cb3-16" title="16"><span class="kw">import</span>           <span class="dt">Database.Persist.Sqlite</span></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="kw">import</span>           <span class="dt">Database.Persist.TH</span></a>
<a class="sourceLine" id="cb3-18" title="18"><span class="kw">import</span>           <span class="dt">Network.Mail.Mime</span></a>
<a class="sourceLine" id="cb3-19" title="19"><span class="kw">import</span>           <span class="dt">Text.Blaze.Html.Renderer.Utf8</span> (renderHtml)</a>
<a class="sourceLine" id="cb3-20" title="20"><span class="kw">import</span>           <span class="dt">Text.Hamlet</span>              (shamlet)</a>
<a class="sourceLine" id="cb3-21" title="21"><span class="kw">import</span>           <span class="dt">Text.Shakespeare.Text</span>    (stext)</a>
<a class="sourceLine" id="cb3-22" title="22"><span class="kw">import</span>           <span class="dt">Yesod</span></a>
<a class="sourceLine" id="cb3-23" title="23"><span class="kw">import</span>           <span class="dt">Yesod.Auth</span></a>
<a class="sourceLine" id="cb3-24" title="24"><span class="kw">import</span>           <span class="dt">Yesod.Auth.Email</span></a>
<a class="sourceLine" id="cb3-25" title="25"></a>
<a class="sourceLine" id="cb3-26" title="26">share [mkPersist sqlSettings { mpsGeneric <span class="fu">=</span> <span class="dt">False</span> }, mkMigrate <span class="st">&quot;migrateAll&quot;</span>] [persistLowerCase|</a>
<a class="sourceLine" id="cb3-27" title="27">User</a>
<a class="sourceLine" id="cb3-28" title="28">    email Text</a>
<a class="sourceLine" id="cb3-29" title="29">    password Text Maybe -- Password may not be set yet</a>
<a class="sourceLine" id="cb3-30" title="30">    verkey Text Maybe -- Used for resetting passwords</a>
<a class="sourceLine" id="cb3-31" title="31">    verified Bool</a>
<a class="sourceLine" id="cb3-32" title="32">    UniqueUser email</a>
<a class="sourceLine" id="cb3-33" title="33">    deriving Typeable</a>
<a class="sourceLine" id="cb3-34" title="34">|]</a>
<a class="sourceLine" id="cb3-35" title="35"></a>
<a class="sourceLine" id="cb3-36" title="36"><span class="kw">data</span> <span class="dt">App</span> <span class="fu">=</span> <span class="dt">App</span> <span class="dt">SqlBackend</span></a>
<a class="sourceLine" id="cb3-37" title="37"></a>
<a class="sourceLine" id="cb3-38" title="38">mkYesod <span class="st">&quot;App&quot;</span> [parseRoutes|</a>
<a class="sourceLine" id="cb3-39" title="39">/ HomeR GET</a>
<a class="sourceLine" id="cb3-40" title="40">/auth AuthR Auth getAuth</a>
<a class="sourceLine" id="cb3-41" title="41">|]</a>
<a class="sourceLine" id="cb3-42" title="42"></a>
<a class="sourceLine" id="cb3-43" title="43"><span class="kw">instance</span> <span class="dt">Yesod</span> <span class="dt">App</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-44" title="44">    <span class="co">-- Emails will include links, so be sure to include an approot so that</span></a>
<a class="sourceLine" id="cb3-45" title="45">    <span class="co">-- the links are valid!</span></a>
<a class="sourceLine" id="cb3-46" title="46">    approot <span class="fu">=</span> <span class="dt">ApprootStatic</span> <span class="st">&quot;http://localhost:3000&quot;</span></a>
<a class="sourceLine" id="cb3-47" title="47">    yesodMiddleware <span class="fu">=</span> defaultCsrfMiddleware <span class="fu">.</span> defaultYesodMiddleware</a>
<a class="sourceLine" id="cb3-48" title="48"></a>
<a class="sourceLine" id="cb3-49" title="49"><span class="kw">instance</span> <span class="dt">RenderMessage</span> <span class="dt">App</span> <span class="dt">FormMessage</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-50" title="50">    renderMessage _ _ <span class="fu">=</span> defaultFormMessage</a>
<a class="sourceLine" id="cb3-51" title="51"></a>
<a class="sourceLine" id="cb3-52" title="52"><span class="co">-- Set up Persistent</span></a>
<a class="sourceLine" id="cb3-53" title="53"><span class="kw">instance</span> <span class="dt">YesodPersist</span> <span class="dt">App</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-54" title="54">    <span class="kw">type</span> <span class="dt">YesodPersistBackend</span> <span class="dt">App</span> <span class="fu">=</span> <span class="dt">SqlBackend</span></a>
<a class="sourceLine" id="cb3-55" title="55">    runDB f <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-56" title="56">        <span class="dt">App</span> conn <span class="ot">&lt;-</span> getYesod</a>
<a class="sourceLine" id="cb3-57" title="57">        runSqlConn f conn</a>
<a class="sourceLine" id="cb3-58" title="58"></a>
<a class="sourceLine" id="cb3-59" title="59"><span class="kw">instance</span> <span class="dt">YesodAuth</span> <span class="dt">App</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-60" title="60">    <span class="kw">type</span> <span class="dt">AuthId</span> <span class="dt">App</span> <span class="fu">=</span> <span class="dt">UserId</span></a>
<a class="sourceLine" id="cb3-61" title="61"></a>
<a class="sourceLine" id="cb3-62" title="62">    loginDest _ <span class="fu">=</span> <span class="dt">HomeR</span></a>
<a class="sourceLine" id="cb3-63" title="63">    logoutDest _ <span class="fu">=</span> <span class="dt">HomeR</span></a>
<a class="sourceLine" id="cb3-64" title="64">    authPlugins _ <span class="fu">=</span> [authEmail]</a>
<a class="sourceLine" id="cb3-65" title="65"></a>
<a class="sourceLine" id="cb3-66" title="66">    <span class="co">-- Need to find the UserId for the given email address.</span></a>
<a class="sourceLine" id="cb3-67" title="67">    getAuthId creds <span class="fu">=</span> runDB <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-68" title="68">        x <span class="ot">&lt;-</span> insertBy <span class="fu">$</span> <span class="dt">User</span> (credsIdent creds) <span class="dt">Nothing</span> <span class="dt">Nothing</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb3-69" title="69">        <span class="fu">return</span> <span class="fu">$</span> <span class="dt">Just</span> <span class="fu">$</span></a>
<a class="sourceLine" id="cb3-70" title="70">            <span class="kw">case</span> x <span class="kw">of</span></a>
<a class="sourceLine" id="cb3-71" title="71">                <span class="dt">Left</span> (<span class="dt">Entity</span> userid _) <span class="ot">-&gt;</span> userid <span class="co">-- newly added user</span></a>
<a class="sourceLine" id="cb3-72" title="72">                <span class="dt">Right</span> userid <span class="ot">-&gt;</span> userid <span class="co">-- existing user</span></a>
<a class="sourceLine" id="cb3-73" title="73"></a>
<a class="sourceLine" id="cb3-74" title="74"><span class="kw">instance</span> <span class="dt">YesodAuthPersist</span> <span class="dt">App</span></a>
<a class="sourceLine" id="cb3-75" title="75"></a>
<a class="sourceLine" id="cb3-76" title="76"><span class="co">-- Here's all of the email-specific code</span></a>
<a class="sourceLine" id="cb3-77" title="77"><span class="kw">instance</span> <span class="dt">YesodAuthEmail</span> <span class="dt">App</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-78" title="78">    <span class="kw">type</span> <span class="dt">AuthEmailId</span> <span class="dt">App</span> <span class="fu">=</span> <span class="dt">UserId</span></a>
<a class="sourceLine" id="cb3-79" title="79"></a>
<a class="sourceLine" id="cb3-80" title="80">    afterPasswordRoute _ <span class="fu">=</span> <span class="dt">HomeR</span></a>
<a class="sourceLine" id="cb3-81" title="81"></a>
<a class="sourceLine" id="cb3-82" title="82">    addUnverified email verkey <span class="fu">=</span></a>
<a class="sourceLine" id="cb3-83" title="83">        runDB <span class="fu">$</span> insert <span class="fu">$</span> <span class="dt">User</span> email <span class="dt">Nothing</span> (<span class="dt">Just</span> verkey) <span class="dt">False</span></a>
<a class="sourceLine" id="cb3-84" title="84"></a>
<a class="sourceLine" id="cb3-85" title="85">    sendVerifyEmail email _ verurl <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-86" title="86">        <span class="co">-- Print out to the console the verification email, for easier</span></a>
<a class="sourceLine" id="cb3-87" title="87">        <span class="co">-- debugging.</span></a>
<a class="sourceLine" id="cb3-88" title="88">        liftIO <span class="fu">$</span> <span class="fu">putStrLn</span> <span class="fu">$</span> <span class="st">&quot;Copy/ Paste this URL in your browser:&quot;</span> <span class="fu">++</span> unpack verurl</a>
<a class="sourceLine" id="cb3-89" title="89"></a>
<a class="sourceLine" id="cb3-90" title="90">        <span class="co">-- Send email.</span></a>
<a class="sourceLine" id="cb3-91" title="91">        liftIO <span class="fu">$</span> renderSendMail (emptyMail <span class="fu">$</span> <span class="dt">Address</span> <span class="dt">Nothing</span> <span class="st">&quot;noreply&quot;</span>)</a>
<a class="sourceLine" id="cb3-92" title="92">            { mailTo <span class="fu">=</span> [<span class="dt">Address</span> <span class="dt">Nothing</span> email]</a>
<a class="sourceLine" id="cb3-93" title="93">            , mailHeaders <span class="fu">=</span></a>
<a class="sourceLine" id="cb3-94" title="94">                [ (<span class="st">&quot;Subject&quot;</span>, <span class="st">&quot;Verify your email address&quot;</span>)</a>
<a class="sourceLine" id="cb3-95" title="95">                ]</a>
<a class="sourceLine" id="cb3-96" title="96">            , mailParts <span class="fu">=</span> [[textPart, htmlPart]]</a>
<a class="sourceLine" id="cb3-97" title="97">            }</a>
<a class="sourceLine" id="cb3-98" title="98">      <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-99" title="99">        textPart <span class="fu">=</span> <span class="dt">Part</span></a>
<a class="sourceLine" id="cb3-100" title="100">            { partType <span class="fu">=</span> <span class="st">&quot;text/plain; charset=utf-8&quot;</span></a>
<a class="sourceLine" id="cb3-101" title="101">            , partEncoding <span class="fu">=</span> <span class="dt">None</span></a>
<a class="sourceLine" id="cb3-102" title="102">            , partFilename <span class="fu">=</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb3-103" title="103">            , partContent <span class="fu">=</span> Data.Text.Lazy.Encoding.encodeUtf8</a>
<a class="sourceLine" id="cb3-104" title="104">                [stext|</a>
<a class="sourceLine" id="cb3-105" title="105">                    Please confirm your email address by clicking on the link below.</a>
<a class="sourceLine" id="cb3-106" title="106"></a>
<a class="sourceLine" id="cb3-107" title="107">                    #{verurl}</a>
<a class="sourceLine" id="cb3-108" title="108"></a>
<a class="sourceLine" id="cb3-109" title="109">                    Thank you</a>
<a class="sourceLine" id="cb3-110" title="110">                |]</a>
<a class="sourceLine" id="cb3-111" title="111">            , partHeaders <span class="fu">=</span> []</a>
<a class="sourceLine" id="cb3-112" title="112">            }</a>
<a class="sourceLine" id="cb3-113" title="113">        htmlPart <span class="fu">=</span> <span class="dt">Part</span></a>
<a class="sourceLine" id="cb3-114" title="114">            { partType <span class="fu">=</span> <span class="st">&quot;text/html; charset=utf-8&quot;</span></a>
<a class="sourceLine" id="cb3-115" title="115">            , partEncoding <span class="fu">=</span> <span class="dt">None</span></a>
<a class="sourceLine" id="cb3-116" title="116">            , partFilename <span class="fu">=</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb3-117" title="117">            , partContent <span class="fu">=</span> renderHtml</a>
<a class="sourceLine" id="cb3-118" title="118">                [shamlet|</a>
<a class="sourceLine" id="cb3-119" title="119">                    <span class="kw">&lt;p&gt;</span>Please confirm your email address by clicking on the link below.</a>
<a class="sourceLine" id="cb3-120" title="120">                    <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb3-121" title="121">                        <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">#{</span>verurl<span class="kw">}&gt;#{</span>verurl<span class="kw">}</span></a>
<a class="sourceLine" id="cb3-122" title="122">                    <span class="kw">&lt;p&gt;</span>Thank you</a>
<a class="sourceLine" id="cb3-123" title="123">                |]</a>
<a class="sourceLine" id="cb3-124" title="124">            , partHeaders <span class="fu">=</span> []</a>
<a class="sourceLine" id="cb3-125" title="125">            }</a>
<a class="sourceLine" id="cb3-126" title="126">    getVerifyKey <span class="fu">=</span> runDB <span class="fu">.</span> <span class="fu">fmap</span> (join <span class="fu">.</span> <span class="fu">fmap</span> userVerkey) <span class="fu">.</span> get</a>
<a class="sourceLine" id="cb3-127" title="127">    setVerifyKey uid key <span class="fu">=</span> runDB <span class="fu">$</span> update uid [<span class="dt">UserVerkey</span> <span class="fu">=.</span> <span class="dt">Just</span> key]</a>
<a class="sourceLine" id="cb3-128" title="128">    verifyAccount uid <span class="fu">=</span> runDB <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-129" title="129">        mu <span class="ot">&lt;-</span> get uid</a>
<a class="sourceLine" id="cb3-130" title="130">        <span class="kw">case</span> mu <span class="kw">of</span></a>
<a class="sourceLine" id="cb3-131" title="131">            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb3-132" title="132">            <span class="dt">Just</span> u <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-133" title="133">                update uid [<span class="dt">UserVerified</span> <span class="fu">=.</span> <span class="dt">True</span>]</a>
<a class="sourceLine" id="cb3-134" title="134">                <span class="fu">return</span> <span class="fu">$</span> <span class="dt">Just</span> uid</a>
<a class="sourceLine" id="cb3-135" title="135">    getPassword <span class="fu">=</span> runDB <span class="fu">.</span> <span class="fu">fmap</span> (join <span class="fu">.</span> <span class="fu">fmap</span> userPassword) <span class="fu">.</span> get</a>
<a class="sourceLine" id="cb3-136" title="136">    setPassword uid pass <span class="fu">=</span> runDB <span class="fu">$</span> update uid [<span class="dt">UserPassword</span> <span class="fu">=.</span> <span class="dt">Just</span> pass]</a>
<a class="sourceLine" id="cb3-137" title="137">    getEmailCreds email <span class="fu">=</span> runDB <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-138" title="138">        mu <span class="ot">&lt;-</span> getBy <span class="fu">$</span> <span class="dt">UniqueUser</span> email</a>
<a class="sourceLine" id="cb3-139" title="139">        <span class="kw">case</span> mu <span class="kw">of</span></a>
<a class="sourceLine" id="cb3-140" title="140">            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb3-141" title="141">            <span class="dt">Just</span> (<span class="dt">Entity</span> uid u) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="fu">$</span> <span class="dt">Just</span> <span class="dt">EmailCreds</span></a>
<a class="sourceLine" id="cb3-142" title="142">                { emailCredsId <span class="fu">=</span> uid</a>
<a class="sourceLine" id="cb3-143" title="143">                , emailCredsAuthId <span class="fu">=</span> <span class="dt">Just</span> uid</a>
<a class="sourceLine" id="cb3-144" title="144">                , emailCredsStatus <span class="fu">=</span> isJust <span class="fu">$</span> userPassword u</a>
<a class="sourceLine" id="cb3-145" title="145">                , emailCredsVerkey <span class="fu">=</span> userVerkey u</a>
<a class="sourceLine" id="cb3-146" title="146">                , emailCredsEmail <span class="fu">=</span> email</a>
<a class="sourceLine" id="cb3-147" title="147">                }</a>
<a class="sourceLine" id="cb3-148" title="148">    getEmail <span class="fu">=</span> runDB <span class="fu">.</span> <span class="fu">fmap</span> (<span class="fu">fmap</span> userEmail) <span class="fu">.</span> get</a>
<a class="sourceLine" id="cb3-149" title="149"></a>
<a class="sourceLine" id="cb3-150" title="150"><span class="ot">getHomeR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></a>
<a class="sourceLine" id="cb3-151" title="151">getHomeR <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-152" title="152">    maid <span class="ot">&lt;-</span> maybeAuthId</a>
<a class="sourceLine" id="cb3-153" title="153">    defaultLayout</a>
<a class="sourceLine" id="cb3-154" title="154">        [whamlet|</a>
<a class="sourceLine" id="cb3-155" title="155">            <span class="kw">&lt;p&gt;</span>Your current auth ID: <span class="kw">#{</span><span class="fu">show</span> maid<span class="kw">}</span></a>
<a class="sourceLine" id="cb3-156" title="156">            <span class="kw">$maybe</span> _ <span class="ot">&lt;-</span> maid</a>
<a class="sourceLine" id="cb3-157" title="157">                <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb3-158" title="158">                    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">AuthR</span> <span class="dt">LogoutR</span><span class="kw">}&gt;</span>Logout</a>
<a class="sourceLine" id="cb3-159" title="159">            <span class="kw">$nothing</span></a>
<a class="sourceLine" id="cb3-160" title="160">                <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb3-161" title="161">                    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">AuthR</span> <span class="dt">LoginR</span><span class="kw">}&gt;</span>Go to the login page</a>
<a class="sourceLine" id="cb3-162" title="162">        |]</a>
<a class="sourceLine" id="cb3-163" title="163"></a>
<a class="sourceLine" id="cb3-164" title="164"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb3-165" title="165">main <span class="fu">=</span> runNoLoggingT <span class="fu">$</span> withSqliteConn <span class="st">&quot;email.db3&quot;</span> <span class="fu">$</span> \conn <span class="ot">-&gt;</span> liftIO <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-166" title="166">    runSqlConn (runMigration migrateAll) conn</a>
<a class="sourceLine" id="cb3-167" title="167">    warp <span class="dv">3000</span> <span class="fu">$</span> <span class="dt">App</span> conn</a></code></pre></div>
<h2 id="認可">認可</h2>
<p>一旦ユーザを認証すれば, その認証情報を用いて, リクエストを認可できる. Yesodにおける認可は単純であり, 宣言的である: 多くの場合, <code>authRoute</code>と<code>isAuthorized</code>メソッドをYesod型クラスのインスタンスに追加すればよいだけである. 例を見てみよう.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1"><span class="ot">{-# LANGUAGE MultiParamTypeClasses #-}</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="ot">{-# LANGUAGE OverloadedStrings     #-}</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="ot">{-# LANGUAGE QuasiQuotes           #-}</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="ot">{-# LANGUAGE TemplateHaskell       #-}</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="ot">{-# LANGUAGE TypeFamilies          #-}</span></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="kw">import</span>           <span class="dt">Data.Default</span>         (def)</a>
<a class="sourceLine" id="cb4-7" title="7"><span class="kw">import</span>           <span class="dt">Data.Text</span>            (<span class="dt">Text</span>)</a>
<a class="sourceLine" id="cb4-8" title="8"><span class="kw">import</span>           <span class="dt">Network.HTTP.Conduit</span> (<span class="dt">Manager</span>, newManager, tlsManagerSettings)</a>
<a class="sourceLine" id="cb4-9" title="9"><span class="kw">import</span>           <span class="dt">Yesod</span></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="kw">import</span>           <span class="dt">Yesod.Auth</span></a>
<a class="sourceLine" id="cb4-11" title="11"><span class="kw">import</span>           <span class="dt">Yesod.Auth.Dummy</span> <span class="co">-- just for testing, don't use in real life!!!</span></a>
<a class="sourceLine" id="cb4-12" title="12"></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="kw">data</span> <span class="dt">App</span> <span class="fu">=</span> <span class="dt">App</span></a>
<a class="sourceLine" id="cb4-14" title="14">    {<span class="ot"> httpManager ::</span> <span class="dt">Manager</span></a>
<a class="sourceLine" id="cb4-15" title="15">    }</a>
<a class="sourceLine" id="cb4-16" title="16"></a>
<a class="sourceLine" id="cb4-17" title="17">mkYesod <span class="st">&quot;App&quot;</span> [parseRoutes|</a>
<a class="sourceLine" id="cb4-18" title="18">/      HomeR  GET POST</a>
<a class="sourceLine" id="cb4-19" title="19">/admin AdminR GET</a>
<a class="sourceLine" id="cb4-20" title="20">/auth  AuthR  Auth getAuth</a>
<a class="sourceLine" id="cb4-21" title="21">|]</a>
<a class="sourceLine" id="cb4-22" title="22"></a>
<a class="sourceLine" id="cb4-23" title="23"><span class="kw">instance</span> <span class="dt">Yesod</span> <span class="dt">App</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-24" title="24">    authRoute _ <span class="fu">=</span> <span class="dt">Just</span> <span class="fu">$</span> <span class="dt">AuthR</span> <span class="dt">LoginR</span></a>
<a class="sourceLine" id="cb4-25" title="25"></a>
<a class="sourceLine" id="cb4-26" title="26">    <span class="co">-- route name, then a boolean indicating if it's a write request</span></a>
<a class="sourceLine" id="cb4-27" title="27">    isAuthorized <span class="dt">HomeR</span> <span class="dt">True</span> <span class="fu">=</span> isAdmin</a>
<a class="sourceLine" id="cb4-28" title="28">    isAuthorized <span class="dt">AdminR</span> _ <span class="fu">=</span> isAdmin</a>
<a class="sourceLine" id="cb4-29" title="29"></a>
<a class="sourceLine" id="cb4-30" title="30">    <span class="co">-- anyone can access other pages</span></a>
<a class="sourceLine" id="cb4-31" title="31">    isAuthorized _ _ <span class="fu">=</span> <span class="fu">return</span> <span class="dt">Authorized</span></a>
<a class="sourceLine" id="cb4-32" title="32"></a>
<a class="sourceLine" id="cb4-33" title="33">isAdmin <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-34" title="34">    mu <span class="ot">&lt;-</span> maybeAuthId</a>
<a class="sourceLine" id="cb4-35" title="35">    <span class="fu">return</span> <span class="fu">$</span> <span class="kw">case</span> mu <span class="kw">of</span></a>
<a class="sourceLine" id="cb4-36" title="36">        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">AuthenticationRequired</span></a>
<a class="sourceLine" id="cb4-37" title="37">        <span class="dt">Just</span> <span class="st">&quot;admin&quot;</span> <span class="ot">-&gt;</span> <span class="dt">Authorized</span></a>
<a class="sourceLine" id="cb4-38" title="38">        <span class="dt">Just</span> _ <span class="ot">-&gt;</span> <span class="dt">Unauthorized</span> <span class="st">&quot;You must be an admin&quot;</span></a>
<a class="sourceLine" id="cb4-39" title="39"></a>
<a class="sourceLine" id="cb4-40" title="40"><span class="kw">instance</span> <span class="dt">YesodAuth</span> <span class="dt">App</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-41" title="41">    <span class="kw">type</span> <span class="dt">AuthId</span> <span class="dt">App</span> <span class="fu">=</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb4-42" title="42">    getAuthId <span class="fu">=</span> <span class="fu">return</span> <span class="fu">.</span> <span class="dt">Just</span> <span class="fu">.</span> credsIdent</a>
<a class="sourceLine" id="cb4-43" title="43"></a>
<a class="sourceLine" id="cb4-44" title="44">    loginDest _ <span class="fu">=</span> <span class="dt">HomeR</span></a>
<a class="sourceLine" id="cb4-45" title="45">    logoutDest _ <span class="fu">=</span> <span class="dt">HomeR</span></a>
<a class="sourceLine" id="cb4-46" title="46"></a>
<a class="sourceLine" id="cb4-47" title="47">    authPlugins _ <span class="fu">=</span> [authDummy]</a>
<a class="sourceLine" id="cb4-48" title="48"></a>
<a class="sourceLine" id="cb4-49" title="49">    maybeAuthId <span class="fu">=</span> lookupSession <span class="st">&quot;_ID&quot;</span></a>
<a class="sourceLine" id="cb4-50" title="50"></a>
<a class="sourceLine" id="cb4-51" title="51"><span class="kw">instance</span> <span class="dt">RenderMessage</span> <span class="dt">App</span> <span class="dt">FormMessage</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-52" title="52">    renderMessage _ _ <span class="fu">=</span> defaultFormMessage</a>
<a class="sourceLine" id="cb4-53" title="53"></a>
<a class="sourceLine" id="cb4-54" title="54"><span class="ot">getHomeR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></a>
<a class="sourceLine" id="cb4-55" title="55">getHomeR <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-56" title="56">    maid <span class="ot">&lt;-</span> maybeAuthId</a>
<a class="sourceLine" id="cb4-57" title="57">    defaultLayout</a>
<a class="sourceLine" id="cb4-58" title="58">        [whamlet|</a>
<a class="sourceLine" id="cb4-59" title="59">            <span class="kw">&lt;p&gt;</span>Note: Log in as &quot;admin&quot; to be an administrator.</a>
<a class="sourceLine" id="cb4-60" title="60">            <span class="kw">&lt;p&gt;</span>Your current auth ID: <span class="kw">#{</span><span class="fu">show</span> maid<span class="kw">}</span></a>
<a class="sourceLine" id="cb4-61" title="61">            <span class="kw">$maybe</span> _ <span class="ot">&lt;-</span> maid</a>
<a class="sourceLine" id="cb4-62" title="62">                <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb4-63" title="63">                    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">AuthR</span> <span class="dt">LogoutR</span><span class="kw">}&gt;</span>Logout</a>
<a class="sourceLine" id="cb4-64" title="64">            <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb4-65" title="65">                <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">AdminR</span><span class="kw">}&gt;</span>Go to admin page</a>
<a class="sourceLine" id="cb4-66" title="66">            <span class="kw">&lt;form</span><span class="ot"> method=</span><span class="st">post</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb4-67" title="67">                Make a change (admins only)</a>
<a class="sourceLine" id="cb4-68" title="68">                \ #</a>
<a class="sourceLine" id="cb4-69" title="69">                <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">submit</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb4-70" title="70">        |]</a>
<a class="sourceLine" id="cb4-71" title="71"></a>
<a class="sourceLine" id="cb4-72" title="72"><span class="ot">postHomeR ::</span> <span class="dt">Handler</span> ()</a>
<a class="sourceLine" id="cb4-73" title="73">postHomeR <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-74" title="74">    setMessage <span class="st">&quot;You made some change to the page&quot;</span></a>
<a class="sourceLine" id="cb4-75" title="75">    redirect <span class="dt">HomeR</span></a>
<a class="sourceLine" id="cb4-76" title="76"></a>
<a class="sourceLine" id="cb4-77" title="77"><span class="ot">getAdminR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></a>
<a class="sourceLine" id="cb4-78" title="78">getAdminR <span class="fu">=</span> defaultLayout</a>
<a class="sourceLine" id="cb4-79" title="79">    [whamlet|</a>
<a class="sourceLine" id="cb4-80" title="80">        <span class="kw">&lt;p&gt;</span>I guess you're an admin!</a>
<a class="sourceLine" id="cb4-81" title="81">        <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb4-82" title="82">            <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">HomeR</span><span class="kw">}&gt;</span>Return to homepage</a>
<a class="sourceLine" id="cb4-83" title="83">    |]</a>
<a class="sourceLine" id="cb4-84" title="84"></a>
<a class="sourceLine" id="cb4-85" title="85"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb4-86" title="86">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-87" title="87">    manager <span class="ot">&lt;-</span> newManager tlsManagerSettings</a>
<a class="sourceLine" id="cb4-88" title="88">    warp <span class="dv">3000</span> <span class="fu">$</span> <span class="dt">App</span> manager</a></code></pre></div>
<p><code>authRoute</code>はログインページであるべきである, ほとんど常に, <code>AuthR</code>, <code>LoginR</code>である. <code>isAuthorized</code>は2つのパラメータを取る関数である: リクエストされたルートと, リクエストが“write”なリクエストであるかどうか, である. 実際に, <code>isWriteRequest</code>を用いることで, writeリクエストが何であるかを変更できるが, 創造的な方法では, RESTful原則に従う: <code>GET</code>, <code>HEAD</code>, <code>OPTIONS</code>, あるいは<code>TRACE</code>リクエストを除いて, 全てwriteリクエストである.</p>
<p><code>isAuthorized</code>の中身に関し便利な点は, 望む<code>Handler</code>コードを何でも実行できることである. これは以下を意味する:</p>
<ul>
<li><p>ファイルシステムにアクセスする(通常のIO)</p></li>
<li><p>データベースから値を探す</p></li>
<li><p>欲しいセッションやリクエスト値を取ってくる</p></li>
</ul>
<p>これらの技術を用い, 望むような洗練された認可システムを開発したり, 組織によって用いられてる既存システムに連動させることができる.</p>
<h2 id="結論">結論</h2>
<p>この章においては, ユーザの認証を行う設定の基礎と, どのように組込の認可関数が, ユーザにとって簡易で, 宣言的な方法を与えるか, について説明した. これらは複雑な概念であるが, Yesodは独自のカスタム化された認可方法を作るための, 根幹を与えるはずである.</p>
      </article>

      <div class="pager">
      
      
      </div>

      <div class="row">
        <div class="col s6 offset-s6" style="position: relative; height: 100px;">
          <div class="fixed-action-btn horizontal" style="position: absolute; display: inline-block; right: 24px;">
  <a class="btn-floating btn-large red">
    <i class="large material-icons">share</i>
  </a>
  <ul>
    <li>
      <a class="btn-floating waves-effect waves-light blue tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Twitter" href="https://twitter.com/intent/tweet?text=ch14-Authentification-and-Authorization&url=https://haskell.e-bigmoon.com/yesod/book/ch14-Authentification-and-Authorization.html"><i class="mdi mdi-twitter white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light indigo tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Facebook" href="https://facebook.com/sharer.php?u=https://haskell.e-bigmoon.com/yesod/book/ch14-Authentification-and-Authorization.html"><i class="mdi mdi-facebook white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light red tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Google+" href="https://plus.google.com/share?url=https://haskell.e-bigmoon.com/yesod/book/ch14-Authentification-and-Authorization.html"><i class="mdi mdi-google-plus white-text"></i></a>
    </li>
  </ul>
</div>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
    </div>

    <footer class="page-footer indigo lighten-1">

  <div class="footer-copyright">

    <div class="container">
      CopyRight © 2018 BIGMOON All Rights Reserved.&nbsp;
      Site proudly generated by <a class="red-text text-accent-1" href="http://jaspervdj.be/hakyll">Hakyll</a>,&nbsp;
      original Jekyll theme by <a class="red-text text-accent-1" href="https://github.com/mumuxme/materialize-jekyll">mumuxme</a>.
    </div>

  </div>

</footer>


    <!-- scrolltop button -->
    <button class="material-scrolltop waves-effect waves-light hide-on-small-only" type="button">
      <i class="mdi mdi-arrow-up-bold small white-text"></i>
    </button>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-19322672-9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-19322672-9');
    </script>

    <!-- jquery -->
    <script type="text/javascript" src="../../lib/jquery-min.js"></script>
    <!-- materialize -->
    <script src="../../lib/materialize/js/materialize.min.js"></script>
    <!-- <\!-- Material ScrollTop plugin -\-> -->
    <script src="../../lib/material-scrolltop/material-scrolltop.js"></script>
    <!-- main -->
    <script src="../../js/init.js"></script>
    <script src="../../js/main.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>

</html>
