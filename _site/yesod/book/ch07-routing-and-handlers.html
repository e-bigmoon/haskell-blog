<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">

  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
  <!-- MUST in hex format, may the same as header-color. This color is for android chrome browser. -->
  <meta name="theme-color" content="#5c6bc0">

  <!-- Metadata. -->
  <meta name="keywords" content="haskell,blog,bigmoon" />
  <title>ルーティングとハンドラ</title>
  <meta name="description" content="BIG MOON">
  <link rel="canonical" href="../../yesod/book/ch07-routing-and-handlers.html">
  <link rel="alternate" type="application/atom+xml" title="ルーティングとハンドラ" href="../../feed.xml" />
  <link rel="shortcut icon" href="../../images/favicon.ico" />
  <meta name="google-site-verification" content="X2YNboLvzw3_bclXLMvohyJDqj68D06_hPDMukRbgTs" />

  <!-- Stylesheets. -->
  <link rel="stylesheet" href="../../lib/materialize/css/materialize.min.css" />
  <link rel="stylesheet" href="../../css/main.css" />
  <link media="all" rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/3.3.92/css/materialdesignicons.min.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="../../lib/material-scrolltop/material-scrolltop.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/agate.min.css" />
  

  <!-- OGP -->
  <meta property="og:title" content="ルーティングとハンドラ" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="/yesod/book/ch07-routing-and-handlers.html" />
  <!-- <meta property="og:image" content=" サムネイル画像の URL" /> -->
  <meta property="og:site_name" content="ルーティングとハンドラ" />
  <meta property="og:description" content="BIG MOON" />

  <meta name="twitter:card" content="summary" />
  <!-- <meta name="twitter:site" content="@[ Twitter ID]" /> -->
  <!-- <meta name="twitter:player" content="@[ Twitter ID]" /> -->

  <noscript>
  <div class="notice-warning noscript">You don't have javascript enabled. Good luck! :(</div>
</noscript>

<!--[if IE]>
  <div class="notice-warning">Oh, you are using Internet Explorer! Good luck... :(</div>
<![endif]-->

</head>


  <body>
    <header class="site-header">
      <nav class="nav-extended indigo lighten-1">
        <div class="nav-wrapper">
  <a href="../../"><span class="site-title">BIGMOON Haskeller's BLOG</span></a>
  <a href="#" data-activates="mobile-navbar" class="button-collapse">
    <i class="mdi mdi-menu white-text"></i>
  </a>

  <ul id="nav-mobile" class="right hide-on-med-and-down">
    <li>
      <a href="../../" class="white-text">
        <i class="mdi mdi-home left indigo-text text-lighten-3"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="white-text">
        <i class="mdi mdi-account-circle left indigo-text text-lighten-3"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../stack/" class="white-text">
        <i class="mdi mdi-wrench left indigo-text text-lighten-3"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/index.html" class="white-text">
        <i class="mdi mdi-comment-question-outline left indigo-text text-lighten-3"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="white-text">
        <i class="mdi mdi-package-variant left indigo-text text-lighten-3"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="white-text">
        <i class="mdi mdi-earth left indigo-text text-lighten-3"></i>
        Yesod
      </a>
    </li>
    <li>
      <a href="../../contact.html" class="white-text">
        <i class="mdi mdi-lead-pencil left indigo-text text-lighten-3"></i>
        Contact
      </a>
    </li>
    <li>
      <a href="../../feed.xml" class="white-text">
        <i class="mdi mdi-rss left indigo-text text-lighten-3"></i>
        Feed
      </a>
    </li>
  </ul>

  <ul class="side-nav" id="mobile-navbar">
    <li>
      <a href="../../" class="waves-effect waves-teal black-text">
        <i class="mdi mdi-home left green-text"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="navbar-text-colour-mobile">
        <i class="mdi mdi-account-circle left blue-text"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../stack/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-wrench left blue-text"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-comment-question-outline left blue-text"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-package-variant left blue-text"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-earth left blue-text"></i>
        Yesod
      </a>
    </li>
    <li>
      <a href="../../contact.html" class="navbar-text-colour-mobile">
        <i class="mdi mdi-lead-pencil left blue-text"></i>
        Contact
      </a>
    </li>
  </ul>
</div>

      </nav>
    </header>

    <div class="site-container" id="tab-main">
      <div class="wrapper">
        <div class="post-ribbon"></div>

<div class="container page-container">
  <div class="post-page card-panel z-depth-2">
    <div class="post-section">
      <div class="post-heading">
        <div style="float: right;">
          
          <span>記事公開日: 2018/03/18</span><br>
          
          
          <span>最終更新日: 2019/03/03</span>
          
        </div>
        <h1 class="post-title">ルーティングとハンドラ</h1>
      </div>

      <article class="page-content">
        <p>Yesod をモデル・ビュー・コントローラフレームワークとして見れば、ルーティングとハンドラはコントローラに対応します。また、他の Web 開発環境で採用されている2つの異なるルーティング方法があります。</p>
<ul>
<li>ファイル名でディスパッチする方法。例えば PHP や ASP などで利用されています。</li>
<li>正規表現を使ってルートをパースする中央集権的なルーティング関数を用意する方法。Django や Rails はこの方法を採用しています。</li>
</ul>
<p>Yesod の仕組み的には Django や Rails と近いのですが、実際にはかなり違います。Yesod は正規表現の代わりに、ルートの断片のマッチを使います。また、単方向のルートとハンドラのマッピングを使うのではなく、Yesod は (ルートデータ型や型安全URLと呼ばれる) 中間データ型と双方向の変換関数を生成します。</p>
<p>このような、発展的なシステムのコーディングは人間が行うと非常に退屈な作業であり、エラーを含みやすいものです。そのため Yesod はルートに特化したドメイン特化言語 (DSL) を定義し、この DSL を Haskell コードに変換するためのテンプレート Haskell 関数を提供します。この章ではルーティング宣言に関する構文を説明し、コード生成がどのように行われるかを確認します。そして、ルーティングとハンドラ間の相互作用について説明します。</p>
<h2 id="ルート構文">ルート構文</h2>
<p>Yesod のアプローチはルート宣言を既存の構文に無理やり組み込むのではなく、ルートのために設計されたシンプルな構文を利用することです。この手法の良い点は、コードが書きやすくなるだけではなく、Yesod の経験が全く無い場合でも、アプリケーションのサイトマップのように、十分に理解しやすいという点です。</p>
<p>基本的な構文は以下のようになります。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="op">/</span>             <span class="dt">HomeR</span>     <span class="dt">GET</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="op">/</span>blog         <span class="dt">BlogR</span>     <span class="dt">GET</span> <span class="dt">POST</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="op">/</span>blog<span class="op">/#</span><span class="dt">BlogId</span> <span class="dt">BlogPostR</span> <span class="dt">GET</span> <span class="dt">POST</span></span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="op">/</span>static       <span class="dt">StaticR</span>   <span class="dt">Static</span> getStatic</span></code></pre></div>
<p>このルート宣言で行われる処理の完全な詳細は以降の節で説明します。</p>
<h3 id="断片">断片</h3>
<p>Yesod がリクエストを受け取った時に最初に行うことの1つは、リクエストされたパスを断片に分割することです。この断片は全てのフォワードスラッシュによってトークン化されます。例えば以下のようにです。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a>toPieces <span class="st">&quot;/&quot;</span> <span class="ot">=</span> []</span>
<span id="cb2-2"><a href="#cb2-2"></a>toPieces <span class="st">&quot;/foo/bar/baz/&quot;</span> <span class="ot">=</span> [<span class="st">&quot;foo&quot;</span>, <span class="st">&quot;bar&quot;</span>, <span class="st">&quot;baz&quot;</span>, <span class="st">&quot;&quot;</span>]</span></code></pre></div>
<p>URLの最後に付けるトレイリングスラッシュや2重スラッシュ (“/foo//bar//”) のような問題のある状況が起こり得ることに気づくでしょう。Yesod は正規化された URL を持つことを推奨します。もしユーザがトレイリングスラッシュあるいは2重スラッシュ付きでURLをリクエストすれば、それらは自動的に正規化された URL にリダイレクトされます。その結果、1つのリソースにつき1つの URL ということが保証されるため、検索順位に良い影響を与えます。</p>
<p>これが意味することは、URL の正確な構造に悩む必要がないということです。パス断片を安全なものとして考えることができ、Yesod は自動的にスラッシュの挿入を制御し、問題のある文字をエスケープしてくれます。</p>
<p>ところで、どのようにパスが断片に分割され再結合されるかについての詳細な制御方法を知りたい場合は Yesod 型クラスの章の <code>cleanPath</code> や <code>joinPath</code> メソッドを再確認してみると良いでしょう。</p>
<h3 id="断片の種類">断片の種類</h3>
<p>ルートを宣言する時は断片の表現方法を次の3つの種類から好きなものを選びます。</p>
<h4 id="スタティック">スタティック</h4>
<p>これはただの文字列表現です。URL と正確に一致する必要があります。</p>
<h4 id="ダイナミックシングル">ダイナミックシングル</h4>
<p>これは (2つのスラッシュ間の) 単一の断片ですが、ユーザが送信した値を表します。ページリクエストで追加のユーザ入力を受け取るためによく使います。ダイナミックシングルはハッシュ (#) で始まり、そのあとにデータ型が続きます。また、このデータ型は <code>PathPiece</code> 型クラスのインスタンスでなければなりません。</p>
<h4 id="ダイナミックマルチ">ダイナミックマルチ</h4>
<p>ダイナミックシングルとほとんど同じですが、URL 断片を複数受け取ることができます。また、この断片は必ずリソースパターンの最後に出現しなければなりません。ダイナミックマルチはアスタリスク (*) から始まり、その後にデータ型が続きます。また、このデータ型は <code>PathMultiPiece</code> のインスタンスでなければなりません。この方法は他の2つと比べて少し変わっていますが、ファイル構造や任意の階層を持つ wiki などの静的ツリー表現のような機能を実装するためにとても重要です。</p>
<div class="yesod-book-notice">
<p>Yesod 1.4 からダイナミックマルチを指定する方法に <code>+</code> が追加されました。この方法は C プロセッサが <code>/*</code> 文字の組み合わせによっておかしくなってしまう場合などで有効です。</p>
</div>
<p>まずは、標準的なリソースパターンを見てみましょう。一番簡単なものは、アプリケーションルートを <code>/</code> にするものです。同じように FAQ を <code>/page/faq</code> としたりする場合もあるでしょう。</p>
<p>例えばフィボナッチウェブサイトを作りたいと思ったら URL を <code>/fib/#Int</code> のようにするでしょう。しかし、これにはちょっとした問題があります。マイナスの値やゼロをアプリケーションに通したくはありません。幸運なことに型システムはこれをしっかりと防いでくれます。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">newtype</span> <span class="dt">Natural</span> <span class="ot">=</span> <span class="dt">Natural</span> <span class="dt">Int</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>    <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Show</span>, <span class="dt">Read</span>)</span>
<span id="cb3-3"><a href="#cb3-3"></a></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="kw">instance</span> <span class="dt">PathPiece</span> <span class="dt">Natural</span> <span class="kw">where</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>    toPathPiece (<span class="dt">Natural</span> i) <span class="ot">=</span> T.pack <span class="op">$</span> <span class="fu">show</span> i</span>
<span id="cb3-6"><a href="#cb3-6"></a>    fromPathPiece s <span class="ot">=</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>        <span class="kw">case</span> <span class="fu">reads</span> <span class="op">$</span> T.unpack s <span class="kw">of</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>            (i, <span class="st">&quot;&quot;</span>)<span class="op">:</span>_</span>
<span id="cb3-9"><a href="#cb3-9"></a>                <span class="op">|</span> i <span class="op">&lt;</span> <span class="dv">1</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>                <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">-&gt;</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">Natural</span> i</span>
<span id="cb3-11"><a href="#cb3-11"></a>            [] <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span></code></pre></div>
<p>このコードを説明すると、1行目は不適切な入力を避けるために、Int に対して newtype を使って Natural 型を定義します。また、<code>PathPiece</code> は2つのメソッドをもつ型クラスだということがわかります。<code>toPathPiece</code> は <code>Text</code> に変換する以上のことは何も行いません。<code>fromPathPiece</code> は <code>Text</code> からデータ型への変換を行いますが、この変換に失敗した場合は <code>Nothing</code> を返します。この <code>Natural</code> 型を使えば、ハンドラ関数に自然数のみが与えられることを保証するため、型システムを使って境界問題に対処できます。</p>
<div class="yesod-book-notice">
<p>現実世界のアプリケーションにおいては、アプリケーション内で有効ではない <code>Natural</code> 値を絶対に作れないことを保証したいでしょう。そのようにするためには <a href="https://wiki.haskell.org/Smart_constructors">smart constructors</a> のような方法があります。ただ、今回の例の目的とは少し違うので、ここでは説明しません。</p>
</div>
<p><code>PathMultiPiece</code> も同じくらい簡単に定義できます。例えば、少なくとも2つ以上の階層をもつ Wiki を作りたいので、次のようなデータ型を定義しましょう。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">data</span> <span class="dt">Page</span> <span class="ot">=</span> <span class="dt">Page</span> <span class="dt">Text</span> <span class="dt">Text</span> [<span class="dt">Text</span>] <span class="co">-- 2 or more</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>    <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Show</span>, <span class="dt">Read</span>)</span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="kw">instance</span> <span class="dt">PathMultiPiece</span> <span class="dt">Page</span> <span class="kw">where</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>    toPathMultiPiece (<span class="dt">Page</span> x y z) <span class="ot">=</span> x <span class="op">:</span> y <span class="op">:</span> z</span>
<span id="cb4-6"><a href="#cb4-6"></a>    fromPathMultiPiece (x<span class="op">:</span>y<span class="op">:</span>z) <span class="ot">=</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">Page</span> x y z</span>
<span id="cb4-7"><a href="#cb4-7"></a>    fromPathMultiPiece _ <span class="ot">=</span> <span class="dt">Nothing</span></span></code></pre></div>
<h3 id="オーバーラップチェック">オーバーラップチェック</h3>
<p>Yesod はデフォルトで、どの2つのルートも互いに重なり合う可能性がないことを保証しています。そこで例えば次のようなルートを考えてみましょう。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a><span class="op">/</span>foo<span class="op">/</span>bar   <span class="dt">Foo1R</span> <span class="dt">GET</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="op">/</span>foo<span class="op">/#</span><span class="dt">Text</span> <span class="dt">Foo2R</span> <span class="dt">GET</span></span></code></pre></div>
<p>このルート宣言は <code>/foo/bar</code> が両方のルートに一致してしまうため、オーバーラップしているものとして拒否されます。しかし、オーバーラップを許可したい時があります。</p>
<ol type="1">
<li>データ型の定義からオーバーラップが絶対発生しないとわかっている場合。例えば、上の <code>Text</code> を <code>Int</code> で置き換えたとすると、オーバーラップするルートが存在しないことはすぐにわかります。しかし、Yesod は今のところそのような分析はできません。</li>
<li>アプリケーションがどのように作動するかについて特別な情報を持っているため、そのような状況が絶対に発生しないとわかっている場合。例えば、<code>Foo2R</code> ルートの引数で <code>bar</code> を受け取ることが絶対に無いといった感じです。</li>
</ol>
<p>オーバーラップチェックをオフにするためには、エクスクラメーションマークをルートの始まりに追加します。例えば、次のコードは問題なく Yesod で動作します。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a><span class="op">/</span>foo<span class="op">/</span>bar    <span class="dt">Foo1R</span> <span class="dt">GET</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="op">!/</span>foo<span class="op">/#</span><span class="dt">Int</span>  <span class="dt">Foo2R</span> <span class="dt">GET</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="op">!/</span>foo<span class="op">/#</span><span class="dt">Text</span> <span class="dt">Foo3R</span> <span class="dt">GET</span></span></code></pre></div>
<div class="yesod-book-notice">
<p>エクスクラメーションマークを置く場所は <code>#</code>、<code>*</code>、<code>+</code> 文字の後でも良いですし、どのパス断片の始めに置いても大丈夫です。ただ、新しい構文のほうが目的が明確なためより好まれます。</p>
</div>
<p>オーバーラッピングルートを利用するとルートが曖昧になってしまうという問題が発生します。上記の例において <code>/foo/bar</code> は <code>Foo1R</code> と <code>Foo3R</code> のどちらにルーティングするべきでしょうか？また <code>/foo/42</code> は <code>Foo2R</code> と <code>Foo3R</code> のどちらにルーティングするべきでしょうか？Yesod では、最初のルートが優先されるという単純なルールになっています。</p>
<h3 id="リソース名">リソース名</h3>
<p>それぞれのリソースパターンは自身と結びつけるための名前を持っています。その名前はアプリケーションの型安全URLデータ型のコンストラクタとなるため、大文字で始まらなければなりません。慣習として、これらのリソース名はすべて大文字の R で終わります。このルールを強制するものは何もなく、わかりやすいのでみんな使っているだけです。</p>
<p>コンストラクタの正確な定義はそれが結びついているリソースパターンに依存しています。パターンの断片がダイナミックシングルであっても、ダイナミックマルチであっても、どちらもパターンで指定された型がコンストラクタの引数の型になります。これはアプリケーションにおいて型安全URLの値と有効な URL の間に1対1の対応があるということを意味します。</p>
<div class="yesod-book-notice">
<p>これは、すべての値に対してページが存在するという意味するのではなく、潜在的には有効な URL だという意味です。例えば <code>PersonR "Michael"</code> という値はデータベースに Michael がなければ有効なページにはたどり着かないでしょう。</p>
</div>
<p>より実用的な例として、<code>PersonR</code> という名前の <code>/person/#Text</code>、<code>YearR</code> という名前の <code>/year/#Int</code>、<code>FaqR</code> という名前の <code>/page/faq</code> というリソースパターンがあるとすれば、ルートデータ型はおおよそ以下のようになるでしょう。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">data</span> <span class="dt">MyRoute</span> <span class="ot">=</span> <span class="dt">PersonR</span> <span class="dt">Text</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>             <span class="op">|</span> <span class="dt">YearR</span> <span class="dt">Int</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>             <span class="op">|</span> <span class="dt">FaqR</span></span></code></pre></div>
<p>もし、ユーザが <code>/year/2009</code> をリクエストすれば Yesod はそれを <code>YearR 2009</code> という値に変換します。同様に <code>/person/Michael</code> は <code>PersonR "Michael"</code> となり、 <code>/page/faq</code> は <code>FaqR</code> なります。一方で <code>/year/two-thousand-nine</code>、<code>/person/michael/snoyman</code>、<code>/page/FAQ</code> は変換されず、404エラーになります。</p>
<h3 id="ハンドラの仕様">ハンドラの仕様</h3>
<p>最後に、リソースを宣言する際にそれらがどのように処理されるかということについて説明します。Yesod には次の3つの選択肢があります。</p>
<ul>
<li>ルートに対して、すべてのリクエストメソッドを処理するシングルハンドラ関数</li>
<li>ルートに対して、それぞれのリクエストメソッドを処理するセパレートハンドラ関数。その他のリクエストメソッドの場合は 405 Method Not Allowed を生成します。</li>
<li>サブサイトに受け流す</li>
</ul>
<p>はじめの2つは簡単に使えます。シングルハンドラ関数は <code>/page/faq FaqR</code> のようなリソースパターンとリソース名だけが1行に書かれています。この場合、ハンドラ関数は <code>handleFaqR</code> と命名しなければなりません。</p>
<p>それぞれのリクエストメソッドに対応するためのセパレートハンドラも同じ書き方ですが、リクエストメソッドのリストが必要になります。このリクエストメソッドは必ず全ての文字が大文字でなければなりません。例えば <code>/person/#String PersonR GET POST DELETE</code> というようにです。この場合、<code>getPersonR</code>、<code>postPersonR</code> <code>deletePersonR</code> という3つのハンドラ関数を定義する必要があります。</p>
<p>サブサイトはとても便利な機能ですが、 Yesod ではかなり複雑な話題です。サブサイトの書き方については後にしますが、それらを使うことはそれほど難しくありません。最も一般的なサブサイトは静的サブサイトで、アプリケーションのために静的ファイルを配信します。<code>/static</code> から静的ファイルを受け取るためには次のようなリソース行が必要となります。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1"></a><span class="op">/</span>static <span class="dt">StaticR</span> <span class="dt">Static</span> getStatic</span></code></pre></div>
<p>この行では <code>/static</code> は単にURL構造のどこから静的ファイルを受け取るかということを言っています。static という言葉自体には何も魔法の力はなく <code>/my/nondynamic/files</code> などに簡単に変更できます。</p>
<p>次の <code>StaticR</code> という単語はリソース名を表します。さらに、その次の2つの単語はサブサイトを使うということを表します。<code>Static</code> はサブサイトのファウンデーションデータ型で、<code>getStatic</code> はマスターファウンデーションデータ型の値から <code>Static</code> 値を取り出すための関数です。</p>
<p>今はサブサイトの詳細にはあまり深入りしないようにしましょう。scaffolded サイトの章で、静的サブサイトについての詳細を確認します。</p>
<h2 id="ディスパッチ">ディスパッチ</h2>
<p>一度ルートを指定すれば Yesod は URL ディスパッチに関する厄介な詳細をすべて引き受けてくれます。そのためには、確実に適切なハンドラ関数を与えていさえすれば良いのです。サブサイトのルートに関してはハンドラ関数を書く必要はありませんが、他の2つに関しては書く必要があります。命名規則については既に説明しました (<code>MyHandlerR GET</code> は <code>getMyHandlerR</code>、 <code>MyOtherHandlerR</code> は <code>handleMyOtherHandlerR</code> となる)。</p>
<p>ここまでで、どんな関数を書けば良いかわかったので、次は型注釈がどのようになるべきかについて理解していきましょう。</p>
<h3 id="戻り値の型">戻り値の型</h3>
<p>簡単なハンドラ関数を見てみましょう。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1"></a>mkYesod <span class="st">&quot;Simple&quot;</span> [parseRoutes|</span>
<span id="cb9-2"><a href="#cb9-2"></a>/ HomeR GET</span>
<span id="cb9-3"><a href="#cb9-3"></a>|]</span>
<span id="cb9-4"><a href="#cb9-4"></a></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="ot">getHomeR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>getHomeR <span class="ot">=</span> defaultLayout [whamlet|<span class="kw">&lt;h1&gt;</span>This is simple|]</span></code></pre></div>
<p>この戻り値の型には2つの要素 <code>Handler</code>、<code>Html</code> があります。これらについてより詳細に分析してみましょう。</p>
<h4 id="ハンドラモナド">ハンドラモナド</h4>
<p><code>Widget</code> 型のように <code>Handler</code> データ型は Yesod ライブラリのどこにも定義されていません。代わりにライブラリには以下のデータ型があります。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">data</span> <span class="dt">HandlerT</span> site m a</span></code></pre></div>
<p><code>WidgetT</code> と同様に3つの引数を持ちます。<code>m</code> はベースモナド、<code>a</code> はモナド値、<code>site</code> はファウンデーションデータ型です。各アプリケーションは <code>site</code> をそのアプリケーションのファウンデーションデータ型、<code>m</code> を <code>IO</code> に制限した <code>Handler</code> シノニムを定義します。もし仮に、アプリケーションのファウンデーションが <code>MyApp</code> であれば、つまり次のようになるでしょう。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">type</span> <span class="dt">Handler</span> <span class="ot">=</span> <span class="dt">HandlerT</span> <span class="dt">MyApp</span> <span class="dt">IO</span></span></code></pre></div>
<p>サブサイトを書く時にベースモナドを変更することがありますが、それ以外では <code>IO</code> を使います。</p>
<p><code>HandlerT</code> モナドはユーザリクエストに関する情報 (例: クエリ文字列パラメータ) へのアクセス方法の提供や、レスポンス (例: レスポンスのヘッダ) の変更など、他にも多くのことができます。Yesod ソースコードの大半がこのモナドとなっているでしょう。</p>
<p>さらに <code>MonadHandler</code> と呼ばれる型クラスがあります。<code>HandlerT</code> と <code>WidgetT</code> はこの型クラスのインスタンスとなっているため、両方のモナドでは共通の関数が数多く使われています。 もし API ドキュメントの中に <code>MonadHandler</code> があれば、その関数は <code>Handler</code> 関数で使うことができる関数だということを思い出してください。</p>
<h4 id="html">Html</h4>
<p>この型について驚くようなことは何もありません。この関数は <code>Html</code> データ型で表される HTML コンテンツを返します。しかし、それが HTML レスポンスのみしか返せないのであれば Yesod は明らかに役に立ちません。CSS、Javascript、JSON、画像、そしてより多くのものをレスポンスとして返したいのです。その際、どんなデータ型を返してあげれば良いのだろうか？という疑問が生じると思います。</p>
<p>レスポンスを生成するためには、2つの情報を知る必要があります。それはコンテンツタイプ (例えば <code>text/html</code> や <code>image/png</code>) と、バイト列へのシリアライズ化の方法です。これは <code>TypedContent</code> データ型で表現されます。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">data</span> <span class="dt">TypedContent</span> <span class="ot">=</span> <span class="dt">TypedContent</span> <span class="op">!</span><span class="dt">ContentType</span> <span class="op">!</span><span class="dt">Content</span></span></code></pre></div>
<p>また任意のデータ型を <code>TypedContent</code> に変換するための型クラスがあります。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">class</span> <span class="dt">ToTypedContent</span> a <span class="kw">where</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="ot">    toTypedContent ::</span> a <span class="ot">-&gt;</span> <span class="dt">TypedContent</span></span></code></pre></div>
<p><code>Html</code>、<code>Value</code> (JSON を表す。aeson パッケージが提供している)、<code>Text</code>、<code>()</code> (空レスポンスを表す) など、よく利用する多くのデータ型は、この型クラスのインスタンスになっています。</p>
<h3 id="引数">引数</h3>
<p>先ほどの例に戻りましょう。</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1"></a>mkYesod <span class="st">&quot;Simple&quot;</span> [parseRoutes|</span>
<span id="cb14-2"><a href="#cb14-2"></a>/ HomeR GET</span>
<span id="cb14-3"><a href="#cb14-3"></a>|]</span>
<span id="cb14-4"><a href="#cb14-4"></a></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="ot">getHomeR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb14-6"><a href="#cb14-6"></a>getHomeR <span class="ot">=</span> defaultLayout [whamlet|<span class="kw">&lt;h1&gt;</span>This is simple|]</span></code></pre></div>
<p>あらゆるルートがこの <code>HomeR</code> ほど単純ではありません。例えば、前に見た <code>PersonR</code> のルートをもう一度確認してみましょう。人物の名前をハンドラ関数に渡す必要があります。このやり方は率直でとてもわかりやすいものです。以下に例を示します。</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="ot">{-# LANGUAGE QuasiQuotes       #-}</span></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="ot">{-# LANGUAGE TemplateHaskell   #-}</span></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="ot">{-# LANGUAGE TypeFamilies      #-}</span></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="ot">{-# LANGUAGE ViewPatterns      #-}</span></span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="kw">import</span>           <span class="dt">Data.Text</span> (<span class="dt">Text</span>)</span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">T</span></span>
<span id="cb15-8"><a href="#cb15-8"></a><span class="kw">import</span>           <span class="dt">Yesod</span></span>
<span id="cb15-9"><a href="#cb15-9"></a></span>
<span id="cb15-10"><a href="#cb15-10"></a><span class="kw">data</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">App</span></span>
<span id="cb15-11"><a href="#cb15-11"></a><span class="kw">instance</span> <span class="dt">Yesod</span> <span class="dt">App</span></span>
<span id="cb15-12"><a href="#cb15-12"></a></span>
<span id="cb15-13"><a href="#cb15-13"></a>mkYesod <span class="st">&quot;App&quot;</span> [parseRoutes|</span>
<span id="cb15-14"><a href="#cb15-14"></a>/person/#Text PersonR GET</span>
<span id="cb15-15"><a href="#cb15-15"></a>/year/#Integer/month/#Text/day/#Int DateR</span>
<span id="cb15-16"><a href="#cb15-16"></a>/wiki/*Texts WikiR GET</span>
<span id="cb15-17"><a href="#cb15-17"></a>|]</span>
<span id="cb15-18"><a href="#cb15-18"></a></span>
<span id="cb15-19"><a href="#cb15-19"></a><span class="ot">getPersonR ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb15-20"><a href="#cb15-20"></a>getPersonR name <span class="ot">=</span> defaultLayout [whamlet|<span class="kw">&lt;h1&gt;</span>Hello <span class="kw">#{</span>name<span class="kw">}</span>!|]</span>
<span id="cb15-21"><a href="#cb15-21"></a></span>
<span id="cb15-22"><a href="#cb15-22"></a><span class="ot">handleDateR ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> <span class="dt">Text</span> <span class="co">-- text/plain</span></span>
<span id="cb15-23"><a href="#cb15-23"></a>handleDateR year month day <span class="ot">=</span></span>
<span id="cb15-24"><a href="#cb15-24"></a>    <span class="fu">return</span> <span class="op">$</span></span>
<span id="cb15-25"><a href="#cb15-25"></a>        T.concat [month, <span class="st">&quot; &quot;</span>, T.pack <span class="op">$</span> <span class="fu">show</span> day, <span class="st">&quot;, &quot;</span>, T.pack <span class="op">$</span> <span class="fu">show</span> year]</span>
<span id="cb15-26"><a href="#cb15-26"></a></span>
<span id="cb15-27"><a href="#cb15-27"></a><span class="ot">getWikiR ::</span> [<span class="dt">Text</span>] <span class="ot">-&gt;</span> <span class="dt">Handler</span> <span class="dt">Text</span></span>
<span id="cb15-28"><a href="#cb15-28"></a>getWikiR <span class="ot">=</span> <span class="fu">return</span> <span class="op">.</span> T.unwords</span>
<span id="cb15-29"><a href="#cb15-29"></a></span>
<span id="cb15-30"><a href="#cb15-30"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb15-31"><a href="#cb15-31"></a>main <span class="ot">=</span> warp <span class="dv">3000</span> <span class="dt">App</span></span></code></pre></div>
<p>各ルートの引数は指定された並び順のダイナミックな断片の型になります。また、 戻り値として <code>Html</code> と <code>Text</code> のどちらも利用可能なことに注意してください。</p>
<h2 id="ハンドラ関数">ハンドラ関数</h2>
<p>コードのほとんどは <code>Handler</code> モナドに書くのでとても重要です。より深く理解するためにもう少し時間を費やしましょう。この章の残りでは <code>Handler</code> モナドでよく使う関数について簡単に紹介したいと思います。セッション関数についてはセッションの章で解説するため、今回は特に説明しません。</p>
<h3 id="アプリケーション情報">アプリケーション情報</h3>
<p>アプリケーション全体の情報を返し、個々のリクエストについては何の情報もあたえない関数が数多くあります。それらをいくつか紹介します。</p>
<h4 id="getyesod">getYesod</h4>
<p>アプリケーションのファウンデーション値を返します。もし, ファウンデーションに設定値を保存していれば、この関数を多用することになるでしょう。(一応 <code>Control.Monad.Reader</code> の <code>ask</code> を使うこともできます。<code>getYesod</code> は単にその型を制限したエイリアスです。)</p>
<h4 id="geturlrender">getUrlRender</h4>
<p>型安全URLを <code>Text</code> に変換する URLレンダリング関数を返します。Hamlet を使えば Yesod が代わりにこの関数を呼び出してくれますが、直接呼び出す必要もたまにはあります。</p>
<h4 id="geturlrenderparams">getUrlRenderParams</h4>
<p><code>getUrlRender</code> の亜種です。型安全URLとクエリ文字列パラメータのリストを <code>Text</code> に変換します。この関数は必要なすべてのパーセントエンコーディングを行います。</p>
<h3 id="リクエスト情報">リクエスト情報</h3>
<p>現在のリクエストで欲しい情報は、リクエストされたパス、クエリ文字列パラメータ、そして <code>POST</code> されたフォームデータが一般的です。リクエストされたパスは既に説明したようにルーティングで取り扱われます。他の2つはフォームモジュールを使って適切に取り扱います。</p>
<p>また、時々データを raw 形式で取得したいときがあります。この目的のために Yesod には <code>YesodRequest</code> データ型とリクエストを回収するための <code>getRequest</code> 関数があります。この関数により GET パラメーターの完全なリスト、クッキー、優先言語へのアクセスが可能になります。さらに <code>lookupGetParam</code>、<code>lookupCookie</code>、<code>languages</code> のような検索用の便利な関数があります。POST パラメータへの raw アクセスに関しては <code>runRequestBody</code> を利用しましょう。</p>
<p>リクエストヘッダのようにさらに多くの raw データが必要な場合 <code>waiRequest</code> を使ってウェブアプリケーションインタフェース (WAI) リクエスト値にアクセスできます。詳細については付録の WAI を参照してください。</p>
<h3 id="ショート">ショート</h3>
<p>ハンドラ関数の処理を即座に終了し、結果をユーザに返します。</p>
<h4 id="redirect">redirect</h4>
<p>リダイレクトレスポンスをユーザ (303レスポンス) に送ります。違うレスポンスコード (例えば、永続的な301リダイレクト) にしたい場合は <code>redirectWith</code> を利用します。</p>
<div class="yesod-book-notice">
<p>Yesod は HTTP/1.1 クライアントには 303 レスポンス、そして HTTP/1.0 クライアントには 302 レスポンスを返します。このひどい実装は HTTP の仕様によるものです。</p>
</div>
<h4 id="notfound">notFound</h4>
<p>404 レスポンスを返します。存在しないデータベース値をユーザがリクエストした場合などで便利です。</p>
<h4 id="permissiondenied">permissionDenied</h4>
<p>特定のエラーメッセージとともに403レスポンスを返します。</p>
<h4 id="invalidargs">invalidArgs</h4>
<p>有効でない引数のリストと一緒に400レスポンスを返します。</p>
<h4 id="sendfile">sendFile</h4>
<p>指定されたコンテンツタイプでファイルシステムからファイルを送信します。これは下地の WAI ハンドラが <code>sendfile</code> システムコールに最適化できるため、静的ファイルを送る方法として好まれます。静的ファイルを送るために <code>readFile</code> を使う必要はありません。</p>
<h4 id="sendresponse">sendResponse</h4>
<p>200ステータスコードと共に通常のレスポンスを返します。即座にレスポンスが返るため、深くネストしたコードから抜け出す必要があるときに便利です。また <code>ToTypedContent</code> の任意のインスタンスが利用できます。</p>
<h4 id="sendwairesponse">sendWaiResponse</h4>
<p>低レベルにおいて raw WAI レスポンスを送りたい場合に利用します。これはストリーミングレスポンスやサーバーが送るイベントのような技術を作るときに便利です。</p>
<h3 id="レスポンスヘッダ">レスポンスヘッダ</h3>
<h4 id="setcookie">setCookie</h4>
<p>クライアントにクッキーをセットします。この関数は有効期限を指定する代わりに、分単位でクッキーの持続時間を指定します。次のリクエストまでは <code>lookupCookie</code> を使っても、このクッキーは見えないことを覚えておいてください。</p>
<h4 id="deletecookie">deleteCookie</h4>
<p>クライアントにクッキーを消去するように伝えます。これもまた <code>lookupCookie</code> を使っても、次のリクエストまで変更は反映されません。</p>
<h4 id="addheader">addHeader</h4>
<p>任意のレスポンスヘッダを設定します。</p>
<h4 id="setlanguage">setLanguage</h4>
<p>ユーザの優先言語を設定します。設定した内容は <code>languages</code> 関数の結果として現れます。</p>
<h4 id="cacheseconds">cacheSeconds</h4>
<p>何秒間このレスポンスをキャッシュするかを制御する Cache−Control ヘッダを設定します。これは <a href="http://www.varnish-cache.org/">vanish on your server</a> を利用している場合に特に便利です。</p>
<h4 id="neverexpires">neverExpires</h4>
<p>Expires ヘッダを2037年に設定します。これはリクエストパスがそれと関連したハッシュ値を持っている場合のように、有効期限が決して切れないコンテンツと共に用いられます。</p>
<h4 id="alreadyexpired">alreadyExpired</h4>
<p>Expires ヘッダを過去に設定します。</p>
<h4 id="expiresat">expiresAt</h4>
<p>Expires ヘッダを指定した日時に設定します。</p>
<h2 id="入出力とデバッグ">入出力とデバッグ</h2>
<p><code>HandlerT</code> と <code>WidgetT</code> モナドトランスフォーマーは両方とも多くの型クラスのインスタンスになっています。ここで重要な型クラスは <code>MonadIO</code> と <code>MonadLogger</code> です。<code>MonadIO</code> はファイルからの読み込みのようなハンドラ内における任意の <code>IO</code> アクションが可能となります。使い方は、呼び出しの先頭に <code>liftIO</code> を追加するだけです。</p>
<p><code>MonadLogger</code> は組み込みのロギングシステムを追加します。どのメッセージがログに記録されるか、どこにログが記録されるかを含み、システムをカスタマイズするための多くの方法があります。デフォルトではログは標準出力、開発においてはすべてのメッセージ、製品版においては警告とエラーがログに記録されます。</p>
<p>ログ取得時に、ソースコードのどこでログが行われているか知りたい時があります。このために <code>MonadLogger</code> は自動的にソースコードの位置をログメッセージに挿入するいくつもの便利なテンプレート Haskell 関数を提供しています。これらの関数は <code>$logDebug</code>、<code>$logInfo</code>、<code>$logWarn</code>、<code>$logError</code> です。これらの関数を使った例を見てみましょう。</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="ot">{-# LANGUAGE QuasiQuotes       #-}</span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="ot">{-# LANGUAGE TemplateHaskell   #-}</span></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="ot">{-# LANGUAGE TypeFamilies      #-}</span></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="kw">import</span>           <span class="dt">Control.Exception</span> (<span class="dt">IOException</span>, try)</span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="kw">import</span>           <span class="dt">Control.Monad</span>     (when)</span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="kw">import</span>           <span class="dt">Yesod</span></span>
<span id="cb16-8"><a href="#cb16-8"></a></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="kw">data</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">App</span></span>
<span id="cb16-10"><a href="#cb16-10"></a><span class="kw">instance</span> <span class="dt">Yesod</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb16-11"><a href="#cb16-11"></a>    <span class="co">-- This function controls which messages are logged</span></span>
<span id="cb16-12"><a href="#cb16-12"></a>    shouldLogIO <span class="dt">App</span> src level <span class="ot">=</span></span>
<span id="cb16-13"><a href="#cb16-13"></a>        <span class="fu">return</span> <span class="dt">True</span> <span class="co">-- good for development</span></span>
<span id="cb16-14"><a href="#cb16-14"></a>        <span class="co">-- level == LevelWarn || level == LevelError -- good for production</span></span>
<span id="cb16-15"><a href="#cb16-15"></a></span>
<span id="cb16-16"><a href="#cb16-16"></a>mkYesod <span class="st">&quot;App&quot;</span> [parseRoutes|</span>
<span id="cb16-17"><a href="#cb16-17"></a>/ HomeR GET</span>
<span id="cb16-18"><a href="#cb16-18"></a>|]</span>
<span id="cb16-19"><a href="#cb16-19"></a></span>
<span id="cb16-20"><a href="#cb16-20"></a><span class="ot">getHomeR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb16-21"><a href="#cb16-21"></a>getHomeR <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb16-22"><a href="#cb16-22"></a>    <span class="op">$</span>logDebug <span class="st">&quot;Trying to read data file&quot;</span></span>
<span id="cb16-23"><a href="#cb16-23"></a>    edata <span class="ot">&lt;-</span> liftIO <span class="op">$</span> try <span class="op">$</span> <span class="fu">readFile</span> <span class="st">&quot;datafile.txt&quot;</span></span>
<span id="cb16-24"><a href="#cb16-24"></a>    <span class="kw">case</span><span class="ot"> edata ::</span> <span class="dt">Either</span> <span class="dt">IOException</span> <span class="dt">String</span> <span class="kw">of</span></span>
<span id="cb16-25"><a href="#cb16-25"></a>        <span class="dt">Left</span> e <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb16-26"><a href="#cb16-26"></a>            <span class="op">$</span>logError <span class="st">&quot;Could not read datafile.txt&quot;</span></span>
<span id="cb16-27"><a href="#cb16-27"></a>            defaultLayout [whamlet|An error occurred|]</span>
<span id="cb16-28"><a href="#cb16-28"></a>        <span class="dt">Right</span> str <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb16-29"><a href="#cb16-29"></a>            <span class="op">$</span>logInfo <span class="st">&quot;Reading of data file succeeded&quot;</span></span>
<span id="cb16-30"><a href="#cb16-30"></a>            <span class="kw">let</span> ls <span class="ot">=</span> <span class="fu">lines</span> str</span>
<span id="cb16-31"><a href="#cb16-31"></a>            when (<span class="fu">length</span> ls <span class="op">&lt;</span> <span class="dv">5</span>) <span class="op">$</span> <span class="op">$</span>logWarn <span class="st">&quot;Less than 5 lines of data&quot;</span></span>
<span id="cb16-32"><a href="#cb16-32"></a>            defaultLayout</span>
<span id="cb16-33"><a href="#cb16-33"></a>                [whamlet|</span>
<span id="cb16-34"><a href="#cb16-34"></a>                    <span class="kw">&lt;ol&gt;</span></span>
<span id="cb16-35"><a href="#cb16-35"></a>                        <span class="kw">$forall</span> l <span class="ot">&lt;-</span> ls</span>
<span id="cb16-36"><a href="#cb16-36"></a>                            <span class="kw">&lt;li&gt;#{</span>l<span class="kw">}</span></span>
<span id="cb16-37"><a href="#cb16-37"></a>                |]</span>
<span id="cb16-38"><a href="#cb16-38"></a></span>
<span id="cb16-39"><a href="#cb16-39"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb16-40"><a href="#cb16-40"></a>main <span class="ot">=</span> warp <span class="dv">3000</span> <span class="dt">App</span></span></code></pre></div>
<h2 id="クエリ文字列とハッシュフラグメント">クエリ文字列とハッシュフラグメント</h2>
<p><code>redirect</code> のような URL っぽいものに対して機能するいくつもの関数を見てきました。これらの関数はすべて型安全URLで機能しますが、他にはどのようなものと機能するのでしょうか？<code>RedirectUrl</code> と呼ばれる型クラスは、ある型をテキスト形式の URL に変換するメソッドを備えます。これは型安全URL、テキスト形式のURL、そしてさらに2つの特別なインスタンスが定義されています。。</p>
<ol type="1">
<li>URLとクエリ文字列パラメータのキー/値ペアのリストのタプル</li>
<li>ハッシュフラグメントを URL の最後に追加するときに使う <code>Fragment</code> データ型</li>
</ol>
<p>これら2つのインスタンスによって、追加の情報を型安全URLに加えることができます。どうやって利用するか、例を見てみましょう。</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="ot">{-# LANGUAGE QuasiQuotes       #-}</span></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="ot">{-# LANGUAGE TemplateHaskell   #-}</span></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="ot">{-# LANGUAGE TypeFamilies      #-}</span></span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="kw">import</span>           <span class="dt">Data.Text</span>        (<span class="dt">Text</span>)</span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="kw">import</span>           <span class="dt">Yesod</span></span>
<span id="cb17-7"><a href="#cb17-7"></a></span>
<span id="cb17-8"><a href="#cb17-8"></a><span class="kw">data</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">App</span></span>
<span id="cb17-9"><a href="#cb17-9"></a></span>
<span id="cb17-10"><a href="#cb17-10"></a>mkYesod <span class="st">&quot;App&quot;</span> [parseRoutes|</span>
<span id="cb17-11"><a href="#cb17-11"></a>/      HomeR  GET</span>
<span id="cb17-12"><a href="#cb17-12"></a>/link1 Link1R GET</span>
<span id="cb17-13"><a href="#cb17-13"></a>/link2 Link2R GET</span>
<span id="cb17-14"><a href="#cb17-14"></a>/link3 Link3R GET</span>
<span id="cb17-15"><a href="#cb17-15"></a>/link4 Link4R GET</span>
<span id="cb17-16"><a href="#cb17-16"></a>|]</span>
<span id="cb17-17"><a href="#cb17-17"></a></span>
<span id="cb17-18"><a href="#cb17-18"></a><span class="kw">instance</span> <span class="dt">Yesod</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb17-19"><a href="#cb17-19"></a></span>
<span id="cb17-20"><a href="#cb17-20"></a><span class="ot">getHomeR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb17-21"><a href="#cb17-21"></a>getHomeR <span class="ot">=</span> defaultLayout <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb17-22"><a href="#cb17-22"></a>    setTitle <span class="st">&quot;Redirects&quot;</span></span>
<span id="cb17-23"><a href="#cb17-23"></a>    [whamlet|</span>
<span id="cb17-24"><a href="#cb17-24"></a>        <span class="kw">&lt;p&gt;</span></span>
<span id="cb17-25"><a href="#cb17-25"></a>            <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">Link1R</span><span class="kw">}&gt;</span>Click to start the redirect chain!</span>
<span id="cb17-26"><a href="#cb17-26"></a>    |]</span>
<span id="cb17-27"><a href="#cb17-27"></a></span>
<span id="cb17-28"><a href="#cb17-28"></a>getLink1R, getLink2R,<span class="ot"> getLink3R ::</span> <span class="dt">Handler</span> ()</span>
<span id="cb17-29"><a href="#cb17-29"></a>getLink1R <span class="ot">=</span> redirect <span class="dt">Link2R</span> <span class="co">-- /link2</span></span>
<span id="cb17-30"><a href="#cb17-30"></a>getLink2R <span class="ot">=</span> redirect (<span class="dt">Link3R</span>, [(<span class="st">&quot;foo&quot;</span>, <span class="st">&quot;bar&quot;</span>)]) <span class="co">-- /link3?foo=bar</span></span>
<span id="cb17-31"><a href="#cb17-31"></a>getLink3R <span class="ot">=</span> redirect <span class="op">$</span> <span class="dt">Link4R</span> <span class="op">:#:</span> (<span class="st">&quot;baz&quot;</span><span class="ot"> ::</span> <span class="dt">Text</span>) <span class="co">-- /link4#baz</span></span>
<span id="cb17-32"><a href="#cb17-32"></a></span>
<span id="cb17-33"><a href="#cb17-33"></a><span class="ot">getLink4R ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb17-34"><a href="#cb17-34"></a>getLink4R <span class="ot">=</span> defaultLayout</span>
<span id="cb17-35"><a href="#cb17-35"></a>    [whamlet|</span>
<span id="cb17-36"><a href="#cb17-36"></a>        <span class="kw">&lt;p&gt;</span>You made it!</span>
<span id="cb17-37"><a href="#cb17-37"></a>    |]</span>
<span id="cb17-38"><a href="#cb17-38"></a></span>
<span id="cb17-39"><a href="#cb17-39"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb17-40"><a href="#cb17-40"></a>main <span class="ot">=</span> warp <span class="dv">3000</span> <span class="dt">App</span></span></code></pre></div>
<p>もちろん以下のように Hamlet テンプレート内でハッシュを直接 URL の後に追加できるのでこれは多くの場合不要です。</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1"></a><span class="op">&lt;</span>a href<span class="op">=@</span>{<span class="dt">Link1R</span>}<span class="op">#</span>somehash<span class="op">&gt;</span><span class="dt">Link</span> to hash</span></code></pre></div>
<h2 id="まとめ">まとめ</h2>
<p>ルーティングとディスパッチは間違いなく Yesod の心臓部です。型安全URLはここで定義され、大部分のコードは <code>Handler</code> モナド内部に記述します。この章では Yesod において最も重要な中心的概念について説明しました。これらをを適切に理解することが重要です。</p>
<p>この章ではまた、後に扱ういくつものより複雑な Yesod に関するトピックについても触れました。しかし、ここまでで学んだ知識だけでもかなり洗練されたウェブアプリケーションを書くことが可能なはずです。</p>
<h2 id="本書のコード">本書のコード</h2>
<ul>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch07/Example01.hs">Example01.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch07/Example02.hs">Example02.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch07/Example03.hs">Example03.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch07/Example04.hs">Example04.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch07/Example05.hs">Example05.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch07/Example06.hs">Example06.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch07/Example07.hs">Example07.hs</a></li>
</ul>
      </article>

      <div class="pager">
      
      
      </div>

      <div class="row">
        <div class="col s6 offset-s6" style="position: relative; height: 100px;">
          <div class="fixed-action-btn horizontal" style="position: absolute; display: inline-block; right: 24px;">
  <a class="btn-floating btn-large red">
    <i class="large material-icons">share</i>
  </a>
  <ul>
    <li>
      <a class="btn-floating waves-effect waves-light blue tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Twitter" href="https://twitter.com/intent/tweet?text=ルーティングとハンドラ&url=https://haskell.e-bigmoon.com/yesod/book/ch07-routing-and-handlers.html"><i class="mdi mdi-twitter white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light indigo tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Facebook" href="https://facebook.com/sharer.php?u=https://haskell.e-bigmoon.com/yesod/book/ch07-routing-and-handlers.html"><i class="mdi mdi-facebook white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light red tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Google+" href="https://plus.google.com/share?url=https://haskell.e-bigmoon.com/yesod/book/ch07-routing-and-handlers.html"><i class="mdi mdi-google-plus white-text"></i></a>
    </li>
  </ul>
</div>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
    </div>

    <footer class="page-footer indigo lighten-1">

  <div class="footer-copyright">

    <div class="container">
      © 2017-2019 BIGMOON&nbsp;
      Site proudly generated by <a class="red-text text-accent-1" href="http://jaspervdj.be/hakyll">Hakyll</a>,&nbsp;
      original Jekyll theme by <a class="red-text text-accent-1" href="https://github.com/mumuxme/materialize-jekyll">mumuxme</a>.
    </div>

  </div>

</footer>


    <!-- scrolltop button -->
    <button class="material-scrolltop waves-effect waves-light hide-on-small-only" type="button">
      <i class="mdi mdi-arrow-up-bold small white-text"></i>
    </button>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-19322672-9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-19322672-9');
    </script>

    <!-- jquery -->
    <script type="text/javascript" src="../../lib/jquery-min.js"></script>
    <!-- materialize -->
    <script src="../../lib/materialize/js/materialize.min.js"></script>
    <!-- <\!-- Material ScrollTop plugin -\-> -->
    <script src="../../lib/material-scrolltop/material-scrolltop.js"></script>
    <!-- main -->
    <script src="../../js/init.js"></script>
    <script src="../../js/main.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/haskell.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/yaml.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/shell.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/bash.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>

</html>
