<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">

  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
  <!-- MUST in hex format, may the same as header-color. This color is for android chrome browser. -->
  <meta name="theme-color" content="#5c6bc0">

  <!-- Metadata. -->
  <meta name="keywords" content="haskell,blog,bigmoon" />
  <title>リクエストを理解する</title>
  <meta name="description" content="BIG MOON">
  <link rel="canonical" href="../../yesod/book/ch18-understanding-a-request.html">
  <link rel="alternate" type="application/atom+xml" title="リクエストを理解する" href="../../feed.xml" />
  <link rel="shortcut icon" href="../../images/favicon.ico" />
  <meta name="google-site-verification" content="X2YNboLvzw3_bclXLMvohyJDqj68D06_hPDMukRbgTs" />

  <!-- Stylesheets. -->
  <link rel="stylesheet" href="../../lib/materialize/css/materialize.min.css" />
  <link rel="stylesheet" href="../../css/main.css" />
  <link media="all" rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/3.3.92/css/materialdesignicons.min.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="../../lib/material-scrolltop/material-scrolltop.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/agate.min.css" />
  

  <!-- OGP -->
  <meta property="og:title" content="リクエストを理解する" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="/yesod/book/ch18-understanding-a-request.html" />
  <!-- <meta property="og:image" content=" サムネイル画像の URL" /> -->
  <meta property="og:site_name" content="リクエストを理解する" />
  <meta property="og:description" content="BIG MOON" />

  <meta name="twitter:card" content="summary" />
  <!-- <meta name="twitter:site" content="@[ Twitter ID]" /> -->
  <!-- <meta name="twitter:player" content="@[ Twitter ID]" /> -->

  <noscript>
  <div class="notice-warning noscript">You don't have javascript enabled. Good luck! :(</div>
</noscript>

<!--[if IE]>
  <div class="notice-warning">Oh, you are using Internet Explorer! Good luck... :(</div>
<![endif]-->

</head>


  <body>
    <header class="site-header">
      <nav class="nav-extended indigo lighten-1">
        <div class="nav-wrapper">
  <a href="../../"><span class="site-title">BIGMOON Haskeller's BLOG</span></a>
  <a href="#" data-activates="mobile-navbar" class="button-collapse">
    <i class="mdi mdi-menu white-text"></i>
  </a>

  <ul id="nav-mobile" class="right hide-on-med-and-down">
    <li>
      <a href="../../" class="white-text">
        <i class="mdi mdi-home left indigo-text text-lighten-3"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="white-text">
        <i class="mdi mdi-account-circle left indigo-text text-lighten-3"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../books/" class="white-text">
        <i class="mdi mdi-book-open left indigo-text text-lighten-3"></i>
        Books
      </a>
    </li>
    <li>
      <a href="../../stack/" class="white-text">
        <i class="mdi mdi-wrench left indigo-text text-lighten-3"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/" class="white-text">
        <i class="mdi mdi-comment-question-outline left indigo-text text-lighten-3"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="white-text">
        <i class="mdi mdi-package-variant left indigo-text text-lighten-3"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="white-text">
        <i class="mdi mdi-earth left indigo-text text-lighten-3"></i>
        Yesod
      </a>
    </li>
    <li>
      <a href="../../feed.xml" class="white-text">
        <i class="mdi mdi-rss left indigo-text text-lighten-3"></i>
        Feed
      </a>
    </li>
  </ul>

  <ul class="side-nav" id="mobile-navbar">
    <li>
      <a href="../../" class="waves-effect waves-teal black-text">
        <i class="mdi mdi-home left green-text"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="navbar-text-colour-mobile">
        <i class="mdi mdi-account-circle left blue-text"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../books/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-book-open left blue-text"></i>
        Books
      </a>
    </li>
    <li>
      <a href="../../stack/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-wrench left blue-text"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-comment-question-outline left blue-text"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-package-variant left blue-text"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-earth left blue-text"></i>
        Yesod
      </a>
    </li>
  </ul>
</div>

      </nav>
    </header>

    <div class="site-container" id="tab-main">
      <div class="wrapper">
        <div class="post-ribbon"></div>

<div class="container page-container">
  <div class="post-page card-panel z-depth-2">
    <div class="post-section">
      <div class="post-heading">
        <div style="float: right;">
          
          <span>記事公開日: 2020/02/02</span><br>
          
          
        </div>
        <h1 class="post-title">リクエストを理解する</h1>
      </div>

      <article class="page-content">
        <p>Yesod の内部で起きていることを理解せずに Yesod を使い続けることもできます。しかし、内部動作の理解は Yesod を使う上で有益です。この章では、良くある Yesod アプリケーションのリクエストハンドリング処理を扱います。 この章の内容の多くは Yesod 1.2 の変更を含むことに注意してください。大部分の概念は以前のバージョンと変わりませんが、必要とするデータ型は少しごちゃごちゃしているかもしれません。</p>
<p>Yesod はボイラープレートコードを減らすために Template Haskell を利用します。そのため、この部分の処理を理解することがほんの少し難しくなります。もし、本章の範囲を超えてさらに分析したければ、<code>-ddump-splices</code> オプションを使って GHC の生成したコードを読むと良いでしょう。</p>
<div class="yesod-book-notice">
<p>本章の情報の多くは Yesod 1.2 におけるブログシリーズとして公開されたものが元になっています。</p>
<ul>
<li><a href="https://www.yesodweb.com/blog/2013/03/yesod-1-2-cleaner-internals">Yesod 1.2’s cleaner internals</a></li>
<li><a href="https://www.yesodweb.com/blog/2013/03/big-subsite-rewrite">Big Subsite Rewrite</a></li>
<li><a href="https://www.yesodweb.com/blog/2013/03/yesod-dispatch-version-1-2">Yesod dispatch, version 1.2</a></li>
</ul>
</div>
<h2 id="ハンドラ">ハンドラ</h2>
<p>Yesod のリクエストハンドリングを理解する際、2つのコンポーネントを確認する必要があります。具体的には</p>
<ol type="1">
<li>リクエストが適切なハンドラコードにどのようにディスパッチされるか</li>
<li>どのようにハンドラ関数が処理されるか</li>
</ol>
<p>という2つです。</p>
<p>まずはハンドラ関数の処理方法について確認し、その後ディスパッチ処理自身の理解に戻ってくることにします。</p>
<h3 id="レイヤ">レイヤ</h3>
<p>Yesod は自身を WAI の上に構築し、Web サーバのプロトコル (または、より一般的にはハンドラ) と互いに通信するためのアプリケーションを提供します。これは2つのデータ型 <code>Rewuest</code> と <code>Response</code> で表現され、アプリケーションは以下の型として定義されます。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Application</span> <span class="ot">=</span> <span class="dt">Request</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>                <span class="ot">-&gt;</span> (<span class="dt">Response</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">ResponseReceived</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">ResponseReceived</span></span></code></pre></div>
<p>WAI ハンドラはアプリケーションを受け取り、それを実行します。</p>
<div class="yesod-book-notice">
<p><code>Application</code> の構造は少し複雑に見えます。それは <code>bracket</code> 関数と同じように継続渡し方式を用いてアプリケーションが安全にリソースを取得できるようにしているためです。詳細については WAI API ドキュメントを確認してください。</p>
</div>
<p>Request と Response はどちらも非常に低レベルであり、HTTP プロトコルをそのまま表現しようとしています。そのため WAI は一般的なツールとなっていますが、Web フレームワークを実装するために必要な情報がかなり不足しています。例えば、WAI はすべてのリクエストヘッダの未加工データを提供しますが、Yesod はクッキーの情報を取得するためにデータをパーズし、さらに、セッション情報を取得するためにクッキーをパーズする必要があります。</p>
<p>この問題を扱うために Yesod は2つの新しいデータ型 <code>YesodRequest</code> と <code>YesodResponse</code> を導入しました。<code>YesodRequest</code>は WAI リクエストを含み、それに加えてクッキーやセッション変数のようなリクエスト情報を追加します。レスポンス側では標準的な WAIレスポンスか、更新されたセッション情報や追加のレスポンスヘッダを含むレスポンスの高レベルの表現のどちらかです。WAI アプリケーションを並列化するために次の型を持ちます。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">YesodApp</span> <span class="ot">=</span> <span class="dt">YesodRequest</span> <span class="ot">-&gt;</span> <span class="dt">ResourceT</span> <span class="dt">IO</span> <span class="dt">YesodResponse</span></span></code></pre></div>
<div class="yesod-book-notice">
<p>Yesod は例外安全のために継続渡し方式ではなく <code>ResourceT</code> を利用します。そのため Yesod では例外安全コードがとても簡単に書けます。</p>
</div>
<p>しかし、実際のところ Yesod ユーザが <code>YesodApp</code> を見ることは無いでしょう。なぜなら、その上には使い慣れている <code>HandlerT</code> レイヤが存在するからです。ハンドラ関数を書くときは3つの異なるものへアクセスする必要があります。</p>
<ul>
<li>現在のリクエストに対する <code>YesodRequest</code> の値</li>
<li>どのようにメッセージをログに残したり、エラー状況を扱うかのような何らかの基本的な環境情報。これは <code>RunHandlerEnv</code> によって提供されます。</li>
<li>返されるヘッダやユーザのセッション情報のような、更新可能な情報を追跡し続けるための可変変数。これは <code>GHState</code> と呼ばれています。(良い名前ではないことはわかっていますが、歴史的理由でこうなっています)</li>
</ul>
<p>つまり、ハンドラ関数を書いている時というのは、本質的には単にあらゆるこれらの情報にアクセスできる <code>ReaderT</code> 変換子の中でコードを記述していることと同じです。<code>runHandler</code> 関数は <code>HandlerT</code> を <code>YesodApp</code> に変換します。<code>yesodRunner</code> はこれを一歩先に進め、しっかりと WAI の <code>Application</code> に変換します。</p>
<h2 id="コンテンツ">コンテンツ</h2>
<p>これまでに見てきた多くの例では、ハンドラは <code>Handler Html</code> の型を持ちます。私たちは <code>Handler</code> が何を意味するかについて記述しただけなのに、どうして Yesod は <code>Html</code> の扱い方を知っているのでしょうか？答えは <code>ToTypedContent</code> 型クラスにあります。関係するコードを示します。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Content</span> <span class="ot">=</span> <span class="dt">ContentBuilder</span> <span class="op">!</span><span class="dt">BBuilder.Builder</span> <span class="op">!</span>(<span class="dt">Maybe</span> <span class="dt">Int</span>) <span class="co">-- ^ The content and optional content length.</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>             <span class="op">|</span> <span class="dt">ContentSource</span> <span class="op">!</span>(<span class="dt">Source</span> (<span class="dt">ResourceT</span> <span class="dt">IO</span>) (<span class="dt">Flush</span> <span class="dt">BBuilder.Builder</span>))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>             <span class="op">|</span> <span class="dt">ContentFile</span> <span class="op">!</span><span class="dt">FilePath</span> <span class="op">!</span>(<span class="dt">Maybe</span> <span class="dt">FilePart</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>             <span class="op">|</span> <span class="dt">ContentDontEvaluate</span> <span class="op">!</span><span class="dt">Content</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">TypedContent</span> <span class="ot">=</span> <span class="dt">TypedContent</span> <span class="op">!</span><span class="dt">ContentType</span> <span class="op">!</span><span class="dt">Content</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">ToContent</span> a <span class="kw">where</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="ot">    toContent ::</span> a <span class="ot">-&gt;</span> <span class="dt">Content</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">ToContent</span> a <span class="ot">=&gt;</span> <span class="dt">ToTypedContent</span> a <span class="kw">where</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="ot">    toTypedContent ::</span> a <span class="ot">-&gt;</span> <span class="dt">TypedContent</span></span></code></pre></div>
<p><code>Content</code> データ型はレスポンスボディを与えるための異なる方法を表すための型です。最初の3つは WAI の表現を直接反映します。4番目 (<code>ContentDontEvaluate</code>) はレスポンスボディがユーザに返される前に完全に評価されるべきかを表すために用いられます。完全評価における利点は、もし純粋なコードから例外が投げられた際に意味のあるエラーメッセージを与えることができるという点です。欠点としては、おそらく処理時間やメモリー消費が増えることです。</p>
<p>いずれにしても Yesod はどのように <code>Content</code> をレスポンスボディに変換するかを知っています。<code>ToContent</code> 型クラスは多くの異なるデータ型をレスポンスボディに変換するための方法を与えます。多くの共通に用いられるデータ型はすでに <code>ToContent</code> のインスタンスになっています。例えば、正格 <code>ByteString</code>、遅延 <code>ByteString</code>、正格 <code>Text</code>、遅延 <code>Text</code>、<code>Html</code> などです。</p>
<p><code>TypedContent</code> は追加の情報として、値のコンテンツタイプを持ちます。予想通り、多くの共通のデータ型に対して <code>ToTypedContent</code> のインスタンスが定義されています。例えば、<code>Html</code>、aeson の <code>Value</code> (JSON のため)、<code>Text</code> (プレーンなテキストとして扱われる) などです。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">ToTypedContent</span> <span class="dt">J.Value</span> <span class="kw">where</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    toTypedContent v <span class="ot">=</span> <span class="dt">TypedContent</span> typeJson (toContent v)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">ToTypedContent</span> <span class="dt">Html</span> <span class="kw">where</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    toTypedContent h <span class="ot">=</span> <span class="dt">TypedContent</span> typeHtml (toContent h)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">ToTypedContent</span> <span class="dt">T.Text</span> <span class="kw">where</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    toTypedContent t <span class="ot">=</span> <span class="dt">TypedContent</span> typePlain (toContent t)</span></code></pre></div>
<p>これらをまとめると、<code>Handler</code> は <code>ToTypedContent</code> のあらゆるインスタンスを返すことができ、Yesod はそれを適切な表現にし、 Content-Type レスポンスヘッダをセットする。</p>
<h2 id="短絡レスポンス">短絡レスポンス</h2>
<p>もう一つの変わっている点は短絡についてです。例えば、ハンドラ関数の途中でリダイレクトを呼び出し、関数の残りの部分は呼び出されないというようなことです。このメカニズムには標準的な Haskell の例外が使われています。<code>ridirect</code> を呼び出すと <code>HandlerContents</code> 型の例外を投げます。<code>runHandler</code> 関数は投げられたあらゆる例外をキャッチし、適切なレスポンスを生成します。<code>HandlerContents</code> 型の各コンストラクタはリダイレクトやファイル送信など、実行する明確なアクションを与えます。他のすべての例外型では、エラーメッセージがユーザに表示されます。</p>
<h2 id="ディスパッチ">ディスパッチ</h2>
<p>ディスパッチというのは入ってくるリクエストを受け取り、適切なレスポンスを生成することです。ディスパッチの方法によっていくつかの異なる制約があります。</p>
<ul>
<li>パスの断片 (あるいは一片) に基づいたディスパッチ</li>
<li>リクエストメソッドに基づいた任意ディスパッチ</li>
<li>サブサイトのサポート。特定の URL プレフィックスの下、複数のルートを与える機能を持つパッケージ化されたコレクション</li>
<li>WAI アプリケーションをサブサイトとして利用することをサポートする一方で、プロセスに対しできる限り実行時オーバーヘッドをかけないようにする。特に、必要なければ YesodRequest を生成するための不必要なパージンングを行うことを避けたい。</li>
</ul>
<p>こらを全て満たすためには単に WAI <code>Application</code> を利用すれば良いでしょう。しかし、そうすると十分な情報は提供されません。私たちはファウンデーション型、ロガー、サブサイトのルートから親サイトのルートへの変換方法などの情報にアクセスする必要があります。これに対処するために2つの補助的なデータ型 <code>YesodRunnerEnv</code> と <code>YesodSubRunnerEnv</code> があります。これらは、追加情報を通常のサイトとサブサイトに与えます。</p>
<p>これらの型を利用することでディスパッチは今や比較的単純なものになります。環境とリクエストを与えれば、レスポンスが返ってくるでしょう。これは <code>YesodDispatch</code> と <code>YesodSubDispatch</code> により表現されます。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">Yesod</span> site <span class="ot">=&gt;</span> <span class="dt">YesodDispatch</span> site <span class="kw">where</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    yesodDispatch ::</span> <span class="dt">YesodRunnerEnv</span> site <span class="ot">-&gt;</span> <span class="dt">W.Application</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">YesodSubDispatch</span> sub m <span class="kw">where</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ot">    yesodSubDispatch ::</span> <span class="dt">YesodSubRunnerEnv</span> sub (<span class="dt">HandlerSite</span> m) m</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                     <span class="ot">-&gt;</span> <span class="dt">W.Application</span></span></code></pre></div>
<p>少し後で <code>YesodSubDispatch</code> の使い方をお見せします。その前に、<code>YesodDispatch</code> がどのように動作するか理解することから始めましょう。</p>
<h2 id="towaiapp-towaiappplain-and-warp">toWaiApp, toWaiAppPlain, and warp</h2>
<p>さて、とりあえず <code>YesodDispatch</code> のインスタンスになっているデータ型があるとしましょう。今、何らかの方法で実際にこれを実行したいです。そのためには WAI <code>Application</code> に変換し、何らかの WAI ハンドラ/サーバへ受け渡す必要があります。これらを行うために、まずは <code>toWaiAppPlain</code> を使います。この関数は必要となるあらゆるアプリケーション毎の初期化を行います。執筆時では、これはロガーを配置し、セッションバックエンドをセットアップすることを意味していますが、将来的に他の機能が追加されるかもしれません。このデータを用いて、<code>YesodRunnerEnv</code> を作ることができます。そして、その値が <code>YesodDispatch</code> に受け渡されると WAI <code>Application</code> になります。</p>
<p>これでほとんど終わりです。最後に残った変更はパス断片のクリーンアップです。<code>Yesod</code> 型クラスは正規化された URL を作るための <code>cleanPath</code> と呼ばれるメンバ関数を含みます。例えば、デフォルトの実装ではダブルスラッシュは取り除かれ、ユーザを <code>/foo//bar</code> から <code>/foo/bar</code> にリダイレクトします。<code>toWaiAppPlain</code> は必要に応じてリクエストされたパスを分析し、クリーンアップ/リダイレクトを実行することで標準的な WAI リクエストに対して何らかの前処置を追加します。</p>
<p>この時点で完全に機能する WAI <code>Appplication</code> を手に入れたことになります。そのほかに2つの補助関数が含まれています。 <code>toWaiApp</code> は <code>toWaiAppPlain</code> をラップし、さらに一般的に用いられる WAI ミドルウェアを含みます。その中には、リクエストログや GZIP 圧縮が含まれます (最新のリストについては Haddock を参照してください)。最後に <code>warp</code> 関数は推察の通り Warp によりアプリケーションを実行します。</p>
<div class="yesod-book-notice">
<p>同様に <code>PORT</code> 環境変数からポート番号情報を読む <code>warpEnv</code> 関数も存在します。これは、Keter デプロイメントマネージャーや FP Haskell Center などのいくつかのツールと相互作用するために利用されます。</p>
</div>
<h2 id="生成されたコード">生成されたコード</h2>
<p>最後に残ったブラックボックスは Tempkate Haskell で生成されたコードです。この生成されたコードはサイトの退屈でエラーに陥りやすい部分を担当しています。もし望むのであれば、代わりにこれらすべてを手書きすることもできます。翻訳がどのようになるかを実際に確認し、このプロセスにおいてどのように YesodDispatch と YesodSubDispatch が機能するかを解明します。どこにでもあるような Yesod アプリケーション例から始めましょう。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE QuasiQuotes       #-}</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TemplateHaskell   #-}</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TypeFamilies      #-}</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE ViewPatterns      #-}</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Lazy.Char8</span> <span class="kw">as</span> <span class="dt">L8</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.HTTP.Types</span>         (status200)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai</span>                (pathInfo, rawPathInfo,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>                                             requestMethod, responseLBS)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">App</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>mkYesod <span class="st">&quot;App&quot;</span> [parseRoutes|</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>/only-get       OnlyGetR   GET</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>/any-method     AnyMethodR</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>/has-param/#Int HasParamR  GET</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>/my-subsite     MySubsiteR WaiSubsite getMySubsite</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>|]</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Yesod</span> <span class="dt">App</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="ot">getOnlyGetR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>getOnlyGetR <span class="ot">=</span> defaultLayout</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    [whamlet|</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;p&gt;</span>Accessed via GET method</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;form </span><span class="er">method=post</span><span class="kw"> </span><span class="er">action=@{AnyMethodR}</span><span class="kw">&gt;</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;button&gt;</span>POST to /any-method</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    |]</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="ot">handleAnyMethodR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>handleAnyMethodR <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    req <span class="ot">&lt;-</span> waiRequest</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    defaultLayout</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        [whamlet|</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;p&gt;</span>In any-method, method == <span class="kw">#{</span><span class="fu">show</span> <span class="op">$</span> requestMethod req<span class="kw">}</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>        |]</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a><span class="ot">getHasParamR ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> <span class="dt">String</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>getHasParamR i <span class="ot">=</span> <span class="fu">return</span> <span class="op">$</span> <span class="fu">show</span> i</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a><span class="ot">getMySubsite ::</span> <span class="dt">App</span> <span class="ot">-&gt;</span> <span class="dt">WaiSubsite</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>getMySubsite _ <span class="ot">=</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">WaiSubsite</span> app</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    app req sendResponse <span class="ot">=</span> sendResponse <span class="op">$</span> responseLBS</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        status200</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>        [(<span class="st">&quot;Content-Type&quot;</span>, <span class="st">&quot;text/plain&quot;</span>)]</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">$</span> L8.pack <span class="op">$</span> <span class="fu">concat</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>            [ <span class="st">&quot;pathInfo == &quot;</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>            , <span class="fu">show</span> <span class="op">$</span> pathInfo req</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>            , <span class="st">&quot;, rawPathInfo == &quot;</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>            , <span class="fu">show</span> <span class="op">$</span> rawPathInfo req</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> warp <span class="dv">3000</span> <span class="dt">App</span></span></code></pre></div>
<p>完全性のために全てのコードを掲載しましたが、ここでは Template Haskell の部分にのみ着目しましょう。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>mkYesod <span class="st">&quot;App&quot;</span> [parseRoutes|</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>/only-get       OnlyGetR   GET</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>/any-method     AnyMethodR</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>/has-param/#Int HasParamR  GET</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>/my-subsite     MySubsiteR WaiSubsite getMySubsite</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>|]</span></code></pre></div>
<p>これは少しのコードしか生成しませんが、サイトが機能するために3つの要素にのみ再現すれば良いです。もっとも簡単なものは <code>Handler</code>型シノニムです。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Handler</span> <span class="ot">=</span> <span class="dt">HandlerT</span> <span class="dt">App</span> <span class="dt">IO</span></span></code></pre></div>
<p>次は型安全 URL とそのレンダリング関数です。レンダリング関数はパス断片とクエリ文字列パラメータの両方を生成できます。標準的な Yesod サイトはクエリ文字列パラメータを絶対に生成しませんが、技術的には可能です。これは、サブサイトでたまに必要になる。以下の <code>MySubsiteR</code> において、qs パラメータの処理方法に注目してください。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">RenderRoute</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">data</span> <span class="dt">Route</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">OnlyGetR</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                   <span class="op">|</span> <span class="dt">AnyMethodR</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                   <span class="op">|</span> <span class="dt">HasParamR</span> <span class="dt">Int</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                   <span class="op">|</span> <span class="dt">MySubsiteR</span> (<span class="dt">Route</span> <span class="dt">WaiSubsite</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Read</span>, <span class="dt">Eq</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    renderRoute <span class="dt">OnlyGetR</span> <span class="ot">=</span> ([<span class="st">&quot;only-get&quot;</span>], [])</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    renderRoute <span class="dt">AnyMethodR</span> <span class="ot">=</span> ([<span class="st">&quot;any-method&quot;</span>], [])</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    renderRoute (<span class="dt">HasParamR</span> i) <span class="ot">=</span> ([<span class="st">&quot;has-param&quot;</span>, toPathPiece i], [])</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    renderRoute (<span class="dt">MySubsiteR</span> subRoute) <span class="ot">=</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> (ps, qs) <span class="ot">=</span> renderRoute subRoute</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>         <span class="kw">in</span> (<span class="st">&quot;my-subsite&quot;</span> <span class="op">:</span> ps, qs)</span></code></pre></div>
<p>高レベルのルート構文と RenderRoute インスタンスからのかなり単純なマッピングがあるのが分かるでしょう。各ルートは構成子になり、各 URL パラメータはその構成子に対する引数になります。サブサイトに対しルートを埋め込み、パラメータをテキストにレンダリングするために <code>toPathPiece</code> を使います。</p>
<p>最後の要素は <code>YesodDispatch</code> インスタンスです。これを少しのコードで見てみましょう。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">YesodDispatch</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    yesodDispatch env req <span class="ot">=</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">case</span> pathInfo req <span class="kw">of</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>            [<span class="st">&quot;only-get&quot;</span>] <span class="ot">-&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>                <span class="kw">case</span> requestMethod req <span class="kw">of</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;GET&quot;</span> <span class="ot">-&gt;</span> yesodRunner</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>                        getOnlyGetR</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>                        env</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>                        (<span class="dt">Just</span> <span class="dt">OnlyGetR</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>                        req</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>                    _ <span class="ot">-&gt;</span> yesodRunner</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>                        (badMethod <span class="op">&gt;&gt;</span> <span class="fu">return</span> ())</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                        env</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>                        (<span class="dt">Just</span> <span class="dt">OnlyGetR</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>                        req</span></code></pre></div>
<p>先ほど説明したように <code>yesodDispatch</code> には環境と WAI <code>Request</code> の値が渡されます。私たちは現在、リクエストパスあるいは WAI の用語でいうと <code>pathInfo</code> に基づきディスパッチを行います。元の高レベルのルート構文を参照し直すと、最初のルートは単一断片の only-get なので今回パターンマッチするものになります。</p>
<p>一度そのマッチが成功すればリクエストメソッドに基づき、さらにパターンマッチを行います。もし、それが <code>GET</code> であれば <code>getOnlyGetR</code> ハンドラ関数を利用する。それ以外は 405 bad method レスポンスを返したいので、<code>badMethod</code> ハンドラ関数を使います。この時点で、オリジナルのハンドラに関する討論を完全に一周しました。ハンドラ関数を実行するために <code>yesodRunner</code> 関数を利用していることがわかると思います。<code>yesodRunner</code> は環境と WAI <code>Request</code> を取り、<code>RunHandlerEnv</code> を構築し、それをハンドラ関数に渡した結果の <code>YesodResponse</code> を WAI <code>Response</code> に変換する関数だったことを思い出してください。</p>
<p>素晴らしい！1つ終わりました。残りはあと3つです。次はさらに簡単です。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>            [<span class="st">&quot;any-method&quot;</span>] <span class="ot">-&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                yesodRunner handleAnyMethodR env (<span class="dt">Just</span> <span class="dt">AnyMethodR</span>) req</span></code></pre></div>
<p><code>onlyGetR</code> と違って <code>AnyMethodR</code> はどんなリクエストメソッドに対しても機能するため、これ以上のパターンマッチは必要ありません。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>            [<span class="st">&quot;has-param&quot;</span>, t] <span class="op">|</span> <span class="dt">Just</span> i <span class="ot">&lt;-</span> fromPathPiece t <span class="ot">-&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                <span class="kw">case</span> requestMethod req <span class="kw">of</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;GET&quot;</span> <span class="ot">-&gt;</span> yesodRunner</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                        (getHasParamR i)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                        env</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                        (<span class="dt">Just</span> <span class="op">$</span> <span class="dt">HasParamR</span> i)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>                        req</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                    _ <span class="ot">-&gt;</span> yesodRunner</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>                        (badMethod <span class="op">&gt;&gt;</span> <span class="fu">return</span> ())</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>                        env</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>                        (<span class="dt">Just</span> <span class="op">$</span> <span class="dt">HasParamR</span> i)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>                        req</span></code></pre></div>
<p>ここで、動的パラメータという複雑なものを追加します。前の例では <code>toPathPiece</code> を使ってテキスト値にレンダリングしましたが、今回は <code>fromPathPiece</code> を利用してパージングを行います。パーズが成功すると、次に <code>OnlyGetR</code> と非常に類似したディスパッチシステムによって処理される。主要な相違点としては、パラメータをハンドラ関数とルートのデータコンストラクタの両方に渡す必要があるという点です。</p>
<p>次にサブサイトについて見てみましょう。これは、今までとかなり違ったものになります。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>            (<span class="st">&quot;my-subsite&quot;</span><span class="op">:</span>rest) <span class="ot">-&gt;</span> yesodSubDispatch</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                <span class="dt">YesodSubRunnerEnv</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                    { ysreGetSub <span class="ot">=</span> getMySubsite</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                    , ysreParentRunner <span class="ot">=</span> yesodRunner</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                    , ysreToParentRoute <span class="ot">=</span> <span class="dt">MySubsiteR</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                    , ysreParentEnv <span class="ot">=</span> env</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>                req { pathInfo <span class="ot">=</span> rest }</span></code></pre></div>
<p>他のパターンマッチと違って、ここではパターンの接頭辞が一致するかを見るだけです。<code>/my-subsite</code> で始まるルートはすべて、処理のためにサブサイトを通過するべきです。これは最終的に <code>yesodSubDispatch</code> を用いることになる場所です。この関数は <code>yesodDispatch</code> をかなり反映しています。私たちは yesodSubDispatch に渡される新しい環境を構築する必要があります。4つのフィールドについて議論しましょう。</p>
<ul>
<li><code>ysreGetSub</code> はサブサイトのファウンデーション型をマスターサイトから取得する方法を明示しています。ここでは <code>getMySubsite</code> を与えていますが、これは高レベルのルート構文において提供される関数です。</li>
<li><code>ysreParentRunner</code> はハンドラ関数を実行するための方法を与えます。単に <code>yesodRunner</code> を与えるだけではつまらないように見えるかもしれませんが、別々のパラメータを持つことで深くネストされたサブサイトの構築が可能となるため、相互的なサブサイトにおける多くの層をラップしたり、アンラップしたりできます。(これは、より進んだ概念なのでこの章でカバーしません)</li>
<li><code>ysreToParentRoute</code> はサブサイトのルートを親サイトのルートに変換します。これは <code>MySubsiteR</code> 構成子の目的です。これにより、サブサイトが <code>getRouteToParent</code> のような関数を使うことができるようになります。</li>
<li><code>ysreParentEnv</code> は単に初期環境を渡すだけです。この初期環境には、サブサイトがたぶん必要となる (ロガーのような) 多くのものを含みます。</li>
</ul>
<p>他の興味深いことは、どのように <code>pathInfo</code> を変更するかということです。これにより、サブサイトが親サイトが去った場所からディスパッチを継続 (<em>continue dispatching</em>) することが可能になります。これがどのように機能するか確認するために、次の図の様々なリクエストのスクリーンショットを見てください。</p>
<p><span style="font-size: 1.6rem; display: block;">Path info in subsite</span> <img src="https://www.yesodweb.com/book-1.4/image/subsite-path-info" alt="image/subsite-path-info" /></p>
<p>そして最後に、すべてのリクエストが妥当なルートであるとは限りません。そのような場合は単に 404 not found で対応したいです。</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>            _ <span class="ot">-&gt;</span> yesodRunner (notFound <span class="op">&gt;&gt;</span> <span class="fu">return</span> ()) env <span class="dt">Nothing</span> req</span></code></pre></div>
<h2 id="完全なコード">完全なコード</h2>
<p>以下は Template Haskell を使わずに書いた完全なコードです。</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE QuasiQuotes       #-}</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TemplateHaskell   #-}</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TypeFamilies      #-}</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE ViewPatterns      #-}</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Lazy.Char8</span> <span class="kw">as</span> <span class="dt">L8</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.HTTP.Types</span>         (status200)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai</span>                (pathInfo, rawPathInfo,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>                                             requestMethod, responseLBS)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod.Core.Types</span>           (<span class="dt">YesodSubRunnerEnv</span> (..))</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">App</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">RenderRoute</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">data</span> <span class="dt">Route</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">OnlyGetR</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>                   <span class="op">|</span> <span class="dt">AnyMethodR</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>                   <span class="op">|</span> <span class="dt">HasParamR</span> <span class="dt">Int</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>                   <span class="op">|</span> <span class="dt">MySubsiteR</span> (<span class="dt">Route</span> <span class="dt">WaiSubsite</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Read</span>, <span class="dt">Eq</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    renderRoute <span class="dt">OnlyGetR</span> <span class="ot">=</span> ([<span class="st">&quot;only-get&quot;</span>], [])</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    renderRoute <span class="dt">AnyMethodR</span> <span class="ot">=</span> ([<span class="st">&quot;any-method&quot;</span>], [])</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    renderRoute (<span class="dt">HasParamR</span> i) <span class="ot">=</span> ([<span class="st">&quot;has-param&quot;</span>, toPathPiece i], [])</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    renderRoute (<span class="dt">MySubsiteR</span> subRoute) <span class="ot">=</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> (ps, qs) <span class="ot">=</span> renderRoute subRoute</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>         <span class="kw">in</span> (<span class="st">&quot;my-subsite&quot;</span> <span class="op">:</span> ps, qs)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Handler</span> <span class="ot">=</span> <span class="dt">HandlerT</span> <span class="dt">App</span> <span class="dt">IO</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Yesod</span> <span class="dt">App</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">YesodDispatch</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    yesodDispatch env req <span class="ot">=</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>        <span class="kw">case</span> pathInfo req <span class="kw">of</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>            [<span class="st">&quot;only-get&quot;</span>] <span class="ot">-&gt;</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>                <span class="kw">case</span> requestMethod req <span class="kw">of</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;GET&quot;</span> <span class="ot">-&gt;</span> yesodRunner</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>                        getOnlyGetR</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>                        env</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>                        (<span class="dt">Just</span> <span class="dt">OnlyGetR</span>)</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>                        req</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>                    _ <span class="ot">-&gt;</span> yesodRunner</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>                        (badMethod <span class="op">&gt;&gt;</span> <span class="fu">return</span> ())</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>                        env</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>                        (<span class="dt">Just</span> <span class="dt">OnlyGetR</span>)</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>                        req</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>            [<span class="st">&quot;any-method&quot;</span>] <span class="ot">-&gt;</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>                yesodRunner handleAnyMethodR env (<span class="dt">Just</span> <span class="dt">AnyMethodR</span>) req</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>            [<span class="st">&quot;has-param&quot;</span>, t] <span class="op">|</span> <span class="dt">Just</span> i <span class="ot">&lt;-</span> fromPathPiece t <span class="ot">-&gt;</span></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>                <span class="kw">case</span> requestMethod req <span class="kw">of</span></span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;GET&quot;</span> <span class="ot">-&gt;</span> yesodRunner</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>                        (getHasParamR i)</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>                        env</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>                        (<span class="dt">Just</span> <span class="op">$</span> <span class="dt">HasParamR</span> i)</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>                        req</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>                    _ <span class="ot">-&gt;</span> yesodRunner</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>                        (badMethod <span class="op">&gt;&gt;</span> <span class="fu">return</span> ())</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>                        env</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>                        (<span class="dt">Just</span> <span class="op">$</span> <span class="dt">HasParamR</span> i)</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>                        req</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>            (<span class="st">&quot;my-subsite&quot;</span><span class="op">:</span>rest) <span class="ot">-&gt;</span> yesodSubDispatch</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>                <span class="dt">YesodSubRunnerEnv</span></span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>                    { ysreGetSub <span class="ot">=</span> getMySubsite</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>                    , ysreParentRunner <span class="ot">=</span> yesodRunner</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>                    , ysreToParentRoute <span class="ot">=</span> <span class="dt">MySubsiteR</span></span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>                    , ysreParentEnv <span class="ot">=</span> env</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>                req { pathInfo <span class="ot">=</span> rest }</span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>            _ <span class="ot">-&gt;</span> yesodRunner (notFound <span class="op">&gt;&gt;</span> <span class="fu">return</span> ()) env <span class="dt">Nothing</span> req</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a><span class="ot">getOnlyGetR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>getOnlyGetR <span class="ot">=</span> defaultLayout</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>    [whamlet|</span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;p&gt;</span>Accessed via GET method</span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;form </span><span class="er">method=post</span><span class="kw"> </span><span class="er">action=@{AnyMethodR}</span><span class="kw">&gt;</span></span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;button&gt;</span>POST to /any-method</span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>    |]</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a><span class="ot">handleAnyMethodR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a>handleAnyMethodR <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a>    req <span class="ot">&lt;-</span> waiRequest</span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>    defaultLayout</span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a>        [whamlet|</span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;p&gt;</span>In any-method, method == <span class="kw">#{</span><span class="fu">show</span> <span class="op">$</span> requestMethod req<span class="kw">}</span></span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a>        |]</span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a><span class="ot">getHasParamR ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> <span class="dt">String</span></span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a>getHasParamR i <span class="ot">=</span> <span class="fu">return</span> <span class="op">$</span> <span class="fu">show</span> i</span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a><span class="ot">getMySubsite ::</span> <span class="dt">App</span> <span class="ot">-&gt;</span> <span class="dt">WaiSubsite</span></span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>getMySubsite _ <span class="ot">=</span></span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a>    <span class="dt">WaiSubsite</span> app</span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a>    app req sendResponse <span class="ot">=</span> sendResponse <span class="op">$</span> responseLBS</span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>        status200</span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a>        [(<span class="st">&quot;Content-Type&quot;</span>, <span class="st">&quot;text/plain&quot;</span>)]</span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a>        <span class="op">$</span> L8.pack <span class="op">$</span> <span class="fu">concat</span></span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>            [ <span class="st">&quot;pathInfo == &quot;</span></span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a>            , <span class="fu">show</span> <span class="op">$</span> pathInfo req</span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a>            , <span class="st">&quot;, rawPathInfo == &quot;</span></span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a>            , <span class="fu">show</span> <span class="op">$</span> rawPathInfo req</span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-105"><a href="#cb15-105" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb15-106"><a href="#cb15-106" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> warp <span class="dv">3000</span> <span class="dt">App</span></span></code></pre></div>
<h2 id="結論">結論</h2>
<p>Yesod は開発者から見えないように、かなり多くの配管作業を抽象化して隠しています。この大部分は喜んで無視するようなボイラープレートコードです。しかし、水面下で何か起こっているかということを正確に理解すれば、Yesod を使ってできることがもっと増えることでしょう。現時点で、Haddock の助けを借りることで、たぶんですが、自動生成される Template Haskell コードが無くてもサイトを書くことができると思います。しかし、それは推奨していません。生成コードを用いる方が簡単で安全です。</p>
<p>この章を理解することで1つ特に有益なことは、WAI の世界のどこに Yesod が位置しているかわかるようになることです。これによって、どのように Yesod が WAI ミドルウェアと相互作用しているか、Yesod アプリケーションの他の WAI フレームワークからコードをインクルードする方法を簡単に確認できるようになります (逆もまた然り!)。</p>
      </article>

      <div class="pager">
      
      
      </div>

      <div class="row">
        <div class="col s6 offset-s6" style="position: relative; height: 100px;">
          <div class="fixed-action-btn horizontal" style="position: absolute; display: inline-block; right: 24px;">
  <a class="btn-floating btn-large red">
    <i class="large material-icons">share</i>
  </a>
  <ul>
    <li>
      <a class="btn-floating waves-effect waves-light blue tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Twitter" href="https://twitter.com/intent/tweet?text=リクエストを理解する&url=https://haskell.e-bigmoon.com/yesod/book/ch18-understanding-a-request.html"><i class="mdi mdi-twitter white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light indigo tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Facebook" href="https://facebook.com/sharer.php?u=https://haskell.e-bigmoon.com/yesod/book/ch18-understanding-a-request.html"><i class="mdi mdi-facebook white-text"></i></a>
    </li>
  </ul>
</div>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
    </div>

    <footer class="page-footer indigo lighten-1">
  <div class="footer-copyright">
    <div class="container">
      © 2017-2020 BIGMOON&nbsp;
      Site proudly generated by <a class="red-text text-accent-1" href="http://jaspervdj.be/hakyll">Hakyll</a>,&nbsp;
      original Jekyll theme by <a class="red-text text-accent-1" href="https://github.com/mumuxme/materialize-jekyll">mumuxme</a>.
    </div>
  </div>
</footer>


    <!-- scrolltop button -->
    <button class="material-scrolltop waves-effect waves-light hide-on-small-only" type="button">
      <i class="mdi mdi-arrow-up-bold small white-text"></i>
    </button>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-19322672-9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-19322672-9');
    </script>

    <!-- jquery -->
    <script type="text/javascript" src="../../lib/jquery-min.js"></script>
    <!-- materialize -->
    <script src="../../lib/materialize/js/materialize.min.js"></script>
    <!-- <\!-- Material ScrollTop plugin -\-> -->
    <script src="../../lib/material-scrolltop/material-scrolltop.js"></script>
    <!-- main -->
    <script src="../../js/init.js"></script>
    <script src="../../js/main.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/haskell.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/yaml.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/shell.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/bash.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>

</html>
