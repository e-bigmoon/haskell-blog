<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">

  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
  <!-- MUST in hex format, may the same as header-color. This color is for android chrome browser. -->
  <meta name="theme-color" content="#5c6bc0">

  <!-- Metadata. -->
  <meta name="keywords" content="haskell,blog,bigmoon" />
  <title>認証と認可</title>
  <meta name="description" content="BIG MOON">
  <link rel="canonical" href="../../yesod/book/ch14-authentication-and-authorization.html">
  <link rel="alternate" type="application/atom+xml" title="認証と認可" href="../../feed.xml" />
  <link rel="shortcut icon" href="../../images/favicon.ico" />
  <meta name="google-site-verification" content="X2YNboLvzw3_bclXLMvohyJDqj68D06_hPDMukRbgTs" />

  <!-- Stylesheets. -->
  <link rel="stylesheet" href="../../lib/materialize/css/materialize.min.css" />
  <link rel="stylesheet" href="../../css/main.css" />
  <link media="all" rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/3.3.92/css/materialdesignicons.min.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="../../lib/material-scrolltop/material-scrolltop.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" />

  <!-- OGP -->
  <meta property="og:title" content="認証と認可" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="/yesod/book/ch14-authentication-and-authorization.html" />
  <!-- <meta property="og:image" content=" サムネイル画像の URL" /> -->
  <meta property="og:site_name" content="認証と認可" />
  <meta property="og:description" content="BIG MOON" />

  <meta name="twitter:card" content="summary" />
  <!-- <meta name="twitter:site" content="@[ Twitter ID]" /> -->
  <!-- <meta name="twitter:player" content="@[ Twitter ID]" /> -->

  <noscript>
  <div class="notice-warning noscript">You don't have javascript enabled. Good luck! :(</div>
</noscript>

<!--[if IE]>
  <div class="notice-warning">Oh, you are using Internet Explorer! Good luck... :(</div>
<![endif]-->

</head>


  <body>
    <header class="site-header">
      <nav class="nav-extended indigo lighten-1">
        <div class="nav-wrapper">
  <a href="../../"><span class="site-title">BIGMOON Haskeller's BLOG</span></a>
  <a href="#" data-activates="mobile-navbar" class="button-collapse">
    <i class="mdi mdi-menu white-text"></i>
  </a>

  <ul id="nav-mobile" class="right hide-on-med-and-down">
    <li>
      <a href="../../" class="white-text">
        <i class="mdi mdi-home left indigo-text text-lighten-3"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="white-text">
        <i class="mdi mdi-account-circle left indigo-text text-lighten-3"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../stack/" class="white-text">
        <i class="mdi mdi-wrench left indigo-text text-lighten-3"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/index.html" class="white-text">
        <i class="mdi mdi-comment-question-outline left indigo-text text-lighten-3"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="white-text">
        <i class="mdi mdi-package-variant left indigo-text text-lighten-3"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="white-text">
        <i class="mdi mdi-earth left indigo-text text-lighten-3"></i>
        Yesod
      </a>
    </li>
    <li>
      <a href="../../contact.html" class="white-text">
        <i class="mdi mdi-lead-pencil left indigo-text text-lighten-3"></i>
        Contact
      </a>
    </li>
    <li>
      <a href="../../feed.xml" class="white-text">
        <i class="mdi mdi-rss left indigo-text text-lighten-3"></i>
        Feed
      </a>
    </li>
  </ul>

  <ul class="side-nav" id="mobile-navbar">
    <li>
      <a href="../../" class="waves-effect waves-teal black-text">
        <i class="mdi mdi-home left green-text"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="navbar-text-colour-mobile">
        <i class="mdi mdi-account-circle left blue-text"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../stack/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-wrench left blue-text"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-comment-question-outline left blue-text"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-package-variant left blue-text"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-earth left blue-text"></i>
        Yesod
      </a>
    </li>
    <li>
      <a href="../../contact.html" class="navbar-text-colour-mobile">
        <i class="mdi mdi-lead-pencil left blue-text"></i>
        Contact
      </a>
    </li>
  </ul>
</div>

      </nav>
    </header>

    <div class="site-container" id="tab-main">
      <div class="wrapper">
        <div class="post-ribbon"></div>

<div class="container page-container">
  <div class="post-page card-panel z-depth-2">
    <div class="post-section">
      <div class="post-heading">
        <h1 class="post-title">認証と認可</h1>
        
        <span>最終更新日: 2019/01/20</span>
        
      </div>

      <article class="page-content">
        <p>認証と認可はとても良く似ていますが、それぞれ異なる概念です。認証はユーザを識別し、認可はユーザの権限を決定します。残念なことに、これらの用語はどちらも “auth” と省略されるため、両者の概念を混同してしまう場合があります。</p>
<p>Yesod は OpenID、BrowserID や OAuth のような多くの第三者認証システムを組み込めるようになっています。つまり、これらの第三者認証システムを組み込むということは、アプリケーションはユーザの認証情報の検証に関して、外部のシステムを信頼すると言うことになります。また、良くある username/password や email/password を使った認証システムについても同様にサポートしています。第三者認証システムの方式ではユーザ (新しいパスワードを覚えずに済む) と実装者 (セキュリティアーキテクチャ全体を扱う必要がなくなる) にとって簡単にはなりますが、開発者が制御できる範囲という視点で考えれば自前の認証システムの方が柔軟です。</p>
<p>認可については REST と型安全URLの長所を活かすことで、シンプルかつ宣言的なシステムを作ることができます。さらに、認可に関するのコードは全て Haskell で記述されているため、ユーザは自分の好きなようにカスタマイズすることもできます。</p>
<p>この章では、Yesod で認証を扱う方法と、異なる認証システムの選択におけるトレードオフについて議論します。</p>
<h2 id="概略">概略</h2>
<p>yesod-auth パッケージはいくつもの異なる認証プラグインのための共通インターフェースを提供します。これらのバックエンドには一意な文字列に基づいてユーザを識別することが求められます。例えば OpenID の場合、一意な文字列は実際の OpenID 値になるでしょう。 BrowserID では、メールアドレス、さらに HashDB (ハッシュ化されたパスワードのデータベースを用いる) では、ユーザ名に相当します。</p>
<p>各認証プラグインは、ログインするための独自システムを提供します。ログインシステムは外部サイトや email/password フォーム経由でトークンをやり取りします。ログインが成功すると、プラグインはユーザのセッションに値にユーザを表す <code>AuthId</code> を設定します。この<code>AuthId</code> は基本的には、ユーザを追跡するために用いられるテーブルからの Persistent ID です。</p>
<p>ユーザの <code>AuthId</code> を問い合わせるための関数のうち、よく使うものとしては <code>maybeAuthId</code>、<code>requireAuthId</code>、<code>maybeAuth</code>、<code>requireAuth</code> などがあります。“require” が付く関数はユーザがログインしていなければログインページにリダイレクトします。また、関数名が <code>Id</code> で終わらない関数はテーブルIDとエンティティ値の両方を返します。</p>
<p><code>AuthId</code> の全てのストレージはセッション上に作られるため、セッションのルールが適用されます。特に、データは暗号化された上でHMAC化したクライアントクッキーに保存され、アクティブでない期間が設定した値を超えると自動的にタイムアウトします。さらに、セッションにはサーバサイドの要素は何も含まれないため、ログアウトはセッションクッキーからデータを削除するだけです。そのため、仮にユーザが古いクッキー値を再利用したとしても、そのセッションはまだ有効なはずです。</p>
<div class="yesod-book-notice">
<p>もし望むのであれば、デフォルトのクライアントサイドセッションをサーバサイドセッションに置き換えることで、強制ログアウト機能を実装できます。また、中間者 (MITM) 攻撃からユーザのセッションを保護したいのであれば、SSL を有効にし、セッションの章で紹介した <code>sslOnlySessions</code> や <code>sslOnlyMiddleware</code> を使ってセッションを堅牢にすべきです。</p>
</div>
<p>認証が yesod-auth パッケージによって処理される一方で、認可は <code>Yesod</code> 型クラスのいくつかのメソッドによって処理されます。各リクエストに対してこれらのメソッドは、アクセスが許可/拒否されているか、ユーザを認証する必要があるかどうかを確認するために実行されます。デフォルトでは、これらのメソッドはどのリクエストも許可しています。型クラスを利用せずに、個々のハンドラ関数に <code>requireAuth</code> の呼び出しを追加することで、認可をよりアドホックに実装することもできます。しかし、このやり方は宣言的な認可システムの多くの利点を損ねることになります。</p>
<h2 id="自分を認証してみよう">自分を認証してみよう</h2>
<p>認証の例に取り組んでみましょう。Google OAuth 認証を動かすためには、次のステップに従う必要があります。</p>
<ol type="1">
<li><a href="https://developers.google.com/identity/protocols/OAuth2">Google Developers Help</a> を読んで OAuth 2.0 認証情報の取得方法について確認しましょう。認証情報はクライアントIDと、Google とあなたのアプリケーションだけが共有するクライアントシークレットです。</li>
<li><code>Authorized redirect URIs</code> を <code>http://localhost:3000/auth/page/googleemail2/complete</code> に設定します。</li>
<li><code>Google+ API</code> と <code>Contacts API</code> を有効にしましょう。</li>
<li>取得した <code>clientId</code> と <code>secretID</code> の値を、以下のコードの <code>clientId</code> と <code>clientSecret</code> にセットしましょう。</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="ot">{-# LANGUAGE MultiParamTypeClasses #-}</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="ot">{-# LANGUAGE OverloadedStrings     #-}</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="ot">{-# LANGUAGE QuasiQuotes           #-}</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="ot">{-# LANGUAGE TemplateHaskell       #-}</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="ot">{-# LANGUAGE TypeFamilies          #-}</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="kw">import</span>           <span class="dt">Data.Default</span>                (def)</a>
<a class="sourceLine" id="cb1-7" title="7"><span class="kw">import</span>           <span class="dt">Data.Text</span>                   (<span class="dt">Text</span>)</a>
<a class="sourceLine" id="cb1-8" title="8"><span class="kw">import</span>           <span class="dt">Network.HTTP.Client.Conduit</span> (<span class="dt">Manager</span>, newManager)</a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw">import</span>           <span class="dt">Yesod</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="kw">import</span>           <span class="dt">Yesod.Auth</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="kw">import</span>           <span class="dt">Yesod.Auth.BrowserId</span></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="kw">import</span>           <span class="dt">Yesod.Auth.GoogleEmail2</span></a>
<a class="sourceLine" id="cb1-13" title="13"></a>
<a class="sourceLine" id="cb1-14" title="14"></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="co">-- Replace with Google client ID.</span></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="ot">clientId ::</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb1-17" title="17">clientId <span class="fu">=</span> <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb1-18" title="18"></a>
<a class="sourceLine" id="cb1-19" title="19"><span class="co">-- Replace with Google secret ID.</span></a>
<a class="sourceLine" id="cb1-20" title="20"><span class="ot">clientSecret ::</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb1-21" title="21">clientSecret <span class="fu">=</span> <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb1-22" title="22"></a>
<a class="sourceLine" id="cb1-23" title="23"><span class="kw">data</span> <span class="dt">App</span> <span class="fu">=</span> <span class="dt">App</span></a>
<a class="sourceLine" id="cb1-24" title="24">    {<span class="ot"> httpManager ::</span> <span class="dt">Manager</span></a>
<a class="sourceLine" id="cb1-25" title="25">    }</a>
<a class="sourceLine" id="cb1-26" title="26"></a>
<a class="sourceLine" id="cb1-27" title="27">mkYesod <span class="st">&quot;App&quot;</span> [parseRoutes|</a>
<a class="sourceLine" id="cb1-28" title="28">/ HomeR GET</a>
<a class="sourceLine" id="cb1-29" title="29">/auth AuthR Auth getAuth</a>
<a class="sourceLine" id="cb1-30" title="30">|]</a>
<a class="sourceLine" id="cb1-31" title="31"></a>
<a class="sourceLine" id="cb1-32" title="32"><span class="kw">instance</span> <span class="dt">Yesod</span> <span class="dt">App</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-33" title="33">    <span class="co">-- Note: In order to log in with BrowserID, you must correctly</span></a>
<a class="sourceLine" id="cb1-34" title="34">    <span class="co">-- set your hostname here.</span></a>
<a class="sourceLine" id="cb1-35" title="35">    approot <span class="fu">=</span> <span class="dt">ApprootStatic</span> <span class="st">&quot;http://localhost:3000&quot;</span></a>
<a class="sourceLine" id="cb1-36" title="36"></a>
<a class="sourceLine" id="cb1-37" title="37"><span class="kw">instance</span> <span class="dt">YesodAuth</span> <span class="dt">App</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-38" title="38">    <span class="kw">type</span> <span class="dt">AuthId</span> <span class="dt">App</span> <span class="fu">=</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb1-39" title="39">    authenticate <span class="fu">=</span> <span class="fu">return</span> <span class="fu">.</span> <span class="dt">Authenticated</span> <span class="fu">.</span> credsIdent</a>
<a class="sourceLine" id="cb1-40" title="40"></a>
<a class="sourceLine" id="cb1-41" title="41">    loginDest _ <span class="fu">=</span> <span class="dt">HomeR</span></a>
<a class="sourceLine" id="cb1-42" title="42">    logoutDest _ <span class="fu">=</span> <span class="dt">HomeR</span></a>
<a class="sourceLine" id="cb1-43" title="43"></a>
<a class="sourceLine" id="cb1-44" title="44">    authPlugins _ <span class="fu">=</span> [ authGoogleEmail clientId clientSecret ]</a>
<a class="sourceLine" id="cb1-45" title="45"></a>
<a class="sourceLine" id="cb1-46" title="46">    <span class="co">-- The default maybeAuthId assumes a Persistent database. We're going for a</span></a>
<a class="sourceLine" id="cb1-47" title="47">    <span class="co">-- simpler AuthId, so we'll just do a direct lookup in the session.</span></a>
<a class="sourceLine" id="cb1-48" title="48">    maybeAuthId <span class="fu">=</span> lookupSession <span class="st">&quot;_ID&quot;</span></a>
<a class="sourceLine" id="cb1-49" title="49"></a>
<a class="sourceLine" id="cb1-50" title="50"><span class="kw">instance</span> <span class="dt">RenderMessage</span> <span class="dt">App</span> <span class="dt">FormMessage</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-51" title="51">    renderMessage _ _ <span class="fu">=</span> defaultFormMessage</a>
<a class="sourceLine" id="cb1-52" title="52"></a>
<a class="sourceLine" id="cb1-53" title="53"><span class="ot">getHomeR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></a>
<a class="sourceLine" id="cb1-54" title="54">getHomeR <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-55" title="55">    maid <span class="ot">&lt;-</span> maybeAuthId</a>
<a class="sourceLine" id="cb1-56" title="56">    defaultLayout</a>
<a class="sourceLine" id="cb1-57" title="57">        [whamlet|</a>
<a class="sourceLine" id="cb1-58" title="58">            <span class="kw">&lt;p&gt;</span>Your current auth ID: <span class="kw">#{</span><span class="fu">show</span> maid<span class="kw">}</span></a>
<a class="sourceLine" id="cb1-59" title="59">            <span class="kw">$maybe</span> _ <span class="ot">&lt;-</span> maid</a>
<a class="sourceLine" id="cb1-60" title="60">                <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb1-61" title="61">                    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">AuthR</span> <span class="dt">LogoutR</span><span class="kw">}&gt;</span>Logout</a>
<a class="sourceLine" id="cb1-62" title="62">            <span class="kw">$nothing</span></a>
<a class="sourceLine" id="cb1-63" title="63">                <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb1-64" title="64">                    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">AuthR</span> <span class="dt">LoginR</span><span class="kw">}&gt;</span>Go to the login page</a>
<a class="sourceLine" id="cb1-65" title="65">        |]</a>
<a class="sourceLine" id="cb1-66" title="66"></a>
<a class="sourceLine" id="cb1-67" title="67"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb1-68" title="68">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-69" title="69">    man <span class="ot">&lt;-</span> newManager</a>
<a class="sourceLine" id="cb1-70" title="70">    warp <span class="dv">3000</span> <span class="fu">$</span> <span class="dt">App</span> man</a></code></pre></div>
<p>ルートの宣言から確認していきましょう。まずは、標準的な <code>HomeR</code> ルートを宣言します。次に、認証サブサイトを設定します。サブサイト宣言には、サブサイトへのパス、ルート名、サブサイト名、サブサイト値を取得するための関数という、4つのパラメータが必要でした。つまり、以下のようになります。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="fu">/</span>auth <span class="dt">AuthR</span> <span class="dt">Auth</span> getAuth</a></code></pre></div>
<p>ここで <code>getAuth :: MyAuthSite → Auth</code> を用意する必要がありますが、自分でこの関数を書かなくても yesod-auth が自動的に用意してくれます。他のサブサイト (静的ファイルなど) では、サブサイト値に構築設定を記述するため、取得用の関数を用意する必要があります。auth サブサイトでは、これらの設定は別の <code>YesodAuth</code> 型クラスで行います。</p>
<div class="yesod-book-notice">
<p>なぜ、サブサイト値を使わないのでしょうか？auth サブサイトに対して与えたい設定はいくつもありますが、レコード型から設定するのは不便でしょう。また、<code>AuthId</code> 関連型を持ちたいので、型クラスの方が自然です。では、なぜ全てのサブサイトで型クラスを用いないのでしょうか？その答えは、型クラスを利用するということは各サイトにつきインスタンスを1つしか定義できないことになります。つまり、異なる静的ファイルを異なるルートから取得できなくなってしまいます。また、サブサイト値はアプリケーションの初期化時にデータを読み込みたいという時に、よりうまく機能します。</p>
</div>
<p>では、この <code>YesodAuth</code> インスタンスでは実際に何が起こっているのでしょうか？この型クラスには5つの必須宣言があります。</p>
<ul>
<li><code>AuthId</code> は関連型です。これは、ユーザがログインしているかどうか (<code>maybeAuthId</code> または <code>requireAuthId</code> を通して) を尋ねた時に <code>yesod-auth</code> が与えてくれる値です。今回の場合は単純に <code>Text</code> を使いました。後の例では、未加工の識別子 (今回はメールアドレス) を保存します。</li>
<li><code>authenticate</code> は実際の <code>AuthId</code> を <code>Creds</code> (credentials) 型から取得します。この型は3つの情報を持ちます。使用されている認証バックエンド (今回の場合は googleemial)、実際の識別子、そして、任意の追加情報のための連想リストです。バックエンドによっては異なる追加情報が必要になります。詳細についてはドキュメントを参照してください。</li>
<li><code>loginDest</code> はログインが成功した後のリダイレクト先を設定します。</li>
<li>同様に、<code>logoutDest</code> はログアウト後のリダイレクト先を設定します。</li>
<li><code>authPlugins</code> は使用する個々の認証バックエンドリストです。今回の例では、Google OAuth による Google アカウントを使ったユーザ認証を実装しました。</li>
</ul>
<p>これら5つのメソッドに加えて、ログインページの見た目のような認証システムの別の側面を制御するためのメソッドも同様に用意されています。詳細については <a href="https://www.stackage.org/package/yesod-auth">API ドキュメント</a> を参照してください。</p>
<p>今回の <code>HomeR</code> ハンドラではユーザがログイン状態によって、ログイン/ログアウトページへの簡単なリンクが出現します。ここでは、サブサイトへのリンクの作り方に注目してください。まずは、サブサイトのルート名 (<code>AuthR</code>) 、次に、サブサイト内のルートを与えるだけです (<code>LoginR</code> と <code>LogoutR</code>)。</p>
<h2 id="email">Email</h2>
<p>多くの場合、メールアドレスの第三者認証で十分でしょう。しかし、たまにはユーザがサイト上でパスワードを作れるようにしたいときもあります。 scaffolded サイトは以下の理由で、この設定を含みません。</p>
<ul>
<li>安全にパスワードを受理するためには、アプリケーションを SSL で実行する必要があります。多くのユーザは SSL を使っていません。</li>
<li>email バックエンドは適切にパスワードをソルト付きでハッシュ化していますが、データベースの流出という問題は依然として残ります。さらに、私達は Yesod ユーザが安全なデプロイメント原則に則っていることを想定していません。</li>
<li>email を送信するためのシステムが必要になります。最近、多くのウェブサーバはメールサーバが装備しているような、あらゆるスパム防御処置を行う準備ができていないのです。</li>
</ul>
<div class="yesod-book-notice">
<p>次の例では、システムに組み込まれた sendmail コマンドを利用します。また、自分のメールサーバを用意することが面倒な場合は Amazon SES を使うこともできます。<a href="https://www.stackage.org/package/mime-mail-ses">mime-mail-ses</a> と呼ばれるパッケージを使えば次の例の sendmail を置き換えることができます。これは私が良く推奨する方法なので FP Haskell Center や Haskellers.com を含む私の大部分のサイトで利用しています。</p>
</div>
<p>これらの問題点を理解した上で、自分のサイトに特化したパスワードでログインさせたいという場合には Yesod の組込バックエンドを利用してください。このバックエンドは、データベースへのパスワードの安全な保存するため、さらには、多くの異なる email をユーザに送信する必要があるため (アカウントの検証や、パスワード修復など) 設定にかなり多くのコードが必要です。</p>
<p>それでは、email 認証を行うサイトを作って、パスワードを Persistent SQLite データベースに保存してみましょう。</p>
<div class="yesod-book-notice">
<p>メールサーバが無い場合でも、デバック目的のために認証用リンクがコンソールに表示されます。</p>
</div>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1"><span class="ot">{-# LANGUAGE DeriveDataTypeable         #-}</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="ot">{-# LANGUAGE FlexibleContexts           #-}</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="ot">{-# LANGUAGE GADTs                      #-}</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="ot">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="ot">{-# LANGUAGE MultiParamTypeClasses      #-}</span></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="ot">{-# LANGUAGE OverloadedStrings          #-}</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="ot">{-# LANGUAGE QuasiQuotes                #-}</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="ot">{-# LANGUAGE TemplateHaskell            #-}</span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="ot">{-# LANGUAGE TypeFamilies               #-}</span></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="kw">import</span>           <span class="dt">Control.Monad</span>            (join)</a>
<a class="sourceLine" id="cb3-11" title="11"><span class="kw">import</span>           <span class="dt">Control.Monad.Logger</span>     (runNoLoggingT)</a>
<a class="sourceLine" id="cb3-12" title="12"><span class="kw">import</span>           <span class="dt">Data.Maybe</span>               (isJust)</a>
<a class="sourceLine" id="cb3-13" title="13"><span class="kw">import</span>           <span class="dt">Data.Text</span>                (<span class="dt">Text</span>, unpack)</a>
<a class="sourceLine" id="cb3-14" title="14"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text.Lazy.Encoding</span></a>
<a class="sourceLine" id="cb3-15" title="15"><span class="kw">import</span>           <span class="dt">Data.Typeable</span>            (<span class="dt">Typeable</span>)</a>
<a class="sourceLine" id="cb3-16" title="16"><span class="kw">import</span>           <span class="dt">Database.Persist.Sqlite</span></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="kw">import</span>           <span class="dt">Database.Persist.TH</span></a>
<a class="sourceLine" id="cb3-18" title="18"><span class="kw">import</span>           <span class="dt">Network.Mail.Mime</span></a>
<a class="sourceLine" id="cb3-19" title="19"><span class="kw">import</span>           <span class="dt">Text.Blaze.Html.Renderer.Utf8</span> (renderHtml)</a>
<a class="sourceLine" id="cb3-20" title="20"><span class="kw">import</span>           <span class="dt">Text.Hamlet</span>                   (shamlet)</a>
<a class="sourceLine" id="cb3-21" title="21"><span class="kw">import</span>           <span class="dt">Text.Shakespeare.Text</span>         (stext)</a>
<a class="sourceLine" id="cb3-22" title="22"><span class="kw">import</span>           <span class="dt">Yesod</span></a>
<a class="sourceLine" id="cb3-23" title="23"><span class="kw">import</span>           <span class="dt">Yesod.Auth</span></a>
<a class="sourceLine" id="cb3-24" title="24"><span class="kw">import</span>           <span class="dt">Yesod.Auth.Email</span></a>
<a class="sourceLine" id="cb3-25" title="25"></a>
<a class="sourceLine" id="cb3-26" title="26">share [mkPersist sqlSettings { mpsGeneric <span class="fu">=</span> <span class="dt">False</span> }, mkMigrate <span class="st">&quot;migrateAll&quot;</span>] [persistLowerCase|</a>
<a class="sourceLine" id="cb3-27" title="27">User</a>
<a class="sourceLine" id="cb3-28" title="28">    email Text</a>
<a class="sourceLine" id="cb3-29" title="29">    password Text Maybe -- Password may not be set yet</a>
<a class="sourceLine" id="cb3-30" title="30">    verkey Text Maybe -- Used for resetting passwords</a>
<a class="sourceLine" id="cb3-31" title="31">    verified Bool</a>
<a class="sourceLine" id="cb3-32" title="32">    UniqueUser email</a>
<a class="sourceLine" id="cb3-33" title="33">    deriving Typeable</a>
<a class="sourceLine" id="cb3-34" title="34">|]</a>
<a class="sourceLine" id="cb3-35" title="35"></a>
<a class="sourceLine" id="cb3-36" title="36"><span class="kw">data</span> <span class="dt">App</span> <span class="fu">=</span> <span class="dt">App</span> <span class="dt">SqlBackend</span></a>
<a class="sourceLine" id="cb3-37" title="37"></a>
<a class="sourceLine" id="cb3-38" title="38">mkYesod <span class="st">&quot;App&quot;</span> [parseRoutes|</a>
<a class="sourceLine" id="cb3-39" title="39">/ HomeR GET</a>
<a class="sourceLine" id="cb3-40" title="40">/auth AuthR Auth getAuth</a>
<a class="sourceLine" id="cb3-41" title="41">|]</a>
<a class="sourceLine" id="cb3-42" title="42"></a>
<a class="sourceLine" id="cb3-43" title="43"><span class="kw">instance</span> <span class="dt">Yesod</span> <span class="dt">App</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-44" title="44">    <span class="co">-- Emails will include links, so be sure to include an approot so that</span></a>
<a class="sourceLine" id="cb3-45" title="45">    <span class="co">-- the links are valid!</span></a>
<a class="sourceLine" id="cb3-46" title="46">    approot <span class="fu">=</span> <span class="dt">ApprootStatic</span> <span class="st">&quot;http://localhost:3000&quot;</span></a>
<a class="sourceLine" id="cb3-47" title="47">    yesodMiddleware <span class="fu">=</span> defaultCsrfMiddleware <span class="fu">.</span> defaultYesodMiddleware</a>
<a class="sourceLine" id="cb3-48" title="48"></a>
<a class="sourceLine" id="cb3-49" title="49"><span class="kw">instance</span> <span class="dt">RenderMessage</span> <span class="dt">App</span> <span class="dt">FormMessage</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-50" title="50">    renderMessage _ _ <span class="fu">=</span> defaultFormMessage</a>
<a class="sourceLine" id="cb3-51" title="51"></a>
<a class="sourceLine" id="cb3-52" title="52"><span class="co">-- Set up Persistent</span></a>
<a class="sourceLine" id="cb3-53" title="53"><span class="kw">instance</span> <span class="dt">YesodPersist</span> <span class="dt">App</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-54" title="54">    <span class="kw">type</span> <span class="dt">YesodPersistBackend</span> <span class="dt">App</span> <span class="fu">=</span> <span class="dt">SqlBackend</span></a>
<a class="sourceLine" id="cb3-55" title="55">    runDB f <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-56" title="56">        <span class="dt">App</span> conn <span class="ot">&lt;-</span> getYesod</a>
<a class="sourceLine" id="cb3-57" title="57">        runSqlConn f conn</a>
<a class="sourceLine" id="cb3-58" title="58"></a>
<a class="sourceLine" id="cb3-59" title="59"><span class="kw">instance</span> <span class="dt">YesodAuth</span> <span class="dt">App</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-60" title="60">    <span class="kw">type</span> <span class="dt">AuthId</span> <span class="dt">App</span> <span class="fu">=</span> <span class="dt">UserId</span></a>
<a class="sourceLine" id="cb3-61" title="61"></a>
<a class="sourceLine" id="cb3-62" title="62">    loginDest _ <span class="fu">=</span> <span class="dt">HomeR</span></a>
<a class="sourceLine" id="cb3-63" title="63">    logoutDest _ <span class="fu">=</span> <span class="dt">HomeR</span></a>
<a class="sourceLine" id="cb3-64" title="64">    authPlugins _ <span class="fu">=</span> [authEmail]</a>
<a class="sourceLine" id="cb3-65" title="65"></a>
<a class="sourceLine" id="cb3-66" title="66">    <span class="co">-- Need to find the UserId for the given email address.</span></a>
<a class="sourceLine" id="cb3-67" title="67">    authenticate creds <span class="fu">=</span> liftHandler <span class="fu">$</span> runDB <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-68" title="68">        x <span class="ot">&lt;-</span> insertBy <span class="fu">$</span> <span class="dt">User</span> (credsIdent creds) <span class="dt">Nothing</span> <span class="dt">Nothing</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb3-69" title="69">        <span class="fu">return</span> <span class="fu">$</span> <span class="dt">Authenticated</span> <span class="fu">$</span>liftHandler <span class="fu">$</span> </a>
<a class="sourceLine" id="cb3-70" title="70">            <span class="kw">case</span> x <span class="kw">of</span></a>
<a class="sourceLine" id="cb3-71" title="71">                <span class="dt">Left</span> (<span class="dt">Entity</span> userid _) <span class="ot">-&gt;</span> userid <span class="co">-- newly added user</span></a>
<a class="sourceLine" id="cb3-72" title="72">                <span class="dt">Right</span> userid <span class="ot">-&gt;</span> userid <span class="co">-- existing user</span></a>
<a class="sourceLine" id="cb3-73" title="73"></a>
<a class="sourceLine" id="cb3-74" title="74"><span class="kw">instance</span> <span class="dt">YesodAuthPersist</span> <span class="dt">App</span></a>
<a class="sourceLine" id="cb3-75" title="75"></a>
<a class="sourceLine" id="cb3-76" title="76"><span class="co">-- Here's all of the email-specific code</span></a>
<a class="sourceLine" id="cb3-77" title="77"><span class="kw">instance</span> <span class="dt">YesodAuthEmail</span> <span class="dt">App</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-78" title="78">    <span class="kw">type</span> <span class="dt">AuthEmailId</span> <span class="dt">App</span> <span class="fu">=</span> <span class="dt">UserId</span></a>
<a class="sourceLine" id="cb3-79" title="79"></a>
<a class="sourceLine" id="cb3-80" title="80">    afterPasswordRoute _ <span class="fu">=</span> <span class="dt">HomeR</span></a>
<a class="sourceLine" id="cb3-81" title="81"></a>
<a class="sourceLine" id="cb3-82" title="82">    addUnverified email verkey <span class="fu">=</span></a>
<a class="sourceLine" id="cb3-83" title="83">        liftHandler <span class="fu">$</span> runDB <span class="fu">$</span> insert <span class="fu">$</span> <span class="dt">User</span> email <span class="dt">Nothing</span> (<span class="dt">Just</span> verkey) <span class="dt">False</span></a>
<a class="sourceLine" id="cb3-84" title="84"></a>
<a class="sourceLine" id="cb3-85" title="85">    sendVerifyEmail email _ verurl <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-86" title="86">        <span class="co">-- Print out to the console the verification email, for easier</span></a>
<a class="sourceLine" id="cb3-87" title="87">        <span class="co">-- debugging.</span></a>
<a class="sourceLine" id="cb3-88" title="88">        liftIO <span class="fu">$</span> <span class="fu">putStrLn</span> <span class="fu">$</span> <span class="st">&quot;Copy/ Paste this URL in your browser:&quot;</span> <span class="fu">++</span> unpack verurl</a>
<a class="sourceLine" id="cb3-89" title="89"></a>
<a class="sourceLine" id="cb3-90" title="90">        <span class="co">-- Send email.</span></a>
<a class="sourceLine" id="cb3-91" title="91">        liftIO <span class="fu">$</span> renderSendMail (emptyMail <span class="fu">$</span> <span class="dt">Address</span> <span class="dt">Nothing</span> <span class="st">&quot;noreply&quot;</span>)</a>
<a class="sourceLine" id="cb3-92" title="92">            { mailTo <span class="fu">=</span> [<span class="dt">Address</span> <span class="dt">Nothing</span> email]</a>
<a class="sourceLine" id="cb3-93" title="93">            , mailHeaders <span class="fu">=</span></a>
<a class="sourceLine" id="cb3-94" title="94">                [ (<span class="st">&quot;Subject&quot;</span>, <span class="st">&quot;Verify your email address&quot;</span>)</a>
<a class="sourceLine" id="cb3-95" title="95">                ]</a>
<a class="sourceLine" id="cb3-96" title="96">            , mailParts <span class="fu">=</span> [[textPart, htmlPart]]</a>
<a class="sourceLine" id="cb3-97" title="97">            }</a>
<a class="sourceLine" id="cb3-98" title="98">      <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-99" title="99">        textPart <span class="fu">=</span> <span class="dt">Part</span></a>
<a class="sourceLine" id="cb3-100" title="100">            { partType <span class="fu">=</span> <span class="st">&quot;text/plain; charset=utf-8&quot;</span></a>
<a class="sourceLine" id="cb3-101" title="101">            , partEncoding <span class="fu">=</span> <span class="dt">None</span></a>
<a class="sourceLine" id="cb3-102" title="102">            , partFilename <span class="fu">=</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb3-103" title="103">            , partContent <span class="fu">=</span> Data.Text.Lazy.Encoding.encodeUtf8</a>
<a class="sourceLine" id="cb3-104" title="104">                [stext|</a>
<a class="sourceLine" id="cb3-105" title="105">                    Please confirm your email address by clicking on the link below.</a>
<a class="sourceLine" id="cb3-106" title="106"></a>
<a class="sourceLine" id="cb3-107" title="107">                    #{verurl}</a>
<a class="sourceLine" id="cb3-108" title="108"></a>
<a class="sourceLine" id="cb3-109" title="109">                    Thank you</a>
<a class="sourceLine" id="cb3-110" title="110">                |]</a>
<a class="sourceLine" id="cb3-111" title="111">            , partHeaders <span class="fu">=</span> []</a>
<a class="sourceLine" id="cb3-112" title="112">            }</a>
<a class="sourceLine" id="cb3-113" title="113">        htmlPart <span class="fu">=</span> <span class="dt">Part</span></a>
<a class="sourceLine" id="cb3-114" title="114">            { partType <span class="fu">=</span> <span class="st">&quot;text/html; charset=utf-8&quot;</span></a>
<a class="sourceLine" id="cb3-115" title="115">            , partEncoding <span class="fu">=</span> <span class="dt">None</span></a>
<a class="sourceLine" id="cb3-116" title="116">            , partFilename <span class="fu">=</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb3-117" title="117">            , partContent <span class="fu">=</span> renderHtml</a>
<a class="sourceLine" id="cb3-118" title="118">                [shamlet|</a>
<a class="sourceLine" id="cb3-119" title="119">                    <span class="kw">&lt;p&gt;</span>Please confirm your email address by clicking on the link below.</a>
<a class="sourceLine" id="cb3-120" title="120">                    <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb3-121" title="121">                        <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">#{</span>verurl<span class="kw">}&gt;#{</span>verurl<span class="kw">}</span></a>
<a class="sourceLine" id="cb3-122" title="122">                    <span class="kw">&lt;p&gt;</span>Thank you</a>
<a class="sourceLine" id="cb3-123" title="123">                |]</a>
<a class="sourceLine" id="cb3-124" title="124">            , partHeaders <span class="fu">=</span> []</a>
<a class="sourceLine" id="cb3-125" title="125">            }</a>
<a class="sourceLine" id="cb3-126" title="126">    getVerifyKey <span class="fu">=</span> liftHandler <span class="fu">.</span> runDB <span class="fu">.</span> <span class="fu">fmap</span> (join <span class="fu">.</span> <span class="fu">fmap</span> userVerkey) <span class="fu">.</span> get</a>
<a class="sourceLine" id="cb3-127" title="127">    setVerifyKey uid key <span class="fu">=</span> liftHandler <span class="fu">$</span> runDB <span class="fu">$</span> update uid [<span class="dt">UserVerkey</span> <span class="fu">=.</span> <span class="dt">Just</span> key]</a>
<a class="sourceLine" id="cb3-128" title="128">    verifyAccount uid <span class="fu">=</span> liftHandler <span class="fu">$</span> runDB <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-129" title="129">        mu <span class="ot">&lt;-</span> get uid</a>
<a class="sourceLine" id="cb3-130" title="130">        <span class="kw">case</span> mu <span class="kw">of</span></a>
<a class="sourceLine" id="cb3-131" title="131">            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb3-132" title="132">            <span class="dt">Just</span> u <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-133" title="133">                update uid [<span class="dt">UserVerified</span> <span class="fu">=.</span> <span class="dt">True</span>]</a>
<a class="sourceLine" id="cb3-134" title="134">                <span class="fu">return</span> <span class="fu">$</span> <span class="dt">Just</span> uid</a>
<a class="sourceLine" id="cb3-135" title="135">    getPassword <span class="fu">=</span> liftHandler <span class="fu">.</span> runDB <span class="fu">.</span> <span class="fu">fmap</span> (join <span class="fu">.</span> <span class="fu">fmap</span> userPassword) <span class="fu">.</span> get</a>
<a class="sourceLine" id="cb3-136" title="136">    setPassword uid pass <span class="fu">=</span> liftHandler <span class="fu">.</span> runDB <span class="fu">$</span> update uid [<span class="dt">UserPassword</span> <span class="fu">=.</span> <span class="dt">Just</span> pass]</a>
<a class="sourceLine" id="cb3-137" title="137">    getEmailCreds email <span class="fu">=</span> liftHandler <span class="fu">$</span> runDB <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-138" title="138">        mu <span class="ot">&lt;-</span> getBy <span class="fu">$</span> <span class="dt">UniqueUser</span> email</a>
<a class="sourceLine" id="cb3-139" title="139">        <span class="kw">case</span> mu <span class="kw">of</span></a>
<a class="sourceLine" id="cb3-140" title="140">            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb3-141" title="141">            <span class="dt">Just</span> (<span class="dt">Entity</span> uid u) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="fu">$</span> <span class="dt">Just</span> <span class="dt">EmailCreds</span></a>
<a class="sourceLine" id="cb3-142" title="142">                { emailCredsId <span class="fu">=</span> uid</a>
<a class="sourceLine" id="cb3-143" title="143">                , emailCredsAuthId <span class="fu">=</span> <span class="dt">Just</span> uid</a>
<a class="sourceLine" id="cb3-144" title="144">                , emailCredsStatus <span class="fu">=</span> isJust <span class="fu">$</span> userPassword u</a>
<a class="sourceLine" id="cb3-145" title="145">                , emailCredsVerkey <span class="fu">=</span> userVerkey u</a>
<a class="sourceLine" id="cb3-146" title="146">                , emailCredsEmail <span class="fu">=</span> email</a>
<a class="sourceLine" id="cb3-147" title="147">                }</a>
<a class="sourceLine" id="cb3-148" title="148">    getEmail <span class="fu">=</span> liftHandler <span class="fu">.</span> runDB <span class="fu">.</span> <span class="fu">fmap</span> (<span class="fu">fmap</span> userEmail) <span class="fu">.</span> get</a>
<a class="sourceLine" id="cb3-149" title="149"></a>
<a class="sourceLine" id="cb3-150" title="150"><span class="ot">getHomeR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></a>
<a class="sourceLine" id="cb3-151" title="151">getHomeR <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-152" title="152">    maid <span class="ot">&lt;-</span> maybeAuthId</a>
<a class="sourceLine" id="cb3-153" title="153">    defaultLayout</a>
<a class="sourceLine" id="cb3-154" title="154">        [whamlet|</a>
<a class="sourceLine" id="cb3-155" title="155">            <span class="kw">&lt;p&gt;</span>Your current auth ID: <span class="kw">#{</span><span class="fu">show</span> maid<span class="kw">}</span></a>
<a class="sourceLine" id="cb3-156" title="156">            <span class="kw">$maybe</span> _ <span class="ot">&lt;-</span> maid</a>
<a class="sourceLine" id="cb3-157" title="157">                <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb3-158" title="158">                    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">AuthR</span> <span class="dt">LogoutR</span><span class="kw">}&gt;</span>Logout</a>
<a class="sourceLine" id="cb3-159" title="159">            <span class="kw">$nothing</span></a>
<a class="sourceLine" id="cb3-160" title="160">                <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb3-161" title="161">                    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">AuthR</span> <span class="dt">LoginR</span><span class="kw">}&gt;</span>Go to the login page</a>
<a class="sourceLine" id="cb3-162" title="162">        |]</a>
<a class="sourceLine" id="cb3-163" title="163"></a>
<a class="sourceLine" id="cb3-164" title="164"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb3-165" title="165">main <span class="fu">=</span> runNoLoggingT <span class="fu">$</span> withSqliteConn <span class="st">&quot;email.db3&quot;</span> <span class="fu">$</span> \conn <span class="ot">-&gt;</span> liftIO <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-166" title="166">    runSqlConn (runMigration migrateAll) conn</a>
<a class="sourceLine" id="cb3-167" title="167">    warp <span class="dv">3000</span> <span class="fu">$</span> <span class="dt">App</span> conn</a></code></pre></div>
<h2 id="認可">認可</h2>
<p>一旦ユーザを認証してしまえば、その認証情報を使ってリクエストを認可できます。Yesod における認可は単純かつ宣言的です。多くの場合、<code>authRoute</code> と <code>isAuthorized</code> メソッドを Yesod 型クラスのインスタンスに追加するだけです。例を見てみましょう。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1"><span class="ot">{-# LANGUAGE MultiParamTypeClasses #-}</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="ot">{-# LANGUAGE OverloadedStrings     #-}</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="ot">{-# LANGUAGE QuasiQuotes           #-}</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="ot">{-# LANGUAGE TemplateHaskell       #-}</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="ot">{-# LANGUAGE TypeFamilies          #-}</span></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="kw">import</span>           <span class="dt">Data.Default</span>         (def)</a>
<a class="sourceLine" id="cb4-7" title="7"><span class="kw">import</span>           <span class="dt">Data.Text</span>            (<span class="dt">Text</span>)</a>
<a class="sourceLine" id="cb4-8" title="8"><span class="kw">import</span>           <span class="dt">Network.HTTP.Conduit</span> (<span class="dt">Manager</span>, newManager, tlsManagerSettings)</a>
<a class="sourceLine" id="cb4-9" title="9"><span class="kw">import</span>           <span class="dt">Yesod</span></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="kw">import</span>           <span class="dt">Yesod.Auth</span></a>
<a class="sourceLine" id="cb4-11" title="11"><span class="kw">import</span>           <span class="dt">Yesod.Auth.Dummy</span> <span class="co">-- just for testing, don't use in real life!!!</span></a>
<a class="sourceLine" id="cb4-12" title="12"></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="kw">data</span> <span class="dt">App</span> <span class="fu">=</span> <span class="dt">App</span></a>
<a class="sourceLine" id="cb4-14" title="14">    {<span class="ot"> httpManager ::</span> <span class="dt">Manager</span></a>
<a class="sourceLine" id="cb4-15" title="15">    }</a>
<a class="sourceLine" id="cb4-16" title="16"></a>
<a class="sourceLine" id="cb4-17" title="17">mkYesod <span class="st">&quot;App&quot;</span> [parseRoutes|</a>
<a class="sourceLine" id="cb4-18" title="18">/      HomeR  GET POST</a>
<a class="sourceLine" id="cb4-19" title="19">/admin AdminR GET</a>
<a class="sourceLine" id="cb4-20" title="20">/auth  AuthR  Auth getAuth</a>
<a class="sourceLine" id="cb4-21" title="21">|]</a>
<a class="sourceLine" id="cb4-22" title="22"></a>
<a class="sourceLine" id="cb4-23" title="23"><span class="kw">instance</span> <span class="dt">Yesod</span> <span class="dt">App</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-24" title="24">    authenticate <span class="fu">=</span> <span class="fu">return</span> <span class="fu">.</span> <span class="dt">Authenticated</span> <span class="fu">.</span> credsIdent</a>
<a class="sourceLine" id="cb4-25" title="25"></a>
<a class="sourceLine" id="cb4-26" title="26">    <span class="co">-- route name, then a boolean indicating if it's a write request</span></a>
<a class="sourceLine" id="cb4-27" title="27">    isAuthorized <span class="dt">HomeR</span> <span class="dt">True</span> <span class="fu">=</span> isAdmin</a>
<a class="sourceLine" id="cb4-28" title="28">    isAuthorized <span class="dt">AdminR</span> _ <span class="fu">=</span> isAdmin</a>
<a class="sourceLine" id="cb4-29" title="29"></a>
<a class="sourceLine" id="cb4-30" title="30">    <span class="co">-- anyone can access other pages</span></a>
<a class="sourceLine" id="cb4-31" title="31">    isAuthorized _ _ <span class="fu">=</span> <span class="fu">return</span> <span class="dt">Authorized</span></a>
<a class="sourceLine" id="cb4-32" title="32"></a>
<a class="sourceLine" id="cb4-33" title="33">isAdmin <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-34" title="34">    mu <span class="ot">&lt;-</span> maybeAuthId</a>
<a class="sourceLine" id="cb4-35" title="35">    <span class="fu">return</span> <span class="fu">$</span> <span class="kw">case</span> mu <span class="kw">of</span></a>
<a class="sourceLine" id="cb4-36" title="36">        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">AuthenticationRequired</span></a>
<a class="sourceLine" id="cb4-37" title="37">        <span class="dt">Just</span> <span class="st">&quot;admin&quot;</span> <span class="ot">-&gt;</span> <span class="dt">Authorized</span></a>
<a class="sourceLine" id="cb4-38" title="38">        <span class="dt">Just</span> _ <span class="ot">-&gt;</span> <span class="dt">Unauthorized</span> <span class="st">&quot;You must be an admin&quot;</span></a>
<a class="sourceLine" id="cb4-39" title="39"></a>
<a class="sourceLine" id="cb4-40" title="40"><span class="kw">instance</span> <span class="dt">YesodAuth</span> <span class="dt">App</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-41" title="41">    <span class="kw">type</span> <span class="dt">AuthId</span> <span class="dt">App</span> <span class="fu">=</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb4-42" title="42">    authenticate <span class="fu">=</span> <span class="fu">return</span> <span class="fu">.</span> <span class="dt">Authenticated</span> <span class="fu">.</span> credsIdent</a>
<a class="sourceLine" id="cb4-43" title="43"></a>
<a class="sourceLine" id="cb4-44" title="44">    loginDest _ <span class="fu">=</span> <span class="dt">HomeR</span></a>
<a class="sourceLine" id="cb4-45" title="45">    logoutDest _ <span class="fu">=</span> <span class="dt">HomeR</span></a>
<a class="sourceLine" id="cb4-46" title="46"></a>
<a class="sourceLine" id="cb4-47" title="47">    authPlugins _ <span class="fu">=</span> [authDummy]</a>
<a class="sourceLine" id="cb4-48" title="48"></a>
<a class="sourceLine" id="cb4-49" title="49">    maybeAuthId <span class="fu">=</span> lookupSession <span class="st">&quot;_ID&quot;</span></a>
<a class="sourceLine" id="cb4-50" title="50"></a>
<a class="sourceLine" id="cb4-51" title="51"><span class="kw">instance</span> <span class="dt">RenderMessage</span> <span class="dt">App</span> <span class="dt">FormMessage</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-52" title="52">    renderMessage _ _ <span class="fu">=</span> defaultFormMessage</a>
<a class="sourceLine" id="cb4-53" title="53"></a>
<a class="sourceLine" id="cb4-54" title="54"><span class="ot">getHomeR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></a>
<a class="sourceLine" id="cb4-55" title="55">getHomeR <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-56" title="56">    maid <span class="ot">&lt;-</span> maybeAuthId</a>
<a class="sourceLine" id="cb4-57" title="57">    defaultLayout</a>
<a class="sourceLine" id="cb4-58" title="58">        [whamlet|</a>
<a class="sourceLine" id="cb4-59" title="59">            <span class="kw">&lt;p&gt;</span>Note: Log in as &quot;admin&quot; to be an administrator.</a>
<a class="sourceLine" id="cb4-60" title="60">            <span class="kw">&lt;p&gt;</span>Your current auth ID: <span class="kw">#{</span><span class="fu">show</span> maid<span class="kw">}</span></a>
<a class="sourceLine" id="cb4-61" title="61">            <span class="kw">$maybe</span> _ <span class="ot">&lt;-</span> maid</a>
<a class="sourceLine" id="cb4-62" title="62">                <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb4-63" title="63">                    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">AuthR</span> <span class="dt">LogoutR</span><span class="kw">}&gt;</span>Logout</a>
<a class="sourceLine" id="cb4-64" title="64">            <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb4-65" title="65">                <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">AdminR</span><span class="kw">}&gt;</span>Go to admin page</a>
<a class="sourceLine" id="cb4-66" title="66">            <span class="kw">&lt;form</span><span class="ot"> method=</span><span class="st">post</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb4-67" title="67">                Make a change (admins only)</a>
<a class="sourceLine" id="cb4-68" title="68">                \ #</a>
<a class="sourceLine" id="cb4-69" title="69">                <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">submit</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb4-70" title="70">        |]</a>
<a class="sourceLine" id="cb4-71" title="71"></a>
<a class="sourceLine" id="cb4-72" title="72"><span class="ot">postHomeR ::</span> <span class="dt">Handler</span> ()</a>
<a class="sourceLine" id="cb4-73" title="73">postHomeR <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-74" title="74">    setMessage <span class="st">&quot;You made some change to the page&quot;</span></a>
<a class="sourceLine" id="cb4-75" title="75">    redirect <span class="dt">HomeR</span></a>
<a class="sourceLine" id="cb4-76" title="76"></a>
<a class="sourceLine" id="cb4-77" title="77"><span class="ot">getAdminR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></a>
<a class="sourceLine" id="cb4-78" title="78">getAdminR <span class="fu">=</span> defaultLayout</a>
<a class="sourceLine" id="cb4-79" title="79">    [whamlet|</a>
<a class="sourceLine" id="cb4-80" title="80">        <span class="kw">&lt;p&gt;</span>I guess you're an admin!</a>
<a class="sourceLine" id="cb4-81" title="81">        <span class="kw">&lt;p&gt;</span></a>
<a class="sourceLine" id="cb4-82" title="82">            <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">HomeR</span><span class="kw">}&gt;</span>Return to homepage</a>
<a class="sourceLine" id="cb4-83" title="83">    |]</a>
<a class="sourceLine" id="cb4-84" title="84"></a>
<a class="sourceLine" id="cb4-85" title="85"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb4-86" title="86">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-87" title="87">    manager <span class="ot">&lt;-</span> newManager tlsManagerSettings</a>
<a class="sourceLine" id="cb4-88" title="88">    warp <span class="dv">3000</span> <span class="fu">$</span> <span class="dt">App</span> manager</a></code></pre></div>
<p><code>authRoute</code> はログインページにしてください。ほとんどいつも <code>AuthR LoginR</code> となります。<code>isAuthorized</code> 関数はリクエストされたルートと、リクエストが “write” なリクエストであるかどうかという、2つのパラメータを引数に取ります。また、 <code>isWriteRequest</code> を使えば write リクエストの定義を変更できますが、初期値は RESTful 原則に従い <code>GET</code>、<code>HEAD</code>、<code>OPTIONS</code>、<code>TRACE</code> リクエスト以外は全て write リクエストとなります。</p>
<p><code>isAuthorized</code> 関数が便利なのは、<code>Handler</code> コードを何でも実行できる点にあります。これは以下のようなことを可能にします。</p>
<ul>
<li>ファイルシステムにアクセスする (通常のIO)</li>
<li>データベースから値を探す</li>
<li>欲しいセッションやリクエスト値を取ってくる</li>
</ul>
<p>これらのテクニックを使いこなすことで、どんな高度な認可システムも開発可能になります。また、組織内の既存システムに連動させることも可能です。</p>
<h2 id="結論">結論</h2>
<p>この章では、ユーザ認証のための設定の基礎や、組み込みの認可関数をユーザにとってシンプルで宣言的な方法で提供する方法について説明しました。これらは複雑な概念かつ多くのアプローチがありますが、Yesod は自分自身で独自にカスタマイズした認証/認可方法を作りあげるために必要な構成要素を提供しています。</p>
      </article>

      <div class="pager">
      
      
      </div>

      <div class="row">
        <div class="col s6 offset-s6" style="position: relative; height: 100px;">
          <div class="fixed-action-btn horizontal" style="position: absolute; display: inline-block; right: 24px;">
  <a class="btn-floating btn-large red">
    <i class="large material-icons">share</i>
  </a>
  <ul>
    <li>
      <a class="btn-floating waves-effect waves-light blue tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Twitter" href="https://twitter.com/intent/tweet?text=認証と認可&url=https://haskell.e-bigmoon.com/yesod/book/ch14-authentication-and-authorization.html"><i class="mdi mdi-twitter white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light indigo tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Facebook" href="https://facebook.com/sharer.php?u=https://haskell.e-bigmoon.com/yesod/book/ch14-authentication-and-authorization.html"><i class="mdi mdi-facebook white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light red tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Google+" href="https://plus.google.com/share?url=https://haskell.e-bigmoon.com/yesod/book/ch14-authentication-and-authorization.html"><i class="mdi mdi-google-plus white-text"></i></a>
    </li>
  </ul>
</div>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
    </div>

    <footer class="page-footer indigo lighten-1">

  <div class="footer-copyright">

    <div class="container">
      CopyRight © 2018 BIGMOON All Rights Reserved.&nbsp;
      Site proudly generated by <a class="red-text text-accent-1" href="http://jaspervdj.be/hakyll">Hakyll</a>,&nbsp;
      original Jekyll theme by <a class="red-text text-accent-1" href="https://github.com/mumuxme/materialize-jekyll">mumuxme</a>.
    </div>

  </div>

</footer>


    <!-- scrolltop button -->
    <button class="material-scrolltop waves-effect waves-light hide-on-small-only" type="button">
      <i class="mdi mdi-arrow-up-bold small white-text"></i>
    </button>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-19322672-9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-19322672-9');
    </script>

    <!-- jquery -->
    <script type="text/javascript" src="../../lib/jquery-min.js"></script>
    <!-- materialize -->
    <script src="../../lib/materialize/js/materialize.min.js"></script>
    <!-- <\!-- Material ScrollTop plugin -\-> -->
    <script src="../../lib/material-scrolltop/material-scrolltop.js"></script>
    <!-- main -->
    <script src="../../js/init.js"></script>
    <script src="../../js/main.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>

</html>
