<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">

  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
  <!-- MUST in hex format, may the same as header-color. This color is for android chrome browser. -->
  <meta name="theme-color" content="#5c6bc0">

  <!-- Metadata. -->
  <meta name="keywords" content="haskell,blog,bigmoon" />
  <title>Wiki: markdown, chat subsite, event source</title>
  <meta name="description" content="BIG MOON">
  <link rel="canonical" href="../../yesod/book/examples-wiki-chat-example.html">
  <link rel="alternate" type="application/atom+xml" title="Wiki: markdown, chat subsite, event source" href="../../feed.xml" />
  <link rel="shortcut icon" href="../../images/favicon.ico" />
  <meta name="google-site-verification" content="X2YNboLvzw3_bclXLMvohyJDqj68D06_hPDMukRbgTs" />

  <!-- Stylesheets. -->
  <link rel="stylesheet" href="../../lib/materialize/css/materialize.min.css" />
  <link rel="stylesheet" href="../../css/main.css" />
  <link media="all" rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/3.3.92/css/materialdesignicons.min.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="../../lib/material-scrolltop/material-scrolltop.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/agate.min.css" />
  

  <!-- OGP -->
  <meta property="og:title" content="Wiki: markdown, chat subsite, event source" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="/yesod/book/examples-wiki-chat-example.html" />
  <!-- <meta property="og:image" content=" サムネイル画像の URL" /> -->
  <meta property="og:site_name" content="Wiki: markdown, chat subsite, event source" />
  <meta property="og:description" content="BIG MOON" />

  <meta name="twitter:card" content="summary" />
  <!-- <meta name="twitter:site" content="@[ Twitter ID]" /> -->
  <!-- <meta name="twitter:player" content="@[ Twitter ID]" /> -->

  <noscript>
  <div class="notice-warning noscript">You don't have javascript enabled. Good luck! :(</div>
</noscript>

<!--[if IE]>
  <div class="notice-warning">Oh, you are using Internet Explorer! Good luck... :(</div>
<![endif]-->

</head>


  <body>
    <header class="site-header">
      <nav class="nav-extended indigo lighten-1">
        <div class="nav-wrapper">
  <a href="../../"><span class="site-title">BIGMOON Haskeller's BLOG</span></a>
  <a href="#" data-activates="mobile-navbar" class="button-collapse">
    <i class="mdi mdi-menu white-text"></i>
  </a>

  <ul id="nav-mobile" class="right hide-on-med-and-down">
    <li>
      <a href="../../" class="white-text">
        <i class="mdi mdi-home left indigo-text text-lighten-3"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="white-text">
        <i class="mdi mdi-account-circle left indigo-text text-lighten-3"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../books/" class="white-text">
        <i class="mdi mdi-book-open left indigo-text text-lighten-3"></i>
        Books
      </a>
    </li>
    <li>
      <a href="../../stack/" class="white-text">
        <i class="mdi mdi-wrench left indigo-text text-lighten-3"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/" class="white-text">
        <i class="mdi mdi-comment-question-outline left indigo-text text-lighten-3"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="white-text">
        <i class="mdi mdi-package-variant left indigo-text text-lighten-3"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="white-text">
        <i class="mdi mdi-earth left indigo-text text-lighten-3"></i>
        Yesod
      </a>
    </li>
    <li>
      <a href="../../feed.xml" class="white-text">
        <i class="mdi mdi-rss left indigo-text text-lighten-3"></i>
        Feed
      </a>
    </li>
  </ul>

  <ul class="side-nav" id="mobile-navbar">
    <li>
      <a href="../../" class="waves-effect waves-teal black-text">
        <i class="mdi mdi-home left green-text"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="navbar-text-colour-mobile">
        <i class="mdi mdi-account-circle left blue-text"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../books/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-book-open left blue-text"></i>
        Books
      </a>
    </li>
    <li>
      <a href="../../stack/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-wrench left blue-text"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-comment-question-outline left blue-text"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-package-variant left blue-text"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-earth left blue-text"></i>
        Yesod
      </a>
    </li>
  </ul>
</div>

      </nav>
    </header>

    <div class="site-container" id="tab-main">
      <div class="wrapper">
        <div class="post-ribbon"></div>

<div class="container page-container">
  <div class="post-page card-panel z-depth-2">
    <div class="post-section">
      <div class="post-heading">
        <div style="float: right;">
          
          <span>記事公開日: 2021/02/28</span><br>
          
          
        </div>
        <h1 class="post-title">Wiki: markdown, chat subsite, event source</h1>
      </div>

      <article class="page-content">
        <p>この例では, いくつかの異なる例をつなぎ合わせる. まずチャットサブサイトから始める. これによりチャットWidgetをあらゆるページに埋め込むことが可能になる. HTML 5イベントソースAPIを用いて, サーバからクライアントへのイベントの送信を扱う.</p>
<h2 id="サブサイト-データ">サブサイト: データ</h2>
<p>サブサイトを定義するために, サブサイトのファウンデーション型を作る必要がある. これは, 通常のYesodアプリーケションに対して行うのと同じである. 今回の場合, 全てのイベントのチャンネルが, チャットの各参加者に送られるようにしたい. これは次のようになる:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @Chat/Data.hs</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE FlexibleContexts      #-}</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE FlexibleInstances     #-}</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings     #-}</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE QuasiQuotes           #-}</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE RankNTypes            #-}</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TemplateHaskell       #-}</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TypeFamilies          #-}</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Chat.Data</span> <span class="kw">where</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Blaze.ByteString.Builder.Char.Utf8</span>  (fromText)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Control.Concurrent.Chan</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Monoid</span>                         ((&lt;&gt;))</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Text</span>                           (<span class="dt">Text</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai.EventSource</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai.EventSource.EventStream</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod.Core.Types</span> (<span class="dt">SubHandlerFor</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Our subsite foundation. We keep a channel of events that all connections</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co">-- will share.</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Chat</span> <span class="ot">=</span> <span class="dt">Chat</span> (<span class="dt">Chan</span> <span class="dt">ServerEvent</span>)</span></code></pre></div>
<p>同じモジュールにサブサイトのルートも定義する必要がある. 2つのコマンド必要とする: 1つは, 新しいメッセージを全てのユーザに送るためのもので, もう1つは, メッセージのストリームを受け取るためのものである.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @Chat/Data.hs</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>mkYesodSubData <span class="st">&quot;Chat&quot;</span> [parseRoutes|</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>/send SendR POST</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>/recv ReceiveR GET</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>|]</span></code></pre></div>
<h2 id="サブサイト-ハンドラ">サブサイト: ハンドラ</h2>
<p>これでファウンデーションとルートを定義できた. サブサイトのディスパッチ機能を与えるために別々のモジュールが必要になる. このモジュールを<code>Chat</code>と呼び, ここからサブサイトがどのように機能するかを見る.</p>
<p>サブサイトは常に, ユーザによって与えられるマスターサイトの上のレイヤとして存在する. 多くの場合, サブサイトはマスターサイトに存在するために, 特別な機能が必要である. 今回のチャットサブサイトにおいては, マスターサイトによりユーザ認証をしてもらいたい. サブサイトは現在のユーザがログインしているかどうかについて, 問い合わせを行い, ユーザ名を得られるようにする必要がある.</p>
<p>この概念を表現するための方法は, 必要な機能を内包する型クラスを定義することである. <code>YesodChat</code>型クラスは次のようになる:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @Chat/Data.hs</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> (<span class="dt">Yesod</span> master, <span class="dt">RenderMessage</span> master <span class="dt">FormMessage</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=&gt;</span> <span class="dt">YesodChat</span> master <span class="kw">where</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="ot">    getUserName ::</span> <span class="dt">HandlerFor</span> master <span class="dt">Text</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="ot">    isLoggedIn ::</span> <span class="dt">HandlerFor</span> master <span class="dt">Bool</span></span></code></pre></div>
<p>チャットサブサイトを使うマスターサイトは<code>YesodChat</code>インスタンスを与える必要がある. (少し後に, この要求がどのように実行されるかについて見る.) いくつかの注目すべき面白いことがある:</p>
<ul>
<li><p>マスターサイトに対し, さらに制約をすることができる. 例えば, <code>Yesod</code>インスタンスを与えたり, フォームメッセージのレンダリングを許可したりできる. 前者によって, <code>defaultLayout</code>を使うことが可能になり, 後者により標準フォームWidgetを使うことが可能になる.</p></li>
<li><p>以前この本では, <code>Handler</code>モナドをかなり多く使った. <code>Handler</code>は単に<code>HandlerFor</code>のアプリケーション特有の型注釈であることを思い出してもらいたい. このコードは多くの異なるアプリケーションにおいて機能することを意図しているため, トランスフォーマに対し, <code>HandlerFor</code>の完全形を用いる.</p></li>
</ul>
<p><code>Handler</code>型注釈について, サブサイトにも同じようなものを持ちたい. 問題点としては: このモナドがどのようになるか?, ということである. サブサイトの場合, サブサイトデータ型とマスターサイト型を持つ<code>SubHandlerFor</code>を用いる. また, このために補助的な注釈を定義するが, それは, <code>YesodChat</code>インスタンスをマスターサイト型に要求し, 次のように表すことができる.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @Chat/Data.hs</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">ChatHandler</span> a <span class="ot">=</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">forall</span> master<span class="op">.</span> <span class="dt">YesodChat</span> master <span class="ot">=&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">SubHandlerFor</span> <span class="dt">Chat</span> master a</span></code></pre></div>
<p>これで部品が整ったので, サブサイトハンドラを書くことにしよう. 2つのルートがありました: 1つは, メッセージを送信するためのもので, もう1つはメッセージを受信するためのものである. まず, 送信から始めましょう. 以下のことが必要になる:</p>
<ol type="1">
<li><p>メッセージを送信するための人のユーザ名を取得する.</p></li>
<li><p>流入するパラメータからメッセージをパーズする. (クライアント側のAjaxコードを容易にするために, GETパラメータを用いる.)</p></li>
<li><p><code>Chan</code>にメッセージを書く.</p></li>
</ol>
<p>このコード全体で最も技巧的な部分は, いつ<code>lift</code>を用いるかについて知ることである. 実装を見て, それらの<code>lift</code>の用い方について議論しましょう:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @Chat/Data.hs</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ot">postSendR ::</span> <span class="dt">ChatHandler</span> ()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>postSendR <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    from <span class="ot">&lt;-</span> liftHandler getUserName</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    body <span class="ot">&lt;-</span> runInputGet <span class="op">$</span> ireq textField <span class="st">&quot;message&quot;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Chat</span> chan <span class="ot">&lt;-</span> getSubYesod</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    liftIO <span class="op">$</span> writeChan chan <span class="op">$</span> <span class="dt">ServerEvent</span> <span class="dt">Nothing</span> <span class="dt">Nothing</span> <span class="op">$</span> <span class="fu">return</span> <span class="op">$</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        fromText from <span class="op">&lt;&gt;</span> fromText <span class="st">&quot;: &quot;</span> <span class="op">&lt;&gt;</span> fromText body</span></code></pre></div>
<p><code>getUserName</code>は早期に<code>YesodChat</code>型クラスで定義された関数である. その型注釈を見れば, それはマスターサイトのハンドラモナドにあることが分かるであろう. したがって, その呼び出しをサブサイトから<code>lift</code>する必要がある.</p>
<p>次の呼び出しである<code>getSubYesod</code>は<code>lift</code>されない. その理由は単純である: メッセージチャンネルにアクセスするために, サブサイトのファウンデーション型が欲しいためである. もし仮にその呼び出しを<code>lift</code>した場合, 代わりにマスターサイトのファウンデーション型を取得することになってしまい, それはこの場合に望むものではない.</p>
<p>最後の行では新しいメッセージをチャンネルに入力する. これは<code>IO</code>アクションであるため, <code>liftIO</code>を用いる. <code>ServerEvent</code>は<code>wai-eventsource</code>パッケージの一部であり, この例においてサーバから送信されるメッセージを与えるための方法である.</p>
<p>受信の側については同様に単純である:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @Chat/Data.hs</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ot">getReceiveR ::</span> <span class="dt">ChatHandler</span> ()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>getReceiveR <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Chat</span> chan <span class="ot">&lt;-</span> getSubYesod</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    sendWaiApplication <span class="op">$</span> eventSourceAppChan chan</span></code></pre></div>
<p>この関数における最後の行は, 根底にある<code>wai-eventsource</code>アプリケーションをYesodハンドラとして露呈する. ここでは, <code>sendWaiApplication</code>を用いることで, WAIアプリケーションをYesodハンドラに昇格している. <code>eventSourceAppChan</code>は内部においてchanを複製しているが, これは並行Haskellにおいて, ブロードキャストチャンネルを作るための標準的な方法である.</p>
<p>今やハンドラ関数を定義できたので, ディスパッチを設定できる. 一般的なアプリケーションにおいては, ディスパッチは<code>mkYesod</code>を呼び出すことで扱われ, それは適切な<code>YesodDispatch</code>インスタンスを作る. サブサイトにおいては, もう少し複雑である. なぜならば, しばしばマスターサイトに制約を付したいためである. 今回使われる形式は以下のようになる:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @Chat.hs</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE FlexibleContexts      #-}</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE FlexibleInstances     #-}</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE MultiParamTypeClasses #-}</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings     #-}</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE QuasiQuotes           #-}</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE RankNTypes            #-}</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TemplateHaskell       #-}</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TypeFamilies          #-}</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Chat</span> <span class="kw">where</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Chat.Data</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">YesodChat</span> master <span class="ot">=&gt;</span> <span class="dt">YesodSubDispatch</span> <span class="dt">Chat</span> master <span class="kw">where</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    yesodSubDispatch <span class="ot">=</span> <span class="op">$</span>(mkYesodSubDispatch resourcesChat)</span></code></pre></div>
<p>今回の<code>Chat</code>サブサイトは<code>YesodChat</code>クラスのインスタンスであるどんなマスターサイトの上にも構築可能である. そして, <code>mkYesodSubDispatch</code>Template Haskell関数を用いて, 全てのディスパッチロジックを生成できる. これは<code>mkYesod</code>を書くよりも少し難しいが, 必要な柔軟性を与え, 書こうとするどんなサブサイトにおいても大部分が同一である.</p>
<h2 id="サブサイト-widget">サブサイト: Widget</h2>
<p>今や完全に機能するサブサイトを作ることができた. チャットライブラリとして求める最後の要素は, Widgetがページに埋め込まれ, チャット機能を提供することである. Widgetとしてこれを作ることで, あらゆるHTML, CSS, Javascriptを再利用可能なコンポーネントとして用いることができる.</p>
<p>今回のWidgetは引数を1つ取る必要がある: <code>Chat</code>サブサイトURLをマスターサイトURLに変換する関数である. この根拠としては, アプリケーション開発者はチャットサブサイトをURL構造のどこにでも配置することができ, このWidgetは正しいURLを指し示すJavascriptを生成できる必要があるためである. Widgetの部分から始めよう:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @Chat.hs</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ot">chatWidget ::</span> <span class="dt">YesodChat</span> master</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>           <span class="ot">=&gt;</span> (<span class="dt">Route</span> <span class="dt">Chat</span> <span class="ot">-&gt;</span> <span class="dt">Route</span> master)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>           <span class="ot">-&gt;</span> <span class="dt">WidgetFor</span> master ()</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>chatWidget toMaster <span class="ot">=</span> <span class="kw">do</span></span></code></pre></div>
<p>次に, Widgetによって用いられる識別子を生成する. 名称の衝突をさけるために, 手動で作る代わりにYesodに唯一の識別子を生成させることが, 常によい慣習である.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @Chat.hs</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    chat <span class="ot">&lt;-</span> newIdent   <span class="co">-- the containing div</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    output <span class="ot">&lt;-</span> newIdent <span class="co">-- the box containing the messages</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    input <span class="ot">&lt;-</span> newIdent  <span class="co">-- input field from the user</span></span></code></pre></div>
<p>次に, ユーザがログインしているかを確認する必要がある. そこでは, <code>YesodChat</code>型クラスにおける<code>isLoggedIn</code>関数を用いる. ここでは<code>Widget</code>にいるが, その関数は<code>Handler</code>モナドにいるため, <code>handlerToWidget</code>を用いる必要がある:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @Chat.hs</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    ili <span class="ot">&lt;-</span> handlerToWidget isLoggedIn  <span class="co">-- check if we're already logged in</span></span></code></pre></div>
<p>もしユーザがログインしていれば, チャットボックスを表示し, それをCSSスタイリングし, Javascriptを用いてそれを相互作用できるようにしたい. これは大部分がクライアント側のコードであり, Widgetにラップされている:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @Chat.hs</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> ili</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">then</span> <span class="kw">do</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>            <span class="co">-- Logged in: show the widget</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>            [whamlet|</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                <span class="kw">&lt;div </span><span class="er">##{chat}</span><span class="kw">&gt;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">&lt;h2&gt;</span>Chat</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">&lt;div </span><span class="er">##{output}</span><span class="kw">&gt;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">&lt;input </span><span class="er">##{input}</span><span class="kw"> </span><span class="er">type=text</span><span class="kw"> </span><span class="er">placeholder=&quot;Enter</span><span class="kw"> </span><span class="er">Message&quot;</span><span class="kw">&gt;</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>            |]</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>            <span class="co">-- Just some CSS</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>            toWidget [lucius|</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                ##{chat} {</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>                    position: absolute;</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                    top: 2em;</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>                    right: 2em;</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>                ##{output} {</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>                    width: 200px;</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>                    height: 300px;</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>                    border: 1px solid #999;</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>                    overflow: auto;</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>            |]</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>            <span class="co">-- And now that Javascript</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>            toWidgetBody [julius|</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Set up the receiving end</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>                <span class="kw">var</span> output <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(#{toJSON output})<span class="op">;</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>                <span class="kw">var</span> src <span class="op">=</span> <span class="kw">new</span> <span class="bu">EventSource</span>(<span class="st">&quot;@{toMaster ReceiveR}&quot;</span>)<span class="op">;</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>                src<span class="op">.</span><span class="at">onmessage</span> <span class="op">=</span> <span class="kw">function</span>(msg) {</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// This function will be called for each new message.</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">var</span> p <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&quot;p&quot;</span>)<span class="op">;</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>                    p<span class="op">.</span><span class="fu">appendChild</span>(<span class="bu">document</span><span class="op">.</span><span class="fu">createTextNode</span>(msg<span class="op">.</span><span class="at">data</span>))<span class="op">;</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>                    output<span class="op">.</span><span class="fu">appendChild</span>(p)<span class="op">;</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// And now scroll down within the output div so the most recent message</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// is displayed.</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>                    output<span class="op">.</span><span class="at">scrollTop</span> <span class="op">=</span> output<span class="op">.</span><span class="at">scrollHeight</span><span class="op">;</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>                }<span class="op">;</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Set up the sending end: send a message via Ajax whenever the user hits</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>                <span class="co">// enter.</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>                <span class="kw">var</span> input <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(#{toJSON input})<span class="op">;</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>                input<span class="op">.</span><span class="at">onkeyup</span> <span class="op">=</span> <span class="kw">function</span>(<span class="bu">event</span>) {</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">var</span> keycode <span class="op">=</span> (<span class="bu">event</span><span class="op">.</span><span class="at">keyCode</span> <span class="op">?</span> <span class="bu">event</span><span class="op">.</span><span class="at">keyCode</span> <span class="op">:</span> <span class="bu">event</span><span class="op">.</span><span class="at">which</span>)<span class="op">;</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> (keycode <span class="op">==</span> <span class="st">'13'</span>) {</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">var</span> xhr <span class="op">=</span> <span class="kw">new</span> <span class="bu">XMLHttpRequest</span>()<span class="op">;</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">var</span> val <span class="op">=</span> input<span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>                        input<span class="op">.</span><span class="at">value</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">var</span> params <span class="op">=</span> <span class="st">&quot;?message=&quot;</span> <span class="op">+</span> <span class="pp">encodeURI</span>(val)<span class="op">;</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>                        xhr<span class="op">.</span><span class="fu">open</span>(<span class="st">&quot;POST&quot;</span><span class="op">,</span> <span class="st">&quot;@{toMaster SendR}&quot;</span> <span class="op">+</span> params)<span class="op">;</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>                        xhr<span class="op">.</span><span class="fu">send</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>            |]</span></code></pre></div>
<p>そして最後に, もしユーザがログインしていなければ, チャットアプリを使うためにログインするように促す.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @Chat.hs</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>        <span class="kw">else</span> <span class="kw">do</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>            <span class="co">-- User isn't logged in, give a not-logged-in message.</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>            master <span class="ot">&lt;-</span> getYesod</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>            [whamlet|</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                <span class="kw">&lt;p&gt;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>                    You must be #</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">$maybe</span> ar <span class="ot">&lt;-</span> authRoute master</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">&lt;a </span><span class="er">href=@{ar}</span><span class="kw">&gt;</span>logged in</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">$nothing</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>                        logged in</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>                    \ to chat.</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>            |]</span></code></pre></div>
<h2 id="マスターサイト-データ">マスターサイト: データ</h2>
<p>今やメインのアプリケーションを書くことを進められる. このアプリケーションはチャットサブサイトとwikiを含む. 最初に考慮すべきことは, どのようにwikiコンテンツを保管するかについてである. 一般的に, これをある種のパージステントデータベースに置きたいと思う. 簡単のため, 内部メモリによる表現を用いる. 各wikiページは, 名前のリストにより指し示され, 各ページのコンテンツは<code>Text</code>になる. すると, 完全なファウンデーションのデータ型は次にようになる.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @ChatMain.hs</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE MultiParamTypeClasses #-}</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings     #-}</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE QuasiQuotes           #-}</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TemplateHaskell       #-}</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TypeFamilies          #-}</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE ViewPatterns          #-}</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">ChatMain</span> <span class="kw">where</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Chat</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Chat.Data</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Control.Concurrent.Chan</span> (newChan)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.IORef</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Map</span>                (<span class="dt">Map</span>)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map</span>                <span class="kw">as</span> <span class="dt">Map</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Text</span>               (<span class="dt">Text</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text.Lazy</span>          <span class="kw">as</span> <span class="dt">TL</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Text.Markdown</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod.Auth</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod.Auth.Dummy</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">System.SetEnv</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">App</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> getChat     ::</span> <span class="dt">Chat</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> wikiContent ::</span> <span class="dt">IORef</span> (<span class="dt">Map</span> [<span class="dt">Text</span>] <span class="dt">Text</span>)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div>
<p>次にルートを設定する.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @ChatMain.hs</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>mkYesod <span class="st">&quot;App&quot;</span> [parseRoutes|</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>/            HomeR GET      -- the homepage</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>/wiki/*Texts WikiR GET POST -- note the multipiece for the wiki hierarchy</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>/chat        ChatR Chat getChat    -- the chat subsite</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>/auth        AuthR Auth getAuth    -- the auth subsite</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>|]</span></code></pre></div>
<h2 id="マスターサイト-インスタンス">マスターサイト: インスタンス</h2>
<p>デフォルトの<code>Yesod</code>インスタンスに対し, 2つの変更をする必要がある. まず, <code>authRoute</code>の実装を与え, サブサイトwidgetがログインページへの適切なリンクを表示できるようにしたい. 次に, <code>defaultLayout</code>をオーバーライドしたい. ログイン/ログアウトリンクを与える以外に, この関数は全ページのチャットwidgetに追加される.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @ChatMain.hs</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Yesod</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    authRoute _ <span class="ot">=</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">AuthR</span> <span class="dt">LoginR</span> <span class="co">-- get a working login link</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Our custom defaultLayout will add the chat widget to every page.</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- We'll also add login and logout links to the top.</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    defaultLayout widget <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        pc <span class="ot">&lt;-</span> widgetToPageContent <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>            widget</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>            chatWidget <span class="dt">ChatR</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        mmsg <span class="ot">&lt;-</span> getMessage</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        withUrlRenderer</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>            [hamlet|</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>                <span class="kw">$</span><span class="er">doctype</span> <span class="er">5</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>                <span class="kw">&lt;html&gt;</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">&lt;head&gt;</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">&lt;title&gt;#{</span>pageTitle pc<span class="kw">}</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">^{</span>pageHead pc<span class="kw">}</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">&lt;body&gt;</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">$maybe</span> msg <span class="ot">&lt;-</span> mmsg</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>                            <span class="kw">&lt;div </span><span class="st">.message</span><span class="kw">&gt;#{</span>msg<span class="kw">}</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">&lt;nav&gt;</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>                            <span class="kw">&lt;a </span><span class="er">href=@{AuthR</span><span class="kw"> </span><span class="er">LoginR}</span><span class="kw">&gt;</span>Login</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>                            \ | #</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>                            <span class="kw">&lt;a </span><span class="er">href=@{AuthR</span><span class="kw"> </span><span class="er">LogoutR}</span><span class="kw">&gt;</span>Logout</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">^{</span>pageBody pc<span class="kw">}</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>            |]</span></code></pre></div>
<p>チャットサブサイトを用いているため, <code>YesodChat</code>のインスタンスを与える必要がある.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @ChatMain.hs</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">YesodChat</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    getUserName <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        muid <span class="ot">&lt;-</span> maybeAuthId</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">case</span> muid <span class="kw">of</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>                setMessage <span class="st">&quot;Not logged in&quot;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>                redirect <span class="op">$</span> <span class="dt">AuthR</span> <span class="dt">LoginR</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Just</span> uid <span class="ot">-&gt;</span> <span class="fu">return</span> uid</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    isLoggedIn <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        ma <span class="ot">&lt;-</span> maybeAuthId</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span> <span class="op">$</span> <span class="fu">maybe</span> <span class="dt">False</span> (<span class="fu">const</span> <span class="dt">True</span>) ma</span></code></pre></div>
<p><code>YesodAuth</code>と<code>RenderMessage</code>インスタンスは, ホームページのハンドラ同様かなり単純である:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @ChatMain.hs</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- Fairly standard YesodAuth instance. We'll use the dummy plugin so that you</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- can create any name you want, and store the login name as the AuthId.</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">YesodAuth</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">type</span> <span class="dt">AuthId</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">Text</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    authPlugins _ <span class="ot">=</span> [authDummy]</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    loginDest _ <span class="ot">=</span> <span class="dt">HomeR</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    logoutDest _ <span class="ot">=</span> <span class="dt">HomeR</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    getAuthId <span class="ot">=</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">.</span> credsIdent</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    maybeAuthId <span class="ot">=</span> lookupSession <span class="st">&quot;_ID&quot;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">RenderMessage</span> <span class="dt">App</span> <span class="dt">FormMessage</span> <span class="kw">where</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    renderMessage _ _ <span class="ot">=</span> defaultFormMessage</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">-- Nothing special here, just giving a link to the root of the wiki.</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="ot">getHomeR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>getHomeR <span class="ot">=</span> defaultLayout</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    [whamlet|</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;p&gt;</span>Welcome to the Wiki!</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;p&gt;</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;a </span><span class="er">href=@{wikiRoot}</span><span class="kw">&gt;</span>Wiki root</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    |]</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    wikiRoot <span class="ot">=</span> <span class="dt">WikiR</span> []</span></code></pre></div>
<h2 id="マスターサイト-wikiハンドラ">マスターサイト: wikiハンドラ</h2>
<p>さあ, wikiハンドラを書きましょう: GETはページを表示するためのもので, POSTはページを更新するためのものである. また, <code>wikiForm</code>関数を作成し, 両方のハンドラにおいて用いる.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @ChatMain.hs</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- A form for getting wiki content</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="ot">wikiForm ::</span> <span class="dt">Maybe</span> <span class="dt">Textarea</span> <span class="ot">-&gt;</span> <span class="dt">Html</span> <span class="ot">-&gt;</span> <span class="dt">MForm</span> <span class="dt">Handler</span> (<span class="dt">FormResult</span> <span class="dt">Textarea</span>, <span class="dt">Widget</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>wikiForm mtext <span class="ot">=</span> renderDivs <span class="op">$</span> areq textareaField <span class="st">&quot;Page body&quot;</span> mtext</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- Show a wiki page and an edit form</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="ot">getWikiR ::</span> [<span class="dt">Text</span>] <span class="ot">-&gt;</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>getWikiR page <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Get the reference to the contents map</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    icontent <span class="ot">&lt;-</span> <span class="fu">fmap</span> wikiContent getYesod</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- And read the map from inside the reference</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    content <span class="ot">&lt;-</span> liftIO <span class="op">$</span> readIORef icontent</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Lookup the contents of the current page, if available</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> mtext <span class="ot">=</span> Map.lookup page content</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Generate a form with the current contents as the default value.</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Note that we use the Textarea wrapper to get a &lt;textarea&gt;.</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    (form, _) <span class="ot">&lt;-</span> generateFormPost <span class="op">$</span> wikiForm <span class="op">$</span> <span class="fu">fmap</span> <span class="dt">Textarea</span> mtext</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    defaultLayout <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">case</span> mtext <span class="kw">of</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>            <span class="co">-- We're treating the input as markdown. The markdown package</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>            <span class="co">-- automatically handles XSS protection for us.</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Just</span> text <span class="ot">-&gt;</span> toWidget <span class="op">$</span> markdown def <span class="op">$</span> TL.fromStrict text</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> [whamlet|<span class="kw">&lt;p&gt;</span>Page does not yet exist|]</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>        [whamlet|</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;h2&gt;</span>Edit page</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;form </span><span class="er">method=post</span><span class="kw">&gt;</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>                <span class="kw">^{</span>form<span class="kw">}</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>                <span class="kw">&lt;div&gt;</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">&lt;input </span><span class="er">type=submit</span><span class="kw">&gt;</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>        |]</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a><span class="co">-- Get a submitted wiki page and updated the contents.</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="ot">postWikiR ::</span> [<span class="dt">Text</span>] <span class="ot">-&gt;</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>postWikiR page <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    icontent <span class="ot">&lt;-</span> <span class="fu">fmap</span> wikiContent getYesod</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    content <span class="ot">&lt;-</span> liftIO <span class="op">$</span> readIORef icontent</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> mtext <span class="ot">=</span> Map.lookup page content</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    ((res, form), _) <span class="ot">&lt;-</span> runFormPost <span class="op">$</span> wikiForm <span class="op">$</span> <span class="fu">fmap</span> <span class="dt">Textarea</span> mtext</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> res <span class="kw">of</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>        <span class="dt">FormSuccess</span> (<span class="dt">Textarea</span> t) <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>            liftIO <span class="op">$</span> atomicModifyIORef icontent <span class="op">$</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>                \m <span class="ot">-&gt;</span> (Map.insert page t m, ())</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>            setMessage <span class="st">&quot;Page updated&quot;</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>            redirect <span class="op">$</span> <span class="dt">WikiR</span> page</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>        _ <span class="ot">-&gt;</span> defaultLayout</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>                [whamlet|</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">&lt;form </span><span class="er">method=post</span><span class="kw">&gt;</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">^{</span>form<span class="kw">}</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">&lt;div&gt;</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>                            <span class="kw">&lt;input </span><span class="er">type=submit</span><span class="kw">&gt;</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>                |]</span></code></pre></div>
<h2 id="マスターサイト-実行">マスターサイト: 実行</h2>
<p>やっと, アプリケーションを実行する準備ができた. この本における以前の多くの例と異なり, <code>main</code>関数において実際の初期化を行う必要がある. <code>Chat</code>サブサイトは, 空の<code>Chan</code>を作られる必要がある. また, wikiコンテンツを格納するためのmutable変数を作る必要がある. 一度これらの値を作ってしまえば, <code>App</code>値を作成し, それを<code>warp</code>関数に渡すことができる.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- @ChatMain.hs</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Create our server event channel</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    chan <span class="ot">&lt;-</span> newChan</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Initially have a blank database of wiki pages</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    icontent <span class="ot">&lt;-</span> newIORef Map.empty</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Set web server's listening port required by warpEnv function</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- This env var is set up automatically if 'yesod devel' is used</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    setEnv <span class="st">&quot;PORT&quot;</span> <span class="st">&quot;3000&quot;</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Run our app</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    warpEnv <span class="dt">App</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        { getChat <span class="ot">=</span> <span class="dt">Chat</span> chan</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>        , wikiContent <span class="ot">=</span> icontent</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>        }</span></code></pre></div>
<h2 id="結論">結論</h2>
<p>この例では非自明なサブサイトの作り方について説明した. 大切な点は, マスターサイトへの制約を表す型クラスの使い方, <code>main</code>関数におけるデータの初期化方法と, <code>lift</code>ingにより, どのようにしてサブサイトとマスターサイトの両方の文脈で操作することが可能になるか, という点である.</p>
<p>もしサブサイトのスキルを試す方法を探しているのなら, この例を変更して, Wikiコードも自身のサブサイト上に所属しているようにすることを推奨する.</p>
      </article>

      <div class="pager">
      
      
      </div>

      <div class="row">
        <div class="col s6 offset-s6" style="position: relative; height: 100px;">
          <div class="fixed-action-btn horizontal" style="position: absolute; display: inline-block; right: 24px;">
  <a class="btn-floating btn-large red">
    <i class="large material-icons">share</i>
  </a>
  <ul>
    <li>
      <a class="btn-floating waves-effect waves-light blue tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Twitter" href="https://twitter.com/intent/tweet?text=Wiki: markdown, chat subsite, event source&url=https://haskell.e-bigmoon.com/yesod/book/examples-wiki-chat-example.html"><i class="mdi mdi-twitter white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light indigo tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Facebook" href="https://facebook.com/sharer.php?u=https://haskell.e-bigmoon.com/yesod/book/examples-wiki-chat-example.html"><i class="mdi mdi-facebook white-text"></i></a>
    </li>
  </ul>
</div>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
    </div>

    <footer class="page-footer indigo lighten-1">
  <div class="footer-copyright">
    <div class="container">
      © 2017-2020 BIGMOON&nbsp;
      Site proudly generated by <a class="red-text text-accent-1" href="http://jaspervdj.be/hakyll">Hakyll</a>,&nbsp;
      original Jekyll theme by <a class="red-text text-accent-1" href="https://github.com/mumuxme/materialize-jekyll">mumuxme</a>.
    </div>
  </div>
</footer>


    <!-- scrolltop button -->
    <button class="material-scrolltop waves-effect waves-light hide-on-small-only" type="button">
      <i class="mdi mdi-arrow-up-bold small white-text"></i>
    </button>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-19322672-9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-19322672-9');
    </script>

    <!-- jquery -->
    <script type="text/javascript" src="../../lib/jquery-min.js"></script>
    <!-- materialize -->
    <script src="../../lib/materialize/js/materialize.min.js"></script>
    <!-- <\!-- Material ScrollTop plugin -\-> -->
    <script src="../../lib/material-scrolltop/material-scrolltop.js"></script>
    <!-- main -->
    <script src="../../js/init.js"></script>
    <script src="../../js/main.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/haskell.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/yaml.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/shell.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/bash.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>

</html>
