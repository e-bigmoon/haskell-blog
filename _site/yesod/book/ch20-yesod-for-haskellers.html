<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">

  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
  <!-- MUST in hex format, may the same as header-color. This color is for android chrome browser. -->
  <meta name="theme-color" content="#5c6bc0">

  <!-- Metadata. -->
  <meta name="keywords" content="haskell,blog,bigmoon" />
  <title>Yesod for Haskellers</title>
  <meta name="description" content="BIG MOON">
  <link rel="canonical" href="../../yesod/book/ch20-yesod-for-haskellers.html">
  <link rel="alternate" type="application/atom+xml" title="Yesod for Haskellers" href="../../feed.xml" />
  <link rel="shortcut icon" href="../../images/favicon.ico" />
  <meta name="google-site-verification" content="X2YNboLvzw3_bclXLMvohyJDqj68D06_hPDMukRbgTs" />

  <!-- Stylesheets. -->
  <link rel="stylesheet" href="../../lib/materialize/css/materialize.min.css" />
  <link rel="stylesheet" href="../../css/main.css" />
  <link media="all" rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/3.3.92/css/materialdesignicons.min.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="../../lib/material-scrolltop/material-scrolltop.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/agate.min.css" />
  

  <!-- OGP -->
  <meta property="og:title" content="Yesod for Haskellers" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="/yesod/book/ch20-yesod-for-haskellers.html" />
  <!-- <meta property="og:image" content=" サムネイル画像の URL" /> -->
  <meta property="og:site_name" content="Yesod for Haskellers" />
  <meta property="og:description" content="BIG MOON" />

  <meta name="twitter:card" content="summary" />
  <!-- <meta name="twitter:site" content="@[ Twitter ID]" /> -->
  <!-- <meta name="twitter:player" content="@[ Twitter ID]" /> -->

  <noscript>
  <div class="notice-warning noscript">You don't have javascript enabled. Good luck! :(</div>
</noscript>

<!--[if IE]>
  <div class="notice-warning">Oh, you are using Internet Explorer! Good luck... :(</div>
<![endif]-->

</head>


  <body>
    <header class="site-header">
      <nav class="nav-extended indigo lighten-1">
        <div class="nav-wrapper">
  <a href="../../"><span class="site-title">BIGMOON Haskeller's BLOG</span></a>
  <a href="#" data-activates="mobile-navbar" class="button-collapse">
    <i class="mdi mdi-menu white-text"></i>
  </a>

  <ul id="nav-mobile" class="right hide-on-med-and-down">
    <li>
      <a href="../../" class="white-text">
        <i class="mdi mdi-home left indigo-text text-lighten-3"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="white-text">
        <i class="mdi mdi-account-circle left indigo-text text-lighten-3"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../books/" class="white-text">
        <i class="mdi mdi-book-open left indigo-text text-lighten-3"></i>
        Books
      </a>
    </li>
    <li>
      <a href="../../stack/" class="white-text">
        <i class="mdi mdi-wrench left indigo-text text-lighten-3"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/" class="white-text">
        <i class="mdi mdi-comment-question-outline left indigo-text text-lighten-3"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="white-text">
        <i class="mdi mdi-package-variant left indigo-text text-lighten-3"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="white-text">
        <i class="mdi mdi-earth left indigo-text text-lighten-3"></i>
        Yesod
      </a>
    </li>
    <li>
      <a href="../../feed.xml" class="white-text">
        <i class="mdi mdi-rss left indigo-text text-lighten-3"></i>
        Feed
      </a>
    </li>
  </ul>

  <ul class="side-nav" id="mobile-navbar">
    <li>
      <a href="../../" class="waves-effect waves-teal black-text">
        <i class="mdi mdi-home left green-text"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="navbar-text-colour-mobile">
        <i class="mdi mdi-account-circle left blue-text"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../books/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-book-open left blue-text"></i>
        Books
      </a>
    </li>
    <li>
      <a href="../../stack/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-wrench left blue-text"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-comment-question-outline left blue-text"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-package-variant left blue-text"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-earth left blue-text"></i>
        Yesod
      </a>
    </li>
  </ul>
</div>

      </nav>
    </header>

    <div class="site-container" id="tab-main">
      <div class="wrapper">
        <div class="post-ribbon"></div>

<div class="container page-container">
  <div class="post-page card-panel z-depth-2">
    <div class="post-section">
      <div class="post-heading">
        <div style="float: right;">
          
          <span>記事公開日: 2020/02/13</span><br>
          
          
        </div>
        <h1 class="post-title">Yesod for Haskellers</h1>
      </div>

      <article class="page-content">
        <p>本書の大部分は Yesod 内部処理の詳細についてはあまり深掘りせず、良くある一般的なタスクの実現方法に関する実用的な情報が得られるように構成されています。また、本書は Haskell の知識を前提としていますが、いくつもの Haskell ライブラリを紹介するような典型的な形式には従っていません。多くの熟練したHaskeller は、このように実装の詳細を隠されることで不快になるかもしれません。この章の目的はそのような不安に対処することです。</p>
<p>本章は簡単な最小限の Web アプリケーションから始めて、より複雑な例を構築します。そして、それらの例を通じてコンポーネントや型についての説明を行います。</p>
<h2 id="hello-warp">Hello Warp</h2>
<p>これ以上はありえないと思うぐらいシンプルなアプリケーションから始めましょう。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Example1.hs</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.HTTP.Types</span>       (status200)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai</span>              (<span class="dt">Application</span>, responseLBS)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai.Handler.Warp</span> (run)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> run <span class="dv">3000</span> app</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="ot">app ::</span> <span class="dt">Application</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>app _req sendResponse <span class="ot">=</span> sendResponse <span class="op">$</span> responseLBS</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    status200</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    [(<span class="st">&quot;Content-Type&quot;</span>, <span class="st">&quot;text/plain&quot;</span>)]</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Hello Warp!&quot;</span></span></code></pre></div>
<p>ちょっと待ってください。Yesod と関係無いじゃないですか！心配しないで下さい、すぐに Yesod につながります。私たちは本当にゼロから作り上げようとしています。その際 Yesod の土台となるのは WAI です。つまり Web アプリケーションインターフェースです。WAI は Web サーバやテストフレームワークのような web ハンドラと web アプリケーションの間に位置します。今回の場合、ハンドラは高パフォーマンス web サーバの Warp で、アプリケーションは <code>app</code> 関数です。</p>
<p>この謎の <code>Application</code> 型は何でしょうか？この型は以下の型シノニムとして定義されています。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Application</span> <span class="ot">=</span> <span class="dt">Request</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                <span class="ot">-&gt;</span> (<span class="dt">Response</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">ResponseReceived</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">ResponseReceived</span></span></code></pre></div>
<p><code>Request</code> の値はリクエストされたパス、クエリ文字列、リクエストヘッダ、リクエストボディ、クライアントのIPアドレスのような情報を含みます。2つ目の引数は “レスポンスを送る” 関数です。アプリケーションが単純に <code>IO Response</code> を返すのではなく、WAI は継続渡しスタイルを利用することで、完全な例外安全を実現しています。これは <code>bracket</code> 関数と同じやり方です。</p>
<p>これは単純なディスパッチ処理に利用することができます。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Example2.hs</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.HTTP.Types</span>       (status200)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai</span>              (<span class="dt">Application</span>, pathInfo, responseLBS)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai.Handler.Warp</span> (run)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> run <span class="dv">3000</span> app</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="ot">app ::</span> <span class="dt">Application</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>app req sendResponse <span class="ot">=</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> pathInfo req <span class="kw">of</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        [<span class="st">&quot;foo&quot;</span>, <span class="st">&quot;bar&quot;</span>] <span class="ot">-&gt;</span> sendResponse <span class="op">$</span> responseLBS</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>            status200</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>            [(<span class="st">&quot;Content-Type&quot;</span>, <span class="st">&quot;text/plain&quot;</span>)]</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;You requested /foo/bar&quot;</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        _ <span class="ot">-&gt;</span> sendResponse <span class="op">$</span> responseLBS</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>            status200</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>            [(<span class="st">&quot;Content-Type&quot;</span>, <span class="st">&quot;text/plain&quot;</span>)]</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;You requested something else&quot;</span></span></code></pre></div>
<p>WAI はパスを (文字列の手前のスラッシュで) 個々の断片に分割してから、テキストに変換します。そのため、パターンマッチが使えます。もし、元々の変換されていない <code>ByteString</code> が必要であれば <code>rawPathInfo</code> を利用してください。利用可能なフィールドに関するより詳細な情報に関しては WAI Haddock を参照してください。</p>
<p>このようにしてリクエスト側が処理されます。では、レスポンスについてはどうでしょうか？コード中の <code>responseLBS</code> は遅延 <code>ByteString</code> からレスポンスを生成するための便利な方法です。この関数は引数として、ステータスコード、レスポンスヘッダ (キー/値のペア) のリスト、ボディ自身の3つを取ります。しかし <code>responseLBS</code> はただの便利なラッパーです。内部の WAI は生バイト列を表現するために blaze-builder パッケージの <code>Builder</code> データ型を利用しています。別のレベルを掘り下げて、直接使ってみましょう。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Example3.hs</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Blaze.ByteString.Builder</span> (<span class="dt">Builder</span>, fromByteString)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.HTTP.Types</span>       (status200)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai</span>              (<span class="dt">Application</span>, responseBuilder)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai.Handler.Warp</span> (run)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> run <span class="dv">3000</span> app</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="ot">app ::</span> <span class="dt">Application</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>app _req sendResponse <span class="ot">=</span> sendResponse <span class="op">$</span> responseBuilder</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    status200</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    [(<span class="st">&quot;Content-Type&quot;</span>, <span class="st">&quot;text/plain&quot;</span>)]</span></code></pre></div>
<p><code>Builder</code> の連結操作は O(1) なので、効率的にレスポンスボディを構築することができそうです。また、blaze-builder の上に構築されている blaze-html を活用することもできます。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Example4.hs</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.HTTP.Types</span>            (status200)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai</span>                   (<span class="dt">Application</span>, responseBuilder)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai.Handler.Warp</span>      (run)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Text.Blaze.Html.Renderer.Utf8</span> (renderHtmlBuilder)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Text.Blaze.Html5</span>              (<span class="dt">Html</span>, docTypeHtml)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Text.Blaze.Html5</span>              <span class="kw">as</span> <span class="dt">H</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> run <span class="dv">3000</span> app</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="ot">app ::</span> <span class="dt">Application</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>app _req sendResponse <span class="ot">=</span> sendResponse <span class="op">$</span> responseBuilder</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    status200</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    [(<span class="st">&quot;Content-Type&quot;</span>, <span class="st">&quot;text/html&quot;</span>)] <span class="co">-- yay!</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    (renderHtmlBuilder myPage)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="ot">myPage ::</span> <span class="dt">Html</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>myPage <span class="ot">=</span> docTypeHtml <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    H.head <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        H.title <span class="st">&quot;Hello from blaze-html and Warp&quot;</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    H.body <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        H.h1 <span class="st">&quot;Hello from blaze-html and Warp&quot;</span></span></code></pre></div>
<p>しかし、純粋な <code>Builder</code> の値には <code>Response</code> の値を返す前に完全なレスポンスボディを構築しなければならないという制限があります。遅延評価があるので、これは言うほど悪いものではありません。なぜなら、全てのボディが一度にメモリに留まるわけではないためです。しかし、もし I/O を使ってレスポンスボディを生成する必要がある場合は (データベースからデータを読み込む際のように) 問題となるでしょう。</p>
<p>そのような状況に対処するために WAI はストリーミングレスポンスボディを生成するための方法を提供します。またそれによりストリームのフラッシュを明示的にコントロールできるようになります。これがどのように機能するか見てみましょう。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Example5.hs</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Blaze.ByteString.Builder</span>           (<span class="dt">Builder</span>, fromByteString)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Blaze.ByteString.Builder.Char.Utf8</span> (fromShow)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Control.Concurrent</span>                 (threadDelay)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Control.Monad</span>                      (forM_)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Control.Monad.Trans.Class</span>          (lift)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Monoid</span>                        ((&lt;&gt;))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.HTTP.Types</span>                 (status200)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai</span>                        (<span class="dt">Application</span>,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>                                                     responseStream)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai.Handler.Warp</span>           (run)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> run <span class="dv">3000</span> app</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="ot">app ::</span> <span class="dt">Application</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>app _req sendResponse <span class="ot">=</span> sendResponse <span class="op">$</span> responseStream</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    status200</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    [(<span class="st">&quot;Content-Type&quot;</span>, <span class="st">&quot;text/plain&quot;</span>)]</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    myStream</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="ot">myStream ::</span> (<span class="dt">Builder</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()) <span class="ot">-&gt;</span> <span class="dt">IO</span> () <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>myStream send flush <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    send <span class="op">$</span> fromByteString <span class="st">&quot;Starting streaming response.\n&quot;</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    send <span class="op">$</span> fromByteString <span class="st">&quot;Performing some I/O.\n&quot;</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    flush</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- pretend we're performing some I/O</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    threadDelay <span class="dv">1000000</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    send <span class="op">$</span> fromByteString <span class="st">&quot;I/O performed, here are some results.\n&quot;</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    forM_ [<span class="dv">1</span><span class="op">..</span><span class="dv">50</span><span class="ot"> ::</span> <span class="dt">Int</span>] <span class="op">$</span> \i <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>        send <span class="op">$</span> fromByteString <span class="st">&quot;Got the value: &quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>               fromShow i <span class="op">&lt;&gt;</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>               fromByteString <span class="st">&quot;\n&quot;</span></span></code></pre></div>
<div class="yesod-book-notice">
<p>以前の wai は conduit ライブラリに依存してストリーミングデータの抽象化を行っていましたが、現在は依存していません。しかし、conduit は wai-conduit パッケージによって、今もなお WAI エコシステムで良くサポートされています。</p>
</div>
<p>ストリーミングレスポンスを扱う際によく必要になるのは、ファイルハンドルのようなわずかなリソースを安全に割り当てる作業です。<em>“安全に”</em> とは、何らかの例外が発生した際にリソースが解放されることを意味します。これは、上で述べた継続渡しスタイルを使います。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Example6.hs</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Blaze.ByteString.Builder</span> (fromByteString)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString</span>          <span class="kw">as</span> <span class="dt">S</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Conduit</span>             (<span class="dt">Flush</span> (<span class="dt">Chunk</span>), ($=))</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Conduit.Binary</span>      (sourceHandle)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Conduit.List</span>        <span class="kw">as</span> <span class="dt">CL</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.HTTP.Types</span>       (status200)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai</span>              (<span class="dt">Application</span>, responseStream)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai.Handler.Warp</span> (run)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">System.IO</span>                (<span class="dt">IOMode</span> (<span class="dt">ReadMode</span>), withFile)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> run <span class="dv">3000</span> app</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="ot">app ::</span> <span class="dt">Application</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>app _req sendResponse <span class="ot">=</span> withFile <span class="st">&quot;index.html&quot;</span> <span class="dt">ReadMode</span> <span class="op">$</span> \handle <span class="ot">-&gt;</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    sendResponse <span class="op">$</span> responseStream</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        status200</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        [(<span class="st">&quot;Content-Type&quot;</span>, <span class="st">&quot;text/html&quot;</span>)]</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">$</span> \send _flush <span class="ot">-&gt;</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> loop <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>                    bs <span class="ot">&lt;-</span> S.hGet handle <span class="dv">4096</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">if</span> S.null bs</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">then</span> <span class="fu">return</span> ()</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">else</span> send (fromByteString bs) <span class="op">&gt;&gt;</span> loop</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>             <span class="kw">in</span> loop</span></code></pre></div>
<p>例外を適切に処理するため、<code>withFile</code> のような既存の例外安全関数を活用している点に注目してください。</p>
<p>しかし、ファイルを返す場合は <code>responseFile</code> を使った方が効率的です。なぜなら、不必要なバッファコピーを避けるために <code>sendfile</code> システムコールを利用するためです。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Example7.hs</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.HTTP.Types</span>       (status200)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai</span>              (<span class="dt">Application</span>, responseFile)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai.Handler.Warp</span> (run)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> run <span class="dv">3000</span> app</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="ot">app ::</span> <span class="dt">Application</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>app _req sendResponse <span class="ot">=</span> sendResponse <span class="op">$</span> responseFile</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    status200</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    [(<span class="st">&quot;Content-Type&quot;</span>, <span class="st">&quot;text/html&quot;</span>)]</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;index.html&quot;</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="co">-- means &quot;serve whole file&quot;</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>            <span class="co">-- you can also serve specific ranges in the file</span></span></code></pre></div>
<p>WAI にはここでは扱わなかった多くの特徴がまだまだあります。その中の重要なトピックの1つに、WAI ミドルウェアがあります。また、リクエストボディについては全く調査しませんでした。しかし、Yesod を理解するという目的に対しては、今のところ十分に説明しました。</p>
<h2 id="yesodについて">Yesodについて</h2>
<p>WAIやWarpについては楽しんだが, Yesodについてはまだ何も見ていない! ちょうどWAIについて学んだため, 最初の疑問点は次のようになるはずである: どのようにYesodはWAIと相互作用しているのであろうか? その答えは1つの非常に重要な関数にある:</p>
<p><code>toWaiApp :: YesodDispatch site =&gt; site -&gt; IO Application</code></p>
<p class="info">
<code>toWaiAppPlain</code>と呼ばれるより基礎的な関数が存在する. 違いは, <code>toWaiAppPlain</code>は付加的なWAIミドルウェアをインストールしないが, <code>toWaiApp</code>はログ, GZIP圧縮やHEADリクエストメソッドハンドリングのような, 一般的に用いられるミドルウェアを与える.
</p>
<p>この関数はサイト値を取るが, それは<code>YesodDispatch</code>のインスタンスである必要がある. そして, <code>Application</code>を構築する. この関数は<code>IO</code>モナドになる. なぜならば, それは共有のログバッファの割り当てのような操作を行うためである. より興味深い疑問点としては, <code>site</code>値が何であるかである.</p>
<p>Yesodはファウンデーションデータ型という概念を持つ. これは各々のアプリケーションの中心にあるデータ型であり, 3つの重要な方法で用いられる.</p>
<ul>
<li><p>それは, HTTPコネクションマネージャ, データベースコネクションプール, ファイルからロードされたセッティングや, カウンタやキャッシュのような大域的な可変状態などの初期化され, アプリケーション全体に渡り共有される値を保持する.</p></li>
<li><p>型クラスのインスタンスは, アプリケーションに関するより多くの情報を与える. <code>Yesod</code>型クラスは, デフォルトのテンプレートがどのようであるかや, 許容される最大のリクエストボディサイズのような, 様々な設定を持つ. <code>YesodDispatch</code>クラスはどのように, 入ってくるリクエストがハンドラ関数にディスパッチされるかについて, 指示する. そして, Yesodヘルパライブラリには, i18nサポートのための<code>RenderMessage</code>や, jQuery Javascriptライブラリの共通の場所を与える<code>YesodJquery</code>のような, 多くの共通に用いられる型クラスが存在する.</p></li>
<li><p>関連型(タイプファミリのような)は, 各アプリケーションに対し, 関連するルートデータ型を作るために用いられる. これは, アプリケーションにおける全ての合法的なルートを表す, 単純なADTである. しかし, 直接文字列を用いる代わりに, この中間データ型を用いることで, Yesodアプリケーションはコンパイラを利用し, 無効なリンクを防ぐことができる. この特徴は, 型安全URLと呼ばれる.</p></li>
</ul>
<p>この章における考え方に沿って, 最初のYesodアプリケーションを全てを手動で書くことで, 苦労して作ってみる. 進むにつれ, より便利なヘルパを順次追加していく.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TypeFamilies      #-}</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.HTTP.Types</span>            (status200)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai</span>                   (responseBuilder)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai.Handler.Warp</span>      (run)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Text.Blaze.Html.Renderer.Utf8</span> (renderHtmlBuilder)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Text.Blaze.Html5</span>              <span class="kw">as</span> <span class="dt">H</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod.Core</span>                    (<span class="dt">Html</span>, <span class="dt">RenderRoute</span> (..), <span class="dt">Yesod</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                                                <span class="dt">YesodDispatch</span> (<span class="op">..</span>), toWaiApp)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod.Core.Types</span>              (<span class="dt">YesodRunnerEnv</span> (..))</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Our foundation datatype.</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">App</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> welcomeMessage ::</span> <span class="op">!</span><span class="dt">Html</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Yesod</span> <span class="dt">App</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">RenderRoute</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">data</span> <span class="dt">Route</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">HomeR</span> <span class="co">-- just one accepted URL</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Read</span>, <span class="dt">Eq</span>, <span class="dt">Ord</span>)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    renderRoute <span class="dt">HomeR</span> <span class="ot">=</span> ( [] <span class="co">-- empty path info, means &quot;/&quot;</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>                        , [] <span class="co">-- empty query string</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">YesodDispatch</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    yesodDispatch (<span class="dt">YesodRunnerEnv</span> _logger site _sessionBackend _ _) _req sendResponse <span class="ot">=</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>        sendResponse <span class="op">$</span> responseBuilder</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>            status200</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>            [(<span class="st">&quot;Content-Type&quot;</span>, <span class="st">&quot;text/html&quot;</span>)]</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>            (renderHtmlBuilder <span class="op">$</span> welcomeMessage site)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- We could get this message from a file instead if we wanted.</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> welcome <span class="ot">=</span> H.p <span class="st">&quot;Welcome to Yesod!&quot;</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    waiApp <span class="ot">&lt;-</span> toWaiApp <span class="dt">App</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        { welcomeMessage <span class="ot">=</span> welcome</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    run <span class="dv">3000</span> waiApp</span></code></pre></div>
<p>さあ, かなり多くの新しいものを追加したが, 一度にそれらを見てみよう. まず最初に, 新しいデータ型である<code>App</code>を構築した. これは, 各アプリケーションにおいて, ファウンデーションデータ型の名前として共通に用いられるが, どんな名前でも好きなものを用いてよい. このデータ型に1つのフィールドを追加した. それは, <code>welcomeMessage</code>でありホームページにおけるコンテンツを持っている.</p>
<p>次に, Yesodインスタンスを宣言する. この例に関しては, 全てのメソッドにおいてデフォルト値を用いる. より興味深いのは, <code>RenderRoute</code>型クラスである. これは型安全URLの中心部である. <code>App</code>に関する関連データ型を作る. それらは, アプリケーションにおける全ての許容されたルートを一覧にする. この場合, 1つだけ追加した: それは<code>HomeR</code>と呼ぶホームページである. 全てのルートデータコンストラクタに<code>R</code>を付加することは, Yesodにおける名称をつける際の慣習である.</p>
<p>また, <code>renderRoute</code>メソッドを作る必要がある. それは, 各型安全ルート値をパスピースと, クエリストリングパラメータのタプルに変換する. 後に, より興味深い例を挙げるが, 今の段階では, それら両方については空リストになっている.</p>
<p><code>YesodDispatch</code>はアプリケーションの振る舞いを決定する. それは<code>YesodDispatch</code>と呼ばれる1つのメソッドを持つ:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ot">yesodDispatch ::</span> <span class="dt">YesodRunnerEnv</span> site <span class="ot">-&gt;</span> <span class="dt">Application</span></span></code></pre></div>
<p><code>YesodRunnerEnv</code>は3つの値を与える: ログメッセージを出力するための<code>Logger</code>値, ファウンデーションデータ型それ自身, ユーザのアクティブセッションにおいて情報を格納したり, 取得したりするためのセッションバックエンド. 実際のYesodアプリケーションにおいては, すぐにわかるように, これらの値を直接扱う必要はない. しかし, 表面下に何があるかを理解することは有益である.</p>
<p><code>YesodDispatch</code>の戻り値の型はWAIからの<code>Application</code>である. しかし最初の方で見たように, <code>Application</code>は単なる<code>Request</code>から<code>Response</code>へのCPSed(継続渡しスタイル)関数である. 従って, <code>YesodDispatch</code>の実装については, 上のWAIで学んだことを使うことができる. どのようにファウンデーションデータ型から<code>welcomeMessage</code>にアクセスするかについても注意せよ.</p>
<p>最後に, <code>main</code>関数がある. <code>App</code>値は作るのが容易であり, お分かりのように, ウェルカムメッセージを得るためにI/O操作を同じくらい容易にできたはずである. <code>toWaiApp</code>を用いて, WAIアプリケーションを得て, 前に行ったようにアプリケーションをワープに渡す.</p>
<p>おめでとうございます, 最初のYesodアプリケーションを作ることができました!(あるいは, 少なくともこの章における最初のアプリケーションである.)</p>
<h2 id="handlert-monad-transformer">HandlerT monad transformer</h2>
<p>その例はYesodを技巧的に使っているが, 信じがたいほどに刺激性のないものである. WAIに関しては, Yesodは邪魔になる以外, 何も行っていないことに関する疑念はない. それは, Yesodの機能を何も利用し始めていないためである. <code>HandlerT</code>モナドトランスフォーマから初めて, それに対処しよう.</p>
<p>単一のリクエストを処理する際に, 一般的に行いたいことが多く存在する, 例えば:</p>
<ul>
<li><p>何らかのHTMLを返す.</p></li>
<li><p>異なるURLにリダイレクトする.</p></li>
<li><p>404 not foundレスポンスを返す.</p></li>
<li><p>ログを取る.</p></li>
</ul>
<p>これら共通の機能全てをカプセル化するために, Yesodは<code>HandlerT</code>モナドトランスフォーマを与える. Yesodにおけるコードの大部分は, このトランスフォーマに存在するため, それには精通すべきである. 前の例における<code>YesodDispatch</code>インスタンスを<code>HandlerT</code>を利用する新しいインスタンスで置き換えるところから始めよう:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TypeFamilies      #-}</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai</span>              (pathInfo)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai.Handler.Warp</span> (run)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Text.Blaze.Html5</span>         <span class="kw">as</span> <span class="dt">H</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod.Core</span>               (<span class="dt">HandlerT</span>, <span class="dt">Html</span>, <span class="dt">RenderRoute</span> (..),</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                                           <span class="dt">Yesod</span>, <span class="dt">YesodDispatch</span> (<span class="op">..</span>), getYesod,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                                           notFound, toWaiApp, yesodRunner)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Our foundation datatype.</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">App</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> welcomeMessage ::</span> <span class="op">!</span><span class="dt">Html</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Yesod</span> <span class="dt">App</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">RenderRoute</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">data</span> <span class="dt">Route</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">HomeR</span> <span class="co">-- just one accepted URL</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Read</span>, <span class="dt">Eq</span>, <span class="dt">Ord</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    renderRoute <span class="dt">HomeR</span> <span class="ot">=</span> ( [] <span class="co">-- empty path info, means &quot;/&quot;</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>                        , [] <span class="co">-- empty query string</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="ot">getHomeR ::</span> <span class="dt">HandlerT</span> <span class="dt">App</span> <span class="dt">IO</span> <span class="dt">Html</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>getHomeR <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    site <span class="ot">&lt;-</span> getYesod</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="op">$</span> welcomeMessage site</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">YesodDispatch</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    yesodDispatch yesodRunnerEnv req sendResponse <span class="ot">=</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> maybeRoute <span class="ot">=</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>                <span class="kw">case</span> pathInfo req <span class="kw">of</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>                    [] <span class="ot">-&gt;</span> <span class="dt">Just</span> <span class="dt">HomeR</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>                    _  <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>            handler <span class="ot">=</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>                <span class="kw">case</span> maybeRoute <span class="kw">of</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> notFound</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">Just</span> <span class="dt">HomeR</span> <span class="ot">-&gt;</span> getHomeR</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>         <span class="kw">in</span> yesodRunner handler yesodRunnerEnv maybeRoute req sendResponse</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- We could get this message from a file instead if we wanted.</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> welcome <span class="ot">=</span> H.p <span class="st">&quot;Welcome to Yesod!&quot;</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    waiApp <span class="ot">&lt;-</span> toWaiApp <span class="dt">App</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>        { welcomeMessage <span class="ot">=</span> welcome</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    run <span class="dv">3000</span> waiApp</span></code></pre></div>
<p><code>getHomeR</code>は最初のハンドラ関数である. (その名前はYesodの世界におけるさらに他の名称慣習である: 小文字のHTTPリクエストメソッドに続き, ルートコンストラクタ名がある.) その型注釈に注意しなさい: <code>HandlerT App IO Html</code>. <code>HandlerT App IO</code>モナドスタックを持つことは非常に一般的であるため, 大部分のアプリケーションはその型シノニムを持つ. <code>type Handler = HandlerT App IO</code>. その関数は<code>Html</code>を返す. Yesodは<code>Html</code>値に対してのみ機能するようにハードコードされているのか, 疑問に思うかもしれない. すぐにそれについての詳細を説明する.</p>
<p>関数の中身は端的である. <code>getYesod</code>関数を用いて, ファウンデーションデータ値を得て, <code>welcomeMessage</code>フィールドを返す. 進行するにつれ, より興味深いハンドラを構築する.</p>
<p><code>YesodDispatch</code>の実装は今や全く異なったものである. そのための鍵となるのは, <code>yesodRunner</code>関数であり, それは, <code>HandlerT</code>スタックをWAI <code>Application</code>に変換するための, ローレベル関数である. その型注釈を見てみよう:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ot">yesodRunner ::</span> (<span class="dt">ToTypedContent</span> res, <span class="dt">Yesod</span> site)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>            <span class="ot">=&gt;</span> <span class="dt">HandlerT</span> site <span class="dt">IO</span> res</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>            <span class="ot">-&gt;</span> <span class="dt">YesodRunnerEnv</span> site</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>            <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">Route</span> site)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>            <span class="ot">-&gt;</span> <span class="dt">Application</span></span></code></pre></div>
<p>前の例からすでに<code>YesodRunnerEnv</code>には精通している. 上の<code>yesodRunner</code>の呼び出しでもわかる通り, その値は変更せずに渡される. <code>Maybe (Route site)</code>は多少興味深く, どのように型安全URLが機能するかについてより洞察を与える. 今まで, これらのURLのレンダリング側のみ見てきた. しかし, パーズ側も同様に重要である: リクエストされたパスをルート値に変換する. 例においては, このコードは数行に過ぎず, 結果を<code>maybeRoute</code>に格納している.</p>
<p class="info">
現在のパーズ関数が小さいことは確かであるが, 大きなアプリケーションにおいてはより複雑である必要があり, 動的パラメータのような問題も扱う. その点においては, パーズ, レンダリング関数が適切な配置にあることを保証するのは, 些細でない試みである. 後にYesodがそれをどのように対処するかについて学ぶ.
</p>
<p><code>Yesod Runner</code>へのパラメータに戻ろう: つい先ほどは<code>Maybe (Route site)</code>と<code>YesodRunnerEnv site</code>を扱った. <code>HandlerT site IO res</code>値を得るために, <code>maybeRoute</code>でパターンマッチを行う. もし, <code>Just HomeR</code>の場合, <code>getHomeR</code>を使う. その他の場合, <code>notFound</code>関数を用いる. これは, 404 not foundレスポンスを返す内蔵の関数であり, デフォルトのサイトテンプレートを用いる. テンプレートはYesod型クラスでオーバーライド可能である; それは単なるつまらないHTMLページである.</p>
<p>1つの例外を除き, 全て意味を成している: <code>ToTypedContent</code>型クラスは何であり, <code>Html</code>レスポンスとどんな関係があるのであろうか? 上の質問から答えることにしよう: いいえ, Yesodは決して<code>Html</code>に対しハードコードサポートしている訳ではない. ハンドラ関数は<code>ToTypedContent</code>インスタンスを持つどんな値でも返すことができる. この型クラス(すぐに調べるであろう)は, mime型と, WAIが消費できるデータの表現の両者を与える. <code>yesodRunner</code>はそれをWAIレスポンスに変換し, <code>Content-type</code>レスポンスヘッダをmime型にセットし, 200 OKステータスコードを用いて, レスポンスボディを送信する.</p>
<h3 id="tocontent-totypedcontent">(To)Content, (To)TypedContent</h3>
<p>Yesodのコンテンツシステムの中心部には次の型が存在する:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Content</span> <span class="ot">=</span> <span class="dt">ContentBuilder</span> <span class="op">!</span><span class="dt">Builder</span> <span class="op">!</span>(<span class="dt">Maybe</span> <span class="dt">Int</span>) <span class="co">-- ^ The content and optional content length.</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>             <span class="op">|</span> <span class="dt">ContentSource</span> <span class="op">!</span>(<span class="dt">Source</span> (<span class="dt">ResourceT</span> <span class="dt">IO</span>) (<span class="dt">Flush</span> <span class="dt">Builder</span>))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>             <span class="op">|</span> <span class="dt">ContentFile</span> <span class="op">!</span><span class="dt">FilePath</span> <span class="op">!</span>(<span class="dt">Maybe</span> <span class="dt">FilePart</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>             <span class="op">|</span> <span class="dt">ContentDontEvaluate</span> <span class="op">!</span><span class="dt">Content</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">ContentType</span> <span class="ot">=</span> <span class="dt">ByteString</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">TypedContent</span> <span class="ot">=</span> <span class="dt">TypedContent</span> <span class="op">!</span><span class="dt">ContentType</span> <span class="op">!</span><span class="dt">Content</span></span></code></pre></div>
<p><code>Content</code>はWAIレスポンス型を少し思い出させるであろう. <code>ContentBuilder</code>は<code>ResponseBuilder</code>と類似しており, <code>ContentSource</code>は<code>responseStream</code>に似ているが, conduitに特化しており, <code>ContentFile</code>は<code>responseFile</code>に類似している. WAIの対応物と異なり, これらのどのコンストラクタもステータスコードやレスポインスヘッダについての情報を含まない; それはYesodにおいては, 別で扱われる.</p>
<p>1つの完全に新しいコンストラクタは, <code>ContentDontEvaluate</code>である. デフォルトでは, Yesodにおいてレスポンスボディを作る際, Yesodはレスポンスを生成する前に, ボディを完全に評価する. この理由としては, 値に純粋でないエラーが存在しないことを保証するためである. Yesodはレスポンスを送り始める前に, このような例外をキャッチすることを確実にしようとしている. そのため, もし例外が発生した場合, エラーでないレスポンスを送る途上で落ちてしまう代わりに, 適切な500 internal serverエラーを生成することができる. しかし, この評価を行うには, よりメモリを必要とする. したがって, Yesodはこの保護から外す方法を提供する.</p>
<p><code>TypedContent</code>は<code>Content</code>に多少の追加を行ったものである: それは, 同様に<code>ContentType</code>を含む. アプリケーションは指定されなければ200 OKステータスを返すという慣習と共に, <code>TypedContent</code>型からレスポンスを生成するために必要な全てのものを取得できる.</p>
<p>Yesodはユーザに常に<code>TypedContent</code>を, ハンドラ関数から返すことを要求する方法を取り得たかもしれない. しかし, それは手動でその型に変換することを要したであろう. 代わりに, Yesodはこのために, <code>ToContent</code>と<code>ToTypedContent</code>という適切に命名された2つの型クラスを用いる. それらは, 正に予想通りの定義である.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">ToContent</span> a <span class="kw">where</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    toContent ::</span> a <span class="ot">-&gt;</span> <span class="dt">Content</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">ToContent</span> a <span class="ot">=&gt;</span> <span class="dt">ToTypedContent</span> a <span class="kw">where</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="ot">    toTypedContent ::</span> a <span class="ot">-&gt;</span> <span class="dt">TypedContent</span></span></code></pre></div>
<p>そして, Yesodは多くの一般的に用いられるデータ型に対し, インスタンスを与え, <code>Text</code>, <code>Html</code>, そして, aesonの<code>Value</code>型(JSONデータを含む)が含まれる. そのようにして, <code>getHomeR</code>関数は<code>Html</code>を返すことができる: Yesodはそれをどのように<code>TypedContent</code>に変換するかを知っており, そこから<code>WAI</code>レスポンスに変換される.</p>
<h3 id="hascontenttypeと表現">HasContentTypeと表現</h3>
<p>この型クラスによる方法は, 1つの新しいよい抽象化を与える. 多くの型の場合, 型システム自身は, コンテンツのコンテンツタイプが何であるべきかを知らせる. 例えば, <code>Html</code>は 常に, <code>text/html</code>コンテンツタイプで扱われる.</p>
<p class="info">
これは<code>ToTypedContent</code>の全てのインスタンスに対し正しい訳ではない. 反例として, <code>ToTypedContent TypedContent</code>インスタンスを考えてみよ.
</p>
<p>ウェブアプリケーションに対するリクエストのいくつかは, 様々な表現で表示される. 例えば, 表形式データのリクエストは次のように扱われる:</p>
<ul>
<li><p>HTMLの表</p></li>
<li><p>CSVファイル</p></li>
<li><p>XML</p></li>
<li><p>クライアント側により消費されるJSONデータ</p></li>
</ul>
<p>HTTP使用によりクライアントは<code>accept</code>リクエストヘッダを通して, 表現方法を指定できる. そして, Yesodによりハンドラ関数が<code>selectRep</code>/<code>provideRep</code>関数の組み合わせを用いて, 複数の表現を与え, フレームワークにクライアントヘッダに基づき, 自動的に適切なものを選ばせることが可能になる.</p>
<p>これらを全て機能させるために, 最後に残ったものは, <code>HasContentType</code>型クラスである:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">ToTypedContent</span> a <span class="ot">=&gt;</span> <span class="dt">HasContentType</span> a <span class="kw">where</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    getContentType ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> m a <span class="ot">-&gt;</span> <span class="dt">ContentType</span></span></code></pre></div>
<p>パラメータ<code>m a</code>は, 単なる<code>Proxy</code>型である. 後から考えると<code>Proxy</code>を用いるべきだったが, 今や互換性を破る変更でしかない. この型クラスには, <code>ToTypedContent</code>によりサポートされている大部分の型に対しインスタンスが存在する. 以下では, データの複数の表現を与えるため上の例を少し変更してみましょう:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TypeFamilies      #-}</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Text</span>                (<span class="dt">Text</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai</span>              (pathInfo)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai.Handler.Warp</span> (run)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Text.Blaze.Html5</span>         <span class="kw">as</span> <span class="dt">H</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod.Core</span>               (<span class="dt">HandlerT</span>, <span class="dt">Html</span>, <span class="dt">RenderRoute</span> (..),</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>                                           <span class="dt">TypedContent</span>, <span class="dt">Value</span>, <span class="dt">Yesod</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>                                           <span class="dt">YesodDispatch</span> (<span class="op">..</span>), getYesod,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>                                           notFound, object, provideRep,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>                                           selectRep, toWaiApp, yesodRunner,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>                                           (<span class="op">.=</span>))</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Our foundation datatype.</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">App</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> welcomeMessageHtml ::</span> <span class="op">!</span><span class="dt">Html</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> welcomeMessageText ::</span> <span class="op">!</span><span class="dt">Text</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> welcomeMessageJson ::</span> <span class="op">!</span><span class="dt">Value</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Yesod</span> <span class="dt">App</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">RenderRoute</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">data</span> <span class="dt">Route</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">HomeR</span> <span class="co">-- just one accepted URL</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Read</span>, <span class="dt">Eq</span>, <span class="dt">Ord</span>)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    renderRoute <span class="dt">HomeR</span> <span class="ot">=</span> ( [] <span class="co">-- empty path info, means &quot;/&quot;</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>                        , [] <span class="co">-- empty query string</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="ot">getHomeR ::</span> <span class="dt">HandlerT</span> <span class="dt">App</span> <span class="dt">IO</span> <span class="dt">TypedContent</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>getHomeR <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    site <span class="ot">&lt;-</span> getYesod</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    selectRep <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>        provideRep <span class="op">$</span> <span class="fu">return</span> <span class="op">$</span> welcomeMessageHtml site</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>        provideRep <span class="op">$</span> <span class="fu">return</span> <span class="op">$</span> welcomeMessageText site</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>        provideRep <span class="op">$</span> <span class="fu">return</span> <span class="op">$</span> welcomeMessageJson site</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">YesodDispatch</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>    yesodDispatch yesodRunnerEnv req sendResponse <span class="ot">=</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> maybeRoute <span class="ot">=</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>                <span class="kw">case</span> pathInfo req <span class="kw">of</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>                    [] <span class="ot">-&gt;</span> <span class="dt">Just</span> <span class="dt">HomeR</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>                    _  <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>            handler <span class="ot">=</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>                <span class="kw">case</span> maybeRoute <span class="kw">of</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> notFound</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">Just</span> <span class="dt">HomeR</span> <span class="ot">-&gt;</span> getHomeR</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>         <span class="kw">in</span> yesodRunner handler yesodRunnerEnv maybeRoute req sendResponse</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>    waiApp <span class="ot">&lt;-</span> toWaiApp <span class="dt">App</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>        { welcomeMessageHtml <span class="ot">=</span> H.p <span class="st">&quot;Welcome to Yesod!&quot;</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>        , welcomeMessageText <span class="ot">=</span> <span class="st">&quot;Welcome to Yesod!&quot;</span></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>        , welcomeMessageJson <span class="ot">=</span> object [<span class="st">&quot;msg&quot;</span> <span class="op">.=</span> (<span class="st">&quot;Welcome to Yesod!&quot;</span><span class="ot"> ::</span> <span class="dt">Text</span>)]</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>    run <span class="dv">3000</span> waiApp</span></code></pre></div>
<h3 id="便利なwarp関数">便利なwarp関数</h3>
<p>Yesodの世界においてかなり見かける1つの小さな便利な関数. <code>toWaiApp</code>を呼び, WAI <code>Application</code>を作り, それをWarpの<code>run</code>関数に渡すことは非常一般的である. よって, Yesodは便利な<code>warp</code>ラッパー関数を与える. 前の例における<code>main</code>関数を次で置き換えることができる:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    warp <span class="dv">3000</span> <span class="dt">App</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        { welcomeMessageHtml <span class="ot">=</span> H.p <span class="st">&quot;Welcome to Yesod!&quot;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        , welcomeMessageText <span class="ot">=</span> <span class="st">&quot;Welcome to Yesod!&quot;</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        , welcomeMessageJson <span class="ot">=</span> object [<span class="st">&quot;msg&quot;</span> <span class="op">.=</span> (<span class="st">&quot;Welcome to Yesod!&quot;</span><span class="ot"> ::</span> <span class="dt">Text</span>)]</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        }</span></code></pre></div>
<p><code>warpEnd</code>関数もあり, これは, ポートナンバを<code>PORT</code>環境変数から読み取る. これは, FP Haskell Centerや. Keterなどのデプロイメントツールのようなプラットフォームで作業する場合に有用である.</p>
<h2 id="ハンドラを書く">ハンドラを書く</h2>
<p>大部分のアプリケーションは<code>HandlerT</code>モナドトランスフォーマに存在することになるため, その文脈において機能するかなり多くの関数が存在することは驚くべきことではない. <code>HandlerT</code>は多くの共通の型クラスのインスタンスであり, <code>MonadIO</code>, <code>MonadTrans</code>, <code>MonadBaseControl</code>, <code>MonadLogger</code>, そして, <code>MonadResource</code>を含み, その結果自動的にそれらの機能を利用することができる.</p>
<p>その標準的機能の他に, 次に挙げるのは関数の一般的なカテゴリである. Yesodがハンドラ関数に置く唯一の要求は, 最終的にそれらが, <code>ToTypedContent</code>のインスタンスである型を返すことである.</p>
<p>この章は機能の端的な概略に過ぎない, 詳細については, Haddockかこの本の残りを調べるべきである.</p>
<h3 id="リクエストパラメータを得る">リクエストパラメータを得る</h3>
<p>リクエストの中でクライアントにより与えられるいくつかの情報がある:</p>
<ul>
<li><p>リクエストされるパス. これは大抵Yesodのルーティングフレームワークにより制御され, ハンドラ関数に直接問い合わせられる訳ではない.</p></li>
<li><p>クエリ文字列パラメータ. これは, <code>lookupGetParam</code>により問い合わせられる.</p></li>
<li><p>リクエストボディ. URLエンコードされたmultipartボディの場合, リクエストパラメータを得るために<code>lookupPostParam</code>を用いることができる. multipartボディについては, ファイルパラメータに対し, <code>lookupFile</code>が存在する.</p></li>
<li><p>リクエストヘッダは<code>lookupHeader</code>を用いて問い合わせられる. (そして, レスポンスヘッダは<code>addHeader</code>によりセットされる).</p></li>
<li><p>Yesodは自動的にクッキをパーズし, <code>lookUpCookie</code>を用いて問い合わせられる. (クッキは<code>setCookie</code>によりセットされる.)</p></li>
<li><p>最後に, Yesodはユーザセッションフレームワークを与える. そこでは, データは暗号化された安全なセッションに セットされ, 各々のユーザと関連づけられる. これは<code>lookupSession</code>, <code>setSession</code>, そして<code>deleteSession</code>を用いて問い合わせられ, セットされる.</p></li>
</ul>
<p>フォームを処理するような目的のために, 直接これらの関数を用いることができるが, yesod-formライブラリを用いたいと思うであろう. それは, applicativeフォームに基づいた高レベルの抽象化フォームを与える.</p>
<h3 id="short-circuiting">Short circuiting</h3>
<p>リクエストの処理をショートカットしたい場合があるであろう. これを行う理由としては以下のようになる:</p>
<ul>
<li><p><code>redirect</code>関数を用いて. HTTPリダイレクトを送る. これはデフォルトで, 303ステータスコードを用いることになる. これをより制御したい場合, <code>redirectWith</code>を用いることができる.</p></li>
<li><p><code>notFound</code>では, 404 not foundを, <code>badMethod</code>では405 bad methodを返す.</p></li>
<li><p><code>notAuthenticated</code>, <code>permissionDenied</code>, または, <code>invalidArgs</code>によりリクエストにおけるエラーを指摘する.</p></li>
<li><p><code>sendFile</code>や<code>sendResponseStatus</code>(status 200レスポンスコードをオーバーライドするために)で, 特別なレスポンスを送る.</p></li>
<li><p>抽象化のレベルを落とし, Yesodによる抽象化をバイパスして, WAI自身を用いるために, <code>sendWaiResponse</code>を使う.</p></li>
</ul>
<h3 id="streaming">Streaming</h3>
<p>今までのところ, 挙げられた<code>ToTypedContent</code>インスタンスの例は全て, ストリーミングでないレスポンスに関連するものであった. <code>Html</code>, <code>Text</code>, そして, <code>Value</code>は全て<code>ContentBuilder</code>コンストラクタに変換される. そのため, それらはデータをユーザに送る途中でI/Oを挟むことはできない. そのように途中でI/O操作を行いたい場合, 何が生じるであろうか.</p>
<p>WAIにおいてこの問題に遭遇した場合, レスポンスを構築するために<code>responseSource</code>メソッドを導入した. <code>sendWaiResponse</code>を用いることで, Yesodにおいてストレーミングレスポンスを作るために, 同じメソッドを再利用できる. しかし, これを行うためのより単純なAPIが存在する: <code>respondSource</code>. <code>respondSource</code>は, 2つのパラメータを取る: レスポンスのコンテンツ型と, <code>Flush Builder</code>の<code>Source</code>である. Yesodはまた, <code>sendChunk</code>, <code>sendChunkBS</code>, そして, <code>sendChunkText</code>のような<code>Source</code>を作るためのいくつもの便利な関数を提供する.</p>
<p>ここに例を挙げる. ここでは, 最初の<code>responseSource</code>の例をWAIからYesodに変換する.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TypeFamilies      #-}</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Blaze.ByteString.Builder</span>           (fromByteString)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Blaze.ByteString.Builder.Char.Utf8</span> (fromShow)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Control.Concurrent</span>                 (threadDelay)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Control.Monad</span>                      (forM_)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Monoid</span>                        ((&lt;&gt;))</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Network.Wai</span>                        (pathInfo)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod.Core</span>                         (<span class="dt">HandlerT</span>, <span class="dt">RenderRoute</span> (..),</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>                                                     <span class="dt">TypedContent</span>, <span class="dt">Yesod</span>,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>                                                     <span class="dt">YesodDispatch</span> (<span class="op">..</span>), liftIO,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>                                                     notFound, respondSource,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>                                                     sendChunk, sendChunkBS,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>                                                     sendChunkText, sendFlush,</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>                                                     warp, yesodRunner)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Our foundation datatype.</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">App</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Yesod</span> <span class="dt">App</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">RenderRoute</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">data</span> <span class="dt">Route</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">HomeR</span> <span class="co">-- just one accepted URL</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Read</span>, <span class="dt">Eq</span>, <span class="dt">Ord</span>)</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    renderRoute <span class="dt">HomeR</span> <span class="ot">=</span> ( [] <span class="co">-- empty path info, means &quot;/&quot;</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>                        , [] <span class="co">-- empty query string</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="ot">getHomeR ::</span> <span class="dt">HandlerT</span> <span class="dt">App</span> <span class="dt">IO</span> <span class="dt">TypedContent</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>getHomeR <span class="ot">=</span> respondSource <span class="st">&quot;text/plain&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    sendChunkBS <span class="st">&quot;Starting streaming response.\n&quot;</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    sendChunkText <span class="st">&quot;Performing some I/O.\n&quot;</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    sendFlush</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- pretend we're performing some I/O</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    liftIO <span class="op">$</span> threadDelay <span class="dv">1000000</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    sendChunkBS <span class="st">&quot;I/O performed, here are some results.\n&quot;</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    forM_ [<span class="dv">1</span><span class="op">..</span><span class="dv">50</span><span class="ot"> ::</span> <span class="dt">Int</span>] <span class="op">$</span> \i <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>        sendChunk <span class="op">$</span> fromByteString <span class="st">&quot;Got the value: &quot;</span> <span class="op">&lt;&gt;</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>                    fromShow i <span class="op">&lt;&gt;</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>                    fromByteString <span class="st">&quot;\n&quot;</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">YesodDispatch</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>    yesodDispatch yesodRunnerEnv req sendResponse <span class="ot">=</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> maybeRoute <span class="ot">=</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>                <span class="kw">case</span> pathInfo req <span class="kw">of</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>                    [] <span class="ot">-&gt;</span> <span class="dt">Just</span> <span class="dt">HomeR</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>                    _  <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>            handler <span class="ot">=</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>                <span class="kw">case</span> maybeRoute <span class="kw">of</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> notFound</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">Just</span> <span class="dt">HomeR</span> <span class="ot">-&gt;</span> getHomeR</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>         <span class="kw">in</span> yesodRunner handler yesodRunnerEnv maybeRoute req sendResponse</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> warp <span class="dv">3000</span> <span class="dt">App</span></span></code></pre></div>
<p>##　動的パラメータ</p>
<p>さあ, <code>HandlerT</code>トランスフォーマの詳細についての回り道は終了したため, より高レベルのYesodリクエスト処理に戻ろう. 今までのところ, 全ての例は単一でサポートされたリクエストルートを扱ってきた. これをより楽しいものにしよう. これから, Fibonacci数を扱うアプリケーションを作りたい. もし, <code>/fib/5</code>へリクエストする場合, 5番目のFibonacci数が返ってくる. もし, <code>/</code>を訪問する場合, 自動的に<code>/fib/1</code>にリダイレクトする.</p>
<p>Yesodの世界において, 最初に尋ねるべき質問としては: どのようにルートデータ型をモデルかするか? これは非常に率直である: <code>data Route App = HomeR | FibR Int</code>. 質問としては: どのように<code>RenderRoute</code>インスタンスを定義したいか? <code>Int</code>を<code>Text</code>に変換する必要がある. どの関数を使うべきであろうか?</p>
<p>それについて答える前に, ディスパッチ目的のため<code>Text</code>を<code>Int</code>にパーズして戻す必要があることを理解しなさい. したがって, <code>fromText . toText == Just</code>という性質を持つような, 関数のペアを持っていることを確認する必要がある. <code>Show</code>/<code>Read</code>は次を除いて, その候補となる:</p>
<ol type="1">
<li><p><code>String</code>を通し変換する必要がある.</p></li>
<li><p><code>Text</code>と<code>String</code>の<code>Show</code>/<code>Read</code>インスタンスは両方とも, 望まぬ余計なエスケープを含む.</p></li>
</ol>
<p>代わりに, Yesodによってとられる方法は, path-pieceパッケージであり, 特に<code>PathPiece</code>型クラスは次のように定義される:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">PathPiece</span> s <span class="kw">where</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    fromPathPiece ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> s</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="ot">    toPathPiece   ::</span> s    <span class="ot">-&gt;</span> <span class="dt">Text</span></span></code></pre></div>
<p>この型クラスを使うことで, ルートデータ型のためのパーズ関数とレンダリング関数を書くことができる.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">RenderRoute</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">data</span> <span class="dt">Route</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">HomeR</span> <span class="op">|</span> <span class="dt">FibR</span> <span class="dt">Int</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Read</span>, <span class="dt">Eq</span>, <span class="dt">Ord</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    renderRoute <span class="dt">HomeR</span> <span class="ot">=</span> ([], [])</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    renderRoute (<span class="dt">FibR</span> i) <span class="ot">=</span> ([<span class="st">&quot;fib&quot;</span>, toPathPiece i], [])</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>parseRoute' [] <span class="ot">=</span> <span class="dt">Just</span> <span class="dt">HomeR</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>parseRoute' [<span class="st">&quot;fib&quot;</span>, i] <span class="ot">=</span> <span class="dt">FibR</span> <span class="op">&lt;$&gt;</span> fromPathPiece i</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>parseRoute' _ <span class="ot">=</span> <span class="dt">Nothing</span></span></code></pre></div>
<p>そして, <code>YesodDispatch</code>型クラスのインスタンスを書く.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">YesodDispatch</span> <span class="dt">App</span> <span class="kw">where</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    yesodDispatch yesodRunnerEnv req sendResponse <span class="ot">=</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> maybeRoute <span class="ot">=</span> parseRoute' (pathInfo req)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>            handler <span class="ot">=</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>                <span class="kw">case</span> maybeRoute <span class="kw">of</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> notFound</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">Just</span> <span class="dt">HomeR</span> <span class="ot">-&gt;</span> getHomeR</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">Just</span> (<span class="dt">FibR</span> i) <span class="ot">-&gt;</span> getFibR i</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>         <span class="kw">in</span> yesodRunner handler yesodRunnerEnv maybeRoute req sendResponse</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>getHomeR <span class="ot">=</span> redirect (<span class="dt">FibR</span> <span class="dv">1</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="ot">fibs ::</span> [<span class="dt">Int</span>]</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>fibs <span class="ot">=</span> <span class="dv">0</span> <span class="op">:</span> <span class="fu">scanl</span> (<span class="op">+</span>) <span class="dv">1</span> fibs</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>getFibR i <span class="ot">=</span> <span class="fu">return</span> <span class="op">$</span> <span class="fu">show</span> <span class="op">$</span> fibs <span class="op">!!</span> i</span></code></pre></div>
<p><code>getHomeR</code>における<code>redirect</code>呼び出しに注意しなさい. <code>redirect</code>のパラメータとしてルートデータ型を使うことができ, Yesodは<code>renderRoute</code>関数を利用して, テキスト形式のリンクを作る.</p>
<h2 id="template-haskellを用いたルーティング">Template Haskellを用いたルーティング</h2>
<p>前のアプリケーションに新しいルートを追加したいとしよう. 次のような変更をする必要がある:</p>
<ol type="1">
<li><p><code>Route</code>データ型自身を変更する.</p></li>
<li><p><code>renderRoute</code>に節を追加する.</p></li>
<li><p><code>parseRoute'</code>に節を追加し, <code>renderRoute</code>と適切に対応することを確認する.</p></li>
<li><p><code>YesodDispatch</code>におけるcase文に, ハンドラ関数を呼ぶための節を追加する.</p></li>
<li><p>ハンドラ関数を書く.</p></li>
</ol>
<p>かなり多くの変更がある! 多くの手動, ボイラープレート変更は誤りにつながる可能性が大きい. 警告をオンにしていれば, コンパイラによって捉えられる誤りもあるが(<code>renderRoute</code>の節や, <code>YesodDispatch</code>のcase構文におけるパターンマッチを追加し忘れた場合), そうでないエラーもある(<code>renderRoute</code>と<code>parseRoute</code>が同じロジックを持っていることを確認することや, <code>parseRoute</code>の節を追加すること).</p>
<p>ここは, Template HaskellのYesodの世界における出番である. これら全ての変化を手動で扱う代わりに, Yesodは高レベルのルーティング構文を宣言する. この宣言によりルート構文, 動的パラメータ, コンストラクタ名, そして, 許容されるリクエストメソッドを指定し, 自動的にパーズ, レンダリング, ディスパッチ関数を生成することが可能になる.</p>
<p>どのくらいの手動コーディングを省略できるかについて知るために, 前の例がTemplate Haskell版に変更されたものを見てみよう.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE QuasiQuotes       #-}</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TemplateHaskell   #-}</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TypeFamilies      #-}</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE ViewPatterns      #-}</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod.Core</span> (<span class="dt">RenderRoute</span> (..), <span class="dt">Yesod</span>, mkYesod, parseRoutes,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>                             redirect, warp)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Our foundation datatype.</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">App</span> <span class="ot">=</span> <span class="dt">App</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Yesod</span> <span class="dt">App</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>mkYesod <span class="st">&quot;App&quot;</span> [parseRoutes|</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>/         HomeR GET</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>/fib/#Int FibR  GET</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>|]</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="ot">getHomeR ::</span> <span class="dt">Handler</span> ()</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>getHomeR <span class="ot">=</span> redirect (<span class="dt">FibR</span> <span class="dv">1</span>)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="ot">fibs ::</span> [<span class="dt">Int</span>]</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>fibs <span class="ot">=</span> <span class="dv">0</span> <span class="op">:</span> <span class="fu">scanl</span> (<span class="op">+</span>) <span class="dv">1</span> fibs</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="ot">getFibR ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> <span class="dt">String</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>getFibR i <span class="ot">=</span> <span class="fu">return</span> <span class="op">$</span> <span class="fu">show</span> <span class="op">$</span> fibs <span class="op">!!</span> i</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> warp <span class="dv">3000</span> <span class="dt">App</span></span></code></pre></div>
<p>これについて素晴らしいことは, 開発者としてアプリケーションの重要な部分に集中でき, パーサやレンダリング関数などの詳細に関与せずに済むことである. もちろん, Template Haskellを使うことの欠点も存在する:</p>
<ul>
<li><p>コンパイル時間が少し遅い.</p></li>
<li><p>舞台裏で起こっていることの詳細が, あまり明瞭ではない. (どのような識別子が生成されているかを見るために, <code>cabal haddock</code>を用いることができるが)</p></li>
<li><p>あまり詳細に制御することができない. 例えば, Yesodのルート構文において, 各動的パラメータは, 結束したフィールドではなく, ルートコンストラクタと分離したフィールドである必要がある. これは, Yesodにおける柔軟性と複雑性の間の意識的なトレードオフである.</p></li>
</ul>
<p>Template Haskellの使用は, Yesodにおける最も論争的な決断である. 個人的には, その利点は明らかに仕様を正当化すると思っている. しかし, Template Haskellを避けたいと思うならば, 自由にそうすることができる. 今までのところ全ての例はそのようにしており, それらの技術に倣うことができる. Yesodの世界には, 他のより単純な方法がある: <code>LiteApp</code>.</p>
<h2 id="liteapp">LiteApp</h2>
<p><code>LiteApp</code>により, 型安全URLやTemplate Haskellを使わないで済ませることができる. それは, 純粋なHaskellにおける単純なルーティングDSLを用いる. 再び, 単純な比較として, Fibonacciの例をそれを使って書き直してみよう.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Text</span>  (pack)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod.Core</span> (<span class="dt">LiteHandler</span>, dispatchTo, dispatchTo, liteApp,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                             onStatic, redirect, warp, withDynamic)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="ot">getHomeR ::</span> <span class="dt">LiteHandler</span> ()</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>getHomeR <span class="ot">=</span> redirect <span class="st">&quot;/fib/1&quot;</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="ot">fibs ::</span> [<span class="dt">Int</span>]</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>fibs <span class="ot">=</span> <span class="dv">0</span> <span class="op">:</span> <span class="fu">scanl</span> (<span class="op">+</span>) <span class="dv">1</span> fibs</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="ot">getFibR ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">LiteHandler</span> <span class="dt">String</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>getFibR i <span class="ot">=</span> <span class="fu">return</span> <span class="op">$</span> <span class="fu">show</span> <span class="op">$</span> fibs <span class="op">!!</span> i</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> warp <span class="dv">3000</span> <span class="op">$</span> liteApp <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    dispatchTo getHomeR</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    onStatic (<span class="fu">pack</span> <span class="st">&quot;fib&quot;</span>) <span class="op">$</span> withDynamic <span class="op">$</span> \i <span class="ot">-&gt;</span> dispatchTo (getFibR i)</span></code></pre></div>
<p>全く言語拡張のない, 単純なYesodアプリケーションである! しかし, このアプリケーションでさえ, 多少の安全性を示す. Yesodは<code>getFibR</code>のパラメータを<code>Text</code>から<code>Int</code>に変換するために, <code>fromPathPiece</code>を用いる. したがって, 不適切なパラメータは全てYesod自身により捕えられる. 1つのチェックだけ行わないで済ませることができる.</p>
<h2 id="shakespeare">Shakespeare</h2>
<p>プレーンなテキストページを生成することは楽しいかもしれないが, これは通常ウェブフレームワークに期待するものとは言い難い. 望むように, YesodはHTML, CSS, そして, Javascriptを生成する内蔵のサポートがあるように作られている.</p>
<p>template言語に入る前に, それを生で, すなわちローレベルの方法で行い, それからもう少し楽しいものを作ろう.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Text</span>  (pack)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod.Core</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="ot">getHomeR ::</span> <span class="dt">LiteHandler</span> <span class="dt">TypedContent</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>getHomeR <span class="ot">=</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">TypedContent</span> typeHtml <span class="op">$</span> toContent</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Hi There!&lt;/title&gt;\</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="st">    \&lt;link rel='stylesheet' href='/style.css'&gt;\</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="st">    \&lt;script src='/script.js'&gt;&lt;/script&gt;&lt;/head&gt;\</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="st">    \&lt;body&gt;&lt;h1&gt;Hello World!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="ot">getStyleR ::</span> <span class="dt">LiteHandler</span> <span class="dt">TypedContent</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>getStyleR <span class="ot">=</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">TypedContent</span> typeCss <span class="op">$</span> toContent</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;h1 { color: red }&quot;</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="ot">getScriptR ::</span> <span class="dt">LiteHandler</span> <span class="dt">TypedContent</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>getScriptR <span class="ot">=</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">TypedContent</span> typeJavascript <span class="op">$</span> toContent</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;alert('Yay, Javascript works too!');&quot;</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> warp <span class="dv">3000</span> <span class="op">$</span> liteApp <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    dispatchTo getHomeR</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    onStatic (<span class="fu">pack</span> <span class="st">&quot;style.css&quot;</span>) <span class="op">$</span> dispatchTo getStyleR</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>    onStatic (<span class="fu">pack</span> <span class="st">&quot;script.js&quot;</span>) <span class="op">$</span> dispatchTo getScriptR</span></code></pre></div>
<p>すでに学んだ<code>TypedContent</code>の素材を再利用しているに過ぎない. 今回は, 3つの異なるルートがあり, HTML, CSS, そして, JavaScriptを提供している. コンテンツを<code>String</code>として与え, <code>toContent</code>を用いて, それらを<code>Content</code>に変換し, <code>TypedContent</code>コンストラクタによりラップし, 適切なコンテンツタイプヘッダを与えている.</p>
<p>しかしいつものように, よりよくすることができる. <code>String</code>を扱うことはあまり効率的ではなく, 常に手動でコンテンツ型を入力しなければならないのは面倒なことである. しかし, それらの問題への解決策をすでに知っている: <code>blaze-html</code>の<code>Html</code>データ型を使うことである. それを使うために, <code>getHomeR</code>関数を変更してみよう:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Text</span>                   (pack)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Text.Blaze.Html5</span>            (toValue, (!))</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Text.Blaze.Html5</span>            <span class="kw">as</span> <span class="dt">H</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Text.Blaze.Html5.Attributes</span> <span class="kw">as</span> <span class="dt">A</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod.Core</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="ot">getHomeR ::</span> <span class="dt">LiteHandler</span> <span class="dt">Html</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>getHomeR <span class="ot">=</span> <span class="fu">return</span> <span class="op">$</span> H.docTypeHtml <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    H.head <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        H.title <span class="op">$</span> toHtml <span class="st">&quot;Hi There!&quot;</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        H.link <span class="op">!</span> A.rel (toValue <span class="st">&quot;stylesheet&quot;</span>) <span class="op">!</span> A.href (toValue <span class="st">&quot;/style.css&quot;</span>)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        H.script <span class="op">!</span> A.src (toValue <span class="st">&quot;/script.js&quot;</span>) <span class="op">$</span> <span class="fu">return</span> ()</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    H.body <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>        H.h1 <span class="op">$</span> toHtml <span class="st">&quot;Hello World!&quot;</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="ot">getStyleR ::</span> <span class="dt">LiteHandler</span> <span class="dt">TypedContent</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>getStyleR <span class="ot">=</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">TypedContent</span> typeCss <span class="op">$</span> toContent</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;h1 { color: red }&quot;</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="ot">getScriptR ::</span> <span class="dt">LiteHandler</span> <span class="dt">TypedContent</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>getScriptR <span class="ot">=</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">TypedContent</span> typeJavascript <span class="op">$</span> toContent</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;alert('Yay, Javascript works too!');&quot;</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> warp <span class="dv">3000</span> <span class="op">$</span> liteApp <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    dispatchTo getHomeR</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    onStatic (<span class="fu">pack</span> <span class="st">&quot;style.css&quot;</span>) <span class="op">$</span> dispatchTo getStyleR</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    onStatic (<span class="fu">pack</span> <span class="st">&quot;script.js&quot;</span>) <span class="op">$</span> dispatchTo getScriptR</span></code></pre></div>
<p>ずっと, 素晴らしい. <code>blaze-html</code>は便利なコンビネータライブラリを提供し, ほとんどの場合, 行おうとするどんな<code>String</code>連結よりも早く実行できる.</p>
<p>もし, <code>blaze-html</code>に満足であれば, 是非それらを使いなさい. しかし, 多くの人々はより特化したテンプレート言語を使いたいと思うであろう. このためのYesodの標準的提供元はShakespear言語である: Hamlet, Lucius, そして, Julius. もし望むなら別のシステムを使っても全く問題ないが, 唯一必要なものは<code>Content</code>値をテンプレートから得られることである.</p>
<p>Shakespearテンプレートは, コンパイル時にチェックされるため, それらを使うにはquasiquoteまたは, Template Haskellが必要になる. ここでは, 前者の方法を用いる. より詳細については, Shakespearの章を参照してください.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE QuasiQuotes #-}</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Text</span>   (<span class="dt">Text</span>, pack)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Text.Julius</span> (<span class="dt">Javascript</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Text.Lucius</span> (<span class="dt">Css</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod.Core</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="ot">getHomeR ::</span> <span class="dt">LiteHandler</span> <span class="dt">Html</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>getHomeR <span class="ot">=</span> withUrlRenderer <span class="op">$</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    [hamlet|</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">$</span><span class="er">doctype</span> <span class="er">5</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;html&gt;</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;head&gt;</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>                <span class="kw">&lt;title&gt;</span>Hi There!</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>                <span class="kw">&lt;link </span><span class="er">rel=stylesheet</span><span class="kw"> </span><span class="er">href=/style</span><span class="st">.css</span><span class="kw">&gt;</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>                <span class="kw">&lt;script </span><span class="er">src=/script</span><span class="st">.js</span><span class="kw">&gt;</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;body&gt;</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>                <span class="kw">&lt;h1&gt;</span>Hello World!</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    |]</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="ot">getStyleR ::</span> <span class="dt">LiteHandler</span> <span class="dt">Css</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>getStyleR <span class="ot">=</span> withUrlRenderer [lucius|h1 { color: red }|]</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="ot">getScriptR ::</span> <span class="dt">LiteHandler</span> <span class="dt">Javascript</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>getScriptR <span class="ot">=</span> withUrlRenderer [julius|<span class="fu">alert</span>(<span class="st">'Yay, Javascript works too!'</span>)<span class="op">;</span>|]</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> warp <span class="dv">3000</span> <span class="op">$</span> liteApp <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    dispatchTo getHomeR</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    onStatic (<span class="fu">pack</span> <span class="st">&quot;style.css&quot;</span>) <span class="op">$</span> dispatchTo getStyleR</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    onStatic (<span class="fu">pack</span> <span class="st">&quot;script.js&quot;</span>) <span class="op">$</span> dispatchTo getScriptR</span></code></pre></div>
<h3 id="urlレンダリング関数">URLレンダリング関数</h3>
<p>おそらくこれの最も混乱する部分は, <code>withUrlRenderer</code>の呼び出しである. これは, Yesodにおける最も強力な特徴の1つに踏み込む: 型安全URLである. もしHTMLにおいて注意するならば, CSSとJavascript URLへのリンクを文字列で与えている点である. <code>main</code>関数においてもそれらの文字列を2回目に与える必要があるため, これは情報の重複につながる. これはとても変更に弱い: コードは壊れたリンクの修正を1つ多く行う必要がある.</p>
<p>代わりに推奨される方法としては, テンプレートにおいて明確な文字列を含む代わりに, 型安全URLデータ型を用いることである. 上で言及されたように, <code>LiteApp</code>は意味のある型安全URLを全く提供しないため, ここではその選択肢はない. しかし, Template Haskell生成器を用いるならば, 自由に型安全URLを得ることができる.</p>
<p>どんな場合においても, Shakespearテンプレートは全て, 型安全URLのレンダリングを行う関数を受け取る必要がある. 型安全URLは実際に使われていないため, ここでは, ほぼどんな関数でも機能する(その関数は完全に無視される). しかし, <code>withUrlRenderer</code>はこれを行うための便利な方法である.</p>
<p>次に見るように, <code>withUrlRenderer</code>は実際, 大部分の場合必要とならない. なぜなら, Widgetが最終的に, 自動的にレンダリング関数を提供するためである.</p>
<h3 id="widget">Widget</h3>
<p>HTML, CSS, そして, Javascriptを個々の要素として扱うことは, 多くの場合便利である. しかし, ページに対し再利用可能な要素を構築したい場合, それはコンポーザビリティを妨げてしまう. もし, なぜwidgetが便利なのかについてより深い動機を求めるならば, widgetの章を見てください. 今は, それらを使うことについて掘り下げてみましょう.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE QuasiQuotes #-}</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Yesod.Core</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="ot">getHomeR ::</span> <span class="dt">LiteHandler</span> <span class="dt">Html</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>getHomeR <span class="ot">=</span> defaultLayout <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    setTitle <span class="op">$</span> toHtml <span class="st">&quot;Hi There!&quot;</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    [whamlet|<span class="kw">&lt;h1&gt;</span>Hello World!|]</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    toWidget [lucius|h1 { color: red }|]</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    toWidget [julius|<span class="fu">alert</span>(<span class="st">'Yay, Javascript works too!'</span>)<span class="op">;</span>|]</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> warp <span class="dv">3000</span> <span class="op">$</span> liteApp <span class="op">$</span> dispatchTo getHomeR</span></code></pre></div>
<p>これは上と同じ例であるが, 今回は1つのハンドラに凝縮している. Yesodは自動的にCSSとJavascriptをHTMLに与えるような操作を行う. デフォルトでは, それぞれ<code>style</code>と<code>script</code>タグによりページの<code>head</code>と<code>body</code>に置く. しかし, Yesodは多くのカスタマイズ設定を与え, 他のこともできるようにする(自動的に一時的な静的ファイルを生成し, それらにリンクするような).</p>
<p>widgetには他の利点もある. <code>defaultLayout</code>関数は, Yesod型クラスのメンバであり, ウェブサイトに対し, カスタマイズされた見た目を与えるように変更可能である. エラーメッセージのような, 多くのYesodにおける内蔵の機能は, widgetシステムを利用している. したがって, widgetを使うことで, 全てのサイトにおいて一貫した感じ方を得ることができる.</p>
<h2 id="扱わない詳細">扱わない詳細</h2>
<p>幸いなことに, この章は表面下において何が起こっているかについて理解するために, Yesodにおける魔法を充分引っ張ってこれた. もちろんこの方法を使いながら, Yesodのエコシステムの残りを分析することもできるが, この本の残りではそれらの大部分は冗長である. 幸いなことに, 今やPersistent, フォーム, セッション, サブサイトの章を読んでいるのだから, より多くのことがわかるはずである.</p>
<h2 id="本書のコード">本書のコード</h2>
<ul>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch20/Example1.hs">Example01.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch20/Example2.hs">Example02.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch20/Example3.hs">Example03.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch20/Example4.hs">Example04.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch20/Example5.hs">Example05.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch20/Example6.hs">Example06.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch20/Example7.hs">Example07.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch20/Example8.hs">Example08.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch20/Example9.hs">Example09.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch20/Example10.hs">Example10.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch20/Example11.hs">Example11.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch20/Example12.hs">Example12.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch20/Example13.hs">Example13.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch20/Example14.hs">Example14.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch20/Example15.hs">Example15.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch20/Example16.hs">Example16.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch20/Example17.hs">Example17.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch20/Example18.hs">Example18.hs</a></li>
</ul>
      </article>

      <div class="pager">
      
      
      </div>

      <div class="row">
        <div class="col s6 offset-s6" style="position: relative; height: 100px;">
          <div class="fixed-action-btn horizontal" style="position: absolute; display: inline-block; right: 24px;">
  <a class="btn-floating btn-large red">
    <i class="large material-icons">share</i>
  </a>
  <ul>
    <li>
      <a class="btn-floating waves-effect waves-light blue tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Twitter" href="https://twitter.com/intent/tweet?text=Yesod for Haskellers&url=https://haskell.e-bigmoon.com/yesod/book/ch20-yesod-for-haskellers.html"><i class="mdi mdi-twitter white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light indigo tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Facebook" href="https://facebook.com/sharer.php?u=https://haskell.e-bigmoon.com/yesod/book/ch20-yesod-for-haskellers.html"><i class="mdi mdi-facebook white-text"></i></a>
    </li>
  </ul>
</div>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
    </div>

    <footer class="page-footer indigo lighten-1">
  <div class="footer-copyright">
    <div class="container">
      © 2017-2020 BIGMOON&nbsp;
      Site proudly generated by <a class="red-text text-accent-1" href="http://jaspervdj.be/hakyll">Hakyll</a>,&nbsp;
      original Jekyll theme by <a class="red-text text-accent-1" href="https://github.com/mumuxme/materialize-jekyll">mumuxme</a>.
    </div>
  </div>
</footer>


    <!-- scrolltop button -->
    <button class="material-scrolltop waves-effect waves-light hide-on-small-only" type="button">
      <i class="mdi mdi-arrow-up-bold small white-text"></i>
    </button>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-19322672-9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-19322672-9');
    </script>

    <!-- jquery -->
    <script type="text/javascript" src="../../lib/jquery-min.js"></script>
    <!-- materialize -->
    <script src="../../lib/materialize/js/materialize.min.js"></script>
    <!-- <\!-- Material ScrollTop plugin -\-> -->
    <script src="../../lib/material-scrolltop/material-scrolltop.js"></script>
    <!-- main -->
    <script src="../../js/init.js"></script>
    <script src="../../js/main.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/haskell.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/yaml.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/shell.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/bash.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>

</html>
