<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">

  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
  <!-- MUST in hex format, may the same as header-color. This color is for android chrome browser. -->
  <meta name="theme-color" content="#5c6bc0">

  <!-- Metadata. -->
  <meta name="keywords" content="haskell,blog,bigmoon" />
  <title>シェイクスピア テンプレート</title>
  <meta name="description" content="BIG MOON">
  <link rel="canonical" href="../../yesod/book/ch04-shakespearen-templates.html">
  <link rel="alternate" type="application/atom+xml" title="シェイクスピア テンプレート" href="../../feed.xml" />
  <link rel="shortcut icon" href="../../images/favicon.ico" />
  <meta name="google-site-verification" content="X2YNboLvzw3_bclXLMvohyJDqj68D06_hPDMukRbgTs" />

  <!-- Stylesheets. -->
  <link rel="stylesheet" href="../../lib/materialize/css/materialize.min.css" />
  <link rel="stylesheet" href="../../css/main.css" />
  <link media="all" rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/3.3.92/css/materialdesignicons.min.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="../../lib/material-scrolltop/material-scrolltop.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/agate.min.css" />
  

  <!-- OGP -->
  <meta property="og:title" content="シェイクスピア テンプレート" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="/yesod/book/ch04-shakespearen-templates.html" />
  <!-- <meta property="og:image" content=" サムネイル画像の URL" /> -->
  <meta property="og:site_name" content="シェイクスピア テンプレート" />
  <meta property="og:description" content="BIG MOON" />

  <meta name="twitter:card" content="summary" />
  <!-- <meta name="twitter:site" content="@[ Twitter ID]" /> -->
  <!-- <meta name="twitter:player" content="@[ Twitter ID]" /> -->

  <noscript>
  <div class="notice-warning noscript">You don't have javascript enabled. Good luck! :(</div>
</noscript>

<!--[if IE]>
  <div class="notice-warning">Oh, you are using Internet Explorer! Good luck... :(</div>
<![endif]-->

</head>


  <body>
    <header class="site-header">
      <nav class="nav-extended indigo lighten-1">
        <div class="nav-wrapper">
  <a href="../../"><span class="site-title">BIGMOON Haskeller's BLOG</span></a>
  <a href="#" data-activates="mobile-navbar" class="button-collapse">
    <i class="mdi mdi-menu white-text"></i>
  </a>

  <ul id="nav-mobile" class="right hide-on-med-and-down">
    <li>
      <a href="../../" class="white-text">
        <i class="mdi mdi-home left indigo-text text-lighten-3"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="white-text">
        <i class="mdi mdi-account-circle left indigo-text text-lighten-3"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../stack/" class="white-text">
        <i class="mdi mdi-wrench left indigo-text text-lighten-3"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/index.html" class="white-text">
        <i class="mdi mdi-comment-question-outline left indigo-text text-lighten-3"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="white-text">
        <i class="mdi mdi-package-variant left indigo-text text-lighten-3"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="white-text">
        <i class="mdi mdi-earth left indigo-text text-lighten-3"></i>
        Yesod
      </a>
    </li>
    <li>
      <a href="../../contact.html" class="white-text">
        <i class="mdi mdi-lead-pencil left indigo-text text-lighten-3"></i>
        Contact
      </a>
    </li>
    <li>
      <a href="../../feed.xml" class="white-text">
        <i class="mdi mdi-rss left indigo-text text-lighten-3"></i>
        Feed
      </a>
    </li>
  </ul>

  <ul class="side-nav" id="mobile-navbar">
    <li>
      <a href="../../" class="waves-effect waves-teal black-text">
        <i class="mdi mdi-home left green-text"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="navbar-text-colour-mobile">
        <i class="mdi mdi-account-circle left blue-text"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../stack/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-wrench left blue-text"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-comment-question-outline left blue-text"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-package-variant left blue-text"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-earth left blue-text"></i>
        Yesod
      </a>
    </li>
    <li>
      <a href="../../contact.html" class="navbar-text-colour-mobile">
        <i class="mdi mdi-lead-pencil left blue-text"></i>
        Contact
      </a>
    </li>
  </ul>
</div>

      </nav>
    </header>

    <div class="site-container" id="tab-main">
      <div class="wrapper">
        <div class="post-ribbon"></div>

<div class="container page-container">
  <div class="post-page card-panel z-depth-2">
    <div class="post-section">
      <div class="post-heading">
        <h1 class="post-title">シェイクスピア テンプレート</h1>
        
        <span>最終更新日: 2019/1/18</span>
        
      </div>

      <article class="page-content">
        <p>Yesod では HTML, CSS, Javascript を生成するための標準的な方法として、テンプレート言語のシェイクスピアファミリーを採用しています。シェイクスピアでは共通の構文を持ち、以下の原則に従います。</p>
<ul>
<li>ベース言語 (Html, Css, Javascript) への干渉をできる限り少なくしながら、便利な機能を提供します。</li>
<li>妥当なコンテンツ (well-formed content) であることをコンパイル時に保証します。</li>
<li>静的型安全性は <a href="http://en.wikipedia.org/wiki/Cross-site_scripting">XSS攻撃(cross-site scripting)</a> の防止に非常に役立ちます。</li>
<li>型安全URLを利用することで、可能な場合は常に展開されたリンクに対して自動的にバリデーションを行います。</li>
</ul>
<p>Yesod とこれらのテンプレート言語の間には本質的な繋がりやその他の制限は何もありません。そのため、それぞれは互いに独立して利用することができます。本章の前半で、テンプレート言語の構文等について説明し、後半では Yesod アプリケーション開発でテンプレート言語の利用方法を述べます。</p>
<h2 id="概要">概要</h2>
<p>シェイクスピアには4つの主要な言語があります。Hamlet は HTML、Julius は Javascript、Cassius と Lucius は両方とも CSS のためのテンプレート言語です。Hamlet と Cassius は空白によって識別される形式となっているため、インデントを用いてネストを表現します。それに対して Lucius は CSS のスーパーセットなので、通常の CSS で使われる波括弧の形式でネストを表します。Julius は Javascript を作り出すための単なるパススルー言語です。唯一追加される機能は変数展開 (variable interpolation) だけです。</p>
<div class="yesod-book-notice">
<p>Cassius は単に Lucius の代替構文です。内部では両者とも同じ処理エンジンを利用していますが、 Cassius のファイルは前処理の段階でインデントを波括弧に変換します。そのため、どちらを利用するかは純粋に構文の好みになります。</p>
</div>
<h3 id="hamlet-html">Hamlet (HTML)</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode hamlet"><code class="sourceCode hamlet"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">$</span><span class="er">doctype</span> <span class="er">5</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>    <span class="kw">&lt;head&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>        <span class="kw">&lt;title&gt;#{</span>pageTitle<span class="kw">}</span> - My Site</span>
<span id="cb1-5"><a href="#cb1-5"></a>        <span class="kw">&lt;link</span><span class="ot"> rel=</span><span class="st">stylesheet</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">Stylesheet</span><span class="kw">}&gt;</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>    <span class="kw">&lt;body&gt;</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>        <span class="kw">&lt;h1 </span><span class="st">.page-title</span><span class="kw">&gt;#{</span>pageTitle<span class="kw">}</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>        <span class="kw">&lt;p&gt;</span>Here is a list of your friends:</span>
<span id="cb1-9"><a href="#cb1-9"></a>        <span class="kw">$if</span> <span class="fu">null</span> friends</span>
<span id="cb1-10"><a href="#cb1-10"></a>            <span class="kw">&lt;p&gt;</span>Sorry, I lied, you don't have any friends.</span>
<span id="cb1-11"><a href="#cb1-11"></a>        <span class="kw">$else</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>            <span class="kw">&lt;ul&gt;</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>                <span class="kw">$forall</span> <span class="dt">Friend</span> name age <span class="ot">&lt;-</span> friends</span>
<span id="cb1-14"><a href="#cb1-14"></a>                    <span class="kw">&lt;li&gt;#{</span>name<span class="kw">}</span> (<span class="kw">#{</span>age<span class="kw">}</span> years old)</span>
<span id="cb1-15"><a href="#cb1-15"></a>        <span class="kw">&lt;footer&gt;^{</span>copyright<span class="kw">}</span></span></code></pre></div>
<h3 id="lucius-css">Lucius (CSS)</h3>
<pre class="lucius"><code>section.blog {
    padding: 1em;
    border: 1px solid #000;
    h1 {
        color: #{headingColor};
        background-image: url(@{MyBackgroundR});
    }
}</code></pre>
<h3 id="cassius-css">Cassius (CSS)</h3>
<p>上の Lucius の例と同じです。</p>
<pre class="cassius"><code>section.blog
    padding: 1em
    border: 1px solid #000
    h1
        color: #{headingColor}
        background-image: url(@{MyBackgroundR})</code></pre>
<h3 id="julius-javascript">Julius (Javascript)</h3>
<p>Julius の文字列展開は他の2つとは少し異なります。これは、セキュリティの観点からとても重要なことです。通常、全ての展開された値は妥当な JSON となっているため、XSS 攻撃を防ぐことができます。しかし、<code>rawJS</code> 関数は文字列をダブルクォートで囲まないため、利用する際は気をつけてください。</p>
<p>信頼できないのであれば、どんな入力に対しても絶対に <code>rawJS</code> 関数を使ってはいけません。例えば、ユーザが任意の入力を行えるフォームで使ってしまったら、それだけで脆弱性が発生します。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="co">-- 型クラスをインポートすることで rawJS 関数がインポートされます</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw">import</span> <span class="dt">Text.Julius</span> (<span class="dt">RawJS</span> (..))</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode julius"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1"></a><span class="at">$</span>(<span class="kw">function</span>()<span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>    <span class="at">$</span>(<span class="st">&quot;section.#{rawJS sectionClass}&quot;</span>).<span class="at">hide</span>()<span class="op">;</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>    <span class="at">$</span>(<span class="st">&quot;#mybutton&quot;</span>).<span class="at">click</span>(<span class="kw">function</span>()<span class="op">{</span><span class="va">document</span>.<span class="at">location</span> <span class="op">=</span> <span class="st">&quot;@{SomeRouteR}&quot;</span><span class="op">;}</span>)<span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>    <span class="op">^{</span>addBling<span class="op">}</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<h2 id="型">型</h2>
<p>構文に入る前に色々な型を見てみましょう。最初に「型は XSS 攻撃の防止に役立つ」と述べました。例えば、誰かの名前を表示する次のような HTML テンプレートがあったとしましょう。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode hamlet"><code class="sourceCode hamlet"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">&lt;p&gt;</span>Hello, my name is <span class="kw">#{</span>name<span class="kw">}</span></span></code></pre></div>
<div class="yesod-book-notice">
<p><code>#{...}</code> はシェイクスピアでは、変数展開を意味します。</p>
</div>
<p>さて、<code>name</code> 変数の値を挿入するためにはどうすれば良いと思いますか？さらにそのデータ型は何であるべきでしょうか？よくある方法は <code>Text</code> の値をそのまま挿入することです。しかし、そうすると <code>name</code> の値が次のような場合に問題が起こります。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">'http://nefarious.com/evil.js'</span><span class="kw">&gt;&lt;/script&gt;</span></span></code></pre></div>
<p>このとき <code>&lt;</code> が <code>&amp;lt;</code> になるように <code>name</code> の値をエンティティエンコードしたいのですが、どうすれば良いでしょうか。</p>
<p>すぐに思い浮かぶのは、単に埋め込まれる全てのテキストをエンティティエンコードするという方法です。しかし、もし、別の処理によって既に HTML が生成されていたとしたら何が起こるでしょうか？例えば、 Yesod のウェブサイトのすべての Haskell コードスニペットは適切な <code>span</code> タグで囲むことで色付けされています。仮に、全てをエンティティエスケープしたとすれば、コードスニペットはほとんど読めない状態になってしまうでしょう。</p>
<p>そういった事態を避けるために <code>Html</code> データ型を使います。<code>Html</code> 型の値を生成するために2種類のAPIがあります。<code>ToMarkup</code> 型クラスは <code>String</code> と <code>Text</code> の値を <code>Html</code> の値に変換する <code>toHtml</code> 関数を提供します。 <code>toHtml</code> 関数は自動的にエンティティエスケープを行います。これは先ほどの <code>name</code> の例で求めていた処理です。また、コードスニペットのような例では <code>preEscapedToMarkup</code> 関数を利用すると良いでしょう。</p>
<p>Hamlet (HTML シェイクスピア言語) の変数展開では、値に対して自動的に <code>toHtml</code> が適用されます。そのため <code>String</code> を展開する場合はエンティティエスケープされますが、 <code>Html</code> の場合は何も変更されません。そのため、コードスニペットの例では <code>#{preEscapedToMarkup myHaskellHtml}</code> のようにして展開すれば期待通りの結果が得られます。</p>
<div class="yesod-book-notice">
<p><code>Html</code> データ型は <code>toHtml</code> や <code>preEscapedToMarkup</code> と一緒に blaze-html パッケージで提供されています。そのため Hamlet は他の全ての blaze-html パッケージと相互作用することが可能になり、 blaze-html の値を生成するための一般的解決策にもなります。さらには blaze-html の素晴らしいパフォーマンスの恩恵を得ることもできます。</p>
</div>
<p>同様に <code>CSS型 と ToCSS クラス</code>, <code>Javascript型 と ToJavascript クラス</code> があります。これらは意図せず HTML を壊してしまうようなコードの混入を防ぐため、コンパイル時にサニティーチェックを行います。</p>
<div class="yesod-book-notice">
<p>CSS にテンプレート言語を採用するその他の利点としては、色や単位についての補助的なデータ型があることです。例えば、以下のような例です。</p>
<pre class="lucius"><code>.red { color: #{colorRed} }</code></pre>
<p>さらなる詳細については Haddock ドキュメントを参照してください。</p>
</div>
<h2 id="型安全url">型安全URL</h2>
<p>おそらく Yesod における最も面白い機能は型安全URLです。この機能はシェイクスピアから直接扱うことができます。使い方は変数展開とほとんど同じで、ハッシュ (#) の代わりにアットマーク (@) を利用するだけです。構文は後で確認することにして、まずは直感的に理解しましょう。</p>
<p>まず、次のような2つのルートを持つアプリケーションがあるとします。<code>http://example.com/profile/home</code> はトップページで <code>http://example.com/display/time</code> は現在の時間を表示します。ここで、トップページから time ページにリンクしたいとき、 URL を構築するためには3つの異なる方法が考えられます。</p>
<ol type="1">
<li>相対リンク: <strong><em>../display/time</em></strong></li>
<li>ドメイン無しの絶対リンク: <strong><em>/display/time</em></strong></li>
<li>ドメイン有りの絶対リンク: <strong><em>http://example.com/display/time</em></strong></li>
</ol>
<p>どの方法もそれぞれ問題があります。1つ目の方法はどちらかのURLが変化することでリンク切れになってしまいますし、全ての状況に適しているというわけではありません。例えば RSS や Atom フィードには絶対URLが必要です。2つ目は1つ目の方法よりも変化に対し柔軟ですが、 RSS や Atom の問題は残ったままです。3つ目は今言った問題の全てを解決できますが、ドメイン名が変わるごとに全ての URL を更新する必要が生じます。そんなこと、そう頻繁には起こらないだろうと思うかもしれませんが、開発からステージングそして最終の本番サーバへの移行を考えてみてください。</p>
<p>しかしより重要なことはそれぞれの方法において、ひとつ非常に大きな問題があるということです。それは、仮にルートを変更したとしてもコンパイラは壊れたリンクに対して警告をしないという点です。誤植が大混乱を招くように、これは最悪な状況だということは言うまでもありません。</p>
<p>型安全URLの目的は人間の代わりにコンパイラにできる限り多くのチェックを行わせることです。これを可能にするための最初のステップとしては、コンパイラが理解できない単純な文字列から離れ、正しく定義されたデータ型に変更することです。今回の単純なアプリケーションではルートを直和型で表現します。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">data</span> <span class="dt">MyRoute</span> <span class="ot">=</span> <span class="dt">Home</span> <span class="op">|</span> <span class="dt">Time</span></span></code></pre></div>
<p>テンプレートに /display/time のようなリンクを記述する代わりに <code>Time</code> コンストラクタを利用します。しかし、そうすると HTML はデータ型ではなくテキストでできているため、これらの値をテキストに変換する方法が必要となります。その変換を行う関数をURLレンダリング関数 (URL rendering function) と呼ぶことにしましょう。簡単な例を以下に示します。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1"></a><span class="ot">renderMyRoute ::</span> <span class="dt">MyRoute</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>renderMyRoute <span class="dt">Home</span> <span class="ot">=</span> <span class="st">&quot;http://example.com/profile/home&quot;</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>renderMyRoute <span class="dt">Time</span> <span class="ot">=</span> <span class="st">&quot;http://example.com/display/time&quot;</span></span></code></pre></div>
<div class="yesod-book-notice">
<p>URLレンダリング関数は実際にはこれより少しだけ複雑です。なぜなら、クエリ文字列パラメータを追加し、コンストラクタのレコードを扱い、より賢くドメイン名を処理する必要があるためです。しかし、実際にはそんな事を考えなくても大丈夫です。Yesod はレンダリング関数を自動生成してくれます。唯一指摘すべきこととしてはクエリ文字列を扱うために、型注釈が実際にはもうちょっとだけ複雑になるということです。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">type</span> <span class="dt">Query</span> <span class="ot">=</span> [(<span class="dt">Text</span>, <span class="dt">Text</span>)]</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="kw">type</span> <span class="dt">Render</span> url <span class="ot">=</span> url <span class="ot">-&gt;</span> <span class="dt">Query</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="ot">renderMyRoute ::</span> <span class="dt">Render</span> <span class="dt">MyRoute</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>renderMyRoute <span class="dt">Home</span> _ <span class="ot">=</span> <span class="op">...</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>renderMyRoute <span class="dt">Time</span> _ <span class="ot">=</span> <span class="op">...</span></span></code></pre></div>
</div>
<p>これで、レンダリング関数とテンプレートに埋め込まれた型安全URLについて、なんとなくわかったと思います。しかし、正確にはこれらはどうやって上手く動作するのでしょうか？テンプレート言語は <code>Html</code> (<code>CSS</code> や <code>Javascript</code>) の値を直接生成するのではなく、レンダリング関数を引数に取り HTML を作り上げる関数を生成します。このことをより詳細に確認するために Hamlet が背後でどのような処理を行っているか軽く覗いてみましょう。以下のテンプレートを考えます。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode hamlet"><code class="sourceCode hamlet"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">Time</span><span class="kw">}&gt;</span>The time</span></code></pre></div>
<p>これは、だいたい次のような Haskell コードに翻訳されます。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1"></a>\render <span class="ot">-&gt;</span> <span class="fu">mconcat</span> [<span class="st">&quot;&lt;a href='&quot;</span>, render <span class="dt">Time</span>, <span class="st">&quot;'&gt;The time&lt;/a&gt;&quot;</span>]</span></code></pre></div>
<h2 id="構文">構文</h2>
<p>シェイクスピア テンプレート言語はどれも同じ展開構文となっているため、同じ方法で型安全URLを利用できます。各テンプレート言語の構文は対象となる言語 (HTML、CSS、Javascript) によって少しずつ違います。それぞれの言語を順番に見てみましょう。</p>
<h2 id="hamlet-構文">Hamlet 構文</h2>
<p>Hamlet はシェイクスピアの中でも最も洗練されたものです。HTML を生成のための構文を提供するだけでなく、条件、ループ、maybe などの基本的な制御構造を備えます。</p>
<h3 id="タグ">タグ</h3>
<p>どんな HTML テンプレート言語でも明らかにタグは重要です。Hamlet では、テンプレート言語を使いやすくするためにできる限り既存の HTML 構文に似せています。一番大きな違いはネストの表現に、閉じタグではなくインデントを採用している点です。そのため、次のような HTML は</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb14-1"><a href="#cb14-1"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="kw">&lt;p&gt;</span>Some paragraph.<span class="kw">&lt;/p&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="kw">&lt;ul&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="kw">&lt;li&gt;</span>Item 1<span class="kw">&lt;/li&gt;</span></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="kw">&lt;li&gt;</span>Item 2<span class="kw">&lt;/li&gt;</span></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="kw">&lt;/ul&gt;</span></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="kw">&lt;/body&gt;</span></span></code></pre></div>
<p>このような Hamlet コードに変換されます。</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode hamlet"><code class="sourceCode hamlet"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>    <span class="kw">&lt;p&gt;</span>Some paragraph.</span>
<span id="cb15-3"><a href="#cb15-3"></a>    <span class="kw">&lt;ul&gt;</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>        <span class="kw">&lt;li&gt;</span>Item 1</span>
<span id="cb15-5"><a href="#cb15-5"></a>        <span class="kw">&lt;li&gt;</span>Item 2</span></code></pre></div>
<p>一般的に、この表記に一度慣れてしまえば通常の HTML よりわかりやすいのではないでしょうか。ただし、タグ前後の空白の扱いについては注意が必要です。例えば、次のような HTML を生成したいとしましょう。</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">&lt;p&gt;</span>Paragraph <span class="kw">&lt;i&gt;</span>italic<span class="kw">&lt;/i&gt;</span> end.<span class="kw">&lt;/p&gt;</span></span></code></pre></div>
<p>空白は “Paragraph” の後の部分や “end” の前の部分で保存されていて欲しいです。そのためには、2種類のエスケープ文字を用います。</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode hamlet"><code class="sourceCode hamlet"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw">&lt;p&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>    Paragraph #</span>
<span id="cb17-3"><a href="#cb17-3"></a>    <span class="kw">&lt;i&gt;</span>italic</span>
<span id="cb17-4"><a href="#cb17-4"></a>    \ end.</span></code></pre></div>
<p>空白のエスケープ規則は実にシンプルです。</p>
<ol type="1">
<li>もし、行頭の文字が空白でなく、バックスラッシュであれば、そのバックスラッシュは無視されます。(注意: これは、その行における全てのタグが単なるテキストとして処理されてしまうということです)</li>
<li>もし、行末の文字がハッシュの場合それは無視されます。</li>
</ol>
<p>あと、 Hamlet はコンテンツ内のエンティティをエスケープしません。そのため、既存の HTML のコピーがしやすくなります。したがって、上の例は次のように書くこともできます。</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode hamlet"><code class="sourceCode hamlet"><span id="cb18-1"><a href="#cb18-1"></a><span class="kw">&lt;p&gt;</span>Paragraph <span class="kw">&lt;i&gt;</span>italic&lt;/i&gt; end.</span></code></pre></div>
<p>Hamlet では最初のタグは自動的に閉じられることに注意してください。それに対して内側の “i” タグはそうではありません。どちらの方法もペナルティ無く自由に使うことができるため、好きな方を選択できます。しかし Hamlet において閉じタグを使う唯一の場面は、このようなインラインタグに限られるということを忘れないでください。通常のタグを閉じることはありません。</p>
<p>この表記で他に注意する点としては、最初のタグより後に出現するタグは ID やクラスについて、特別な処理を行わないということです。例えば、次の Hamlet スニペットは</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode hamlet"><code class="sourceCode hamlet"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">&lt;p </span><span class="er">#firstid</span><span class="kw">&gt;</span>Paragraph <span class="kw">&lt;i </span><span class="er">#secondid</span><span class="kw">&gt;</span>italic&lt;/i&gt; end.</span></code></pre></div>
<p>以下の HTML を生成します。</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb20-1"><a href="#cb20-1"></a><span class="kw">&lt;p</span><span class="ot"> id=</span><span class="st">&quot;firstid&quot;</span><span class="kw">&gt;</span>Paragraph <span class="kw">&lt;i</span><span class="ot"> #secondid</span><span class="kw">&gt;</span>italic<span class="kw">&lt;/i&gt;</span> end.<span class="kw">&lt;/p&gt;</span></span></code></pre></div>
<p><code>i</code> タグが単純なテキストとして処理される一方で <code>p</code>タグは自動的に閉じられ、その属性が特別扱いを受ける点に注意してください。</p>
<h3 id="展開">展開</h3>
<p>これまでに紹介したものは簡潔な HTML なので何の問題も起こっていませんが、まだ Haskell コードと相互作用できていません。どのようにして変数を受け渡せば良いのでしょうか？それは単純に展開を利用します。</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode hamlet"><code class="sourceCode hamlet"><span id="cb21-1"><a href="#cb21-1"></a><span class="kw">&lt;head&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>    <span class="kw">&lt;title&gt;#{</span>title<span class="kw">}</span></span></code></pre></div>
<p>ハッシュの後ろに波括弧のペアが続く表記は変数展開 (<strong><em>variable interpolation</em></strong>) です。上の例では、テンプレートが呼ばれたスコープで <code>title</code> 変数が利用できます。そのことは次のように言い直せます。Hamlet は変数が呼ばれた際に自動的にスコープ内の変数へアクセスします。そのため、特に変数を受け渡す必要はありません。</p>
<p>展開の中では関数適用、文字列、数値リテラル、修飾付きモジュールを利用することができます。また、処理をまとめるために丸括弧やドルマークを使うこともできます。展開の処理の最後に <code>toHtml</code> 関数が適用されます。これは <code>ToHtml</code> クラスの全てのインスタンスが展開可能だということを意味します。例えば、次のコードを考えてみましょう。</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb22-1"><a href="#cb22-1"></a><span class="co">-- Just ignore the quasiquote stuff for now, and that shamlet thing.</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="co">-- It will be explained later.</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="ot">{-# LANGUAGE QuasiQuotes #-}</span></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="kw">import</span> <span class="dt">Text.Hamlet</span> (shamlet)</span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="kw">import</span> <span class="dt">Text.Blaze.Html.Renderer.String</span> (renderHtml)</span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="kw">import</span> <span class="dt">Data.Char</span> (toLower)</span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="kw">import</span> <span class="dt">Data.List</span> (sort)</span>
<span id="cb22-8"><a href="#cb22-8"></a></span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="kw">data</span> <span class="dt">Person</span> <span class="ot">=</span> <span class="dt">Person</span></span>
<span id="cb22-10"><a href="#cb22-10"></a>    {<span class="ot"> name ::</span> <span class="dt">String</span></span>
<span id="cb22-11"><a href="#cb22-11"></a>    ,<span class="ot"> age  ::</span> <span class="dt">Int</span></span>
<span id="cb22-12"><a href="#cb22-12"></a>    }</span>
<span id="cb22-13"><a href="#cb22-13"></a></span>
<span id="cb22-14"><a href="#cb22-14"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb22-15"><a href="#cb22-15"></a>main <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="op">$</span> renderHtml [shamlet|</span>
<span id="cb22-16"><a href="#cb22-16"></a><span class="kw">&lt;p&gt;</span>Hello, my name is <span class="kw">#{</span>name person<span class="kw">}</span> and I am <span class="kw">#{</span><span class="fu">show</span> <span class="op">$</span> age person<span class="kw">}</span>.</span>
<span id="cb22-17"><a href="#cb22-17"></a><span class="kw">&lt;p&gt;</span></span>
<span id="cb22-18"><a href="#cb22-18"></a>    Let's do some funny stuff with my name: #</span>
<span id="cb22-19"><a href="#cb22-19"></a>    <span class="kw">&lt;b&gt;#{</span><span class="fu">sort</span> <span class="op">$</span> <span class="fu">map</span> <span class="fu">toLower</span> (name person)<span class="kw">}</span></span>
<span id="cb22-20"><a href="#cb22-20"></a><span class="kw">&lt;p&gt;</span>Oh, and in 5 years I'll be <span class="kw">#{</span><span class="fu">show</span> ((<span class="op">+</span>) <span class="dv">5</span> (age person))<span class="kw">}</span> years old.</span>
<span id="cb22-21"><a href="#cb22-21"></a>|]</span>
<span id="cb22-22"><a href="#cb22-22"></a>  <span class="kw">where</span></span>
<span id="cb22-23"><a href="#cb22-23"></a>    person <span class="ot">=</span> <span class="dt">Person</span> <span class="st">&quot;Michael&quot;</span> <span class="dv">26</span></span></code></pre></div>
<p>目玉機能の型安全URLについてはどうでしょうか？それらはシャープの代わりにアットマーク (@) で始まる点を除けば、あらゆる面で変数展開と同じです。さらにキャレット (^) によって同じ型の別のテンプレートを埋め込むことが可能になります。次のコード例で確認しましょう。</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb23-1"><a href="#cb23-1"></a><span class="ot">{-# LANGUAGE QuasiQuotes #-}</span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="kw">import</span> <span class="dt">Text.Hamlet</span> (<span class="dt">HtmlUrl</span>, hamlet)</span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="kw">import</span> <span class="dt">Text.Blaze.Html.Renderer.String</span> (renderHtml)</span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="kw">import</span> <span class="dt">Data.Text</span> (<span class="dt">Text</span>)</span>
<span id="cb23-6"><a href="#cb23-6"></a></span>
<span id="cb23-7"><a href="#cb23-7"></a><span class="kw">data</span> <span class="dt">MyRoute</span> <span class="ot">=</span> <span class="dt">Home</span></span>
<span id="cb23-8"><a href="#cb23-8"></a></span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="ot">render ::</span> <span class="dt">MyRoute</span> <span class="ot">-&gt;</span> [(<span class="dt">Text</span>, <span class="dt">Text</span>)] <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb23-10"><a href="#cb23-10"></a>render <span class="dt">Home</span> _ <span class="ot">=</span> <span class="st">&quot;/home&quot;</span></span>
<span id="cb23-11"><a href="#cb23-11"></a></span>
<span id="cb23-12"><a href="#cb23-12"></a><span class="ot">footer ::</span> <span class="dt">HtmlUrl</span> <span class="dt">MyRoute</span></span>
<span id="cb23-13"><a href="#cb23-13"></a>footer <span class="ot">=</span> [hamlet|</span>
<span id="cb23-14"><a href="#cb23-14"></a><span class="kw">&lt;footer&gt;</span></span>
<span id="cb23-15"><a href="#cb23-15"></a>    Return to #</span>
<span id="cb23-16"><a href="#cb23-16"></a>    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">Home</span><span class="kw">}&gt;</span>Homepage</span>
<span id="cb23-17"><a href="#cb23-17"></a>    .</span>
<span id="cb23-18"><a href="#cb23-18"></a>|]</span>
<span id="cb23-19"><a href="#cb23-19"></a></span>
<span id="cb23-20"><a href="#cb23-20"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb23-21"><a href="#cb23-21"></a>main <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="op">$</span> renderHtml <span class="op">$</span> [hamlet|</span>
<span id="cb23-22"><a href="#cb23-22"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb23-23"><a href="#cb23-23"></a>    <span class="kw">&lt;p&gt;</span>This is my page.</span>
<span id="cb23-24"><a href="#cb23-24"></a>    <span class="kw">^{</span>footer<span class="kw">}</span></span>
<span id="cb23-25"><a href="#cb23-25"></a>|] render</span></code></pre></div>
<p>さらに、クエリ文字列パラメータを受け入れるような URL 展開の変種があます。これは例えばページ番号をつけるようなレスポンスに適しています。<code>@{...}</code> を用いる代わりにクエスチョンマークを加え <code>@?{...}</code> とすることで、クエリ文字列があることを表します。与える値は2要素のタプルでなければなりません。第1要素が型安全URL、第2要素はクエリ文字列パラメータのリストのペアとなります。例えば、次のコードスニペットの例を見てみましょう。</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb24-1"><a href="#cb24-1"></a><span class="ot">{-# LANGUAGE QuasiQuotes #-}</span></span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="kw">import</span> <span class="dt">Text.Hamlet</span> (<span class="dt">HtmlUrl</span>, hamlet)</span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="kw">import</span> <span class="dt">Text.Blaze.Html.Renderer.String</span> (renderHtml)</span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="kw">import</span> <span class="dt">Data.Text</span> (<span class="dt">Text</span>, append, pack)</span>
<span id="cb24-6"><a href="#cb24-6"></a><span class="kw">import</span> <span class="dt">Control.Arrow</span> (second)</span>
<span id="cb24-7"><a href="#cb24-7"></a><span class="kw">import</span> <span class="dt">Network.HTTP.Types</span> (renderQueryText)</span>
<span id="cb24-8"><a href="#cb24-8"></a><span class="kw">import</span> <span class="dt">Data.Text.Encoding</span> (decodeUtf8)</span>
<span id="cb24-9"><a href="#cb24-9"></a><span class="kw">import</span> <span class="dt">Blaze.ByteString.Builder</span> (toByteString)</span>
<span id="cb24-10"><a href="#cb24-10"></a></span>
<span id="cb24-11"><a href="#cb24-11"></a><span class="kw">data</span> <span class="dt">MyRoute</span> <span class="ot">=</span> <span class="dt">SomePage</span></span>
<span id="cb24-12"><a href="#cb24-12"></a></span>
<span id="cb24-13"><a href="#cb24-13"></a><span class="ot">render ::</span> <span class="dt">MyRoute</span> <span class="ot">-&gt;</span> [(<span class="dt">Text</span>, <span class="dt">Text</span>)] <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb24-14"><a href="#cb24-14"></a>render <span class="dt">SomePage</span> params <span class="ot">=</span> <span class="st">&quot;/home&quot;</span> <span class="ot">`append`</span></span>
<span id="cb24-15"><a href="#cb24-15"></a>    decodeUtf8 (toByteString <span class="op">$</span> renderQueryText <span class="dt">True</span> (<span class="fu">map</span> (second <span class="dt">Just</span>) params))</span>
<span id="cb24-16"><a href="#cb24-16"></a></span>
<span id="cb24-17"><a href="#cb24-17"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb24-18"><a href="#cb24-18"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb24-19"><a href="#cb24-19"></a>    <span class="kw">let</span> currPage <span class="ot">=</span> <span class="dv">2</span><span class="ot"> ::</span> <span class="dt">Int</span></span>
<span id="cb24-20"><a href="#cb24-20"></a>    <span class="fu">putStrLn</span> <span class="op">$</span> renderHtml <span class="op">$</span> [hamlet|</span>
<span id="cb24-21"><a href="#cb24-21"></a><span class="kw">&lt;p&gt;</span></span>
<span id="cb24-22"><a href="#cb24-22"></a>    You are currently on page <span class="kw">#{</span>currPage<span class="kw">}</span>.</span>
<span id="cb24-23"><a href="#cb24-23"></a>    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">@?{(SomePage,</span><span class="kw"> </span><span class="er">[(&quot;page&quot;,</span><span class="ot"> pack </span><span class="er">$</span><span class="ot"> </span><span class="er">show</span><span class="ot"> </span><span class="er">$</span><span class="ot"> </span><span class="er">currPage</span><span class="ot"> </span><span class="er">-</span><span class="ot"> </span><span class="er">1)])}</span><span class="kw">&gt;</span>Previous</span>
<span id="cb24-24"><a href="#cb24-24"></a>    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">@?{(SomePage,</span><span class="kw"> </span><span class="er">[(&quot;page&quot;,</span><span class="ot"> pack </span><span class="er">$</span><span class="ot"> </span><span class="er">show</span><span class="ot"> </span><span class="er">$</span><span class="ot"> </span><span class="er">currPage</span><span class="ot"> </span><span class="er">+</span><span class="ot"> </span><span class="er">1)])}</span><span class="kw">&gt;</span>Next</span>
<span id="cb24-25"><a href="#cb24-25"></a>|] render</span></code></pre></div>
<p>これは、次のようなHTMLを生成します。</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb25-1"><a href="#cb25-1"></a><span class="kw">&lt;p&gt;</span>You are currently on page 2.</span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;/home?page=1&quot;</span><span class="kw">&gt;</span>Previous<span class="kw">&lt;/a&gt;</span></span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;/home?page=3&quot;</span><span class="kw">&gt;</span>Next<span class="kw">&lt;/a&gt;</span></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="kw">&lt;/p&gt;</span></span></code></pre></div>
<h3 id="属性">属性</h3>
<p>前の最後の例では “a” タグに href 属性を追加しました。構文について詳しく見てみましょう。</p>
<ul>
<li>属性の値にも変数展開が利用できます。</li>
<li>HTML と同様に属性のイコール記号と値はオプションです。したがって <code>&lt;input type=checkbox checked&gt;</code> は完全に正しい書き方です。</li>
<li>id と class 属性についてはそれぞれハッシュ (#) と ピリオド (.) を使います。つまり <code>&lt;p #paragraphid .class1 .class2&gt;</code> という感じです。</li>
<li>属性値を囲うための前後のクォートは省略可能ですが、途中でスペースを用いる場合は必要です。</li>
<li>コロンを利用することでオプションの属性を追加できます。isChecked 変数の値が True の場合のみチェックボックスをチェックした状態にしたい場合 <code>&lt;input type=checkbox :isChecked:checked&gt;</code> とします。また、ある段落の文字色を赤色にしたい場合は <code>&lt;p :isRed:style="color:red"&gt;</code> とします。(これはクラス名を使っても良いです。例えば、 <code>&lt;p :isCurrent:.current&gt;</code> は isCurrent が <code>True</code> の場合, <code>current</code> クラスをセットします)</li>
<li>任意のキーと値のペアもまた <code>*{...}</code> 構文を用いて展開が可能です。属性の場合の変数展開は値が String または Text のタプルか, タプルのリストである必要があります。例えば <code>attrs = [("foo", "bar")]</code> という値であれば展開可能です。</li>
</ul>
<h3 id="条件文">条件文</h3>
<p>いつかはページ内に何らかのロジックを組み込みたいと思うでしょう。Hamlet の目的はロジックを可能な限り最小にすることで Haskell に大部分を任せることです。そのようなものとして <code>if</code>、 <code>elseif</code>、 <code>else</code> は非常に基本的な論理文です。</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode hamlet"><code class="sourceCode hamlet"><span id="cb26-1"><a href="#cb26-1"></a><span class="kw">$if</span> isAdmin</span>
<span id="cb26-2"><a href="#cb26-2"></a>    <span class="kw">&lt;p&gt;</span>Welcome to the admin section.</span>
<span id="cb26-3"><a href="#cb26-3"></a><span class="kw">$elseif</span> isLoggedIn</span>
<span id="cb26-4"><a href="#cb26-4"></a>    <span class="kw">&lt;p&gt;</span>You are not the administrator.</span>
<span id="cb26-5"><a href="#cb26-5"></a><span class="kw">$else</span></span>
<span id="cb26-6"><a href="#cb26-6"></a>    <span class="kw">&lt;p&gt;</span>I don't know who you are. Please log in so I can decide if you get access.</span></code></pre></div>
<p>通常の展開と同じ規則が条件文にも当てはまります。</p>
<h3 id="maybe">Maybe</h3>
<p>同様に Maybe 値を扱うための特別な記法があります。技術的には <code>if</code>、 <code>isJust</code>、 <code>fromJust</code> を使えば同じ処理を行えます。しかし、<code>maybe</code> を使うと、部分関数を避けることができるので、こちらの方が便利です。</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode hamlet"><code class="sourceCode hamlet"><span id="cb27-1"><a href="#cb27-1"></a><span class="kw">$maybe</span> name <span class="ot">&lt;-</span> maybeName</span>
<span id="cb27-2"><a href="#cb27-2"></a>    <span class="kw">&lt;p&gt;</span>Your name is <span class="kw">#{</span>name<span class="kw">}</span></span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="kw">$nothing</span></span>
<span id="cb27-4"><a href="#cb27-4"></a>    <span class="kw">&lt;p&gt;</span>I don't know your name.</span></code></pre></div>
<p>単純な識別子に加え、コンストラクタやタプルなど、より複雑な値を左辺に使うことができます。</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode hamlet"><code class="sourceCode hamlet"><span id="cb28-1"><a href="#cb28-1"></a><span class="kw">$maybe</span> <span class="dt">Person</span> firstName lastName <span class="ot">&lt;-</span> maybePerson</span>
<span id="cb28-2"><a href="#cb28-2"></a>    <span class="kw">&lt;p&gt;</span>Your name is <span class="kw">#{</span>firstName<span class="kw">}</span> <span class="kw">#{</span>lastName<span class="kw">}</span></span></code></pre></div>
<p>右辺は展開と同じ規則に従い、変数や関数適用などが使えます。</p>
<h3 id="forall">Forall</h3>
<p>リストのループについてはどうでしょうか？こんな感じです。</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode hamlet"><code class="sourceCode hamlet"><span id="cb29-1"><a href="#cb29-1"></a><span class="kw">$if</span> <span class="fu">null</span> people</span>
<span id="cb29-2"><a href="#cb29-2"></a>    <span class="kw">&lt;p&gt;</span>No people.</span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="kw">$else</span></span>
<span id="cb29-4"><a href="#cb29-4"></a>    <span class="kw">&lt;ul&gt;</span></span>
<span id="cb29-5"><a href="#cb29-5"></a>        <span class="kw">$forall</span> person <span class="ot">&lt;-</span> people</span>
<span id="cb29-6"><a href="#cb29-6"></a>            <span class="kw">&lt;li&gt;#{</span>person<span class="kw">}</span></span></code></pre></div>
<h3 id="case">Case</h3>
<p>パターンマッチは Haskell の重要な強みの1つです。直和型は多くの現実的な型をきれいにモデル化することができます。また、 <code>case</code> 文を利用すると安全にマッチさせることができます。どれにもマッチしない場合には、コンパイラが警告を出してくれます。Hamlet の case 文も、それと同様の力を持ちます。</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode hamlet"><code class="sourceCode hamlet"><span id="cb30-1"><a href="#cb30-1"></a><span class="kw">$</span><span class="er">case</span> <span class="er">foo</span></span>
<span id="cb30-2"><a href="#cb30-2"></a>    <span class="kw">$</span><span class="er">of</span> <span class="er">Left</span> <span class="er">bar</span></span>
<span id="cb30-3"><a href="#cb30-3"></a>        <span class="kw">&lt;p&gt;</span>It was left: <span class="kw">#{</span>bar<span class="kw">}</span></span>
<span id="cb30-4"><a href="#cb30-4"></a>    <span class="kw">$</span><span class="er">of</span> <span class="er">Right</span> <span class="er">baz</span></span>
<span id="cb30-5"><a href="#cb30-5"></a>        <span class="kw">&lt;p&gt;</span>It was right: <span class="kw">#{</span>baz<span class="kw">}</span></span></code></pre></div>
<h3 id="with">With</h3>
<p>文を短くするために <code>with</code> を利用します。基本的には長い式に対して、エイリアスを定義するために利用します。</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode hamlet"><code class="sourceCode hamlet"><span id="cb31-1"><a href="#cb31-1"></a><span class="kw">$</span><span class="er">with</span> <span class="er">foo</span> <span class="er">&lt;-</span> <span class="er">some</span> <span class="er">very</span> <span class="er">(long</span> <span class="er">ugly)</span> <span class="er">expression</span> <span class="er">that</span> <span class="er">$</span> <span class="er">should</span> <span class="er">only</span> <span class="er">$</span> <span class="er">happen</span> <span class="er">once</span></span>
<span id="cb31-2"><a href="#cb31-2"></a>    <span class="kw">&lt;p&gt;</span>But I'm going to use <span class="kw">#{</span>foo<span class="kw">}</span> multiple times. <span class="kw">#{</span>foo<span class="kw">}</span></span></code></pre></div>
<h3 id="doctype">Doctype</h3>
<p>最後はちょっとした糖衣構文の doctype 文です。 <code>dectype</code> は複数の異なるバージョンがサポートされていますが、モダンな Web アプリケーションでは <code>$doctype 5</code> を推奨しています。これは <code>&lt;!DOCTYPE html&gt;</code> を生成します。</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode hamlet"><code class="sourceCode hamlet"><span id="cb32-1"><a href="#cb32-1"></a><span class="kw">$</span><span class="er">doctype</span> <span class="er">5</span></span>
<span id="cb32-2"><a href="#cb32-2"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb32-3"><a href="#cb32-3"></a>    <span class="kw">&lt;head&gt;</span></span>
<span id="cb32-4"><a href="#cb32-4"></a>        <span class="kw">&lt;title&gt;</span>Hamlet is Awesome</span>
<span id="cb32-5"><a href="#cb32-5"></a>    <span class="kw">&lt;body&gt;</span></span>
<span id="cb32-6"><a href="#cb32-6"></a>        <span class="kw">&lt;p&gt;</span>All done.</span></code></pre></div>
<div class="yesod-book-notice">
<p>これよりも古い構文として3つのエクスクラメーション (!!!) が今もサポートされています。時にはこのようなコードを見かけるかもしれません。この形式を削除する予定はありませんが、一般的に <code>doctype</code> による方法がより読みやすいと思います。</p>
</div>
<h2 id="lucius-構文">Lucius 構文</h2>
<p>Lucius はシェイクスピアに2種類存在する CSS テンプレート言語のうちの一つです。これは CSS のスーパーセットであることを意図しているため、既存の構文よりも機能が豊富です。</p>
<ul>
<li>Hamlet のように変数と URL の展開が可能です。</li>
<li>CSS のブロックはネストが可能です。</li>
<li>テンプレートで変数宣言が可能です。</li>
<li>複合的な CSS プロパティはミックスイン (mixin) として作り、複数の宣言で再利用することが可能です。</li>
</ul>
<p>CSS ブロックのネストから説明を始めましょう。<code>article</code> 内部の複数のタグで特別なスタイルを適用させたいとします。普通の CSS では次のように書くでしょう。</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode css"><code class="sourceCode css"><span id="cb33-1"><a href="#cb33-1"></a>article code { <span class="kw">background-color</span>: <span class="cn">grey</span><span class="op">;</span> }</span>
<span id="cb33-2"><a href="#cb33-2"></a>article p { <span class="kw">text-indent</span>: <span class="dv">2</span><span class="dt">em</span><span class="op">;</span> }</span>
<span id="cb33-3"><a href="#cb33-3"></a>article a { <span class="kw">text-decoration</span>: <span class="dv">none</span><span class="op">;</span> }</span>
<span id="cb33-4"><a href="#cb33-4"></a>article a <span class="op">&gt;</span> h1 { <span class="kw">color</span>: <span class="cn">green</span><span class="op">;</span> }</span></code></pre></div>
<p>上記のコードは記述量は少ないですが article を何度も打たなければならないため多少不快ですし、もしそれが何十個もあったらどうでしょうか。世界一悪い事ではないにしても少し嫌です。Lucius はこのような場面で役立ちます。</p>
<pre class="lucius"><code>article {
    code { background-color: grey; }
    p { text-indent: 2em; }
    a { text-decoration: none; }
    &gt; h1 { color: green; }
}</code></pre>
<p>Lucius 変数を使えば繰り返しを避けることができます。単純な例として共通して使う文字色を定義してみましょう。</p>
<pre class="lucius"><code>@textcolor: #ccc; /* just because we hate our users */
body { color: #{textcolor} }
a:link, a:visited { color: #{textcolor} }</code></pre>
<p>ミックスインは Lucius に比較的最近追加されたものです。アイデアとしてはプロパティの集合を与えるミックスインを宣言して、キャレット展開 (^) を使うことで、そのミックスインをテンプレートに埋め込みます。次の例はミックスインを利用してベンダープレフィックスを扱う方法を示すコードです。</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb36-1"><a href="#cb36-1"></a><span class="ot">{-# LANGUAGE QuasiQuotes #-}</span></span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="kw">import</span> <span class="dt">Text.Lucius</span></span>
<span id="cb36-3"><a href="#cb36-3"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text.Lazy.IO</span> <span class="kw">as</span> <span class="dt">TLIO</span></span>
<span id="cb36-4"><a href="#cb36-4"></a></span>
<span id="cb36-5"><a href="#cb36-5"></a><span class="co">-- Dummy render function.</span></span>
<span id="cb36-6"><a href="#cb36-6"></a>render <span class="ot">=</span> <span class="fu">undefined</span></span>
<span id="cb36-7"><a href="#cb36-7"></a></span>
<span id="cb36-8"><a href="#cb36-8"></a><span class="co">-- Our mixin, which provides a number of vendor prefixes for transitions.</span></span>
<span id="cb36-9"><a href="#cb36-9"></a>transition val <span class="ot">=</span></span>
<span id="cb36-10"><a href="#cb36-10"></a>    [luciusMixin|</span>
<span id="cb36-11"><a href="#cb36-11"></a>        -webkit-transition: #{val};</span>
<span id="cb36-12"><a href="#cb36-12"></a>        -moz-transition: #{val};</span>
<span id="cb36-13"><a href="#cb36-13"></a>        -ms-transition: #{val};</span>
<span id="cb36-14"><a href="#cb36-14"></a>        -o-transition: #{val};</span>
<span id="cb36-15"><a href="#cb36-15"></a>        transition: #{val};</span>
<span id="cb36-16"><a href="#cb36-16"></a>    |]</span>
<span id="cb36-17"><a href="#cb36-17"></a></span>
<span id="cb36-18"><a href="#cb36-18"></a><span class="co">-- Our actual Lucius template, which uses the mixin.</span></span>
<span id="cb36-19"><a href="#cb36-19"></a>myCSS <span class="ot">=</span></span>
<span id="cb36-20"><a href="#cb36-20"></a>    [lucius|</span>
<span id="cb36-21"><a href="#cb36-21"></a>        .some-class {</span>
<span id="cb36-22"><a href="#cb36-22"></a>            ^{transition &quot;all 4s ease&quot;}</span>
<span id="cb36-23"><a href="#cb36-23"></a>        }</span>
<span id="cb36-24"><a href="#cb36-24"></a>    |]</span>
<span id="cb36-25"><a href="#cb36-25"></a></span>
<span id="cb36-26"><a href="#cb36-26"></a>main <span class="ot">=</span> TLIO.putStrLn <span class="op">$</span> renderCss <span class="op">$</span> myCSS render</span></code></pre></div>
<h2 id="cassius-構文">Cassius 構文</h2>
<p>Cassius と Lucius の違いは空白の扱いだけです。概要の部分で述べたように、処理エンジンは Lucius と同じですが、サブブロックを閉じるための波括弧や行末を表すセミコロンを挿入するための前処理を行います。これは Cassius を書く時に Lucius のすべての機能を使えるということを意味します。以下は簡単な例です。</p>
<pre class="cassius"><code>#banner
    border: 1px solid #{bannerColor}
    background-image: url(@{BannerImageR})</code></pre>
<h2 id="julius-構文">Julius 構文</h2>
<p>Julius は本章で論じられた言語の中で最も単純です。実際に単なる Javascript だという人もいるかもしれません。Julius ではこれまで述べた3種類の展開方法が利用できますが、それ以外については中身に何の変化も与えません。</p>
<div class="yesod-book-notice">
<p>Julius を scaffolded Yesod サイトで利用する場合 Javascript が自動的に圧縮されていることに気づくでしょう。これは Julius の機能ではなく Yesod が Julius の出力ファイルを圧縮するために hjsmin パッケージを利用しているためです。</p>
</div>
<h2 id="シェイクスピアの呼び出し方法">シェイクスピアの呼び出し方法</h2>
<p>もちろんある点において疑問が生じるでしょう。実際にどのようにしてこれらのものを動かすのでしょうか？Haskell コードからシェイクスピアを呼び出すための方法は3種類あります。</p>
<h4 id="準クォート">準クォート</h4>
<p>準クォートを用いることで任意のコンテンツを Haskell コードに埋め込み、コンパイル時に Haskell コードへ変換することが可能となります。</p>
<h4 id="外部ファイル">外部ファイル</h4>
<p>外部ファイルの場合、テンプレートコードは別のファイルにあり Template Haskell を通して参照されます。</p>
<h4 id="リロードモード">リロードモード</h4>
<p>準クォートや外部ファイルを使った方法では、何か変更を加えると完全な再コンパイルが必要となります。リロードモードでは、テンプレートは別のファイルに保存されるため Template Haskell で参照します。しかし、実行時に外部ファイルは毎回最初から再パーズされます。</p>
<div class="yesod-book-notice">
<p>リロードモードは Hamlet では利用できません Cassius、 Lucius、 Julius でのみ利用可能です。Hamlet には Haskell コンパイラに直接依存し、実行時にうまく再実装できないようなあまりにも多くの洗練された側面があるからです。</p>
</div>
<p>プロダクション環境では、はじめの2つの方法の内どちらかを利用することになります。どちらともテンプレート全体を最終的な実行ファイルに埋め込むため、デプロイメントを簡潔にするとともにパフォーマンスを向上させます。準クォートの利点は全てが単一ファイルに存在するという簡潔さにあります。そのため、短いテンプレートであれば準クォートが適しています。しかし、一般的には次のような理由で外部ファイルによる方法が推薦されます。</p>
<ul>
<li>ロジックとデザインの分離という伝統にとても従っている。</li>
<li>簡単な CPP マクロを使うことで外部ファイルとデバッグモードを簡単に切り替えることができます。これにより、迅速な開発とプロダクション環境における高いパフォーマンスが達成可能になります。</li>
</ul>
<p>これらは特別な準クォートと Template Haskell 関数であるため、適切な言語拡張を有効にして、正しい構文を使う必要があります。次のコードスニペットでそれぞれの簡単な例を見てみましょう。</p>
<h3 id="準クォート-1">準クォート</h3>
<div class="sourceCode" id="cb38"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb38-1"><a href="#cb38-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span> <span class="co">-- we're using Text below</span></span>
<span id="cb38-2"><a href="#cb38-2"></a><span class="ot">{-# LANGUAGE QuasiQuotes #-}</span></span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="kw">import</span> <span class="dt">Text.Hamlet</span> (<span class="dt">HtmlUrl</span>, hamlet)</span>
<span id="cb38-4"><a href="#cb38-4"></a><span class="kw">import</span> <span class="dt">Data.Text</span> (<span class="dt">Text</span>)</span>
<span id="cb38-5"><a href="#cb38-5"></a><span class="kw">import</span> <span class="dt">Text.Blaze.Html.Renderer.String</span> (renderHtml)</span>
<span id="cb38-6"><a href="#cb38-6"></a></span>
<span id="cb38-7"><a href="#cb38-7"></a><span class="kw">data</span> <span class="dt">MyRoute</span> <span class="ot">=</span> <span class="dt">Home</span> <span class="op">|</span> <span class="dt">Time</span> <span class="op">|</span> <span class="dt">Stylesheet</span></span>
<span id="cb38-8"><a href="#cb38-8"></a></span>
<span id="cb38-9"><a href="#cb38-9"></a><span class="ot">render ::</span> <span class="dt">MyRoute</span> <span class="ot">-&gt;</span> [(<span class="dt">Text</span>, <span class="dt">Text</span>)] <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb38-10"><a href="#cb38-10"></a>render <span class="dt">Home</span> _ <span class="ot">=</span> <span class="st">&quot;/home&quot;</span></span>
<span id="cb38-11"><a href="#cb38-11"></a>render <span class="dt">Time</span> _ <span class="ot">=</span> <span class="st">&quot;/time&quot;</span></span>
<span id="cb38-12"><a href="#cb38-12"></a>render <span class="dt">Stylesheet</span> _ <span class="ot">=</span> <span class="st">&quot;/style.css&quot;</span></span>
<span id="cb38-13"><a href="#cb38-13"></a></span>
<span id="cb38-14"><a href="#cb38-14"></a><span class="ot">template ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">HtmlUrl</span> <span class="dt">MyRoute</span></span>
<span id="cb38-15"><a href="#cb38-15"></a>template title <span class="ot">=</span> [hamlet|</span>
<span id="cb38-16"><a href="#cb38-16"></a><span class="kw">$</span><span class="er">doctype</span> <span class="er">5</span></span>
<span id="cb38-17"><a href="#cb38-17"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb38-18"><a href="#cb38-18"></a>    <span class="kw">&lt;head&gt;</span></span>
<span id="cb38-19"><a href="#cb38-19"></a>        <span class="kw">&lt;title&gt;#{</span>title<span class="kw">}</span></span>
<span id="cb38-20"><a href="#cb38-20"></a>        <span class="kw">&lt;link</span><span class="ot"> rel=</span><span class="st">stylesheet</span><span class="ot"> href=</span><span class="kw">@{</span><span class="dt">Stylesheet</span><span class="kw">}&gt;</span></span>
<span id="cb38-21"><a href="#cb38-21"></a>    <span class="kw">&lt;body&gt;</span></span>
<span id="cb38-22"><a href="#cb38-22"></a>        <span class="kw">&lt;h1&gt;#{</span>title<span class="kw">}</span></span>
<span id="cb38-23"><a href="#cb38-23"></a>|]</span>
<span id="cb38-24"><a href="#cb38-24"></a></span>
<span id="cb38-25"><a href="#cb38-25"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb38-26"><a href="#cb38-26"></a>main <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="op">$</span> renderHtml <span class="op">$</span> template <span class="st">&quot;My Title&quot;</span> render</span></code></pre></div>
<h3 id="外部ファイル-1">外部ファイル</h3>
<div class="sourceCode" id="cb39"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb39-1"><a href="#cb39-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span> <span class="co">-- we're using Text below</span></span>
<span id="cb39-2"><a href="#cb39-2"></a><span class="ot">{-# LANGUAGE TemplateHaskell #-}</span></span>
<span id="cb39-3"><a href="#cb39-3"></a><span class="ot">{-# LANGUAGE CPP #-}</span> <span class="co">-- to control production versus debug</span></span>
<span id="cb39-4"><a href="#cb39-4"></a><span class="kw">import</span> <span class="dt">Text.Lucius</span> (<span class="dt">CssUrl</span>, luciusFile, luciusFileReload, renderCss)</span>
<span id="cb39-5"><a href="#cb39-5"></a><span class="kw">import</span> <span class="dt">Data.Text</span> (<span class="dt">Text</span>)</span>
<span id="cb39-6"><a href="#cb39-6"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text.Lazy.IO</span> <span class="kw">as</span> <span class="dt">TLIO</span></span>
<span id="cb39-7"><a href="#cb39-7"></a></span>
<span id="cb39-8"><a href="#cb39-8"></a><span class="kw">data</span> <span class="dt">MyRoute</span> <span class="ot">=</span> <span class="dt">Home</span> <span class="op">|</span> <span class="dt">Time</span> <span class="op">|</span> <span class="dt">Stylesheet</span></span>
<span id="cb39-9"><a href="#cb39-9"></a></span>
<span id="cb39-10"><a href="#cb39-10"></a><span class="ot">render ::</span> <span class="dt">MyRoute</span> <span class="ot">-&gt;</span> [(<span class="dt">Text</span>, <span class="dt">Text</span>)] <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb39-11"><a href="#cb39-11"></a>render <span class="dt">Home</span> _ <span class="ot">=</span> <span class="st">&quot;/home&quot;</span></span>
<span id="cb39-12"><a href="#cb39-12"></a>render <span class="dt">Time</span> _ <span class="ot">=</span> <span class="st">&quot;/time&quot;</span></span>
<span id="cb39-13"><a href="#cb39-13"></a>render <span class="dt">Stylesheet</span> _ <span class="ot">=</span> <span class="st">&quot;/style.css&quot;</span></span>
<span id="cb39-14"><a href="#cb39-14"></a></span>
<span id="cb39-15"><a href="#cb39-15"></a><span class="ot">template ::</span> <span class="dt">CssUrl</span> <span class="dt">MyRoute</span></span>
<span id="cb39-16"><a href="#cb39-16"></a><span class="pp">#if PRODUCTION</span></span>
<span id="cb39-17"><a href="#cb39-17"></a>template <span class="ot">=</span> <span class="op">$</span>(luciusFile <span class="st">&quot;template.lucius&quot;</span>)</span>
<span id="cb39-18"><a href="#cb39-18"></a><span class="pp">#else</span></span>
<span id="cb39-19"><a href="#cb39-19"></a>template <span class="ot">=</span> <span class="op">$</span>(luciusFileReload <span class="st">&quot;template.lucius&quot;</span>)</span>
<span id="cb39-20"><a href="#cb39-20"></a><span class="pp">#endif</span></span>
<span id="cb39-21"><a href="#cb39-21"></a></span>
<span id="cb39-22"><a href="#cb39-22"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb39-23"><a href="#cb39-23"></a>main <span class="ot">=</span> TLIO.putStrLn <span class="op">$</span> renderCss <span class="op">$</span> template render</span></code></pre></div>
<div class="sourceCode" id="cb40"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb40-1"><a href="#cb40-1"></a><span class="co">-- @template.lucius</span></span>
<span id="cb40-2"><a href="#cb40-2"></a>foo { bar<span class="op">:</span> baz }</span></code></pre></div>
<p>これら関数の命名規則には次のような一貫性があります。</p>
<table>
<thead>
<tr class="header">
<th>テンプレート言語</th>
<th>準クォート</th>
<th>外部ファイル</th>
<th>リロード</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Hamlet</td>
<td><code>hamlet</code></td>
<td><code>hamletFile</code></td>
<td><strong><em>N/A</em></strong></td>
</tr>
<tr class="even">
<td>Cassius</td>
<td><code>cassius</code></td>
<td><code>cassiusFile</code></td>
<td><code>cassiusFileReload</code></td>
</tr>
<tr class="odd">
<td>Lucius</td>
<td><code>lucius</code></td>
<td><code>luciusFile</code></td>
<td><code>luciusFileReload</code></td>
</tr>
<tr class="even">
<td>Julius</td>
<td><code>julius</code></td>
<td><code>juliusFile</code></td>
<td><code>juliusFileReload</code></td>
</tr>
</tbody>
</table>
<h2 id="その他の-hamlet-型">その他の Hamlet 型</h2>
<p>これまでのところ型安全URLが埋め込まれた HTML の断片のような Hamlet から <code>HtmlUrl</code> の値を生成する方法を見てきました。 その他にも Halmet が生成できる値は3つあります。単純な HTML、 URLと国際化されたメッセージを持った HTML、そしてウィジェットです。ウィジェットについてはウィジェットの章で詳しく説明します。</p>
<p>URL が埋め込まれていない単純な HTML を生成するために “シンプルな Hamlet” を使います。普通の Hamlet との違いがいくつかあります。</p>
<ul>
<li>接頭辞に “s” が付く異なる種類の関数を利用します。したがって準クォートは <code>shamlet</code>、外部ファイルは <code>shamletFile</code> となります。これらをどのように発音するかについてはいまだ論争中です。</li>
<li>URL 展開は許可されないため、コンパイル時エラーになります。</li>
<li>埋め込み (キャレット展開) は <code>HtmlUrl</code> の値を許可しなくなります。ルールとして埋め込み値はテンプレートそれ自体と同じ型を持つ必要があるので、この場合は <code>Html</code> 型でなければなりません。このことは <code>shamlet</code> において埋め込みは (ハッシュを用いた) 通常の変数展開で完全に置き換え可能であることを意味します。</li>
</ul>
<p>Hamlet の国際化 (i18) への対応は少々複雑です。Hamlet はメッセージデータ型で i18n をサポートします。それは概念・実装面において型安全URLとかなり類似しています。例として hello と言った後にりんごをいくつ購入したかを述べるアプリケーションを作りたいとしましょう。これらのメッセージをデータ型を使って以下のように表現します。</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb41-1"><a href="#cb41-1"></a><span class="kw">data</span> <span class="dt">Msg</span> <span class="ot">=</span> <span class="dt">Hello</span> <span class="op">|</span> <span class="dt">Apples</span> <span class="dt">Int</span></span></code></pre></div>
<p>次に、これを人間が読める形式に変換したいので、レンダリング関数をいくつか定義します。</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb42-1"><a href="#cb42-1"></a><span class="ot">renderEnglish ::</span> <span class="dt">Msg</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb42-2"><a href="#cb42-2"></a>renderEnglish <span class="dt">Hello</span> <span class="ot">=</span> <span class="st">&quot;Hello&quot;</span></span>
<span id="cb42-3"><a href="#cb42-3"></a>renderEnglish (<span class="dt">Apples</span> <span class="dv">0</span>) <span class="ot">=</span> <span class="st">&quot;You did not buy any apples.&quot;</span></span>
<span id="cb42-4"><a href="#cb42-4"></a>renderEnglish (<span class="dt">Apples</span> <span class="dv">1</span>) <span class="ot">=</span> <span class="st">&quot;You bought 1 apple.&quot;</span></span>
<span id="cb42-5"><a href="#cb42-5"></a>renderEnglish (<span class="dt">Apples</span> i) <span class="ot">=</span> T.concat [<span class="st">&quot;You bought &quot;</span>, T.pack <span class="op">$</span> <span class="fu">show</span> i, <span class="st">&quot; apples.&quot;</span>]</span></code></pre></div>
<p>そして Msg の値を直接テンプレート内で展開するためにアンダースコア展開を使います。</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode hamlet"><code class="sourceCode hamlet"><span id="cb43-1"><a href="#cb43-1"></a><span class="kw">$</span><span class="er">doctype</span> <span class="er">5</span></span>
<span id="cb43-2"><a href="#cb43-2"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb43-3"><a href="#cb43-3"></a>    <span class="kw">&lt;head&gt;</span></span>
<span id="cb43-4"><a href="#cb43-4"></a>        <span class="kw">&lt;title&gt;</span>i18n</span>
<span id="cb43-5"><a href="#cb43-5"></a>    <span class="kw">&lt;body&gt;</span></span>
<span id="cb43-6"><a href="#cb43-6"></a>        <span class="kw">&lt;h1&gt;_{</span><span class="dt">Hello</span><span class="kw">}</span></span>
<span id="cb43-7"><a href="#cb43-7"></a>        <span class="kw">&lt;p&gt;_{</span><span class="dt">Apples</span> count<span class="kw">}</span></span></code></pre></div>
<p>この種のテンプレートは、型安全URLをレンダリング関数に渡した時のように、これらの値を HTML に変換する何らかの方法を必要とします。</p>
<p>これを表現するために、新しい型シノニムを定義します。</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb44-1"><a href="#cb44-1"></a><span class="kw">type</span> <span class="dt">Render</span> url <span class="ot">=</span> url <span class="ot">-&gt;</span> [(<span class="dt">Text</span>, <span class="dt">Text</span>)] <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb44-2"><a href="#cb44-2"></a><span class="kw">type</span> <span class="dt">Translate</span> msg <span class="ot">=</span> msg <span class="ot">-&gt;</span> <span class="dt">Html</span></span>
<span id="cb44-3"><a href="#cb44-3"></a><span class="kw">type</span> <span class="dt">HtmlUrlI18n</span> msg url <span class="ot">=</span> <span class="dt">Translate</span> msg <span class="ot">-&gt;</span> <span class="dt">Render</span> url <span class="ot">-&gt;</span> <span class="dt">Html</span></span></code></pre></div>
<p>これによって <code>renderEnglish</code>、 <code>renderSpanish</code>、 <code>renderKlingon</code> をテンプレートに渡すことができ、それはうまく翻訳された出力を生成します (もちろん翻訳機の性能に依存します・・・)。 完全なプログラムは以下のようになります。</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb45-1"><a href="#cb45-1"></a><span class="ot">{-# LANGUAGE QuasiQuotes #-}</span></span>
<span id="cb45-2"><a href="#cb45-2"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb45-3"><a href="#cb45-3"></a><span class="kw">import</span> <span class="dt">Data.Text</span> (<span class="dt">Text</span>)</span>
<span id="cb45-4"><a href="#cb45-4"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">T</span></span>
<span id="cb45-5"><a href="#cb45-5"></a><span class="kw">import</span> <span class="dt">Text.Hamlet</span> (<span class="dt">HtmlUrlI18n</span>, ihamlet)</span>
<span id="cb45-6"><a href="#cb45-6"></a><span class="kw">import</span> <span class="dt">Text.Blaze.Html</span> (toHtml)</span>
<span id="cb45-7"><a href="#cb45-7"></a><span class="kw">import</span> <span class="dt">Text.Blaze.Html.Renderer.String</span> (renderHtml)</span>
<span id="cb45-8"><a href="#cb45-8"></a></span>
<span id="cb45-9"><a href="#cb45-9"></a><span class="kw">data</span> <span class="dt">MyRoute</span> <span class="ot">=</span> <span class="dt">Home</span> <span class="op">|</span> <span class="dt">Time</span> <span class="op">|</span> <span class="dt">Stylesheet</span></span>
<span id="cb45-10"><a href="#cb45-10"></a></span>
<span id="cb45-11"><a href="#cb45-11"></a><span class="ot">renderUrl ::</span> <span class="dt">MyRoute</span> <span class="ot">-&gt;</span> [(<span class="dt">Text</span>, <span class="dt">Text</span>)] <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb45-12"><a href="#cb45-12"></a>renderUrl <span class="dt">Home</span> _ <span class="ot">=</span> <span class="st">&quot;/home&quot;</span></span>
<span id="cb45-13"><a href="#cb45-13"></a>renderUrl <span class="dt">Time</span> _ <span class="ot">=</span> <span class="st">&quot;/time&quot;</span></span>
<span id="cb45-14"><a href="#cb45-14"></a>renderUrl <span class="dt">Stylesheet</span> _ <span class="ot">=</span> <span class="st">&quot;/style.css&quot;</span></span>
<span id="cb45-15"><a href="#cb45-15"></a></span>
<span id="cb45-16"><a href="#cb45-16"></a><span class="kw">data</span> <span class="dt">Msg</span> <span class="ot">=</span> <span class="dt">Hello</span> <span class="op">|</span> <span class="dt">Apples</span> <span class="dt">Int</span></span>
<span id="cb45-17"><a href="#cb45-17"></a></span>
<span id="cb45-18"><a href="#cb45-18"></a><span class="ot">renderEnglish ::</span> <span class="dt">Msg</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb45-19"><a href="#cb45-19"></a>renderEnglish <span class="dt">Hello</span> <span class="ot">=</span> <span class="st">&quot;Hello&quot;</span></span>
<span id="cb45-20"><a href="#cb45-20"></a>renderEnglish (<span class="dt">Apples</span> <span class="dv">0</span>) <span class="ot">=</span> <span class="st">&quot;You did not buy any apples.&quot;</span></span>
<span id="cb45-21"><a href="#cb45-21"></a>renderEnglish (<span class="dt">Apples</span> <span class="dv">1</span>) <span class="ot">=</span> <span class="st">&quot;You bought 1 apple.&quot;</span></span>
<span id="cb45-22"><a href="#cb45-22"></a>renderEnglish (<span class="dt">Apples</span> i) <span class="ot">=</span> T.concat [<span class="st">&quot;You bought &quot;</span>, T.pack <span class="op">$</span> <span class="fu">show</span> i, <span class="st">&quot; apples.&quot;</span>]</span>
<span id="cb45-23"><a href="#cb45-23"></a></span>
<span id="cb45-24"><a href="#cb45-24"></a><span class="ot">template ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">HtmlUrlI18n</span> <span class="dt">Msg</span> <span class="dt">MyRoute</span></span>
<span id="cb45-25"><a href="#cb45-25"></a>template count <span class="ot">=</span> [ihamlet|</span>
<span id="cb45-26"><a href="#cb45-26"></a>$doctype 5</span>
<span id="cb45-27"><a href="#cb45-27"></a>&lt;html&gt;</span>
<span id="cb45-28"><a href="#cb45-28"></a>    &lt;head&gt;</span>
<span id="cb45-29"><a href="#cb45-29"></a>        &lt;title&gt;i18n</span>
<span id="cb45-30"><a href="#cb45-30"></a>    &lt;body&gt;</span>
<span id="cb45-31"><a href="#cb45-31"></a>        &lt;h1&gt;_{Hello}</span>
<span id="cb45-32"><a href="#cb45-32"></a>        &lt;p&gt;_{Apples count}</span>
<span id="cb45-33"><a href="#cb45-33"></a>|]</span>
<span id="cb45-34"><a href="#cb45-34"></a></span>
<span id="cb45-35"><a href="#cb45-35"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb45-36"><a href="#cb45-36"></a>main <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="op">$</span> renderHtml</span>
<span id="cb45-37"><a href="#cb45-37"></a>     <span class="op">$</span> (template <span class="dv">5</span>) (toHtml <span class="op">.</span> renderEnglish) renderUrl</span></code></pre></div>
<h2 id="その他のシェイクスピア">その他のシェイクスピア</h2>
<p>HTML、CSS、Javascript の補助だけでなく、より一般的な利用用途がシェイクスピアには存在します。シェイクスピアのテキストは Ruby や Python のようにスクリプト言語で慣れているような展開された文字列を作るための簡単な方法を提供します。そのため、明らかにこのパッケージの利用用途は Yesod に限定されません。</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb46-1"><a href="#cb46-1"></a><span class="ot">{-# LANGUAGE QuasiQuotes, OverloadedStrings #-}</span></span>
<span id="cb46-2"><a href="#cb46-2"></a><span class="kw">import</span> <span class="dt">Text.Shakespeare.Text</span></span>
<span id="cb46-3"><a href="#cb46-3"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text.Lazy.IO</span> <span class="kw">as</span> <span class="dt">TLIO</span></span>
<span id="cb46-4"><a href="#cb46-4"></a><span class="kw">import</span> <span class="dt">Data.Text</span> (<span class="dt">Text</span>)</span>
<span id="cb46-5"><a href="#cb46-5"></a><span class="kw">import</span> <span class="dt">Control.Monad</span> (forM_)</span>
<span id="cb46-6"><a href="#cb46-6"></a></span>
<span id="cb46-7"><a href="#cb46-7"></a><span class="kw">data</span> <span class="dt">Item</span> <span class="ot">=</span> <span class="dt">Item</span></span>
<span id="cb46-8"><a href="#cb46-8"></a>    {<span class="ot"> itemName ::</span> <span class="dt">Text</span></span>
<span id="cb46-9"><a href="#cb46-9"></a>    ,<span class="ot"> itemQty ::</span> <span class="dt">Int</span></span>
<span id="cb46-10"><a href="#cb46-10"></a>    }</span>
<span id="cb46-11"><a href="#cb46-11"></a></span>
<span id="cb46-12"><a href="#cb46-12"></a><span class="ot">items ::</span> [<span class="dt">Item</span>]</span>
<span id="cb46-13"><a href="#cb46-13"></a>items <span class="ot">=</span></span>
<span id="cb46-14"><a href="#cb46-14"></a>    [ <span class="dt">Item</span> <span class="st">&quot;apples&quot;</span> <span class="dv">5</span></span>
<span id="cb46-15"><a href="#cb46-15"></a>    , <span class="dt">Item</span> <span class="st">&quot;bananas&quot;</span> <span class="dv">10</span></span>
<span id="cb46-16"><a href="#cb46-16"></a>    ]</span>
<span id="cb46-17"><a href="#cb46-17"></a></span>
<span id="cb46-18"><a href="#cb46-18"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb46-19"><a href="#cb46-19"></a>main <span class="ot">=</span> forM_ items <span class="op">$</span> \item <span class="ot">-&gt;</span> TLIO.putStrLn</span>
<span id="cb46-20"><a href="#cb46-20"></a>    [lt|You have #{show $ itemQty item} #{itemName item}.|]</span></code></pre></div>
<p>この単純な例におけるポイントを以下に挙げます。</p>
<ul>
<li>文字列を表すデータ型には <code>String</code>, 正格 <code>Text</code>, 遅延 <code>Text</code> があることに注意してください。それらは共に全てうまく機能します。</li>
<li>遅延テキストを生成したい場合は <code>lt</code> という名称の準クォートを使います。同様に <code>st</code> は正格テキストを生成します。</li>
<li>これらの準クォートには長い名称も存在します。 (<code>ltext</code> と <code>stext</code>)</li>
</ul>
<h2 id="一般的推奨事項">一般的推奨事項</h2>
<p>これは Yesod コミュニティからシェイクスピアを最大限に利用するための一般的なヒントです。</p>
<ul>
<li>実際のサイトにおいては外部ファイルを利用してください。ライブラリにおいては長くなり過ぎない限り、準クォートを利用しても良いです。</li>
<li>Patrick Briston 氏が非常に有益な <a href="https://github.com/pbrisbin/html-template-syntax">Vim code hilighter</a> をまとめあげました。</li>
<li>Hamlet タグは既存のタグの後に開始・終了タグを埋め込むのではなく、常に新たな行から始める必要があります。これに関する唯一の例外はまれに大きなテキストブロックにおいて出現する <code>&lt;i&gt;</code>、 <code>&lt;b&gt;</code> タグだけです。</li>
</ul>
<h2 id="本書のコード">本書のコード</h2>
<ul>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch04/Example01.hs">Example01.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch04/Example02.hs">Example02.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch04/Example03.hs">Example03.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch04/Example04.hs">Example04.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch04/Example05.hs">Example05.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch04/Example06.hs">Example06.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch04/Example07.hs">Example07.hs</a></li>
<li><a href="https://github.com/e-bigmoon/haskell-blog/tree/master/sample-code/yesod/ch04/Example08.hs">Example08.hs</a></li>
</ul>
      </article>

      <div class="pager">
      
      
      </div>

      <div class="row">
        <div class="col s6 offset-s6" style="position: relative; height: 100px;">
          <div class="fixed-action-btn horizontal" style="position: absolute; display: inline-block; right: 24px;">
  <a class="btn-floating btn-large red">
    <i class="large material-icons">share</i>
  </a>
  <ul>
    <li>
      <a class="btn-floating waves-effect waves-light blue tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Twitter" href="https://twitter.com/intent/tweet?text=シェイクスピア テンプレート&url=https://haskell.e-bigmoon.com/yesod/book/ch04-shakespearen-templates.html"><i class="mdi mdi-twitter white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light indigo tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Facebook" href="https://facebook.com/sharer.php?u=https://haskell.e-bigmoon.com/yesod/book/ch04-shakespearen-templates.html"><i class="mdi mdi-facebook white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light red tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Google+" href="https://plus.google.com/share?url=https://haskell.e-bigmoon.com/yesod/book/ch04-shakespearen-templates.html"><i class="mdi mdi-google-plus white-text"></i></a>
    </li>
  </ul>
</div>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
    </div>

    <footer class="page-footer indigo lighten-1">

  <div class="footer-copyright">

    <div class="container">
      © 2017-2019 BIGMOON&nbsp;
      Site proudly generated by <a class="red-text text-accent-1" href="http://jaspervdj.be/hakyll">Hakyll</a>,&nbsp;
      original Jekyll theme by <a class="red-text text-accent-1" href="https://github.com/mumuxme/materialize-jekyll">mumuxme</a>.
    </div>

  </div>

</footer>


    <!-- scrolltop button -->
    <button class="material-scrolltop waves-effect waves-light hide-on-small-only" type="button">
      <i class="mdi mdi-arrow-up-bold small white-text"></i>
    </button>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-19322672-9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-19322672-9');
    </script>

    <!-- jquery -->
    <script type="text/javascript" src="../../lib/jquery-min.js"></script>
    <!-- materialize -->
    <script src="../../lib/materialize/js/materialize.min.js"></script>
    <!-- <\!-- Material ScrollTop plugin -\-> -->
    <script src="../../lib/material-scrolltop/material-scrolltop.js"></script>
    <!-- main -->
    <script src="../../js/init.js"></script>
    <script src="../../js/main.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/haskell.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/yaml.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/shell.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/bash.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>

</html>
