<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">

  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
  <!-- MUST in hex format, may the same as header-color. This color is for android chrome browser. -->
  <meta name="theme-color" content="#5c6bc0">

  <!-- Metadata. -->
  <meta name="keywords" content="haskell,blog,bigmoon" />
  <title>Liquid Haskell</title>
  <meta name="description" content="はじめに
Liquid Haskell で少しハマったのでメモとして残しておきます。
本来なら先に仕様を書いて実装を書くべきだと思いますが、今回の例は既存のコードにリファインメント型をつけるような場合を想定しています。
$ liquid
LiquidHaskell Version 0.8.2.4, Git revisi">
  <link rel="canonical" href="../../posts/2018/03-01-liquidhaskell.html">
  <link rel="alternate" type="application/atom+xml" title="Liquid Haskell" href="../../feed.xml" />
  <link rel="shortcut icon" href="../../images/favicon.ico" />
  <meta name="google-site-verification" content="X2YNboLvzw3_bclXLMvohyJDqj68D06_hPDMukRbgTs" />

  <!-- Stylesheets. -->
  <link rel="stylesheet" href="../../lib/materialize/css/materialize.min.css" />
  <link rel="stylesheet" href="../../css/main.css" />
  <link media="all" rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/3.3.92/css/materialdesignicons.min.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="../../lib/material-scrolltop/material-scrolltop.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" />

  <!-- OGP -->
  <meta property="og:title" content="Liquid Haskell" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="/posts/2018/03-01-liquidhaskell.html" />
  <!-- <meta property="og:image" content=" サムネイル画像の URL" /> -->
  <meta property="og:site_name" content="Liquid Haskell" />
  <meta property="og:description" content="はじめに
Liquid Haskell で少しハマったのでメモとして残しておきます。
本来なら先に仕様を書いて実装を書くべきだと思いますが、今回の例は既存のコードにリファインメント型をつけるような場合を想定しています。
$ liquid
LiquidHaskell Version 0.8.2.4, Git revisi" />

  <meta name="twitter:card" content="summary" />
  <!-- <meta name="twitter:site" content="@[ Twitter ID]" /> -->
  <!-- <meta name="twitter:player" content="@[ Twitter ID]" /> -->

  <noscript>
  <div class="notice-warning noscript">You don't have javascript enabled. Good luck! :(</div>
</noscript>

<!--[if IE]>
  <div class="notice-warning">Oh, you are using Internet Explorer! Good luck... :(</div>
<![endif]-->

</head>


  <body>
    <header class="site-header">
      <nav class="nav-extended indigo lighten-1">
        <div class="nav-wrapper">
  <a href="../../"><span class="site-title">BIGMOON Haskeller's BLOG</span></a>
  <a href="#" data-activates="mobile-navbar" class="button-collapse">
    <i class="mdi mdi-menu white-text"></i>
  </a>

  <ul id="nav-mobile" class="right hide-on-med-and-down">
    <li>
      <a href="../../" class="white-text">
        <i class="mdi mdi-home left indigo-text text-lighten-3"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="white-text">
        <i class="mdi mdi-account-circle left indigo-text text-lighten-3"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../stack/" class="white-text">
        <i class="mdi mdi-wrench left indigo-text text-lighten-3"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/index.html" class="white-text">
        <i class="mdi mdi-comment-question-outline left indigo-text text-lighten-3"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="white-text">
        <i class="mdi mdi-package-variant left indigo-text text-lighten-3"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="white-text">
        <i class="mdi mdi-earth left indigo-text text-lighten-3"></i>
        Yesod
      </a>
    </li>
    <li>
      <a href="../../contact.html" class="white-text">
        <i class="mdi mdi-lead-pencil left indigo-text text-lighten-3"></i>
        Contact
      </a>
    </li>
    <li>
      <a href="../../feed.xml" class="white-text">
        <i class="mdi mdi-rss left indigo-text text-lighten-3"></i>
        Feed
      </a>
    </li>
  </ul>

  <ul class="side-nav" id="mobile-navbar">
    <li>
      <a href="../../" class="waves-effect waves-teal black-text">
        <i class="mdi mdi-home left green-text"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="navbar-text-colour-mobile">
        <i class="mdi mdi-account-circle left blue-text"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../stack/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-wrench left blue-text"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-comment-question-outline left blue-text"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-package-variant left blue-text"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-earth left blue-text"></i>
        Yesod
      </a>
    </li>
    <li>
      <a href="../../contact.html" class="navbar-text-colour-mobile">
        <i class="mdi mdi-lead-pencil left blue-text"></i>
        Contact
      </a>
    </li>
  </ul>
</div>

      </nav>
    </header>

    <div class="site-container" id="tab-main">
      <div class="wrapper">
        <div class="post-ribbon"></div>

<div class="container post-container">
  <div class="post-page card-panel z-depth-2">
    <div class="post-section">

      <p class="grey-text">
        <i class="mdi mdi-calendar"></i>&nbsp;
        Posted on March  1, 2018
        
        
          &nbsp;&nbsp;<i class="mdi mdi-account-circle"></i>&nbsp;
          authored by Shinya Yamaguchi
        
        &nbsp;
        
          <i class="mdi mdi-folder"></i>&nbsp;
          <span class="capitalize"></span>
          <!-- &emsp;<i class="mdi mdi-refresh"></i>&nbsp;UPDATE: {% if page.update %}{{ page.update | date: "%b %-d, %Y" }}{% else %}{{ page.last_modified_at | date: "%b %-d, %Y" }}{% endif %} -->
        
      </p>

      <div class="post-header">
        <h1 class="post-title">Liquid Haskell</h1>

        <div class="row">
        
          <div class="col s6">
            <i class="post-tag mdi mdi-tag-multiple waves-effect waves-light"></i>
            <div class="chip"><a href="../../tags/bigmoon.html">bigmoon</a>, <a href="../../tags/liquidhaskell.html">liquidhaskell</a></div>
          </div>
        

          <div class="col s6">
            <div style="position: relative; top: 70px;">
            <div class="fixed-action-btn horizontal" style="position: absolute; display: inline-block; right: 24px;">
  <a class="btn-floating btn-large red">
    <i class="large material-icons">share</i>
  </a>
  <ul>
    <li>
      <a class="btn-floating waves-effect waves-light blue tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Twitter" href="https://twitter.com/intent/tweet?text=Liquid Haskell&url=https://haskell.e-bigmoon.com/posts/2018/03-01-liquidhaskell.html"><i class="mdi mdi-twitter white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light indigo tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Facebook" href="https://facebook.com/sharer.php?u=https://haskell.e-bigmoon.com/posts/2018/03-01-liquidhaskell.html"><i class="mdi mdi-facebook white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light red tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Google+" href="https://plus.google.com/share?url=https://haskell.e-bigmoon.com/posts/2018/03-01-liquidhaskell.html"><i class="mdi mdi-google-plus white-text"></i></a>
    </li>
  </ul>
</div>
            </div>
          </div>
        </div>
      </div>

      <article class="post-content">
        <h2 id="はじめに">はじめに</h2>
<p>Liquid Haskell で少しハマったのでメモとして残しておきます。</p>
<p>本来なら先に仕様を書いて実装を書くべきだと思いますが、今回の例は既存のコードにリファインメント型をつけるような場合を想定しています。</p>
<pre class="shell"><code>$ liquid
LiquidHaskell Version 0.8.2.4, Git revision d641244775cd842776cecf2c5d3e9afa01549e76 (dirty)
Copyright 2013-18 Regents of the University of California. All Rights Reserved.</code></pre>
<p>Liquid Haskell を気になってる人向けの記事です。</p>
<!--more-->
<h2 id="やりたいこと">やりたいこと</h2>
<p>データの挿入と更新操作を次のような型で表現します。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">data</span> <span class="dt">Operation</span> <span class="ot">=</span> <span class="dt">Insert</span> <span class="op">|</span> <span class="dt">Update</span></a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="kw">deriving</span> <span class="dt">Eq</span></a></code></pre></div>
<p>上記のデータ型を使って、次のような関数を定義します。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1"><span class="ot">adjustBound ::</span> <span class="dt">Operation</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb3-2" title="2">adjustBound op lower upper n <span class="op">|</span> isInsert op <span class="ot">=</span> upper <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb3-3" title="3">                             <span class="op">|</span> <span class="fu">otherwise</span>   <span class="ot">=</span> lower <span class="ot">`max`</span> (n <span class="ot">`min`</span> upper)</a>
<a class="sourceLine" id="cb3-4" title="4"></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="ot">isInsert ::</span> <span class="dt">Operation</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb3-6" title="6">isInsert <span class="dt">Insert</span> <span class="ot">=</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb3-7" title="7">isInsert _      <span class="ot">=</span> <span class="dt">False</span></a></code></pre></div>
<p><code>adjustBound</code> 関数は以下のように動作します。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1"><span class="op">&gt;</span> adjustBound <span class="dt">Insert</span> <span class="dv">0</span> <span class="dv">10</span> <span class="dv">5</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="dv">11</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="op">&gt;</span> adjustBound <span class="dt">Insert</span> <span class="dv">0</span> <span class="dv">10</span> <span class="dv">100</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="dv">11</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="op">&gt;</span> adjustBound <span class="dt">Insert</span> <span class="dv">0</span> <span class="dv">10</span> (<span class="op">-</span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb4-6" title="6"><span class="dv">11</span></a>
<a class="sourceLine" id="cb4-7" title="7"></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="op">&gt;</span> adjustBound <span class="dt">Update</span> <span class="dv">0</span> <span class="dv">10</span> <span class="dv">5</span></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="dv">5</span></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="op">&gt;</span> adjustBound <span class="dt">Update</span> <span class="dv">0</span> <span class="dv">10</span> <span class="dv">100</span></a>
<a class="sourceLine" id="cb4-11" title="11"><span class="dv">10</span></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="op">&gt;</span> adjustBound <span class="dt">Update</span> <span class="dv">0</span> <span class="dv">10</span> (<span class="op">-</span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb4-13" title="13"><span class="dv">0</span></a></code></pre></div>
<p><code>adjustBound</code> のような関数でバグが無いことを確認するためには何をしたら良いでしょうか？</p>
<p>型は非常に強力ですが、値について何も教えてくれません。</p>
<h2 id="バグの少ない世界を目指して">バグの少ない世界を目指して</h2>
<p>僕が Haskell を使う理由は、第一に <code>楽しい</code> からです。そのため、「勉強しても就職する時に役に立たないでしょ？」などと言われても全く気になりません。(そもそも、就職するために勉強するわけじゃないですよね)</p>
<p>また Haskell を使えば、正しいソフトウェアを普通に作ることができます。また、<code>hspec</code> などで単体テストを書いたり、<code>QuichCheck</code> などでランダムテストを書くことで、過去に起こった問題を再発させないようにする努力や、バグを少なくするための取り組みが行われています。</p>
<p>しかしながら、個人的にはどれもまだ不安です。もしかしたら、チェックしてない部分にバグがあるんじゃないの・・・？</p>
<p>そんな心配性の方は <code>Liquid Haskell (LH)</code> を使いましょう！</p>
<h2 id="型をより厳しく">型をより厳しく</h2>
<p>最初に定義した <code>Operation</code> 型と <code>adjustBound</code> を再掲します。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" title="1"><span class="co">-- LH.hs</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="kw">module</span> <span class="dt">LH</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb5-3" title="3"></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="kw">data</span> <span class="dt">Operation</span> <span class="ot">=</span> <span class="dt">Insert</span> <span class="op">|</span> <span class="dt">Update</span></a>
<a class="sourceLine" id="cb5-5" title="5">  <span class="kw">deriving</span> <span class="dt">Eq</span></a>
<a class="sourceLine" id="cb5-6" title="6"></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="ot">adjustBound ::</span> <span class="dt">Operation</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb5-8" title="8">adjustBound op lower upper n <span class="op">|</span> isInsert op <span class="ot">=</span> upper <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb5-9" title="9">                             <span class="op">|</span> <span class="fu">otherwise</span>   <span class="ot">=</span> lower <span class="ot">`max`</span> (n <span class="ot">`min`</span> upper)</a>
<a class="sourceLine" id="cb5-10" title="10"></a>
<a class="sourceLine" id="cb5-11" title="11"><span class="ot">isInsert ::</span> <span class="dt">Operation</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb5-12" title="12">isInsert <span class="dt">Insert</span> <span class="ot">=</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb5-13" title="13">isInsert _      <span class="ot">=</span> <span class="dt">False</span></a></code></pre></div>
<p>とりあえず、現在のコードを <code>LH</code> にかけてみます。</p>
<pre class="shell"><code>$ liquid LH.hs
LiquidHaskell Version 0.8.2.4, Git revision d641244775cd842776cecf2c5d3e9afa01549e76 (dirty)
Copyright 2013-18 Regents of the University of California. All Rights Reserved.


**** DONE:  A-Normalization ****************************************************


**** DONE:  Extracted Core using GHC *******************************************


**** DONE:  Transformed Core ***************************************************

Working 100% [=================================================================]

**** DONE:  annotate ***********************************************************


**** RESULT: SAFE **************************************************************</code></pre>
<p><code>RESULT: SAFE</code> が表示されれば問題ありません！</p>
<h3 id="入力を自然数に限定させよう">入力を自然数に限定させよう</h3>
<p>例えば <code>lower</code> と <code>upper</code> が自然数 (0含む) しか許容しないという仕様が与えられた時、どうしますか？</p>
<p>よくある対応としては、コメントにその旨を書いたり、テストを作ったりという作業になるでしょう。</p>
<p><code>Liquid Haskell</code> では上記の仕様を <code>事前条件</code> として記述することができます。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" title="1"><span class="co">{-@ adjustBound :: _ -&gt; Nat -&gt; Nat -&gt; _ -&gt; _ @-}</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="ot">adjustBound ::</span> <span class="dt">Operation</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb7-3" title="3">adjustBound op lower upper n <span class="op">|</span> isInsert op <span class="ot">=</span> upper <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb7-4" title="4">                             <span class="op">|</span> <span class="fu">otherwise</span>   <span class="ot">=</span> lower <span class="ot">`max`</span> (n <span class="ot">`min`</span> upper)</a></code></pre></div>
<p><code>Nat</code> は <a href="https://github.com/ucsd-progsys/liquidhaskell/blob/develop/include/Prelude.spec">Prelude</a> で以下のように定義されています。つまり、0以上の <code>Int</code> のみを含むリファインメント型です。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" title="1"><span class="co">{-@ type Nat = {v: Int | v &gt;= 0 } @-}</span></a></code></pre></div>
<p>これだけです。<code>LH</code> で結果を確かめてみましょう。</p>
<pre class="shell"><code>$ liquid LH.hs
...

**** RESULT: SAFE **************************************************************</code></pre>
<p><code>SAFE</code> ですね！</p>
<p>これでもう <code>adjustBound</code> の <code>lower</code> と <code>upper</code> は <code>0</code> 以上の自然数でしか呼び出されていないことが示されました。</p>
<h3 id="もう少し具体例">もう少し具体例</h3>
<p>では、別のプログラマが <code>adjustBound</code> を利用した関数を作ったとしましょう。この関数自体に意味はないですが、<code>LH</code> を理解するためにはとても良い例だと思います。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" title="1"><span class="ot">f ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb10-2" title="2">f <span class="ot">=</span> adjustBound <span class="dt">Insert</span> (<span class="op">-</span><span class="dv">100</span>) (<span class="op">-</span><span class="dv">50</span>) (<span class="op">-</span><span class="dv">70</span>)</a></code></pre></div>
<p>この関数 <code>f</code> は、型が正しいため当然コンパイルできます。</p>
<pre class="shell"><code>$ stack repl -- LH.hs
&gt; f
-49</code></pre>
<p>けれども、僕らの仕様では <code>adjustBound</code> の <code>lower</code> と <code>upper</code> には自然数しか適用してはいけないはずです。</p>
<p>次に <code>LH</code> を実行してみましょう。</p>
<pre class="shell"><code>$ liquid LH.hs
**** RESULT: UNSAFE ************************************************************


 LH.hs:18:25-28: Error: Liquid Type Mismatch

 18 | f = adjustBound Insert (-100) (-50) (-70)
                              ^^^^


   Inferred type
    VV : {v : Int | v == (-?a)
                    &amp;&amp; v == ?b}

  not a subtype of Required type
    VV : {VV : Int | VV &gt;= 0}

  In Context
    ?b : {?b : Int | ?b == (-?a)}

    ?a : {?a : Int | ?a == (100 : int)}


 LH.hs:18:32-34: Error: Liquid Type Mismatch

 18 | f = adjustBound Insert (-100) (-50) (-70)
                                     ^^^


   Inferred type
    VV : {v : Int | v == (-?b)
                    &amp;&amp; v == ?a}

  not a subtype of Required type
    VV : {VV : Int | VV &gt;= 0}

  In Context
    ?b : {?b : Int | ?b == (50 : int)}

    ?a : {?a : Int | ?a == (-?b)}</code></pre>
<p><code>UNSAFE</code> になりましたね。こういうことです。</p>
<p>つまり、<strong>自分たちが使っている範囲</strong>で <code>Liquid Haskell</code> のリファインメント型について、正しく整合性が取れているのかということを判定しています。</p>
<h3 id="戻り値の型も厳しくしよう">戻り値の型も厳しくしよう！</h3>
<p>先程、事前条件についてリファインメント型を書きました。</p>
<p>次は事後条件についてリファインメントを書きましょう！</p>
<p>同様に戻り値の型も自然数という仕様にします。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" title="1"><span class="co">{-@ adjustBound :: _ -&gt; Nat -&gt; Nat -&gt; _ -&gt; Nat @-}</span></a>
<a class="sourceLine" id="cb13-2" title="2"><span class="ot">adjustBound ::</span> <span class="dt">Operation</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb13-3" title="3">adjustBound op lower upper n <span class="op">|</span> isInsert op <span class="ot">=</span> upper <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb13-4" title="4">                             <span class="op">|</span> <span class="fu">otherwise</span>   <span class="ot">=</span> lower <span class="ot">`max`</span> (n <span class="ot">`min`</span> upper)</a></code></pre></div>
<pre class="shell"><code>$ liquid LH.hs
**** RESULT: SAFE **************************************************************</code></pre>
<p>リファインメント型 (Refinement type) は <code>篩 (ふるい) 型</code> と訳されている本 (<a href="https://taimen.jp/f/389">入門LiquidHaskell−篩型による静的コード解析−</a>) もありますが、それは <code>Haskell</code> の型の値が条件によって <code>ふるい</code> 落とされて、新しい型 (リファインメント型) になっているというイメージから来ているのだと思います。(読んだこと無いので間違ってたらすみません・・・。)</p>
<p>追記: チェシャ猫さんから <code>篩型</code> について教えてもらいました！</p>
<blockquote class="twitter-tweet" data-lang="ja">
<p lang="ja" dir="ltr">
&gt; リファインメント型 (Refinement type) は 篩 (ふるい) 型 と訳されている本もありますが<br><br>頒布したときに最も多かった質問は「これ何て読むんですか？」だった。ちなみに「篩型」はこの本で勝手に作った造語ではなく、論文タイトルなどにも使われています。<a href="https://t.co/Du6mK1hqdD">https://t.co/Du6mK1hqdD</a>
</p>
— チェシャ猫 (<span class="citation" data-cites="y_taka_23">@y_taka_23</span>) <a href="https://twitter.com/y_taka_23/status/969499842895495168?ref_src=twsrc%5Etfw">2018年3月2日</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-lang="ja">
<p lang="ja" dir="ltr">
五十嵐先生と末永先生が発案した訳語のようです。 <a href="https://t.co/rcZuFuptl6">https://t.co/rcZuFuptl6</a>
</p>
— チェシャ猫 (<span class="citation" data-cites="y_taka_23">@y_taka_23</span>) <a href="https://twitter.com/y_taka_23/status/969515905737621506?ref_src=twsrc%5Etfw">2018年3月2日</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<h2 id="もっと仕様を">もっと仕様を</h2>
<p><code>adjustBound</code> 関数はこれで十分なのでしょうか？人によっては十分だね。と答えるかもしれません。</p>
<p>しかし、今回は次のような仕様を与えることにします。</p>
<ol type="1">
<li><code>upper</code> は <code>lower</code> 以上の自然数</li>
<li><code>Insert</code> の操作の場合の戻り値は <code>lower</code> 〜 <code>upper + 1</code> の間の自然数</li>
<li><code>Update</code> の操作の場合の戻り値は <code>lower</code> 〜 <code>lower `max` (n `min` upper)</code> の間の自然数</li>
</ol>
<p>ここからが面白いところです。</p>
<p>まずは前準備として <code>x 〜 y</code> までの間の自然数を表すリファインメント型と述語を定義します。</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" title="1"><span class="co">{-@ type Btwn Lo Hi = {v:Int | Lo &lt;= v &amp;&amp; v &lt;= Hi} @-}</span></a>
<a class="sourceLine" id="cb15-2" title="2"><span class="co">{-@ predicate BtwnP Lo Hi = Lo &lt;= v &amp;&amp; v &lt;= Hi @-}</span></a></code></pre></div>
<p>では、<code>仕様1</code>を反映させてみましょう。</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb16-1" title="1"><span class="co">{-@ adjustBound :: _ -&gt; l:Nat -&gt; {u:Nat | l &lt;= u} -&gt; _ -&gt; Nat @-}</span></a>
<a class="sourceLine" id="cb16-2" title="2"><span class="ot">adjustBound ::</span> <span class="dt">Operation</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb16-3" title="3">adjustBound op lower upper n <span class="op">|</span> isInsert op <span class="ot">=</span> upper <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb16-4" title="4">                             <span class="op">|</span> <span class="fu">otherwise</span>   <span class="ot">=</span> lower <span class="ot">`max`</span> (n <span class="ot">`min`</span> upper)</a></code></pre></div>
<pre class="shell"><code>$ liquid LH.hs
**** RESULT: SAFE **************************************************************</code></pre>
<p>では次に、<code>仕様2</code> と <code>仕様3</code> です。</p>
<p>リファインメント型は以下のようになります。</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb18-1" title="1"><span class="co">{-@ adjustBound ::</span></a>
<a class="sourceLine" id="cb18-2" title="2"><span class="co">      op:Operation -&gt;</span></a>
<a class="sourceLine" id="cb18-3" title="3"><span class="co">      l:Nat -&gt;</span></a>
<a class="sourceLine" id="cb18-4" title="4"><span class="co">      {u:Nat | l &lt;= u} -&gt;</span></a>
<a class="sourceLine" id="cb18-5" title="5"><span class="co">      _ -&gt;</span></a>
<a class="sourceLine" id="cb18-6" title="6"><span class="co">      {v:Nat | if (isInsert op) then (BtwnP l (u+1)) else BtwnP l u }</span></a>
<a class="sourceLine" id="cb18-7" title="7"><span class="co">@-}</span></a>
<a class="sourceLine" id="cb18-8" title="8"><span class="ot">adjustBound ::</span> <span class="dt">Operation</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb18-9" title="9">adjustBound op lower upper n <span class="op">|</span> isInsert op <span class="ot">=</span> upper <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb18-10" title="10">                             <span class="op">|</span> <span class="fu">otherwise</span>   <span class="ot">=</span> lower <span class="ot">`max`</span> (n <span class="ot">`min`</span> upper)</a>
<a class="sourceLine" id="cb18-11" title="11"></a>
<a class="sourceLine" id="cb18-12" title="12"><span class="co">{-@ measure isInsert @-}</span></a>
<a class="sourceLine" id="cb18-13" title="13"><span class="ot">isInsert ::</span> <span class="dt">Operation</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb18-14" title="14">isInsert <span class="dt">Insert</span> <span class="ot">=</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb18-15" title="15">isInsert _      <span class="ot">=</span> <span class="dt">False</span></a></code></pre></div>
<pre class="shell"><code>$ liquid LH.hs
**** RESULT: SAFE **************************************************************</code></pre>
<h2 id="はまったポイント">はまったポイント</h2>
<p><code>if (isInsert op) then (BtwnP l (u+1)) else BtwnP l u</code> の部分でかなりはまりました。</p>
<p>例えば <code>if</code> の括弧を外した場合は次のようなエラーになります。</p>
<p><code>if isInsert op then (BtwnP l (u+1)) else BtwnP l u</code></p>
<pre class="shell"><code>**** RESULT: ERROR *************************************************************


 LH.hs:10:73: Error: Cannot parse specification:

 10 | {-@ adjustBound :: op:Operation -&gt; l:Nat -&gt; {u:Nat | l &lt;= u}  -&gt; _ -&gt; {v:Nat | if isInsert op then (BtwnP l (u+1)) else BtwnP l u } @-}
                                                                              ^

     unexpected &quot;:&quot;
     expecting operator, white space or &quot;}&quot;</code></pre>
<p>また、同様に <code>then</code> の括弧を外してもエラーになります。</p>
<p><code>if (isInsert op) then BtwnP l (u+1) else BtwnP l u</code></p>
<pre class="shell"><code>**** RESULT: ERROR *************************************************************


 LH.hs:10:73: Error: Cannot parse specification:

 10 | {-@ adjustBound :: op:Operation -&gt; l:Nat -&gt; {u:Nat | l &lt;= u}  -&gt; _ -&gt; {v:Nat | if (isInsert op) then BtwnP l (u+1) else BtwnP l u } @-}
                                                                              ^

     unexpected &quot;:&quot;
     expecting operator, white space or &quot;}&quot;</code></pre>
<p><code>else</code> については括弧があっても無くても <code>SAFE</code> です。</p>
<p>この挙動が本当にわからなくてつらかったです・・・。</p>
<p>ちなみに、以下のような場合も同様にはまるので、ご注意ください。</p>
<pre><code>-- UNSAFE
{-@ adjustBound :: _ -&gt; l:Nat -&gt; {u:Nat | l &lt;= u}  -&gt; _ -&gt; Btwn l (u+1) @-}
{-@ adjustBound :: _ -&gt; l:Nat -&gt; {u:Nat | l &lt;= u}  -&gt; _ -&gt; Btwn l {u+1} @-}

-- SAFE
{-@ adjustBound :: _ -&gt; l:Nat -&gt; {u:Nat | l &lt;= u}  -&gt; _ -&gt; Btwn {l} {u+1} @-}</code></pre>
<h2 id="まとめ">まとめ</h2>
<ul>
<li><code>if</code> を使う場合は多めに括弧を付けておいた方が良さそう。</li>
<li><code>{}</code> で囲むと上手くいく場合もある</li>
<li><code>LiquidHaskell</code> はすごい</li>
</ul>
<p>この良くわからない挙動について一緒に考えてくれた友人の tkg さんありがとうございました。</p>
<p>以上です。</p>
      </article>

      <div class="row pager">
        <div class="col s6">
          
            <a class="waves-effect waves-light btn white-text left prev" href="../../posts/2018/02-26-Announcing-the-debug-package.html"><i class="material-icons left">navigate_before</i>debug パッケージのアナウンス (翻訳)</a>
          
        </div>
        <div class="col s6">
          
            <a class="waves-effect waves-light btn white-text right next" href="../../posts/2018/03-03-liquidhaskell-intro.html">Liquid Haskell のインストールと学習方法<i class="material-icons right">navigate_next</i></a>
          
        </div>
      </div>

      <div class="row">
        <div class="col s6 offset-s6" style="position: relative; height: 100px;">
          <div class="fixed-action-btn horizontal" style="position: absolute; display: inline-block; right: 24px;">
  <a class="btn-floating btn-large red">
    <i class="large material-icons">share</i>
  </a>
  <ul>
    <li>
      <a class="btn-floating waves-effect waves-light blue tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Twitter" href="https://twitter.com/intent/tweet?text=Liquid Haskell&url=https://haskell.e-bigmoon.com/posts/2018/03-01-liquidhaskell.html"><i class="mdi mdi-twitter white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light indigo tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Facebook" href="https://facebook.com/sharer.php?u=https://haskell.e-bigmoon.com/posts/2018/03-01-liquidhaskell.html"><i class="mdi mdi-facebook white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light red tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Google+" href="https://plus.google.com/share?url=https://haskell.e-bigmoon.com/posts/2018/03-01-liquidhaskell.html"><i class="mdi mdi-google-plus white-text"></i></a>
    </li>
  </ul>
</div>
        </div>
      </div>

    </div>
  </div>

  <!-- {% if page.mathjax %} -->
  <!--   {% include mathjax_support.html %} -->
  <!-- {% endif %} -->

</div>

      </div>
    </div>

    <footer class="page-footer indigo lighten-1">

  <div class="footer-copyright">

    <div class="container">
      © 2017-2019 BIGMOON&nbsp;
      Site proudly generated by <a class="red-text text-accent-1" href="http://jaspervdj.be/hakyll">Hakyll</a>,&nbsp;
      original Jekyll theme by <a class="red-text text-accent-1" href="https://github.com/mumuxme/materialize-jekyll">mumuxme</a>.
    </div>

  </div>

</footer>


    <!-- scrolltop button -->
    <button class="material-scrolltop waves-effect waves-light hide-on-small-only" type="button">
      <i class="mdi mdi-arrow-up-bold small white-text"></i>
    </button>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-19322672-9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-19322672-9');
    </script>

    <!-- jquery -->
    <script type="text/javascript" src="../../lib/jquery-min.js"></script>
    <!-- materialize -->
    <script src="../../lib/materialize/js/materialize.min.js"></script>
    <!-- <\!-- Material ScrollTop plugin -\-> -->
    <script src="../../lib/material-scrolltop/material-scrolltop.js"></script>
    <!-- main -->
    <script src="../../js/init.js"></script>
    <script src="../../js/main.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>

</html>
