<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">

  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
  <!-- MUST in hex format, may the same as header-color. This color is for android chrome browser. -->
  <meta name="theme-color" content="#5c6bc0">

  <!-- Metadata. -->
  <meta name="keywords" content="haskell,blog,bigmoon" />
  <title>stack 1.6.5 がリリースされました。</title>
  <meta name="description" content="はじめに
先日 Stack version 1.6.5 がリリースされました。
バグフィックスのみです。
いくつか前回の 1.6.3 に含まれていた内容が 1.6.5 に移動してますね。">
  <link rel="canonical" href="../../posts/2018/02-21-stack165.html">
  <link rel="alternate" type="application/atom+xml" title="stack 1.6.5 がリリースされました。" href="../../feed.xml" />
  <link rel="shortcut icon" href="../../images/favicon.ico" />
  <meta name="google-site-verification" content="X2YNboLvzw3_bclXLMvohyJDqj68D06_hPDMukRbgTs" />

  <!-- Stylesheets. -->
  <link rel="stylesheet" href="../../lib/materialize/css/materialize.min.css" />
  <link rel="stylesheet" href="../../css/main.css" />
  <link media="all" rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/3.3.92/css/materialdesignicons.min.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="../../lib/material-scrolltop/material-scrolltop.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" />

  <!-- OGP -->
  <meta property="og:title" content="stack 1.6.5 がリリースされました。" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="/posts/2018/02-21-stack165.html" />
  <!-- <meta property="og:image" content=" サムネイル画像の URL" /> -->
  <meta property="og:site_name" content="stack 1.6.5 がリリースされました。" />
  <meta property="og:description" content="はじめに
先日 Stack version 1.6.5 がリリースされました。
バグフィックスのみです。
いくつか前回の 1.6.3 に含まれていた内容が 1.6.5 に移動してますね。" />

  <meta name="twitter:card" content="summary" />
  <!-- <meta name="twitter:site" content="@[ Twitter ID]" /> -->
  <!-- <meta name="twitter:player" content="@[ Twitter ID]" /> -->

  <noscript>
  <div class="notice-warning noscript">You don't have javascript enabled. Good luck! :(</div>
</noscript>

<!--[if IE]>
  <div class="notice-warning">Oh, you are using Internet Explorer! Good luck... :(</div>
<![endif]-->

</head>


  <body>
    <header class="site-header">
      <nav class="nav-extended indigo lighten-1">
        <div class="nav-wrapper">
  <a href="../../"><span class="site-title">BIGMOON Haskeller's BLOG</span></a>
  <a href="#" data-activates="mobile-navbar" class="button-collapse">
    <i class="mdi mdi-menu white-text"></i>
  </a>

  <ul id="nav-mobile" class="right hide-on-med-and-down">
    <li>
      <a href="../../" class="white-text">
        <i class="mdi mdi-home left indigo-text text-lighten-3"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="white-text">
        <i class="mdi mdi-account-circle left indigo-text text-lighten-3"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../stack/" class="white-text">
        <i class="mdi mdi-wrench left indigo-text text-lighten-3"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/index.html" class="white-text">
        <i class="mdi mdi-comment-question-outline left indigo-text text-lighten-3"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="white-text">
        <i class="mdi mdi-package-variant left indigo-text text-lighten-3"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="white-text">
        <i class="mdi mdi-earth left indigo-text text-lighten-3"></i>
        Yesod
      </a>
    </li>
    <li>
      <a href="../../contact.html" class="white-text">
        <i class="mdi mdi-lead-pencil left indigo-text text-lighten-3"></i>
        Contact
      </a>
    </li>
    <li>
      <a href="../../feed.xml" class="white-text">
        <i class="mdi mdi-rss left indigo-text text-lighten-3"></i>
        Feed
      </a>
    </li>
  </ul>

  <ul class="side-nav" id="mobile-navbar">
    <li>
      <a href="../../" class="waves-effect waves-teal black-text">
        <i class="mdi mdi-home left green-text"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="navbar-text-colour-mobile">
        <i class="mdi mdi-account-circle left blue-text"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../stack/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-wrench left blue-text"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-comment-question-outline left blue-text"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-package-variant left blue-text"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-earth left blue-text"></i>
        Yesod
      </a>
    </li>
    <li>
      <a href="../../contact.html" class="navbar-text-colour-mobile">
        <i class="mdi mdi-lead-pencil left blue-text"></i>
        Contact
      </a>
    </li>
  </ul>
</div>

      </nav>
    </header>

    <div class="site-container" id="tab-main">
      <div class="wrapper">
        <div class="post-ribbon"></div>

<div class="container post-container">
  <div class="post-page card-panel z-depth-2">
    <div class="post-section">

      <p class="grey-text">
        <i class="mdi mdi-calendar"></i>&nbsp;
        Posted on February 21, 2018
        
        
          &nbsp;&nbsp;<i class="mdi mdi-account-circle"></i>&nbsp;
          authored by Shinya Yamaguchi
        
        &nbsp;
        
          <i class="mdi mdi-folder"></i>&nbsp;
          <span class="capitalize"></span>
          <!-- &emsp;<i class="mdi mdi-refresh"></i>&nbsp;UPDATE: {% if page.update %}{{ page.update | date: "%b %-d, %Y" }}{% else %}{{ page.last_modified_at | date: "%b %-d, %Y" }}{% endif %} -->
        
      </p>

      <div class="post-header">
        <h1 class="post-title">stack 1.6.5 がリリースされました。</h1>

        <div class="row">
        
          <div class="col s6">
            <i class="post-tag mdi mdi-tag-multiple waves-effect waves-light"></i>
            <div class="chip"><a href="../../tags/bigmoon.html">bigmoon</a>, <a href="../../tags/stack.html">stack</a></div>
          </div>
        

          <div class="col s6">
            <div style="position: relative; top: 70px;">
            <div class="fixed-action-btn horizontal" style="position: absolute; display: inline-block; right: 24px;">
  <a class="btn-floating btn-large red">
    <i class="large material-icons">share</i>
  </a>
  <ul>
    <li>
      <a class="btn-floating waves-effect waves-light blue tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Twitter" href="https://twitter.com/intent/tweet?text=stack 1.6.5 がリリースされました。&url=https://haskell.e-bigmoon.com/posts/2018/02-21-stack165.html"><i class="mdi mdi-twitter white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light indigo tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Facebook" href="https://facebook.com/sharer.php?u=https://haskell.e-bigmoon.com/posts/2018/02-21-stack165.html"><i class="mdi mdi-facebook white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light red tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Google+" href="https://plus.google.com/share?url=https://haskell.e-bigmoon.com/posts/2018/02-21-stack165.html"><i class="mdi mdi-google-plus white-text"></i></a>
    </li>
  </ul>
</div>
            </div>
          </div>
        </div>
      </div>

      <article class="post-content">
        <h2 id="はじめに">はじめに</h2>
<p>先日 Stack version 1.6.5 が<a href="https://github.com/commercialhaskell/stack/blob/master/ChangeLog.md#v165">リリース</a>されました。</p>
<p>バグフィックスのみです。</p>
<p>いくつか前回の <a href="https://haskell.e-bigmoon.com/posts/2017-12-24-stack163.html">1.6.3</a> に含まれていた内容が 1.6.5 に移動してますね。</p>
<!--more-->
<h2 id="更新方法">更新方法</h2>
<pre class="shell"><code>$ stack upgrade

$ stack --version
Version 1.6.5, Git revision 24ab0d6ff07f28276e082c3ce74dfdeb1a2ca9e9 (5514 commits) x86_64 hpack-0.20.0</code></pre>
<h2 id="バグフィックス">バグフィックス</h2>
<ul>
<li>Windows でプリコンパイルされたキャッシュファイルのパス名が長過ぎる場合にビルドが失敗する問題を修正しました (<a href="https://github.com/commercialhaskell/stack/issues/3649">#3649</a>)</li>
</ul>
<p>僕は Windows ユーザではないので、どのぐらいこのバグが深刻なのかわかりません。</p>
<p><code>stack</code> の内部的には <a href="https://github.com/commercialhaskell/stack/blob/v1.6.5/src/Stack/Build/Cache.hs#L372">pathTooLong</a> が新しく定義され、以前まではただの <code>length</code> で比較していたところを <code>utf16StringLength</code> の比較に修正したようです。</p>
<hr />
<ul>
<li>スクリプトインタプリタ形式で暗黙的に渡されるファイル引数を他の引数より先に処理するようにしました (<a href="https://github.com/commercialhaskell/stack/issues/3658">#3658</a>)。この修正により、スクリプト実行時に <code>-- +RTS ... -RTS</code> を渡せるようになりました。</li>
</ul>
<p>以下のような <code>RTS</code> オプションの指定が適切に処理できるようになりました。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="pp">#!/usr/bin/env stack</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">{- stack</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co">  script</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co">  --resolver lts-6.25</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co">  --package turtle</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="co">  --</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co">  +RTS -s -RTS</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co">-}</span></span>
<span id="cb2-9"><a href="#cb2-9"></a></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="ot">main ::</span> <span class="dt">IO</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>main <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="st">&quot;Hello, world!&quot;</span></span></code></pre></div>
<hr />
<ul>
<li>stack 設定ファイルで <code>year</code> パラメータが設定できるようになりました。それに伴い、ドキュメントもわかりやすくしました。 (<a href="https://github.com/commercialhaskell/stack/issues/2275">#2275</a>)。</li>
</ul>
<p>こんな感じで指定できるようです。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">templates</span><span class="kw">:</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="at">  </span><span class="fu">params</span><span class="kw">:</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="at">    </span><span class="fu">author-email</span><span class="kw">:</span><span class="at"> 415fox@gmail.com</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="at">    </span><span class="fu">author-name</span><span class="kw">:</span><span class="at"> michael fox</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="at">    </span><span class="fu">category</span><span class="kw">:</span><span class="at"> Application</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="at">    </span><span class="fu">copyright</span><span class="kw">:</span><span class="at"> copytright michael fox 2016</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="at">    </span><span class="fu">github-username</span><span class="kw">:</span><span class="at"> gitfoxi</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="at">    </span><span class="fu">year</span><span class="kw">:</span><span class="at"> </span><span class="dv">2016</span></span></code></pre></div>
<p>ドキュメントを見る限り <code>copyright</code> を省略した場合は <code>author-name</code> と <code>year</code> を使って <code>copyright</code> が生成されるようです。</p>
<p>また <code>year</code> を省略した場合は現在の年が設定されるとのことなので、設定しなくても良さそうですね。</p>
<hr />
<ul>
<li>ベンチーマークが別のベンチマークやビルドステップと並行して実行されてしまう問題を修正しました。これは別のプロセスのCPU利用がベンチマークに悪影響を及ぼすと思われるので理想的ではありません。また、デフォルトでベンチマークの出力が表示されないようになっていた件も同様に修正しました (<a href="https://github.com/commercialhaskell/stack/issues/3663">#3663</a>)</li>
</ul>
<p><a href="https://github.com/commercialhaskell/stack/pull/3666">Never run benchmarks concurrently, always output to console #3663 #3666</a>が修正のPRです。</p>
<p>良くわかりませんが <code>Actiontype</code> 型に <code>ConcurrencyDisallowed</code> というデータコンストラクタを追加し <code>bench</code> が呼ばれた際はこの値を <code>Action</code> 型の <code>actionConcurrency</code> フィールドに設定することで処理を切り替えるようにしているっぽいです。</p>
<hr />
<ul>
<li>パッケージのコンポーネントごとに別々のビルドキャッシュを持つことによって、未変更のファイルについて不要なリビルドを回避するようになりました (<a href="https://github.com/commercialhaskell/stack/issues/3732">#3732</a>)</li>
</ul>
<p><code>issue</code> にあがっている具体例だと <code>foo</code> と <code>bar</code> の2つのパッケージを作り、<code>bar</code> は <code>foo</code> に依存しているという関係です。</p>
<pre class="shell"><code>$ stack test --no-run-tests
$ stack test --no-run-tests bar</code></pre>
<p>この時、1回目でテストが終わってるので2回目で <code>bar</code> を指定した時に何も起こらないはずです。</p>
<p>しかし、実際にはこうなります。</p>
<pre class="shell"><code>$ stack test --no-run-tests bar
bar-0.1.0.0: unregistering (missing dependencies: foo)
foo-0.1.0.0: unregistering (local file changes: app/Main.hs test/Spec.hs)
foo-0.1.0.0: build (lib + exe)
foo-0.1.0.0: copy/register
bar-0.1.0.0: configure (lib + exe + test)</code></pre>
<p><a href="https://github.com/commercialhaskell/stack/pull/3750">Use a separate build cache for each component of a package #3750</a>で修正されています。</p>
<p>実装を見る感じ、コンポーネントというのは <code>lib</code>, <code>exe</code>, <code>test</code>, <code>bench</code> のことで、それぞれを接頭辞にしたビルドキャッシュを持つようになったみたい？です。</p>
<hr />
<ul>
<li>スナップショットからローカルパッケージにパッケージを反映させる処理の動作を修正しました。これはスナップショットのバージョン境界が衝突する時に発生する問題なので、古いパッケージの Hackage リビジョンによって引き起こされます。同様にカスタムスナップショットでも、問題の起きないパッケージの衝突するバージョンが定義できるようになりました。(<a href="https://github.com/fpco/stackage/issues/3185">Stackage issue #3185</a>)</li>
</ul>
<p><a href="https://github.com/commercialhaskell/stack/pull/3758/">Fix package promotion to snapshot #3758</a> で修正されました。コードの差分は以下の1行です。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a><span class="pp"># 変更前</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="dt">Just</span> version <span class="ot">-&gt;</span> version <span class="ot">`withinIntervals`</span> intervals</span>
<span id="cb6-3"><a href="#cb6-3"></a></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="pp"># 変更後</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="dt">Just</span> _version <span class="ot">-&gt;</span> <span class="dt">True</span></span></code></pre></div>
<p>このようにローカルパッケージ反映時？にバージョンチェックを行わないようになりました。</p>
<p>以下のようにカスタムスナップショットに追加する場合はビルドできます。(<code>async-2.1.1.1</code> には <code>stm &gt;= 2.2 &amp;&amp; &lt; 2.5</code> の依存関係が設定されています。<a href="https://hackage.haskell.org/package/async-2.1.1.1/src/async.cabal">async.cabal</a>)</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># stack.yaml</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="fu">resolver</span><span class="kw">:</span><span class="at"> snapshot.yaml</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># snapshot.yaml</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="fu">resolver</span><span class="kw">:</span><span class="at"> ghc-8.0.2</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> hackage-revisions-are-annoying</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="fu">packages</span><span class="kw">:</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="kw">-</span><span class="at"> async-2.1.1.1</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="kw">-</span><span class="at"> stm-2.1.2.2</span></span></code></pre></div>
<p>実行結果。</p>
<pre class="shell"><code>$ stack build --stack-yaml as-snapshot.yaml
WARNING: Ignoring out of range dependency (trusting snapshot over Hackage revisions): stm-2.1.2.2. async requires: &gt;=2.2 &amp;&amp; &lt;2.5

...

Process exited with code: ExitFailure 1
    Logs have been written to: /home/bm12/Desktop/testProj/test/.stack-work/logs/async-2.1.1.1.log

    Configuring async-2.1.1.1...
    Cabal-simple_mPHDZzAJ_1.24.2.0_ghc-8.0.2: Encountered missing dependencies:
    stm &gt;=2.2 &amp;&amp; &lt;2.5 &amp;&amp; ==2.1.2.2</code></pre>
<p>また、以下のように <code>extra-deps</code> に追加する場合はビルドが実行される前にバージョンエラーになります。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># stack.yaml</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="fu">resolver</span><span class="kw">:</span><span class="at"> ghc-8.0.2</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="fu">extra-deps</span><span class="kw">:</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="kw">-</span><span class="at"> async-2.1.1.1</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="kw">-</span><span class="at"> stm-2.1.2.2</span></span></code></pre></div>
<p>実行結果</p>
<pre class="shell"><code>$ stack build --stack-yaml as-extra-dep.yaml

Error: While constructing the build plan, the following exceptions were encountered:

In the dependencies for async-2.1.1.1:
    stm-2.1.2.2 from stack configuration does not match &gt;=2.2 &amp;&amp; &lt;2.5  (latest matching version is 2.4.5.0)
needed due to test-0.1.0.0 -&gt; async-2.1.1.1

Some different approaches to resolving this:

  * Set 'allow-newer: true' to ignore all version constraints and build anyway.

  * Consider trying 'stack solver', which uses the cabal-install solver to attempt to find some working build configuration. This can be convenient when
    dealing with many complicated constraint errors, but results may be unpredictable.

  * Recommended action: try adding the following to your extra-deps in /home/bm12/Desktop/testProj/test/as-extra-dep.yaml:

- stm-2.4.5.0

Plan construction failed.</code></pre>
<hr />
<ul>
<li><code>stack ghci</code> で複数のパッケージで定義されている同名のモジュールを読み込めるようになりました (<a href="https://github.com/commercialhaskell/stack/pull/3776">#3776</a>)。</li>
</ul>
<p>あんまりわかってないですが、<code>issue</code> の内容は <code>stack</code> と <code>rio</code> の両方のパッケージで同名のモジュールがある場合でも、ちゃんと読み込めるようになったみたいです。</p>
<pre><code>Path.Extra (in stack, rio)
RIO (in stack, rio)
RIO.Logger (in stack, rio)
RIO.Prelude (in stack, rio)
RIO.Process (in stack, rio)</code></pre>
<p><a href="https://github.com/commercialhaskell/stack/pull/3779">With ghci, allow multiple packages to use the same module #3776 #3779</a> で修正されました。</p>
<p><code>ghciPkgModules</code> の型を <code>Set ModuleName</code> から <code>ModuleMap</code> に変更しています。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">type</span> <span class="dt">ModuleMap</span> <span class="ot">=</span> <span class="dt">Map</span> <span class="dt">ModuleName</span> (<span class="dt">Map</span> (<span class="dt">Path</span> <span class="dt">Abs</span> <span class="dt">File</span>) (<span class="dt">Set</span> (<span class="dt">PackageName</span>, <span class="dt">NamedComponent</span>)))</span></code></pre></div>
<p><code>モジュール名</code> → <code>ファイルの絶対パス</code> の順番で探して、その中を <code>Set (PackageName, NamedComponent)</code> で持つようになっています。今まではモジュール名の <code>Set</code> だったので確かに複数のパッケージでも上手く処理できそうな感じがします。</p>
<hr />
<ul>
<li><code>stack ghci</code> で <code>base</code> の依存関係を追加する必要が無くなりました。これはローカルターゲットが存在しない場合に自動的に追加されるためです。これにより、<code>base</code> を置き換えているコードも同様に読み込めるようになります (<a href="https://github.com/commercialhaskell/stack/issues/3589">#3589</a>)</li>
</ul>
<p>修正の<a href="https://github.com/commercialhaskell/stack/commit/196bdbae986ddf887f92999b26129085a8ed0be5">コミット</a>を見ると <code>"-package" : "base"</code> が明示的に追加されています。</p>
<hr />
<ul>
<li><code>--no-rerun-tests</code> が修正されました。今まではテストを実行した後に結果の記録を忘れていました。そのため、前回テストにパスしていたとしても、常に全てのテストが実行されていました (<a href="https://github.com/commercialhaskell/stack/pull/3770">#3770</a>)</li>
</ul>
<hr />
<ul>
<li><code>hackage-security</code> のパッチを当てたバージョンを含めるようにしました。このパッチには機械故障や <code>SIGKILL</code> に対して更新処理が正しく復帰できるように、非同期例外処理に関する問題とディレクトリロックからファイルロックへの変更の2つが含まれます (<a href="https://github.com/haskell/hackage-security/issues/187">hackage-security #187</a>, <a href="https://github.com/commercialhaskell/stack/issues/3073">#3073</a>)</li>
</ul>
<p>この問題よくわかってないのですが、<code>stack</code> のコミットは <code>extra-deps</code> にパッチの当たっている <code>hackage-security</code> を追加しただけです。(<a href="https://github.com/commercialhaskell/stack/commit/4bf68f02d901a6ffc7f4b81a22985d98435fbb14">コミット</a>)</p>
<p>実際のパッチは以下の2つです。</p>
<ul>
<li><a href="https://github.com/haskell/hackage-security/pull/202">Detect asynchronous exceptions via their types #187 #202</a></li>
<li><a href="https://github.com/haskell/hackage-security/pull/203">Use file instead of dir locking #187 #203</a></li>
</ul>
<h2 id="bug-fix-オリジナル">Bug fix (オリジナル)</h2>
<ul>
<li>1.6.1 introduced a change that made some precompiled cache files use longer paths, sometimes causing builds to fail on windows. This has been fixed. See <a href="https://github.com/commercialhaskell/stack/issues/3649">#3649</a></li>
<li>The script interpreter’s implicit file arguments are now passed before other arguments. See <a href="https://github.com/commercialhaskell/stack/issues/3658">#3658</a>. In particular, this makes it possible to pass <code>-- +RTS ... -RTS</code> to specify RTS arguments used when running the script.</li>
<li>Don’t ignore the template <code>year</code> parameter in config files, and clarify the surrounding documentation. See <a href="https://github.com/commercialhaskell/stack/issues/2275">#2275</a>.</li>
<li>Benchmarks used to be run concurrently with other benchmarks and build steps. This is non-ideal because CPU usage of other processes may interfere with benchmarks. It also prevented benchmark output from being displayed by default. This is now fixed. See <a href="https://github.com/commercialhaskell/stack/issues/3663">#3663</a>.</li>
<li>Some unnecessary rebuilds when no files were changed are now avoided, by having a separate build cache for each component of a package. See <a href="https://github.com/commercialhaskell/stack/issues/3732">#3732</a>.</li>
<li>Correct the behavior of promoting a package from snapshot to local package. This would get triggered when version bounds conflicted in a snapshot, which could be triggered via Hackage revisions for old packages. This also should allow custom snapshots to define conflicting versions of packages without issue. See <a href="https://github.com/fpco/stackage/issues/3185">Stackage issue #3185</a>.</li>
<li>When promoting packages from snapshot to local, we were occassionally discarding the actual package location content and instead defaulting to pulling the package from the index. We now correctly retain this information. Note that if you were affected by this bug, you will likely need to delete the binary build cache associated with the relevant custom snapshot. See <a href="https://github.com/commercialhaskell/stack/issues/3714">#3714</a>.</li>
<li><code>stack ghci</code> now allows loading multiple packages with the same module name, as long as they have the same filepath. See <a href="https://github.com/commercialhaskell/stack/pull/3776">#3776</a>.</li>
<li><code>stack ghci</code> no longer always adds a dependency on <code>base</code>. It is now only added when there are no local targets. This allows it to be to load code that uses replacements for <code>base</code>. See <a href="https://github.com/commercialhaskell/stack/issues/3589#issuecomment">#3589</a></li>
<li><code>--no-rerun-tests</code> has been fixed. Previously, after running a test we were forgetting to record the result, which meant that all tests always ran even if they had already passed before. See <a href="https://github.com/commercialhaskell/stack/pull/3770">#3770</a>.</li>
<li>Includes a patched version of <code>hackage-security</code> which fixes both some issues around asynchronous exception handling, and moves from directory locking to file locking, making the update mechanism resilient against SIGKILL and machine failure. See <a href="https://github.com/haskell/hackage-security/issues/187">hackage-security #187</a> and <a href="https://github.com/commercialhaskell/stack/issues/3073">#3073</a>.</li>
</ul>
<h2 id="まとめ">まとめ</h2>
<ul>
<li><code>stack ghci</code> 周りのバグフィックスもいくつかあったので <code>ghci</code> を多用する人にとっては嬉しいですね。</li>
<li>古い <code>LTS</code> を使っているプロジェクトでビルドができなくて困っている人は <code>1.6.5</code> にアップデートすると直るかもしれません。</li>
</ul>
<p>以上です。</p>
      </article>

      <div class="row pager">
        <div class="col s6">
          
            <a class="waves-effect waves-light btn white-text left prev" href="../../posts/2018/02-12-pattern-synonyms.html"><i class="material-icons left">navigate_before</i>Pattern Synonyms で DEPRECATED</a>
          
        </div>
        <div class="col s6">
          
            <a class="waves-effect waves-light btn white-text right next" href="../../posts/2018/02-23-stack-build-failure.html">stack でどうしてもビルドできないとき<i class="material-icons right">navigate_next</i></a>
          
        </div>
      </div>

      <div class="row">
        <div class="col s6 offset-s6" style="position: relative; height: 100px;">
          <div class="fixed-action-btn horizontal" style="position: absolute; display: inline-block; right: 24px;">
  <a class="btn-floating btn-large red">
    <i class="large material-icons">share</i>
  </a>
  <ul>
    <li>
      <a class="btn-floating waves-effect waves-light blue tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Twitter" href="https://twitter.com/intent/tweet?text=stack 1.6.5 がリリースされました。&url=https://haskell.e-bigmoon.com/posts/2018/02-21-stack165.html"><i class="mdi mdi-twitter white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light indigo tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Facebook" href="https://facebook.com/sharer.php?u=https://haskell.e-bigmoon.com/posts/2018/02-21-stack165.html"><i class="mdi mdi-facebook white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light red tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Google+" href="https://plus.google.com/share?url=https://haskell.e-bigmoon.com/posts/2018/02-21-stack165.html"><i class="mdi mdi-google-plus white-text"></i></a>
    </li>
  </ul>
</div>
        </div>
      </div>

    </div>
  </div>

  <!-- {% if page.mathjax %} -->
  <!--   {% include mathjax_support.html %} -->
  <!-- {% endif %} -->

</div>

      </div>
    </div>

    <footer class="page-footer indigo lighten-1">

  <div class="footer-copyright">

    <div class="container">
      © 2017-2019 BIGMOON&nbsp;
      Site proudly generated by <a class="red-text text-accent-1" href="http://jaspervdj.be/hakyll">Hakyll</a>,&nbsp;
      original Jekyll theme by <a class="red-text text-accent-1" href="https://github.com/mumuxme/materialize-jekyll">mumuxme</a>.
    </div>

  </div>

</footer>


    <!-- scrolltop button -->
    <button class="material-scrolltop waves-effect waves-light hide-on-small-only" type="button">
      <i class="mdi mdi-arrow-up-bold small white-text"></i>
    </button>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-19322672-9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-19322672-9');
    </script>

    <!-- jquery -->
    <script type="text/javascript" src="../../lib/jquery-min.js"></script>
    <!-- materialize -->
    <script src="../../lib/materialize/js/materialize.min.js"></script>
    <!-- <\!-- Material ScrollTop plugin -\-> -->
    <script src="../../lib/material-scrolltop/material-scrolltop.js"></script>
    <!-- main -->
    <script src="../../js/init.js"></script>
    <script src="../../js/main.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>

</html>
