<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">

  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
  <!-- MUST in hex format, may the same as header-color. This color is for android chrome browser. -->
  <meta name="theme-color" content="#5c6bc0">

  <!-- Metadata. -->
  <meta name="keywords" content="haskell,blog,bigmoon" />
  <title>Haskell Quiz No.6 Conduit Part.2</title>
  <meta name="description" content="Haskell Quiz No.6
難易度: λλ
以下の Conduit を使ったコードの実行結果を予想してみてください！
#!/usr/bin/env stack
-- stack script --resolver lts-11.2
import Conduit

trans :: Monad m =&gt; C">
  <link rel="canonical" href="../../posts/2018/04-06-quiz-6.html">
  <link rel="alternate" type="application/atom+xml" title="Haskell Quiz No.6 Conduit Part.2" href="../../feed.xml" />
  <link rel="shortcut icon" href="../../images/favicon.ico" />
  <meta name="google-site-verification" content="X2YNboLvzw3_bclXLMvohyJDqj68D06_hPDMukRbgTs" />

  <!-- Stylesheets. -->
  <link rel="stylesheet" href="../../lib/materialize/css/materialize.min.css" />
  <link rel="stylesheet" href="../../css/main.css" />
  <link media="all" rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/3.3.92/css/materialdesignicons.min.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="../../lib/material-scrolltop/material-scrolltop.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/agate.min.css" />
  

  <!-- OGP -->
  <meta property="og:title" content="Haskell Quiz No.6 Conduit Part.2" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="/posts/2018/04-06-quiz-6.html" />
  <!-- <meta property="og:image" content=" サムネイル画像の URL" /> -->
  <meta property="og:site_name" content="Haskell Quiz No.6 Conduit Part.2" />
  <meta property="og:description" content="Haskell Quiz No.6
難易度: λλ
以下の Conduit を使ったコードの実行結果を予想してみてください！
#!/usr/bin/env stack
-- stack script --resolver lts-11.2
import Conduit

trans :: Monad m =&gt; C" />

  <meta name="twitter:card" content="summary" />
  <!-- <meta name="twitter:site" content="@[ Twitter ID]" /> -->
  <!-- <meta name="twitter:player" content="@[ Twitter ID]" /> -->

  <noscript>
  <div class="notice-warning noscript">You don't have javascript enabled. Good luck! :(</div>
</noscript>

<!--[if IE]>
  <div class="notice-warning">Oh, you are using Internet Explorer! Good luck... :(</div>
<![endif]-->

</head>


  <body>
    <header class="site-header">
      <nav class="nav-extended indigo lighten-1">
        <div class="nav-wrapper">
  <a href="../../"><span class="site-title">BIGMOON Haskeller's BLOG</span></a>
  <a href="#" data-activates="mobile-navbar" class="button-collapse">
    <i class="mdi mdi-menu white-text"></i>
  </a>

  <ul id="nav-mobile" class="right hide-on-med-and-down">
    <li>
      <a href="../../" class="white-text">
        <i class="mdi mdi-home left indigo-text text-lighten-3"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="white-text">
        <i class="mdi mdi-account-circle left indigo-text text-lighten-3"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../books/" class="white-text">
        <i class="mdi mdi-book-open left indigo-text text-lighten-3"></i>
        Books
      </a>
    </li>
    <li>
      <a href="../../stack/" class="white-text">
        <i class="mdi mdi-wrench left indigo-text text-lighten-3"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/" class="white-text">
        <i class="mdi mdi-comment-question-outline left indigo-text text-lighten-3"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="white-text">
        <i class="mdi mdi-package-variant left indigo-text text-lighten-3"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="white-text">
        <i class="mdi mdi-earth left indigo-text text-lighten-3"></i>
        Yesod
      </a>
    </li>
    <li>
      <a href="../../feed.xml" class="white-text">
        <i class="mdi mdi-rss left indigo-text text-lighten-3"></i>
        Feed
      </a>
    </li>
  </ul>

  <ul class="side-nav" id="mobile-navbar">
    <li>
      <a href="../../" class="waves-effect waves-teal black-text">
        <i class="mdi mdi-home left green-text"></i>
        Home
      </a>
    </li>
    <li>
      <a href="../../about.html" class="navbar-text-colour-mobile">
        <i class="mdi mdi-account-circle left blue-text"></i>
        About
      </a>
    </li>
    <li>
      <a href="../../books/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-book-open left blue-text"></i>
        Books
      </a>
    </li>
    <li>
      <a href="../../stack/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-wrench left blue-text"></i>
        Development
      </a>
    </li>
    <li>
      <a href="../../quiz/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-comment-question-outline left blue-text"></i>
        Quiz
      </a>
    </li>
    <li>
      <a href="../../libraries/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-package-variant left blue-text"></i>
        Libraries
      </a>
    </li>
    <li>
      <a href="../../yesod/" class="navbar-text-colour-mobile">
        <i class="mdi mdi-earth left blue-text"></i>
        Yesod
      </a>
    </li>
  </ul>
</div>

      </nav>
    </header>

    <div class="site-container" id="tab-main">
      <div class="wrapper">
        <div class="post-ribbon"></div>

<div class="container post-container">
  <div class="post-page card-panel z-depth-2">
    <div class="post-section">

      <p class="grey-text">
        <i class="mdi mdi-calendar"></i>&nbsp;
        Posted on April  6, 2018
        
        
          &nbsp;&nbsp;<i class="mdi mdi-account-circle"></i>&nbsp;
          authored by Shinya Yamaguchi
        
        
          <br>
          <i class="mdi mdi-calendar"></i>&nbsp;
          Last Updated April  8, 2018
        
        &nbsp;
        
          <i class="mdi mdi-folder"></i>&nbsp;
          <span class="capitalize"></span>
          <!-- &emsp;<i class="mdi mdi-refresh"></i>&nbsp;UPDATE: {% if page.update %}{{ page.update | date: "%b %-d, %Y" }}{% else %}{{ page.last_modified_at | date: "%b %-d, %Y" }}{% endif %} -->
        
      </p>

      <div class="post-header">
        <h1 class="post-title">Haskell Quiz No.6 Conduit Part.2</h1>

        <div class="row">
        
          <div class="col s6">
            <i class="post-tag mdi mdi-tag-multiple waves-effect waves-light"></i>
            <div class="chip"><a title="All pages tagged 'bigmoon'." href="../../tags/bigmoon.html">bigmoon</a>, <a title="All pages tagged 'quiz'." href="../../tags/quiz.html">quiz</a></div>
          </div>
        

          <div class="col s6">
            <div style="position: relative; top: 70px;">
            <div class="fixed-action-btn horizontal" style="position: absolute; display: inline-block; right: 24px;">
  <a class="btn-floating btn-large red">
    <i class="large material-icons">share</i>
  </a>
  <ul>
    <li>
      <a class="btn-floating waves-effect waves-light blue tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Twitter" href="https://twitter.com/intent/tweet?text=Haskell Quiz No.6 Conduit Part.2&url=https://haskell.e-bigmoon.com/posts/2018/04-06-quiz-6.html"><i class="mdi mdi-twitter white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light indigo tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Facebook" href="https://facebook.com/sharer.php?u=https://haskell.e-bigmoon.com/posts/2018/04-06-quiz-6.html"><i class="mdi mdi-facebook white-text"></i></a>
    </li>
  </ul>
</div>
            </div>
          </div>
        </div>
      </div>

      <article class="post-content">
        <h2 id="haskell-quiz-no.6">Haskell Quiz No.6</h2>
<p>難易度: λλ</p>
<p>以下の <code>Conduit</code> を使ったコードの実行結果を予想してみてください！</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="pp">#!/usr/bin/env stack</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="co">-- stack script --resolver lts-11.2</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Conduit</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="ot">trans ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">ConduitM</span> <span class="dt">Int</span> <span class="dt">Int</span> m ()</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a>trans <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a>  takeC <span class="dv">5</span> <span class="op">.|</span> mapC (<span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a>  mapC (<span class="op">*</span> <span class="dv">2</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a>main <span class="ot">=</span> runConduit <span class="op">$</span> yieldMany [<span class="dv">1</span><span class="op">..</span><span class="dv">10</span>] <span class="op">.|</span> trans <span class="op">.|</span> mapM_C <span class="fu">print</span></span></code></pre></div>
<p>答えは<a href="04-07-quiz-7.html">次回</a>。</p>
<p>最近は <code>Conduit</code> にはまっているので、クイズも <code>Conduit</code> が続きます。</p>
<!--more-->
<h2 id="はじめに">はじめに</h2>
<p><a href="./03-31-quiz-5.html">前回</a>の問題と答えは以下の通りです。</p>
<h3 id="問題">問題</h3>
<p>難易度: λλ</p>
<p>以下の <code>Conduit</code> を使ったコードの実行結果を予想してみてください！</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="pp">#!/usr/bin/env stack</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="co">-- stack script --resolver lts-11.0</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Conduit</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a><span class="ot">sink ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">ConduitM</span> <span class="dt">Int</span> o m (<span class="dt">String</span>, <span class="dt">Int</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>sink <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>  x <span class="ot">&lt;-</span> takeC <span class="dv">5</span> <span class="op">.|</span> mapC <span class="fu">show</span> <span class="op">.|</span> foldC</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>  y <span class="ot">&lt;-</span> sumC</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>  <span class="fu">return</span> (x, y)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a>  <span class="kw">let</span> res <span class="ot">=</span> runConduitPure <span class="op">$</span> yieldMany [<span class="dv">1</span><span class="op">..</span><span class="dv">10</span>] <span class="op">.|</span> sink</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>  <span class="fu">print</span> res</span></code></pre></div>
<h3 id="こたえ">こたえ</h3>
<p>実際に実行してみましょう！</p>
<pre class="shell"><code>$ ./Quiz5.hs
(&quot;12345&quot;,40)</code></pre>
<p>どうですか？予想通りでしたか？？</p>
<h2 id="haskell-quiz-no.5-の解説">Haskell Quiz No.5 の解説</h2>
<p>この問題を解くためには <a href="https://www.stackage.org/lts-11.3/package/conduit-1.3.0.2">conduit</a> というストリーム処理ライブラリの知識が必要になります。</p>
<h3 id="conduit-を使うモチベーション">Conduit を使うモチベーション</h3>
<p>具体例として指定したディレクトリ以下の<strong>ファイル数</strong>と<strong>容量の合計</strong>を出力するようなプログラムを作ってみましょう。</p>
<p>ディレクトリ操作については <a href="https://www.stackage.org/lts-11.3/package/directory-1.3.0.2">directory</a> パッケージに便利な関数が色々と定義されているので、このパッケージを利用します。</p>
<p>必要な操作と、対応する関数は以下の通りです。</p>
<ul>
<li>ファイルの列挙: <a href="https://www.stackage.org/haddock/lts-11.3/directory-1.3.0.2/System-Directory.html#v:listDirectory">listDirectory</a></li>
<li>ファイルサイズの取得: <a href="https://www.stackage.org/haddock/lts-11.3/directory-1.3.0.2/System-Directory.html#v:getFileSize">getFileSize</a></li>
<li>ファイル・ディレクトリの判定: <a href="https://www.stackage.org/haddock/lts-11.3/directory-1.3.0.2/System-Directory.html#v:doesFileExist">doesFileExist</a></li>
</ul>
<p>これらの関数を使って、こんな感じでプログラムを作ることができます。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="pp">#!/usr/bin/env stack</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="co">{-</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a><span class="co">stack script --resolver lts-11.3</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a><span class="co">  --package extra</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a><span class="co">  --package filepath</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a><span class="co">  --package directory</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a><span class="co">-}</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">System.Environment</span> (getArgs)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">System.Directory</span> (listDirectory, doesFileExist, getFileSize)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">System.FilePath</span> ((&lt;/&gt;))</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Control.Monad.Extra</span> (partitionM, ifM)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Control.Monad</span> (when)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true"></a>  arg <span class="ot">&lt;-</span> getArgs</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true"></a>  when (<span class="fu">length</span> arg <span class="op">==</span> <span class="dv">1</span>) <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true"></a>    (cnt, size) <span class="ot">&lt;-</span> recListDir <span class="op">$</span> <span class="fu">head</span> arg</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true"></a>    <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;総ファイル数: &quot;</span> <span class="op">++</span> <span class="fu">show</span> cnt</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true"></a>    <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;総ファイルサイズ: &quot;</span> <span class="op">++</span> <span class="fu">show</span> size</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true"></a><span class="ot">recListDir ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Int</span>, <span class="dt">Integer</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true"></a>recListDir fp <span class="ot">=</span> loop (<span class="dv">0</span>, <span class="dv">0</span>) [fp]</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true"></a>    loop summary [] <span class="ot">=</span> <span class="fu">return</span> summary</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true"></a>    loop (accCnt, accSize) (fp<span class="op">:</span>fps) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true"></a>      dirs <span class="ot">&lt;-</span> listDirectory fp</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true"></a>      (files, childDirs) <span class="ot">&lt;-</span> partitionM doesFileExist <span class="op">$</span> <span class="fu">map</span> (fp <span class="op">&lt;/&gt;</span>) dirs</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true"></a>      size <span class="ot">&lt;-</span> <span class="fu">sum</span> <span class="op">&lt;$&gt;</span> <span class="fu">mapM</span> getFileSize files</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true"></a>      <span class="kw">let</span> summary <span class="ot">=</span> (accCnt <span class="op">+</span> <span class="fu">length</span> files, accSize <span class="op">+</span> size)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true"></a>      loop summary <span class="op">$</span> fps <span class="op">++</span> childDirs</span></code></pre></div>
<p>実際に、プロファイリングを取得しつつ動かしてみます。</p>
<pre class="shell"><code>$ stack ghc Ex &amp;&amp; sudo ./Ex /home/bm12/Desktop/ +RTS -s
総ファイル数: 338866
総ファイルサイズ: 37870090712</code></pre>
<p>とりあえず、上手く動いているような気がします。</p>
<p>しかし、メモリ使用量は・・・</p>
<pre class="shell"><code>  13,440,124,048 bytes allocated in the heap
   8,760,418,592 bytes copied during GC
   1,225,650,008 bytes maximum residency (23 sample(s))
      19,423,400 bytes maximum slop
            2599 MB total memory in use (0 MB lost due to fragmentation)

                                     Tot time (elapsed)  Avg pause  Max pause
  Gen  0      9869 colls,     0 par    7.821s   9.831s     0.0010s    1.1223s
  Gen  1        23 colls,     0 par    0.011s   0.013s     0.0006s    0.0009s

  INIT    time    0.000s  (  0.000s elapsed)
  MUT     time    5.255s  (  6.347s elapsed)
  GC      time    7.832s  (  9.845s elapsed)
  EXIT    time    0.032s  (  0.123s elapsed)
  Total   time   13.118s  ( 16.315s elapsed)

  %GC     time      59.7%  (60.3% elapsed)

  Alloc rate    2,557,607,298 bytes per MUT second

  Productivity  40.3% of total user, 39.7% of total elapsed</code></pre>
<ul>
<li><strong>2599 MB total memory in use</strong></li>
<li><strong>%GC time 59.7% (60.3% elapsed)</strong></li>
</ul>
<p>ということで、非常にやばいですね。</p>
<h3 id="conduit-で書き直そう">Conduit で書き直そう！</h3>
<p>先程作ったプログラムは、どうやらスペースリークしているようです。指定したディレクトリ以下のファイルの数とファイルサイズの合計を取得するだけなのに、メモリを使いすぎですね。</p>
<p>解決方法は色々ありますが、今回はストリームライブラリの <code>Conduit</code> を使って解決していきましょう。</p>
<p><code>Conduit</code> には <a href="https://www.stackage.org/haddock/lts-11.3/conduit-1.3.0.2/Conduit.html#v:sourceDirectoryDeep">sourceDirectoryDeep</a> という、関数が用意されています。</p>
<p>だいたいこんな感じで書き直すことができます。先程の定義と比べると <strong>sourceDirectoryDeep</strong> 関数のおかげでスッキリした印象です。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="pp">#!/usr/bin/env stack</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a><span class="co">{-</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a><span class="co">stack script --resolver lts-11.3</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a><span class="co">  --package conduit</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a><span class="co">  --package extra</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a><span class="co">  --package directory</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a><span class="co">-}</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Conduit</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">System.Environment</span> (getArgs)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">System.Directory</span> (doesFileExist, getFileSize)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Control.Monad.Extra</span> (whenM)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Control.Monad</span> (when)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true"></a>  arg <span class="ot">&lt;-</span> getArgs</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true"></a>  when (<span class="fu">length</span> arg <span class="op">==</span> <span class="dv">1</span>) <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true"></a>    (cnt, size) <span class="ot">&lt;-</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true"></a>      runConduitRes <span class="op">$</span> sourceDirectoryDeep <span class="dt">True</span> (<span class="fu">head</span> arg)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true"></a>                   <span class="op">.|</span> awaitForever getInfo</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true"></a>                   <span class="op">.|</span> getZipSink ((,) <span class="op">&lt;$&gt;</span> <span class="dt">ZipSink</span> lengthC <span class="op">&lt;*&gt;</span> <span class="dt">ZipSink</span> sumC)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true"></a>    <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;総ファイル数: &quot;</span> <span class="op">++</span> <span class="fu">show</span> cnt</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true"></a>    <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;総ファイルサイズ: &quot;</span> <span class="op">++</span> <span class="fu">show</span> size</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true"></a></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true"></a><span class="ot">getInfo ::</span> <span class="dt">MonadResource</span> m <span class="ot">=&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">ConduitM</span> <span class="dt">FilePath</span> <span class="dt">Integer</span> m ()</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true"></a>getInfo path <span class="ot">=</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true"></a>  whenM (liftIO <span class="op">$</span> doesFileExist path) <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true"></a>    size <span class="ot">&lt;-</span> liftIO <span class="op">$</span> getFileSize path</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true"></a>    yield size</span></code></pre></div>
<p>では、同様にプロファイルを取得しつつ、実行してみましょう。</p>
<pre class="shell"><code>$ stack ghc Ex2 &amp;&amp; sudo ./Ex2 /home/bm12/Desktop/ +RTS -s
総ファイル数: 338866
総ファイルサイズ: 37870092264</code></pre>
<p>肝心のメモリ使用量はと言うと・・・</p>
<pre class="shell"><code>  10,742,224,392 bytes allocated in the heap
      86,720,088 bytes copied during GC
          87,576 bytes maximum residency (19 sample(s))
          33,320 bytes maximum slop
               3 MB total memory in use (0 MB lost due to fragmentation)

                                     Tot time (elapsed)  Avg pause  Max pause
  Gen  0     10347 colls,     0 par    0.146s   0.198s     0.0000s    0.0008s
  Gen  1        19 colls,     0 par    0.000s   0.001s     0.0000s    0.0001s

  INIT    time    0.000s  (  0.000s elapsed)
  MUT     time    5.252s  (  7.444s elapsed)
  GC      time    0.146s  (  0.198s elapsed)
  EXIT    time    0.000s  (  0.000s elapsed)
  Total   time    5.398s  (  7.642s elapsed)

  %GC     time       2.7%  (2.6% elapsed)

  Alloc rate    2,045,428,118 bytes per MUT second

  Productivity  97.3% of total user, 97.4% of total elapsed</code></pre>
<ul>
<li><strong>3 MB total memory in use</strong></li>
<li><strong>%GC time 2.7% (2.6% elapsed)</strong></li>
</ul>
<p>どうですか？ストリーム処理って凄いですよね。</p>
<h3 id="解説">解説</h3>
<p>この問題の重要なポイントは、実行すると <code>("12345", 6+7+8+9+10)</code> という結果のように、<code>[1..10]</code> のリストの前半と後半で異なる処理になっているという点です。</p>
<pre class="shell"><code>$ ./Quiz5.hs
(&quot;12345&quot;,40)</code></pre>
<p>ここで理解しておきたい知識は以下の3点です。</p>
<ul>
<li>データは<strong>パイプ</strong> (ストリーム) を流れて処理されます</li>
<li><code>yieldMany</code> 関数は受け取ったデータをパイプに流す<strong>準備</strong>をします (<code>yieldMany</code> は自分から積極的にデータを流すことはしません。準備だけしておき <code>await</code> 関数などで、実際に必要になった際にだけデータを流します)</li>
<li><code>.|</code> はパイプを<strong>合成</strong>します</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a>  <span class="kw">let</span> res <span class="ot">=</span> runConduitPure <span class="op">$</span> yieldMany [<span class="dv">1</span><span class="op">..</span><span class="dv">10</span>] <span class="op">.|</span> sink</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a>  <span class="fu">print</span> res</span></code></pre></div>
<p><code>sink</code> 関数は <code>takeC 5 .| mapC show .| foldC</code> というパイプと <code>sumC</code> というパイプからなる、大きなパイプです。</p>
<p><code>takeC 5 .| mapC show .| foldC</code> 関数は <code>takeC 5</code> の部分でデータを <strong>5つだけ</strong> 上流のパイプに要求します。そのため、残りの5つのデータは次の <code>sumC</code> に流れることになります。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="ot">sink ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">ConduitM</span> <span class="dt">Int</span> o m (<span class="dt">String</span>, <span class="dt">Int</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a>sink <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a>  x <span class="ot">&lt;-</span> takeC <span class="dv">5</span> <span class="op">.|</span> mapC <span class="fu">show</span> <span class="op">.|</span> foldC <span class="co">-- 1,2,3,4,5  のデータが処理される</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a>  y <span class="ot">&lt;-</span> sumC                          <span class="co">-- 6,7,8,9,10 のデータが処理される</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a>  <span class="fu">return</span> (x, y)</span></code></pre></div>
<p>そのため、最終的には <code>("12345",40)</code> となりました。</p>
<p><code>"12345"</code> はそれぞれの <strong>Int</strong> 型が <code>mapC show</code> によって <strong>String</strong> 型に変換され、<code>foldC</code> の <code>mappend</code> による畳込みによって文字列連結されます。</p>
<h2 id="まとめ">まとめ</h2>
<p>実用的なアプリケーションを作ろうと考えている方は <code>Conduit</code> などのストリームライブラリを理解していると、色々と面倒なことを考えなくて済むのでとても良いですよ。</p>
<p>以上です。</p>
      </article>

      <div class="row pager">
        <div class="col s6">
          
            <a class="waves-effect waves-light btn white-text left prev" href="../../posts/2018/03-31-quiz-5.html"><i class="material-icons left">navigate_before</i>Haskell Quiz No.5 Conduit Part.1</a>
          
        </div>
        <div class="col s6">
          
            <a class="waves-effect waves-light btn white-text right next" href="../../posts/2018/04-07-quiz-7.html">Haskell Quiz No.7 Conduit Part.3<i class="material-icons right">navigate_next</i></a>
          
        </div>
      </div>

      <div class="row">
        <div class="col s6 offset-s6" style="position: relative; height: 100px;">
          <div class="fixed-action-btn horizontal" style="position: absolute; display: inline-block; right: 24px;">
  <a class="btn-floating btn-large red">
    <i class="large material-icons">share</i>
  </a>
  <ul>
    <li>
      <a class="btn-floating waves-effect waves-light blue tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Twitter" href="https://twitter.com/intent/tweet?text=Haskell Quiz No.6 Conduit Part.2&url=https://haskell.e-bigmoon.com/posts/2018/04-06-quiz-6.html"><i class="mdi mdi-twitter white-text"></i></a>
    </li>
    <li>
      <a class="btn-floating waves-effect waves-light indigo tooltipped" data-position="bottom" data-delay="20" data-tooltip="Share on Facebook" href="https://facebook.com/sharer.php?u=https://haskell.e-bigmoon.com/posts/2018/04-06-quiz-6.html"><i class="mdi mdi-facebook white-text"></i></a>
    </li>
  </ul>
</div>
        </div>
      </div>

    </div>
  </div>

  <!-- {% if page.mathjax %} -->
  <!--   {% include mathjax_support.html %} -->
  <!-- {% endif %} -->

</div>

      </div>
    </div>

    <footer class="page-footer indigo lighten-1">
  <div class="footer-copyright">
    <div class="container">
      © 2017-2020 BIGMOON&nbsp;
      Site proudly generated by <a class="red-text text-accent-1" href="http://jaspervdj.be/hakyll">Hakyll</a>,&nbsp;
      original Jekyll theme by <a class="red-text text-accent-1" href="https://github.com/mumuxme/materialize-jekyll">mumuxme</a>.
    </div>
  </div>
</footer>


    <!-- scrolltop button -->
    <button class="material-scrolltop waves-effect waves-light hide-on-small-only" type="button">
      <i class="mdi mdi-arrow-up-bold small white-text"></i>
    </button>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-19322672-9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-19322672-9');
    </script>

    <!-- jquery -->
    <script type="text/javascript" src="../../lib/jquery-min.js"></script>
    <!-- materialize -->
    <script src="../../lib/materialize/js/materialize.min.js"></script>
    <!-- <\!-- Material ScrollTop plugin -\-> -->
    <script src="../../lib/material-scrolltop/material-scrolltop.js"></script>
    <!-- main -->
    <script src="../../js/init.js"></script>
    <script src="../../js/main.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/haskell.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/yaml.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/shell.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/bash.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>

</html>
