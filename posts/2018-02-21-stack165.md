---
title: stack 1.6.5 がリリースされました。
author: Shinya Yamaguchi
tags: bigmoon, stack
---

## はじめに

先日 Stack version 1.6.5 が[リリース](https://github.com/commercialhaskell/stack/blob/master/ChangeLog.md#v165)されました。

バグフィックスのみです。

いくつか前回の [1.6.3](https://haskell.e-bigmoon.com/posts/2017-12-24-stack163.html) に含まれていた内容が 1.6.5 に移動してますね。

<!--more-->

## 更新方法

```shell
$ stack upgrade

$ stack --version
Version 1.6.5, Git revision 24ab0d6ff07f28276e082c3ce74dfdeb1a2ca9e9 (5514 commits) x86_64 hpack-0.20.0
```

## バグフィックス

- Windows でプリコンパイルキャッシュファイルに長いパス名を利用した際、たまにビルドが失敗する問題を修正しました ([#3649](https://github.com/commercialhaskell/stack/issues/3649))

- スクリプトインタプリタ形式で暗黙的に渡されるファイル引数を他の引数より先に処理するようにしました ([#3658](https://github.com/commercialhaskell/stack/issues/3658))。この修正により、スクリプト実行時に `-- +RTS ... -RTS` を渡せるようになりました。

- stack 設定ファイルで `year` パラメータが設定できるようになりました。それに伴い、ドキュメントもわかりやすくしました。 ([#2275](https://github.com/commercialhaskell/stack/issues/2275))。

- ベンチーマークが別のベンチマークやビルドステップと並行して実行されてしまう問題を修正しました。これは別のプロセスのCPU利用がベンチマークに悪影響を及ぼすと思われるので理想的ではありません。また、デフォルトでベンチマークの出力が表示されないようになっていた件も同様に修正しました ([#3663](https://github.com/commercialhaskell/stack/issues/3663))

- パッケージのコンポーネントごとに別々のビルドキャッシュを持つことによって、未変更のファイルについて不要なリビルドを回避するようになりました ([#3732](https://github.com/commercialhaskell/stack/issues/3732))

- スナップショットからローカルパッケージにパッケージを反映させる処理の動作を修正しました。これはスナップショットのバージョン境界が衝突する時に発生する問題なので、古いパッケージの Hackage リビジョンによって引き起こされました。同様にカスタムスナップショットでも、問題の起きないパッケージの衝突するバージョン定義を許可しました。([Stackage issue #3185](https://github.com/fpco/stackage/issues/3185))

- `stack ghci` で複数のパッケージで定義されている同名のモジュールを読み込めるようになりました ([#3776](https://github.com/commercialhaskell/stack/pull/3776))。

- `stack ghci` で `base` の依存関係を追加する必要が無くなりました。これはローカルターゲットが存在しない場合に自動的に追加されるためです。これにより、`base` を置き換えているコードも同様に読み込めるようになります ([#3589](https://github.com/commercialhaskell/stack/issues/3589#issuecomment))

- `--no-rerun-tests` が修正されました。今まではテストを実行した後に結果の記録を忘れていました。そのため、前回テストにパスしていたとしても、常に全てのテストが実行されていました ([#3770](https://github.com/commercialhaskell/stack/pull/3770))

- `hackage-security` のパッチを当てたバージョンを含めるようにしました。このパッチには機械故障や `SIGKILL` に対して更新処理が正しく復帰できるように、非同期例外処理に関する問題とディレクトリロックからファイルロックへの変更の2つが含まれます ([hackage-security #187](https://github.com/haskell/hackage-security/issues/187), [#3073](https://github.com/commercialhaskell/stack/issues/3073))

## Bug fix (オリジナル)

* 1.6.1 introduced a change that made some precompiled cache files use
  longer paths, sometimes causing builds to fail on windows. This has been
  fixed. See [#3649](https://github.com/commercialhaskell/stack/issues/3649)
* The script interpreter's implicit file arguments are now passed before other
  arguments. See [#3658](https://github.com/commercialhaskell/stack/issues/3658).
  In particular, this makes it possible to pass `-- +RTS ... -RTS` to specify
  RTS arguments used when running the script.
* Don't ignore the template `year` parameter in config files, and clarify the
  surrounding documentation. See
  [#2275](https://github.com/commercialhaskell/stack/issues/2275).
* Benchmarks used to be run concurrently with other benchmarks
  and build steps. This is non-ideal because CPU usage of other processes
  may interfere with benchmarks. It also prevented benchmark output from
  being displayed by default. This is now fixed. See
  [#3663](https://github.com/commercialhaskell/stack/issues/3663).
* Some unnecessary rebuilds when no files were changed are now avoided, by
  having a separate build cache for each component of a package. See
  [#3732](https://github.com/commercialhaskell/stack/issues/3732).
* Correct the behavior of promoting a package from snapshot to local
  package. This would get triggered when version bounds conflicted in
  a snapshot, which could be triggered via Hackage revisions for old
  packages. This also should allow custom snapshots to define
  conflicting versions of packages without issue. See
  [Stackage issue #3185](https://github.com/fpco/stackage/issues/3185).
* When promoting packages from snapshot to local, we were
  occassionally discarding the actual package location content and
  instead defaulting to pulling the package from the index. We now
  correctly retain this information. Note that if you were affected by
  this bug, you will likely need to delete the binary build cache
  associated with the relevant custom snapshot. See
  [#3714](https://github.com/commercialhaskell/stack/issues/3714).
* `stack ghci` now allows loading multiple packages with the same
  module name, as long as they have the same filepath. See
  [#3776](https://github.com/commercialhaskell/stack/pull/3776).
* `stack ghci` no longer always adds a dependency on `base`. It is
  now only added when there are no local targets. This allows it to
  be to load code that uses replacements for `base`. See
  [#3589](https://github.com/commercialhaskell/stack/issues/3589#issuecomment)
* `--no-rerun-tests` has been fixed. Previously, after running a test
  we were forgetting to record the result, which meant that all tests
  always ran even if they had already passed before. See
  [#3770](https://github.com/commercialhaskell/stack/pull/3770).
* Includes a patched version of `hackage-security` which fixes both
  some issues around asynchronous exception handling, and moves from
  directory locking to file locking, making the update mechanism
  resilient against SIGKILL and machine failure. See
  [hackage-security #187](https://github.com/haskell/hackage-security/issues/187)
  and [#3073](https://github.com/commercialhaskell/stack/issues/3073).

## まとめ

- [Stackage issue #3185](https://github.com/fpco/stackage/issues/3185) の問題については [Fix package promotion to snapshot #3758](https://github.com/commercialhaskell/stack/pull/3758/files) を参照する方が良さそうです。
- `stack ghci` 周りのバグフィックスもいくつかあったので `ghci` を多用する人にとっては嬉しいですね。
- 古い `LTS` を使っているプロジェクトでビルドができなくて困っている人は `1.6.5` にアップデートすると直るかもしれません。

以上です。