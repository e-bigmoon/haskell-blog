---
title: tasty-1.0 がリリースされました。
author: Shinya Yamaguchi
tags: bigmoon, package, tasty
---

`Haskell` で広く利用されているテストフレームワークに [Hspec](http://hspec.github.io/) と [Tasty](http://documentup.com/feuerbach/tasty) があります。

`Haskell` は型がテストのように振る舞い、結果としてバグが少ないプログラムを素早く作ることができます。

しかしながら、それでもテストを書くことは重要です。

なぜなら、値については何も保証しないからです。コンパイルが通ったからといって全てが正しいわけではありません。

例えば、以下の関数はコンパイルには通りますが、期待通りの結果を返さないでしょう。

```haskell
isZero :: Int -> Bool
isZero 1 = True
isZero 0 = False
```

`Haskell` においてこの種のバグをデバッグすることは、基本的に難しい作業ではないでしょうか。(現実的には、モナドトランスフォーマーのベースに `IO` があって `print` デバッグ的なことができたり、`Debug.Trace` の `trace` 関数を使ったりして実際の値を確かめたりします。)

このようなバグができるだけ入り込まないよう、関数が仕様を満たしていることを確認するために単体テストやランダムテストを実施します。

`Hspec` や `Tasty` はそれらのテストパッケージを使ってテストをより効率的に書けるよう、便利な関数などを含めて提供しているテストフレームワークです。(`Hspec` でよく見る `shouldBe` も [HUnit](https://www.stackage.org/package/HUnit) パッケージで提供されている関数をラップしているだけです。)

本記事では `Tasty` が `1.0` になったので使い方などを紹介したいと思います。

<!--more-->

## Tasty と Hspec の違い

`Tasty` は `Hspec` よりも後に作られたライブラリです。そのため、一般的なプロジェクトでは `Hspec` が利用されていることが多いです。(`stack new` で作られるプロジェクトのデフォルトテンプレートも `Hspec` になっています)

また `Tasty` は「`Haskell` のモダンテストフレームワークを作ろう！」ということで `Hspec` よりも後に作られました。

どちらが優れているというわけではないですが、個人的には以下の理由で `Tasty` が結構好きです。

- プロンプトのテスト結果に色が付く
- テスト結果のレポートを出力できる
- `providers` と `ingredients` が別々に用意されているので拡張性が高い
- `golden test` が書ける
- `Hspec` の形式も `Tasty` に記述できる
- `tasty-discover` が強力

## Tasty を採用しているプロジェクト

- [cabal](https://github.com/haskell/cabal)
- [attoparsec](https://github.com/bos/attoparsec)
- [pandoc](https://github.com/jgm/pandoc)
- [hakyll](https://github.com/jaspervdj/hakyll)

`cabal` や `pandoc` といった大きなプロジェクトでも採用実績があります。

## 使い方

[stack-templates](https://github.com/commercialhaskell/stack-templates) に [tasty-discover.hsfiles](https://github.com/commercialhaskell/stack-templates/blob/master/tasty-discover.hsfiles) と [tasty-travis.hsfiles](https://github.com/commercialhaskell/stack-templates/blob/master/tasty-travis.hsfiles) がありますが、今回は0から作っていきます。

### プロジェクトの作成

適当にディレクトリを作ってから、以下の内容で `stack.yaml` と `package.yaml` を作ります。

```shell
$ tree .
.
├── package.yaml
├── src
└── stack.yaml
```

```yaml
# package.yaml
name: tasty-example

dependencies:
  - base

library:
 source-dirs: src
```

```yaml
# stack.yaml
resolver: lts-10.3
```

### テスト対象の関数を作る (設計)

何かテスト対象となる関数を定義しなければなりません。

何でも良いのですが、こういう時は **閏年の判定** と **消費税の計算** にしておきましょう。

```haskell
-- src/Leap.hs
module Leap where

isLeapYear :: Int -> Bool
isLeapYear = undefined
```

```haskell
-- src/Tax.hs
module Tax where

calcSalesTax :: Integer -> Double
calcSalesTax = undefined
```

このように `undefined` を使って型だけ合わせてから、実装を後から定義するという手法は良く使われます。

### テストの実装 (準備)

実際の開発同様に [tasty-discover](https://github.com/lwm/tasty-discover) を使います。

`package.yaml` にテストのための記述を追加しましょう。

```yaml
name: tasty-example

dependencies:
  - base

library:
 source-dirs: src

# 追記
tests:
  tasty:
    main: Tasty.hs
    source-dirs:
      - src
      - test
    dependencies:
      - tasty
      - tasty-discover
      # ここから先のパッケージは必要に応じて追加する
      ## Providers
      - tasty-hunit
      - tasty-golden
      - tasty-smallcheck
      - tasty-quickcheck
      - tasty-hspec
      - tasty-program
      - tasty-bdd
      - tasty-dejafu
      ## Ingredients
      - tasty-ant-xml
      - tasty-rerun
      - tasty-html
      - tasty-stats
      ## Other packages
      - tasty-th
      - tasty-hunit-adapter
      - tasty-expected-failure
```

今回は `tasty` 関連パッケージの紹介を兼ねて `package.yaml` の依存関係に色々と追加しましたが、例えば `QuickCheck` しか使わないのであれば `tasty-quickcheck` だけで大丈夫です。

実際の開発では、自分が利用するテストパッケージだけを依存関係に追加します。

#### tasty-discover

`test/Tasty.hs` の内容は以下の通りです。

```haskell
{-# OPTIONS_GHC -F -pgmF tasty-discover #-}
```

これでルールに沿って関数を定義すれば自動的にテストを見つけてくれます。

ルールは以下のように、関数に特定の接頭辞を付けることで `stack test` を実行した際、それぞれの関数がどのテストを実行するか判断します。

関数の接頭辞 | テスト
-------|-------
prop_ | QuickCheck
scprop_ | SmallCheck
hprop_ | Hedgehog
unit_ | HUnit
spec_ | Hspec
test_ | Tasty

### テストの実装

次にテストケースを実装します。

ここでは単体テストをいろいろなパッケージを使って記述してみようと思います。

### tasty-hunit

## 参考

- [feuerbach/tasty](https://github.com/feuerbach/tasty)
- [hspec/hspec](https://github.com/hspec/hspec/)
- [Tasty](http://documentup.com/feuerbach/tasty)
- [A Testing Framework for Haskell](https://hspec.github.io/)
- [haskell/cabal](https://github.com/haskell/cabal)
- [lwm/tasty-discover](https://github.com/lwm/tasty-discover)