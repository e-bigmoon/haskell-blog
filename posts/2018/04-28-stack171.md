---
title: stack 1.7.1 がリリースされました。
author: Shinya Yamaguchi
tags: bigmoon, stack
---

## はじめに

Stack version 1.7.1 が[リリース](https://github.com/commercialhaskell/stack/blob/v1.7.1/ChangeLog.md#v171)されました。

更新は以下のコマンドですぐに終わります。

```shell
$ stack upgrade
$ stack --version
Version 1.7.1, Git revision 681c800873816c022739ca7ed14755e85a579565 (5807 commits) x86_64 hpack-0.28.2
```

<!--more-->

## リリースノート

どうやらこの辺の[コミット](https://github.com/commercialhaskell/stack/commit/9a23b91bd1ba4d120a77c9982e85079f825ebf06#diff-e705c8fadf1193ab59443a5e6c8cbe8b)の内容ですね。

- stack が aarch64 (64ビットARM) で初めて利用可能になりました。

stack のダウンロードリンクが `https://www.stackage.org/stack/` から `https://get.haskellstack.org/stable/` に変わりました。

各種バイナリへのリンクは `https://get.haskellstack.org/stable/<PLATFORM>.<EXTENSION>` という形式になるようです。

---

- Alpine Linux の GHC 8.2.2 対応が困難なため、静的にリンクされた Linux バイナリが利用不可になります。

関連する issue は[Official support for Alpine Linux #2387](https://github.com/commercialhaskell/stack/issues/2387), [
Cannot compile ghc 8.2.1 or 8.2.2 on armv7l architectures](https://ghc.haskell.org/trac/ghc/ticket/14739)ら辺です。

GHC 8.4 で Alpine Linux に正式対応すると良いなぁ・・・。

---

- CentOS 6 の 32bit Linux GMP4 バイナリは GHC 8.2.2 からサポートされなくなるため, stack も利用できなくなります。

関連してそうな issue 等は [linux64-gmp4 variant for GHC 8.2.2 #3613](https://github.com/commercialhaskell/stack/issues/3613), [The Glasgow Haskell Compiler -- version 8.2.1](https://ghc.haskell.org/trac/ghc/blog/ghc-8.2.11-released) でしょうか。

### 大きな変更

- Cabal 2.0 から Cabal 2.2 にアップグレートしました

PR は [Switch to Cabal 2.2 (prerelease) #3878](https://github.com/commercialhaskell/stack/pull/3878) ですね。

### 変更点

- デフォルトで PIE が有効な GCC を利用する Linux ディストリビューションにおいて、`stack setup` コマンドは異なる GHC コンフィグレーションオプションを利用しなくなりました。ghc-8.0.2 から GHC は自分自身で検出できるようになり、

コミットは [acb196788948bab7a01e13cddf6e6cd5b5bf93a0](https://github.com/commercialhaskell/stack/commit/acb196788948bab7a01e13cddf6e6cd5b5bf93a0#diff-e705c8fadf1193ab59443a5e6c8cbe8b) です。

- stack setup no longer uses different GHC configure options on Linux distributions that use GCC with PIE enabled by default. GHC detects this itself since ghc-8.0.2, and Stack's attempted workaround for older versions caused more problems than it solved.

---

- プロジェクトテンプレートに stack.yaml ファイルが含まれる場合、`stack new` コマンドは初期化を行わなくなります。

PR: [Initialize a new project only when no stack.yaml #3888](https://github.com/commercialhaskell/stack/pull/3888)

### その他の改良点

- stack に新たなサブコマンド `ls` が導入されました。このコマンドによってシステムが提供するローカルとリモートのスナップショットを確認することができます。詳細は `stack ls snapshots --help` コマンドで確認してください。

過去に[ブログ記事](../2017/12-20-stack-ls-command.html)にしたので、詳しくはそちらを参照ということで。

---

- `list-dependencies` コマンドが廃止されます。同等の機能は `ls dependencies` コマンドで引き続き提供されます。詳しくは [#3669](https://github.com/commercialhaskell/stack/issues/3669) を確認してください。

---

- 全ての HTTP リクエストヘッダに User-Agent を指定できるようになりました。詳細は [#3628](https://github.com/commercialhaskell/stack/issues/3628) をご確認ください。

PR: [Specify User-Agent on every HTTP request (#3628) #3682](https://github.com/commercialhaskell/stack/pull/3682/)

---

- stack setup looks for GHC bindists and installations by any OS key that is compatible (rather than only checking a single one). This is relevant on Linux where different distributions may have different combinations of libtinfo 5/6, ncurses 5/6, and gmp 4/5, and will allow simpifying the setup-info metadata YAML for future GHC releases.

---

- ビルドプログレスバーが現在ビルドしているパッケージ名を表示するようになりました。

PR: [Report currently building packages along with "Progress:" label #3763](https://github.com/commercialhaskell/stack/pull/3763)

変更前

```
Progress: 3/74
```

変更後

```
Progress: 3/74; [Cabal-2.0.1.1|basement-0.0.4|old-time-1.1.0.3|simple-sendfile-0.2.26|stm-2.4.4.1|stringsearch-0.3.6.6]
```

---

- `stack setup --verbose` で GHC 設定処理のログも含めて出力するようにしました。詳細は [#3716](https://github.com/commercialhaskell/stack/issues/3716) をご確認ください。

ISSUE: [Never ending "Configuring GHC..." #3712](https://github.com/commercialhaskell/stack/issues/3712)
PR: [Log GHC configure output on `stack -v setup` #3740](https://github.com/commercialhaskell/stack/pull/3740)

変更前は以下のように `Configuring GHC ...` で何も表示されていなかったようですが、

```shell
$ stack build --verbose
...

2017-12-27 00:30:23.869257: [debug] Run process: /home/gleb/.stack/programs/x86_64-linux/ghc-tinfo6-nopie-8.0.2.temp/ghc-8.0.2/configure --prefix=/home/gleb/.stack/programs/x86_64-linux/ghc-tinfo6-nopie-8.0.2/
@(System/Process/Log.hs:37:3)
Configuring GHC ...
```

こんな感じのログが続いて表示されるようになったようです。

```shell
...
018-01-03 10:49:29.280793: [debug] Run process within /home/kp/.stack/programs/x86_64-linux/ghc-7.10.3.temp/ghc-7.10.3/: /usr/bin/make install
@(subs/rio/src/RIO/Process.hs:191:3)
2018-01-03 10:49:29.304283: [info] /usr/bin/make -r --no-print-directory -f ghc.mk install BINDIST=YES NO_INCLUDE_DEPS=YES
@(Stack/Setup.hs:1096:54)
2018-01-03 10:49:29.737966: [info] "rm" -f utils/ghc-pkg/dist-install/build/Version.hs
@(Stack/Setup.hs:1096:54)
2018-01-03 10:49:29.739872: [info] echo "module Version where"                    >> utils/ghc-pkg/dist-install/build/Version.hs
@(Stack/Setup.hs:1096:54)
2018-01-03 10:49:29.741026: [info] echo "version, targetOS, targetARCH :: String" >> utils/ghc-pkg/dist-install/build/Version.hs
@(Stack/Setup.hs:1096:54)
2018-01-03 10:49:29.742170: [info] echo "version    = \"7.10.3\""      >> utils/ghc-pkg/dist-install/build/Version.hs
```

---

- ファイルパスまたは git 参照から `extra-dep` が見つからなかった時のエラーメッセージが改善されました。[#3808](https://github.com/commercialhaskell/stack/pull/3808)を参照。

ISSUE: [Confusing error message when a cabal file for an extra-dep can't be found #3806](https://github.com/commercialhaskell/stack/issues/3806)

---

- Nix インテグレーションを明示的に有効にしていても、ウィンドウズではサポートされていないため無効になります。

ISSUE: [Nix doesn't work on Windows #3600](https://github.com/commercialhaskell/stack/issues/3600)
PR: [Disable nix on windows (#3600) #3833](https://github.com/commercialhaskell/stack/pull/3833)

---

- `stack build` に `--keep-tmp-files` フラグを追加しました。デバッグ目的のため一時的に作成したファイルやディレクトリを残します。このフラグは同等の機能を持つ ghc オプションと同時に使うと良いでしょう。`stack build --keep-tmp-files --ghc-options=-keep-tmp-files` のように。

ISSUE: [How to keep temporary files on build failures? #3857](https://github.com/commercialhaskell/stack/issues/3857)

---

- スナップショットのパーズ例外時のエラーメッセージを改善しました。

commit: [cb947f140a3315d742dd1abe3defc21f57f18b30](https://github.com/commercialhaskell/stack/commit/cb947f140a3315d742dd1abe3defc21f57f18b30#diff-e705c8fadf1193ab59443a5e6c8cbe8b)

---

- `stack unpack` コマンドに `--to /target/directory` オプションが追加されました。パッケージの展開先を指定できるようになります。

---

- `stack hoogle` コマンドに `--server` オプションが追加されました。ローカルのポート8080番で Hoogle サーバーが実行されます。

ISSUE: [Add `stack hoogle --server` command #2310](https://github.com/commercialhaskell/stack/issues/2310)
PR: [Introduce Hoogle server command line option #3941](https://github.com/commercialhaskell/stack/pull/3941)

---

リリースノートに載ってないけど・・・。

[Allow 'github' shorthand for extra-deps (fixes #3873) #3890](https://github.com/commercialhaskell/stack/pull/3890)

上記のPRにより `extra-deps` で `github` という短縮形が使えるようになりました。

```yaml
- github: commercialhaskell/rio
  commit: 09654f9fcbdcd96d0f5102796b32fdac5da7260e
```

詳細は以下のブログ記事をご確認ください。

- [extra-deps に github の短縮形が指定できるようになります](./03-13-stack-extra-deps-shorthand.html)

### バグフィックス

- スクリプトインタプリタ形式で暗黙的に渡されるファイル引数を他の引数より先に処理するようにしました (#3658)。この修正により、スクリプト実行時に -- +RTS ... -RTS を渡せるようになりました。

[v.1.6.5](./02-21-stack165.html)の時に紹介したので飛ばし。

---

- stack 設定ファイルで year パラメータが設定できるようになりました。それに伴い、ドキュメントもわかりやすくしました。 (#2275)。

これも[v.1.6.5](./02-21-stack165.html)で紹介したので飛ばし。

---

- ベンチーマークが別のベンチマークやビルドステップと並行して実行されてしまう問題を修正しました。これは別のプロセスのCPU利用がベンチマークに悪影響を及ぼすと思われるので理想的ではありません。また、デフォルトでベンチマークの出力が表示されないようになっていた件も同様に修正しました ([#3663](https://github.com/commercialhaskell/stack/issues/3663))

これも[v.1.6.5](./02-21-stack165.html)で紹介したので飛ばし。

---

- stack ghci で複数のパッケージで定義されている同名のモジュールを読み込めるようになりました ([#3776](https://github.com/commercialhaskell/stack/pull/3776))。

これも[v.1.6.5](./02-21-stack165.html)で紹介したので飛ばし。

---

- stack ghci で base の依存関係を追加する必要が無くなりました。これはローカルターゲットが存在しない場合に自動的に追加されるためです。これにより、base を置き換えているコードも同様に読み込めるようになります ([#3589](https://github.com/commercialhaskell/stack/issues/3589#issuecomment))

これも[v.1.6.5](./02-21-stack165.html)で紹介したので飛ばし。

---

- `stack ghci` コマンドで autogen ファイルのパスを適切に扱えるようになりました。

ISSUE: [#3791](https://github.com/commercialhaskell/stack/issues/3791)
PR: [Use per-component build directories for ghci with Cabal>=2.0 #3791 #3795](https://github.com/commercialhaskell/stack/pull/3795)

---

- stack はサブディレクトリを含むパッケージを常に再コンパイルしていました。現在は修正され、サブディレクトリを再コンパイルする必要がある時だけ行うようになりました。

ISSUe: [hakyll dependency on nightly is not cached #3899](https://github.com/commercialhaskell/stack/issues/3899)

実際にこれ踏みました。特に `Hakyll` や `Pandoc` (依存しているライブラリも同様に影響を受ける) を使う場合に発生していたため、作業効率がありえないほど落ちるという・・・。

同じ問題に直面している人はアップグレード推奨です。

---

- `get-stack.sh` インストールスクリプトは

- The get-stack.sh install script now matches manual instructions when it comes to Debian/Fedora/CentOS install dependencies.

---

- Nix を利用する際は libgmp で Cabal-simple をコンパイルします。

ISSUE: [Nix: stack should compile setup-Simple-Cabal with libgmp #2944](https://github.com/commercialhaskell/stack/issues/2944)

---

- `stack ghci` コマンドの stack 処理は ghci で置き換えられました。これによりシグナルハンドリングの動作が改善されます。特に Ctrl-C のハンドリングが改善されます。そのため、生成されたファイルは終了後に残ります。このパスはファイルコンテンツのハッシュにより決まり、システムの一時的なディレクトリに保存されます。そのため、ゴミを出しすぎるべきでありません。

ISSUE: [stack repl exits on ctrl+c with error <stdin>: hGetChar: hardware fault (Input/output error) #3821](https://github.com/commercialhaskell/stack/issues/3821)

RP: [Fix stack ghci ctrl c 3821 #3869](https://github.com/commercialhaskell/stack/pull/3869)

## Changelog (オリジナル)

### Release notes

- aarch64 (64-bit ARM) bindists are now available for the first time.
- Statically linked Linux bindists are no longer available, due to difficulty with GHC 8.2.2 on Alpine Linux.
- 32-bit Linux GMP4 bindists for CentOS 6 are no longer available, since GHC 8.2.2 is no longer being built for that platform.

### Major changes

- Upgrade from Cabal 2.0 to Cabal 2.2

### Behavior changes

- `stack setup` no longer uses different GHC configure options on Linux
  distributions that use GCC with PIE enabled by default.  GHC detects
  this itself since ghc-8.0.2, and Stack's attempted workaround for older
  versions caused more problems than it solved.
- `stack new` no longer initializes a project if the project template contains
   a stack.yaml file.

### Other enhancements

- A new sub command `ls` has been introduced to stack to view
  local and remote snapshots present in the system. Use `stack ls
  snapshots --help` to get more details about it.
- `list-dependencies` has been deprecated. The functionality has
  to accessed through the new `ls dependencies` interface. See
  [#3669](https://github.com/commercialhaskell/stack/issues/3669)
  for details.
- Specify User-Agent HTTP request header on every HTTP request.
  See [#3628](https://github.com/commercialhaskell/stack/issues/3628) for details.
- `stack setup` looks for GHC bindists and installations by any OS key
  that is compatible (rather than only checking a single one).   This is
  relevant on Linux where different distributions may have different
  combinations of libtinfo 5/6, ncurses 5/6, and gmp 4/5, and will allow
  simpifying the setup-info metadata YAML for future GHC releases.
- The build progress bar reports names of packages currently building.
- `stack setup --verbose` causes verbose output of GHC configure process.
  See [#3716](https://github.com/commercialhaskell/stack/issues/3716)
- Improve the error message when an `extra-dep` from a path or git reference can't be found
  See [#3808](https://github.com/commercialhaskell/stack/pull/3808)
- Nix integration is now disabled on windows even if explicitly enabled,
  since it isn't supported. See
  [#3600](https://github.com/commercialhaskell/stack/issues/3600)
- `stack build` now supports a new flag `--keep-tmp-files` to retain intermediate
  files and directories for the purpose of debugging.
  It is best used with ghc's equivalent flag,
  i.e. `stack build --keep-tmp-files --ghc-options=-keep-tmp-files`.
  See [#3857](https://github.com/commercialhaskell/stack/issues/3857)
- Improved error messages for snapshot parse exceptions
- `stack unpack` now supports a `--to /target/directory` option to
  specify where to unpack the package into
- `stack hoogle` now supports a new flag `--server` that launches local
  Hoogle server on port 8080. See
  [#2310](https://github.com/commercialhaskell/stack/issues/2310)

### Bug fixes

- The script interpreter's implicit file arguments are now passed before other
  arguments. See [#3658](https://github.com/commercialhaskell/stack/issues/3658).
  In particular, this makes it possible to pass `-- +RTS ... -RTS` to specify
  RTS arguments used when running the script.
- Don't ignore the template `year` parameter in config files, and clarify the
  surrounding documentation. See
  [#2275](https://github.com/commercialhaskell/stack/issues/2275).
- Benchmarks used to be run concurrently with other benchmarks
  and build steps. This is non-ideal because CPU usage of other processes
  may interfere with benchmarks. It also prevented benchmark output from
  being displayed by default. This is now fixed. See
  [#3663](https://github.com/commercialhaskell/stack/issues/3663).
- `stack ghci` now allows loading multiple packages with the same
  module name, as long as they have the same filepath. See
  [#3776](https://github.com/commercialhaskell/stack/pull/3776).
- `stack ghci` no longer always adds a dependency on `base`. It is
  now only added when there are no local targets. This allows it to
  be to load code that uses replacements for `base`. See
  [#3589](https://github.com/commercialhaskell/stack/issues/3589#issuecomment)
- `stack ghci` now uses correct paths for autogen files with
  [#3791](https://github.com/commercialhaskell/stack/issues/3791)
- When a package contained sublibraries, stack was always recompiling the
  package. This has been fixed now, no recompilation is being done because of
  sublibraries. See [#3899](https://github.com/commercialhaskell/stack/issues/3899).
- The `get-stack.sh` install script now matches manual instructions
  when it comes to Debian/Fedora/CentOS install dependencies.
- Compile Cabal-simple with gmp when using Nix.
  See [#2944](https://github.com/commercialhaskell/stack/issues/2944)
- `stack ghci` now replaces the stack process with ghci. This improves
  signal handling behavior. In particular, handling of Ctrl-C.  To make
  this possible, the generated files are now left behind after exit.
  The paths are based on hashing file contents, and it's stored in the
  system temporary directory, so this shouldn't result in too much
  garbage. See
  [#3821](https://github.com/commercialhaskell/stack/issues/3821).
